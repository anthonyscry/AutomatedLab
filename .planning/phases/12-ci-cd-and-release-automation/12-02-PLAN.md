---
phase: 12-ci-cd-and-release-automation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/pr-lint.yml
  - .PSScriptAnalyzerSettings.psd1
autonomous: true
requirements:
  - CICD-02

must_haves:
  truths:
    - "PR to main triggers ScriptAnalyzer lint check on Windows runner"
    - "ScriptAnalyzer results appear as annotations on changed files in PR"
    - "PSAvoidUsingWriteHost and PSUseShouldProcessForStateChangingFunctions are suppressed project-wide"
    - "Errors fail the pipeline, warnings are non-blocking annotations"
    - "Lint runs on clean runner without manual setup"
  artifacts:
    - path: ".github/workflows/pr-lint.yml"
      provides: "PR lint pipeline workflow"
      contains: "PSScriptAnalyzer"
    - path: ".PSScriptAnalyzerSettings.psd1"
      provides: "Project-specific ScriptAnalyzer rule configuration"
      contains: "PSAvoidUsingWriteHost"
  key_links:
    - from: ".github/workflows/pr-lint.yml"
      to: ".PSScriptAnalyzerSettings.psd1"
      via: "Settings parameter in Invoke-ScriptAnalyzer"
      pattern: "PSScriptAnalyzerSettings"
---

<objective>
Add a GitHub Actions ScriptAnalyzer lint workflow with project-specific baseline exceptions so static analysis runs automatically on PRs.

Purpose: Catch code quality issues early with PSScriptAnalyzer, suppressing intentional patterns (WriteHost for CLI output) while catching real problems.
Output: `.github/workflows/pr-lint.yml` workflow file, `.PSScriptAnalyzerSettings.psd1` settings file.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-cd-and-release-automation/12-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScriptAnalyzer settings file</name>
  <files>.PSScriptAnalyzerSettings.psd1</files>
  <action>
Create `.PSScriptAnalyzerSettings.psd1` at the repository root with project-specific rule configuration:

```powershell
@{
    Severity = @('Error', 'Warning')

    ExcludeRules = @(
        'PSAvoidUsingWriteHost'
        'PSUseShouldProcessForStateChangingFunctions'
    )
}
```

**Rationale:**
- `PSAvoidUsingWriteHost`: Intentionally used throughout for CLI output (per CONTEXT.md decision).
- `PSUseShouldProcessForStateChangingFunctions`: Suppressed where CmdletBinding already has SupportsShouldProcess (per CONTEXT.md decision).
- Use a baseline exception file (not inline suppression attributes) per user decision.

Do NOT add `IncludeDefaultRules = $true` -- this is the default behavior.
Do NOT exclude `PSAvoidUsingCmdletAliases` or other common rules -- only suppress the two explicitly decided.
  </action>
  <verify>Read `.PSScriptAnalyzerSettings.psd1` and verify it contains the two exclusions and severity levels. Validate PowerShell data file syntax: `pwsh -c "Import-PowerShellDataFile '.PSScriptAnalyzerSettings.psd1'"` if pwsh available, otherwise inspect visually.</verify>
  <done>Settings file exists at repo root with Error+Warning severity and two project-specific exclusions.</done>
</task>

<task type="auto">
  <name>Task 2: Create PR lint workflow</name>
  <files>.github/workflows/pr-lint.yml</files>
  <action>
Create `.github/workflows/pr-lint.yml` with:

**Trigger:** `pull_request` to `main` branch only.

**Runner:** `windows-latest` (for PowerShell 5.1 compatibility with the codebase).

**Permissions:** `contents: read`, `checks: write`.

**Job: `lint`**
1. `actions/checkout@v4`
2. Install PSScriptAnalyzer: `Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck` using `pwsh` shell.
3. Run ScriptAnalyzer step (pwsh shell):
   ```powershell
   $results = @()
   $results += Invoke-ScriptAnalyzer -Path ./Public -Recurse -Settings .PSScriptAnalyzerSettings.psd1
   $results += Invoke-ScriptAnalyzer -Path ./Private -Recurse -Settings .PSScriptAnalyzerSettings.psd1
   $results += Invoke-ScriptAnalyzer -Path ./Scripts -Recurse -Settings .PSScriptAnalyzerSettings.psd1
   $results += Invoke-ScriptAnalyzer -Path ./Deploy.ps1 -Settings .PSScriptAnalyzerSettings.psd1
   $results += Invoke-ScriptAnalyzer -Path ./Bootstrap.ps1 -Settings .PSScriptAnalyzerSettings.psd1
   $results += Invoke-ScriptAnalyzer -Path ./OpenCodeLab-App.ps1 -Settings .PSScriptAnalyzerSettings.psd1

   $errors = $results | Where-Object { $_.Severity -eq 'Error' }
   $warnings = $results | Where-Object { $_.Severity -eq 'Warning' }

   # Emit GitHub Actions annotations for all results
   foreach ($r in $results) {
       $file = $r.ScriptName
       $line = $r.Line
       $msg = "$($r.RuleName): $($r.Message)"
       if ($r.Severity -eq 'Error') {
           Write-Output "::error file=$file,line=$line::$msg"
       } else {
           Write-Output "::warning file=$file,line=$line::$msg"
       }
   }

   Write-Output ""
   Write-Output "ScriptAnalyzer: $($errors.Count) error(s), $($warnings.Count) warning(s)"

   if ($errors.Count -gt 0) {
       Write-Output "::error::ScriptAnalyzer found $($errors.Count) error(s)"
       exit 1
   }
   ```

**Key decisions:**
- Errors fail the pipeline (exit 1), warnings are annotations only (per CONTEXT.md).
- Scan Public/, Private/, Scripts/, and key root scripts. Do NOT scan Tests/ (test files have different conventions).
- Do NOT scan GUI/ or LabBuilder/ directories in this initial pass -- they can be added later.
- Use `::error` and `::warning` workflow commands for GitHub PR annotations on changed files.
  </action>
  <verify>Validate YAML syntax. Verify the workflow references `.PSScriptAnalyzerSettings.psd1`, scans the correct directories, emits GitHub annotations, and exits 1 only on errors.</verify>
  <done>Lint workflow triggers on PR, runs ScriptAnalyzer with project settings, emits inline PR annotations, fails only on errors.</done>
</task>

</tasks>

<verification>
- [ ] `.PSScriptAnalyzerSettings.psd1` is valid PowerShell data file
- [ ] Settings exclude PSAvoidUsingWriteHost and PSUseShouldProcessForStateChangingFunctions
- [ ] `.github/workflows/pr-lint.yml` is valid YAML
- [ ] Workflow triggers on `pull_request` to `main`
- [ ] Uses `windows-latest` runner
- [ ] ScriptAnalyzer annotations appear as `::error` and `::warning` commands
- [ ] Only errors cause pipeline failure
</verification>

<success_criteria>
ScriptAnalyzer lint workflow is ready to run on next PR. Errors block merge, warnings appear as inline annotations, project-specific suppressions prevent false positives.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-cd-and-release-automation/12-02-SUMMARY.md`
</output>
