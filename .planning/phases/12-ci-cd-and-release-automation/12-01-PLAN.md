---
phase: 12-ci-cd-and-release-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/pr-tests.yml
  - Tests/Run.Tests.ps1
autonomous: true
requirements:
  - CICD-01

must_haves:
  truths:
    - "PR to main triggers Pester test suite on Windows runner"
    - "Pester failures show test name and error message in GitHub Actions log"
    - "Test results appear as a check run summary on the PR"
    - "Pipeline fails with non-zero exit code when any test fails"
    - "CI runs on clean GitHub-hosted runner without manual setup"
  artifacts:
    - path: ".github/workflows/pr-tests.yml"
      provides: "PR test pipeline workflow"
      contains: "pull_request"
    - path: "Tests/Run.Tests.ps1"
      provides: "Pester test runner with CI-compatible output"
      contains: "Invoke-Pester"
  key_links:
    - from: ".github/workflows/pr-tests.yml"
      to: "Tests/Run.Tests.ps1"
      via: "pwsh invocation step"
      pattern: "Run\\.Tests\\.ps1"
---

<objective>
Add a GitHub Actions PR test workflow that runs the full Pester suite on Windows with clear failure diagnostics.

Purpose: Ensure every pull request to main is validated by the existing 847+ Pester tests before merge, with actionable failure output.
Output: `.github/workflows/pr-tests.yml` workflow file, updated `Tests/Run.Tests.ps1` for CI compatibility.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-cd-and-release-automation/12-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR test workflow</name>
  <files>.github/workflows/pr-tests.yml</files>
  <action>
Create a GitHub Actions workflow `.github/workflows/pr-tests.yml` with:

**Trigger:** `pull_request` to `main` branch only.

**Runner:** `windows-latest` (required for Hyper-V module stubs and PowerShell 5.1 compatibility).

**Permissions:** `contents: read`, `checks: write` (for test reporter).

**Job: `test`**
1. `actions/checkout@v4`
2. Install Pester step: `Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser -SkipPublisherCheck` using `pwsh` shell.
3. Run Pester step: Invoke `Tests/Run.Tests.ps1` with `-OutputPath Tests/results/testResults.xml -Verbosity Detailed`. Use `pwsh` shell. Set `shell: pwsh` at job level for consistency.
4. Upload test results artifact: `actions/upload-artifact@v4` with `name: pester-results`, `path: Tests/results/testResults.xml`, `if: always()`.
5. Publish test summary: `dorny/test-reporter@v1` with `name: Pester Results`, `path: Tests/results/testResults.xml`, `reporter: java-junit`, `if: always()`.

**Fail-fast:** The workflow should fail on first Pester failure (exit code from Run.Tests.ps1 equals FailedCount).

Do NOT reuse the existing `ci.yml` Docker-based workflow -- that is for the v2 codebase. This workflow targets the v1 PowerShell module directly on Windows.
  </action>
  <verify>Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/pr-tests.yml'))"` or equivalent. Verify the file references the correct test runner path and uses `windows-latest`.</verify>
  <done>`.github/workflows/pr-tests.yml` exists, triggers on PR to main, runs on windows-latest, invokes Pester, uploads results, publishes test summary.</done>
</task>

<task type="auto">
  <name>Task 2: Update test runner for CI compatibility</name>
  <files>Tests/Run.Tests.ps1</files>
  <action>
Update `Tests/Run.Tests.ps1` to ensure CI compatibility:

1. Ensure the `results` subdirectory is created before running: add `$resultsDir = Split-Path $OutputPath; if ($resultsDir -and -not (Test-Path $resultsDir)) { New-Item -ItemType Directory -Path $resultsDir -Force | Out-Null }` before `Invoke-Pester`.

2. Set `$config.Output.CIFormat = 'GithubActions'` (instead of `'Auto'`) when environment variable `GITHUB_ACTIONS` is present: `if ($env:GITHUB_ACTIONS) { $config.Output.CIFormat = 'GithubActions' }`. This enables inline annotations on test failures in the GitHub PR.

3. Ensure the JUnit XML output format is set for test results (already using JaCoCo for coverage, but test results should use NUnitXml or JUnitXml). The current `$config.TestResult.OutputFormat` defaults to NUnit2.5 which works with `dorny/test-reporter`'s `java-junit` reporter. Leave as default.

Do NOT change the exit code behavior (`exit $result.FailedCount`) -- this is correct for CI.
Do NOT remove the code coverage configuration -- it will be used by Phase 13.
  </action>
  <verify>Read the updated `Tests/Run.Tests.ps1` and verify: (1) results directory creation logic exists, (2) GithubActions CIFormat is set conditionally, (3) exit code behavior preserved.</verify>
  <done>Test runner creates output directory, sets GitHub Actions CI format when in CI, preserves all existing behavior for local runs.</done>
</task>

</tasks>

<verification>
- [ ] `.github/workflows/pr-tests.yml` is valid YAML
- [ ] Workflow triggers on `pull_request` to `main`
- [ ] Uses `windows-latest` runner
- [ ] Installs Pester, runs tests, uploads artifacts, publishes summary
- [ ] `Tests/Run.Tests.ps1` creates output directory, uses GithubActions format in CI
- [ ] No changes to existing `ci.yml` or `opencodelab-v2-ci.yml`
</verification>

<success_criteria>
PR test workflow is ready to run on next pull request to main. Pester failures will appear as inline annotations and a test summary check on the PR.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-cd-and-release-automation/12-01-SUMMARY.md`
</output>
