---
phase: 12-ci-cd-and-release-automation
plan: 03
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - .github/workflows/release.yml
  - SimpleLab.psd1
autonomous: true
requirements:
  - CICD-03
  - CICD-04
user_setup:
  - service: "PowerShell Gallery"
    why: "Module publishing requires API key"
    env_vars:
      - name: PSGALLERY_API_KEY
        source: "PowerShell Gallery -> API Keys -> Create/manage"
    dashboard_config:
      - task: "Create repository secret PSGALLERY_API_KEY"
        location: "GitHub -> Repository -> Settings -> Secrets and variables -> Actions"

must_haves:
  truths:
    - "Tag push (v*) triggers release workflow that validates version, runs tests, and creates GitHub Release"
    - "Version in SimpleLab.psd1 must match the pushed tag or release fails"
    - "Full Pester suite passes before any release artifact is created"
    - "Module loads without errors as a pre-publish check"
    - "FunctionsToExport count matches Public/ function count as a pre-publish check"
    - "Publish step uses -WhatIf dry-run before actual publish"
    - "Publish step requires manual workflow_dispatch confirmation"
    - "Release creates a GitHub Release with the tag and basic release notes"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Tag-triggered release and publish workflow"
      contains: "workflow_dispatch"
    - path: "SimpleLab.psd1"
      provides: "Module manifest with ProjectUri and LicenseUri for Gallery metadata"
      contains: "ProjectUri"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "SimpleLab.psd1"
      via: "Version extraction and module load verification"
      pattern: "ModuleVersion"
    - from: ".github/workflows/release.yml"
      to: "Tests/Run.Tests.ps1"
      via: "Full test suite execution before release"
      pattern: "Run\\.Tests\\.ps1"
---

<objective>
Add a release workflow that validates versioning, runs tests, creates a GitHub Release, and optionally publishes to PowerShell Gallery with pre-publish safety checks.

Purpose: Ensure releases are verified (tests pass, version matches tag, module loads cleanly) before publishing, with controlled permissions for Gallery publishing.
Output: `.github/workflows/release.yml` workflow file, updated `SimpleLab.psd1` metadata.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-cd-and-release-automation/12-CONTEXT.md
@.planning/phases/12-ci-cd-and-release-automation/12-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release and publish workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with TWO triggers:

**Triggers:**
1. `push` with `tags: ['v*']` -- automated release on tag push
2. `workflow_dispatch` with input `publish_to_gallery` (boolean, default false, description "Publish to PowerShell Gallery after release") -- manual trigger for Gallery publish

**Runner:** `windows-latest`

**Permissions:** `contents: write` (for creating GitHub Release), `checks: write`.

**Job: `release`**

Steps:

1. **Checkout:** `actions/checkout@v4` with `fetch-depth: 0` (for changelog generation).

2. **Extract version from tag** (pwsh):
   ```powershell
   $tag = if ($env:GITHUB_REF_TYPE -eq 'tag') { $env:GITHUB_REF_NAME } else { 'v0.0.0-manual' }
   $version = $tag -replace '^v', ''
   Write-Output "TAG=$tag" >> $env:GITHUB_OUTPUT
   Write-Output "VERSION=$version" >> $env:GITHUB_OUTPUT
   ```
   Use `id: version`.

3. **Validate version matches manifest** (pwsh):
   ```powershell
   $manifest = Import-PowerShellDataFile -Path SimpleLab.psd1
   $manifestVersion = $manifest.ModuleVersion
   $tagVersion = '${{ steps.version.outputs.VERSION }}'
   if ($tagVersion -ne '0.0.0-manual' -and $manifestVersion -ne $tagVersion) {
       Write-Output "::error::Version mismatch: SimpleLab.psd1 has $manifestVersion but tag is v$tagVersion"
       exit 1
   }
   Write-Output "Version validated: $manifestVersion"
   ```

4. **Install Pester:** Same as pr-tests.yml.

5. **Run full test suite:** Invoke `Tests/Run.Tests.ps1 -OutputPath Tests/results/testResults.xml -Verbosity Detailed`. Fail if any test fails.

6. **Upload test results:** `actions/upload-artifact@v4`, `if: always()`.

7. **Verify module loads** (pwsh):
   ```powershell
   Import-Module ./SimpleLab.psd1 -Force -ErrorAction Stop
   $mod = Get-Module SimpleLab
   Write-Output "Module loaded: $($mod.Name) v$($mod.Version)"
   Write-Output "Exported functions: $($mod.ExportedFunctions.Count)"
   ```

8. **Validate FunctionsToExport** (pwsh):
   ```powershell
   $manifest = Import-PowerShellDataFile -Path SimpleLab.psd1
   $exportCount = $manifest.FunctionsToExport.Count
   $publicFiles = (Get-ChildItem -Path ./Public -Filter '*.ps1' -Recurse -File).Count
   if ($exportCount -ne $publicFiles) {
       Write-Output "::warning::FunctionsToExport ($exportCount) does not match Public/ file count ($publicFiles). Review before publishing."
   }
   Write-Output "Export check: $exportCount functions exported, $publicFiles Public/ files"
   ```

9. **Create GitHub Release:** Use `softprops/action-gh-release@v2` with:
   - `tag_name: ${{ steps.version.outputs.TAG }}`
   - `name: SimpleLab ${{ steps.version.outputs.TAG }}`
   - `body`: Generate from recent commits: `git log $(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)..HEAD --pretty=format:"- %s" --no-merges`
   - `draft: false`
   - `prerelease: false`
   - Only run when `github.ref_type == 'tag'`.

10. **Publish to Gallery (conditional)** (pwsh):
    Only run when `github.event_name == 'workflow_dispatch'` AND input `publish_to_gallery` is true.

    ```powershell
    # Dry run first
    Write-Output "--- DRY RUN ---"
    Publish-Module -Path . -NuGetApiKey '${{ secrets.PSGALLERY_API_KEY }}' -WhatIf -Verbose
    Write-Output "--- DRY RUN COMPLETE ---"

    # Actual publish
    Write-Output "--- PUBLISHING ---"
    Publish-Module -Path . -NuGetApiKey '${{ secrets.PSGALLERY_API_KEY }}' -Verbose
    Write-Output "Published SimpleLab to PowerShell Gallery"
    ```

    Use `if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_gallery == 'true'`.

**Key decisions per CONTEXT.md:**
- Tag-based releases (push v* tag triggers release).
- Version source of truth: SimpleLab.psd1 ModuleVersion.
- No automatic version bump -- developer sets version before tagging.
- Publish requires manual workflow_dispatch (not automatic on tag).
- -WhatIf dry-run before actual publish.
  </action>
  <verify>Validate YAML syntax. Verify: (1) two triggers (tag push + workflow_dispatch), (2) version validation step, (3) test suite execution, (4) module load check, (5) FunctionsToExport validation, (6) GitHub Release creation, (7) conditional Gallery publish with WhatIf.</verify>
  <done>Release workflow handles tag-based releases with full validation pipeline and optional Gallery publishing with safety checks.</done>
</task>

<task type="auto">
  <name>Task 2: Add Gallery metadata to module manifest</name>
  <files>SimpleLab.psd1</files>
  <action>
Update `SimpleLab.psd1` PrivateData.PSData section to include Gallery-required metadata:

1. Uncomment and set `ProjectUri` to the GitHub repository URL. Use a placeholder that matches the repo: `'https://github.com/yourorg/AutomatedLab'` -- the executor should detect the actual remote URL via `git remote get-url origin` and use that.

2. Uncomment and set `LicenseUri` to `'https://github.com/yourorg/AutomatedLab/blob/main/LICENSE'` (adjust to actual remote URL).

3. Add `ReleaseNotes` field with `'See GitHub Releases for changelog.'`.

Do NOT change `ModuleVersion` -- that is set by the developer before tagging.
Do NOT change `FunctionsToExport` -- that is managed by Phase 10 reconciliation.
Do NOT add `IconUri` -- not required for initial Gallery listing.
  </action>
  <verify>Read `SimpleLab.psd1` and verify PSData section has ProjectUri, LicenseUri, and ReleaseNotes populated. Validate manifest: `pwsh -c "Test-ModuleManifest SimpleLab.psd1"` if pwsh available.</verify>
  <done>Module manifest includes Gallery metadata (ProjectUri, LicenseUri, ReleaseNotes) for reviewable publishing.</done>
</task>

</tasks>

<verification>
- [ ] `.github/workflows/release.yml` is valid YAML
- [ ] Workflow triggers on tag push (v*) and workflow_dispatch
- [ ] Version validation: tag must match SimpleLab.psd1 ModuleVersion
- [ ] Full Pester suite runs before release
- [ ] Module load and FunctionsToExport validation before publish
- [ ] GitHub Release created on tag push
- [ ] Gallery publish only on manual dispatch with WhatIf dry-run
- [ ] PSGALLERY_API_KEY referenced as repository secret
- [ ] SimpleLab.psd1 has ProjectUri, LicenseUri, ReleaseNotes
</verification>

<success_criteria>
Release workflow validates version+tests+module integrity before creating GitHub Release. Gallery publishing is gated behind manual dispatch with dry-run safety. Module manifest has required Gallery metadata.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-cd-and-release-automation/12-03-SUMMARY.md`
</output>
