---
phase: 30-lab-analytics
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - Public/Export-LabAnalyticsData.ps1
  - Tests/LabAnalyticsExport.Tests.ps1
autonomous: true
requirements:
  - ANLY-02

must_haves:
  truths:
    - "Operator can export lab usage data to CSV for external analysis"
    - "Operator can export lab usage data to JSON for external analysis"
    - "Export function supports filtering by date range and event type"
    - "Exported files are written to a specified output path"
    - "Export includes all analytics fields (timestamp, event type, lab name, VM names, metadata)"
  artifacts:
    - path: "Public/Export-LabAnalyticsData.ps1"
      provides: "Public API for exporting analytics data"
      exports: ["Export-LabAnalyticsData"]
      min_lines: 80
    - path: "Tests/LabAnalyticsExport.Tests.ps1"
      provides: "Unit tests for export functionality"
      min_lines: 30
  key_links:
    - from: "Export-LabAnalyticsData.ps1"
      to: "Get-LabAnalytics.ps1"
      via: "Reads analytics events for export"
      pattern: "Get-LabAnalytics"
    - from: "Export-LabAnalyticsData.ps1"
      to: "Write-LabAnalyticsEvent.ps1"
      via: "Uses same event schema for export format"
      pattern: "Timestamp|EventType|LabName"
---

<objective>
Create export functionality that allows operators to export lab usage analytics data to CSV or JSON formats for external analysis in tools like Excel, Power BI, or custom scripts.

Purpose: Enable operators to perform custom analytics, generate reports, and integrate lab usage data with external tools by providing flexible export options with filtering capabilities.

Output: Export-LabAnalyticsData public API with CSV and JSON export formats, filtering support, and unit tests.
</objective>

<execution_context>
@/home/anthonysshit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-lab-analytics/30-01-SUMMARY.md

# Existing patterns from codebase (for reference, not to copy)
Private/Write-LabRunArtifacts.ps1 - Shows JSON file writing pattern
Private/Write-LabSTIGCompliance.ps1 - Shows ConvertTo-Json with Set-Content
Public/Get-LabRunHistory.ps1 - Shows data reading and filtering patterns
</context>

<tasks>

<task type="auto">
  <name>Create Export-LabAnalyticsData function</name>
  <files>Public/Export-LabAnalyticsData.ps1</files>
  <action>
Create Public/Export-LabAnalyticsData.ps1 with CSV and JSON export:

```powershell
function Export-LabAnalyticsData {
    <#
    .SYNOPSIS
        Exports lab analytics data to CSV or JSON file.

    .DESCRIPTION
        Export-LabAnalyticsData reads analytics events and exports them to a
        specified file in CSV or JSON format. Supports filtering by date range,
        event type, and lab name. CSV format exports flattened properties
        suitable for spreadsheet analysis. JSON format exports complete event
        objects with nested metadata.

    .PARAMETER OutputPath
        Path where export file will be written. Extension determines format:
        .csv for CSV, .json for JSON.

    .PARAMETER EventType
        Filter to events of this type only (optional).

    .PARAMETER LabName
        Filter to events for this lab only (optional).

    .PARAMETER After
        Only include events after this DateTime (optional).

    .PARAMETER Before
        Only include events before this DateTime (optional).

    .PARAMETER Force
        Overwrite existing file without prompting (default: prompt).

    .EXAMPLE
        Export-LabAnalyticsData -OutputPath 'analytics.csv'
        Exports all analytics events to CSV.

    .EXAMPLE
        Export-LabAnalyticsData -OutputPath 'feb-data.json' -After (Get-Date '2026-02-01') -Before (Get-Date '2026-03-01')
        Exports February 2026 events to JSON.

    .EXAMPLE
        Export-LabAnalyticsData -OutputPath 'deploys.csv' -EventType 'LabDeployed' -Force
        Exports only LabDeployed events to CSV, overwriting if exists.
    #>
    [CmdletBinding(SupportsShouldProcess)]
    [OutputType([string])]
    param(
        [Parameter(Mandatory)]
        [string]$OutputPath,

        [string]$EventType,

        [string]$LabName,

        [DateTime]$After,

        [DateTime]$Before,

        [switch]$Force
    )

    $getExtension = [System.IO.Path]::GetExtension($OutputPath)
    $format = switch ($getExtension) {
        '.csv'  { 'CSV' }
        '.json' { 'JSON' }
        default { throw "Output file must have .csv or .json extension" }
    }

    $getAnalyticsParams = @{}

    if ($PSBoundParameters.ContainsKey('EventType')) {
        $getAnalyticsParams.EventType = $EventType
    }
    if ($PSBoundParameters.ContainsKey('LabName')) {
        $getAnalyticsParams.LabName = $LabName
    }
    if ($PSBoundParameters.ContainsKey('After')) {
        $getAnalyticsParams.After = $After
    }
    if ($PSBoundParameters.ContainsKey('Before')) {
        $getAnalyticsParams.Before = $Before
    }

    $events = Get-LabAnalytics @getAnalyticsParams

    if ($events.Count -eq 0) {
        Write-Warning "No analytics events found matching the specified criteria"
        return $null
    }

    $shouldProcess = $Force -or $PSCmdlet.ShouldProcess(
        $OutputPath,
        "Export $($events.Count) analytics events to $format format"
    )

    if (-not $shouldProcess) {
        return $null
    }

    try {
        $parentDir = Split-Path -Parent $OutputPath
        if (-not [string]::IsNullOrWhiteSpace($parentDir) -and -not (Test-Path $parentDir)) {
            $null = New-Item -Path $parentDir -ItemType Directory -Force
            Write-Verbose "Created directory: $parentDir"
        }

        switch ($format) {
            'CSV' {
                $flatEvents = $events | ForEach-Object {
                    $metadataStr = if ($_.Metadata) {
                        ($_.Metadata.GetEnumerator() | ForEach-Object {
                            "$($_.Key)=$($_.Value)"
                        }) -join '; '
                    } else {
                        ''
                    }

                    [pscustomobject]@{
                        Timestamp   = $_.Timestamp
                        EventType   = $_.EventType
                        LabName     = $_.LabName
                        VMNames     = $_.VMNames -join ', '
                        Metadata    = $metadataStr
                        Host        = $_.Host
                        User        = $_.User
                    }
                }

                $flatEvents | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8
            }

            'JSON' {
                $events | ConvertTo-Json -Depth 8 | Set-Content -Path $OutputPath -Encoding UTF8
            }
        }

        $resolvedPath = (Resolve-Path $OutputPath).Path
        Write-Host "`n  Exported $($events.Count) events to: $resolvedPath" -ForegroundColor DarkGray
        return $resolvedPath
    }
    catch {
        $PSCmdlet.WriteError(
            [System.Management.Automation.ErrorRecord]::new(
                [System.Exception]::new("Export-LabAnalyticsData: failed to export to '$OutputPath' - $_", $_.Exception),
                'Export-LabAnalyticsData.Failure',
                [System.Management.Automation.ErrorCategory]::WriteError,
                $null
            )
        )
        return $null
    }
}
```

This function provides export functionality for both CSV and JSON formats. It uses the file extension to determine format (.csv or .json). For CSV export, it flattens the event structure to handle nested metadata as a semicolon-separated key=value string. For JSON export, it uses the native ConvertTo-Json with Depth 8 to preserve the full structure. The function supports all filtering parameters from Get-LabAnalytics and includes ShouldProcess support for safety (requires -Force or confirmation to overwrite). This follows the pattern of export functions in the codebase with proper error handling and user feedback.
  </action>
  <verify>Export-LabAnalyticsData -OutputPath 'test.csv' -Force creates CSV file with flattened event properties</verify>
  <done>Export-LabAnalyticsData function exists and exports to both CSV and JSON formats</done>
</task>

<task type="auto">
  <name>Create unit tests for export functionality</name>
  <files>Tests/LabAnalyticsExport.Tests.ps1</files>
  <action>
Create Tests/LabAnalyticsExport.Tests.ps1 with unit tests:

```powershell
Describe 'Export-LabAnalyticsData' {
    BeforeAll {
        $moduleRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
        Import-Module "$moduleRoot\SimpleLab\SimpleLab.psd1" -Force

        $testOutputPath = Join-Path $TestDrive 'analytics-export'
    }

    BeforeEach {
        if (Test-Path $testOutputPath) {
            Remove-Item $testOutputPath -Recurse -Force
        }
    }

    AfterEach {
        if (Test-Path $testOutputPath) {
            Remove-Item $testOutputPath -Recurse -Force
        }
    }

    Context 'CSV export' {
        It 'Exports analytics events to CSV format' {
            $csvPath = "$testOutputPath.csv"
            $result = Export-LabAnalyticsData -OutputPath $csvPath -Force

            $result | Should -BeOfType [string]
            Test-Path $csvPath | Should -BeTrue

            $content = Get-Content $csvPath
            $content[0] | Should -Match 'Timestamp'
        }

        It 'Flattens metadata as semicolon-separated key=value pairs' {
            $csvPath = "$testOutputPath.csv"
            Export-LabAnalyticsData -OutputPath $csvPath -Force

            $content = Get-Content $csvPath
            $content | Should -Match '\w+=.*;\s*\w+='
        }
    }

    Context 'JSON export' {
        It 'Exports analytics events to JSON format' {
            $jsonPath = "$testOutputPath.json"
            $result = Export-LabAnalyticsData -OutputPath $jsonPath -Force

            $result | Should -BeOfType [string]
            Test-Path $jsonPath | Should -BeTrue

            $content = Get-Content $jsonPath -Raw
            { $content | ConvertFrom-Json } | Should -Not -Throw
        }

        It 'Preserves nested metadata structure in JSON' {
            $jsonPath = "$testOutputPath.json"
            Export-LabAnalyticsData -OutputPath $jsonPath -Force

            $content = Get-Content $jsonPath -Raw
            $data = $content | ConvertFrom-Json

            if ($data.Count -gt 0 -and $data[0].Metadata) {
                $data[0].Metadata.PSObject.Properties.Count | Should -BeGreaterThan 0
            }
        }
    }

    Context 'File extension validation' {
        It 'Throws error for unsupported file extension' {
            $txtPath = "$testOutputPath.txt"

            { Export-LabAnalyticsData -OutputPath $txtPath -Force } |
                Should -Throw "*must have .csv or .json extension*"
        }
    }

    Context 'ShouldProcess support' {
        It 'Prompts before overwriting existing file without -Force' {
            $csvPath = "$testOutputPath.csv"
            $null = New-Item -Path $csvPath -ItemType File -Force

            Mock -CommandName ShouldProcess -MockWith { return $false }

            Export-LabAnalyticsData -OutputPath $csvPath -ErrorAction SilentlyContinue

            Should -Invoke ShouldProcess -Times 1 -Exactly
        }

        It 'Overwrites without prompt when -Force specified' {
            $csvPath = "$testOutputPath.csv"
            $null = New-Item -Path $csvPath -ItemType File -Force

            $result = Export-LabAnalyticsData -OutputPath $csvPath -Force

            $result | Should -BeOfType [string]
        }
    }
}
```

These tests verify the export functionality works correctly for both CSV and JSON formats. Tests cover CSV flattening, JSON structure preservation, file extension validation, and ShouldProcess behavior. The test pattern uses Pester 5 conventions with TestDrive for temporary file isolation. The BeforeEach/AfterEach blocks ensure test isolation. Tests verify both successful export paths and error conditions.
  </action>
  <verify>Invoke-Pester Tests/LabAnalyticsExport.Tests.ps1 -PassThru | Select-Object -ExpandProperty PassedCount is greater than 0</verify>
  <done>Unit tests exist and verify export functionality</done>
</task>

<task type="auto">
  <name>Add Export-LabAnalyticsData to module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Update both SimpleLab.psm1 and SimpleLab.psd1 to export Export-LabAnalyticsData.

In SimpleLab.psm1, add 'Export-LabAnalyticsData' to the Export-ModuleMember array.
In SimpleLab.psd1, add 'Export-LabAnalyticsData' to the FunctionsToExport array.

This follows the established pattern for public API functions and makes the export functionality available to operators.
  </action>
  <verify>Get-Command Export-LabAnalyticsData -Module SimpleLab returns command info</verify>
  <done>Export-LabAnalyticsData is exported from SimpleLab module</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1` succeeds
2. Test CSV export: Export-LabAnalyticsData -OutputPath 'test.csv' -Force creates CSV file
3. Test JSON export: Export-LabAnalyticsData -OutputPath 'test.json' -Force creates JSON file
4. Test filtering: Export with -EventType parameter filters events correctly
5. Test validation: Invalid file extension throws error
6. Run tests: Pester tests for export functionality pass
</verification>

<success_criteria>
1. Export-LabAnalyticsData exports to CSV format with flattened properties
2. Export-LabAnalyticsData exports to JSON format with nested structure
3. File extension determines export format (.csv or .json)
4. Filtering parameters (EventType, LabName, After, Before) work correctly
5. ShouldProcess support prevents accidental overwrites
6. Export-LabAnalyticsData is exported from SimpleLab module
</success_criteria>

<output>
After completion, create `.planning/phases/30-lab-analytics/30-03-SUMMARY.md` with:
- Actual files created with line counts
- Export format specifications (CSV columns, JSON schema)
- Test coverage summary
- Any deviations from plan
- Phase completion summary
</output>
