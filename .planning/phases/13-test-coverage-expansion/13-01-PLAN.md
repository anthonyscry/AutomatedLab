---
phase: 13-test-coverage-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/TestHelpers.ps1
  - Tests/VMLifecycle.Tests.ps1
  - Tests/Checkpoints.Tests.ps1
  - Tests/NetworkInfra.Tests.ps1
  - Tests/DomainSetup.Tests.ps1
  - Tests/LinuxPublic.Tests.ps1
  - Tests/LabStatus.Tests.ps1
autonomous: true
requirements: [TEST-01]

must_haves:
  truths:
    - "20+ previously untested Public functions have passing Pester tests"
    - "All tests run without Hyper-V by mocking Get-VM, Start-VM, Checkpoint-VM and related cmdlets"
    - "Shared mock patterns are reusable across test files via dot-sourced TestHelpers.ps1"
    - "Each test validates parameter handling, error paths, return types, and correct cmdlet invocations"
  artifacts:
    - path: "Tests/TestHelpers.ps1"
      provides: "Shared Hyper-V mock infrastructure"
      contains: "function New-MockVM"
    - path: "Tests/VMLifecycle.Tests.ps1"
      provides: "Tests for New-LabVM, Remove-LabVM, Remove-LabVMs, Start-LabVMs, Stop-LabVMs, Restart-LabVM, Restart-LabVMs, Suspend-LabVM, Suspend-LabVMs, Resume-LabVM, Initialize-LabVMs"
      min_lines: 100
    - path: "Tests/Checkpoints.Tests.ps1"
      provides: "Tests for Get-LabCheckpoint, Save-LabCheckpoint, Restore-LabCheckpoint, Save-LabReadyCheckpoint"
      min_lines: 60
    - path: "Tests/NetworkInfra.Tests.ps1"
      provides: "Tests for New-LabSwitch, Remove-LabSwitch, New-LabNAT, Initialize-LabNetwork, Test-LabNetwork, Test-LabNetworkHealth"
      min_lines: 80
    - path: "Tests/DomainSetup.Tests.ps1"
      provides: "Tests for Initialize-LabDNS, Initialize-LabDomain, Join-LabDomain, Test-LabDomainHealth"
      min_lines: 60
    - path: "Tests/LinuxPublic.Tests.ps1"
      provides: "Tests for New-LinuxVM, Wait-LinuxVMReady, New-LinuxGoldenVhdx, New-CidataVhdx, Get-LinuxVMIPv4, Get-LinuxSSHConnectionInfo, Invoke-BashOnLinuxVM, Join-LinuxToDomain, Add-LinuxDhcpReservation, Finalize-LinuxInstallMedia, Remove-HyperVVMStale, Get-Sha512PasswordHash"
      min_lines: 80
    - path: "Tests/LabStatus.Tests.ps1"
      provides: "Tests for Get-LabStatus, Show-LabStatus, Write-LabStatus, Write-RunArtifact, Wait-LabVMReady, Connect-LabVM, Reset-Lab, New-LabSSHKey, Test-HyperVEnabled, Test-LabIso"
      min_lines: 80
  key_links:
    - from: "Tests/VMLifecycle.Tests.ps1"
      to: "Public/New-LabVM.ps1"
      via: "BeforeAll dot-source"
      pattern: "\\. .+Public.+New-LabVM"
    - from: "Tests/TestHelpers.ps1"
      to: "Tests/*.Tests.ps1"
      via: "dot-source in BeforeAll"
      pattern: "\\. .+TestHelpers\\.ps1"
---

<objective>
Add unit tests for all ~47 previously untested Public functions grouped into 6 logical test files, plus a shared TestHelpers.ps1 with reusable Hyper-V mock infrastructure.

Purpose: Satisfy TEST-01 requirement (20+ previously untested Public functions have passing unit tests) and establish mock patterns for downstream E2E test plan.
Output: 7 new test files in Tests/ directory with all tests passing via `Invoke-Pester`.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-test-coverage-expansion/13-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared TestHelpers.ps1 with reusable Hyper-V mock infrastructure</name>
  <files>Tests/TestHelpers.ps1</files>
  <action>
Create `Tests/TestHelpers.ps1` as a dot-sourceable helper file providing shared mock patterns for all Public function test files.

Include these helper functions and patterns:

1. **`New-MockVM`** — Returns a `[PSCustomObject]` mimicking a Hyper-V VM object with properties: Name, State (default 'Running'), MemoryAssigned, MemoryStartup, ProcessorCount, Status, Uptime, Path, CheckpointFileLocation, ParentSnapshotId, ParentSnapshotName. Accept `-Name`, `-State` parameters.

2. **`New-MockVMSwitch`** — Returns a `[PSCustomObject]` with Name, SwitchType, NetAdapterInterfaceDescription, AllowManagementOS.

3. **`New-MockVMSnapshot`** — Returns a `[PSCustomObject]` with VMName, Name, CreationTime, ParentSnapshotName, SnapshotType.

4. **`New-MockNetNat`** — Returns a `[PSCustomObject]` with Name, InternalIPInterfaceAddressPrefix, Active.

5. **`Register-HyperVMocks`** — A function that calls `Mock` for common Hyper-V cmdlets that don't exist in CI: `Get-VM`, `Start-VM`, `Stop-VM`, `Restart-VM`, `Suspend-VM`, `Resume-VM`, `Remove-VM`, `New-VM`, `Set-VM`, `Set-VMMemory`, `Set-VMProcessor`, `Get-VMSwitch`, `New-VMSwitch`, `Remove-VMSwitch`, `Get-VMSnapshot`, `Checkpoint-VM`, `Restore-VMSnapshot`, `Remove-VMSnapshot`, `Get-VMNetworkAdapter`, `Set-VMNetworkAdapter`, `Add-VMNetworkAdapter`, `Connect-VMNetworkAdapter`, `Get-NetNat`, `New-NetNat`, `Remove-NetNat`, `Get-VMHardDiskDrive`, `Add-VMHardDiskDrive`, `Set-VMFirmware`, `Get-VMFirmware`, `Mount-VHD`, `Dismount-VHD`, `New-VHD`, `Get-VHD`, `Enable-VMIntegrationService`, `Invoke-Command`, `Test-Connection`, `Resolve-DnsName`. Default each to no-op or sensible return (e.g., `Get-VM` returns empty array, `Test-Connection` returns `$true`).

6. **`$script:RepoRoot`** variable set to `Split-Path -Parent $PSScriptRoot` for consistent path resolution.

Use standard PowerShell 5.1 patterns. No module dependencies beyond Pester 5.x. Each mock function should use `[CmdletBinding()]` with typed parameters.

**Important:** This file is dot-sourced in `BeforeAll` blocks, NOT a module. Functions defined here become available in the test scope. The `Register-HyperVMocks` function must be called inside a `BeforeEach` or `BeforeAll` block within a `Describe`/`Context` to properly register mocks.
  </action>
  <verify>
Dot-source the file in a PowerShell session and verify:
- `New-MockVM -Name 'test'` returns an object with `.Name -eq 'test'` and `.State -eq 'Running'`
- `New-MockVMSwitch -Name 'LabSwitch'` returns an object with `.Name -eq 'LabSwitch'`
- `$script:RepoRoot` resolves to the repository root
- No syntax errors on load
  </verify>
  <done>TestHelpers.ps1 exists in Tests/, loads without errors, all helper functions return expected mock objects</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for all ~47 untested Public functions across 6 test files</name>
  <files>
    Tests/VMLifecycle.Tests.ps1
    Tests/Checkpoints.Tests.ps1
    Tests/NetworkInfra.Tests.ps1
    Tests/DomainSetup.Tests.ps1
    Tests/LinuxPublic.Tests.ps1
    Tests/LabStatus.Tests.ps1
  </files>
  <action>
Create 6 test files covering ALL Public functions. Each file dot-sources `TestHelpers.ps1` and the relevant Public function files in `BeforeAll`. Each file calls `Register-HyperVMocks` in `BeforeEach` within each `Describe` block.

**Test file grouping and functions to test:**

**VMLifecycle.Tests.ps1** (11 functions):
- `New-LabVM` — test parameter validation (VMName required), mock New-VM/Set-VM/Set-VMMemory/Set-VMProcessor, verify calls
- `Remove-LabVM` — test VM removal with mock, verify Remove-VM called
- `Remove-LabVMs` — test bulk removal, verify iterates correctly
- `Start-LabVMs` — test starting multiple VMs, verify Start-VM called per VM
- `Stop-LabVMs` — test stopping, verify Stop-VM called
- `Restart-LabVM` — single VM restart
- `Restart-LabVMs` — bulk restart
- `Suspend-LabVM` — single VM suspend
- `Suspend-LabVMs` — bulk suspend
- `Resume-LabVM` — single VM resume
- `Initialize-LabVMs` — test VM initialization flow with mocked Hyper-V

**Checkpoints.Tests.ps1** (4 functions):
- `Get-LabCheckpoint` — test returns snapshot list from mock
- `Save-LabCheckpoint` — test creates checkpoint via mock Checkpoint-VM
- `Restore-LabCheckpoint` — test restores via mock Restore-VMSnapshot
- `Save-LabReadyCheckpoint` — test creates LabReady-named checkpoint

**NetworkInfra.Tests.ps1** (6 functions):
- `New-LabSwitch` — test switch creation, verify New-VMSwitch called
- `Remove-LabSwitch` — test switch removal
- `New-LabNAT` — test NAT creation with IP validation
- `Initialize-LabNetwork` — test full network setup orchestration
- `Test-LabNetwork` — test network validation returns status object
- `Test-LabNetworkHealth` — test health check returns structured result

**DomainSetup.Tests.ps1** (4 functions):
- `Initialize-LabDNS` — test DNS configuration with mocked Resolve-DnsName
- `Initialize-LabDomain` — test domain setup orchestration
- `Join-LabDomain` — test domain join with mocked Invoke-Command
- `Test-LabDomainHealth` — test domain health returns boolean/object

**LinuxPublic.Tests.ps1** (12 functions):
- `New-LinuxVM` — test Linux VM creation with mocked New-VM
- `Wait-LinuxVMReady` — test wait loop with mocked Test-Connection
- `New-LinuxGoldenVhdx` — test golden image creation
- `New-CidataVhdx` — test cloud-init data VHDX creation
- `Get-LinuxVMIPv4` — test IP retrieval from mock VM network adapter
- `Get-LinuxSSHConnectionInfo` — test SSH connection info construction
- `Invoke-BashOnLinuxVM` — test bash command execution via mock SSH
- `Join-LinuxToDomain` — test Linux domain join
- `Add-LinuxDhcpReservation` — test DHCP reservation with mock
- `Finalize-LinuxInstallMedia` — test media finalization
- `Remove-HyperVVMStale` — test stale VM cleanup
- `Get-Sha512PasswordHash` — test password hash generation (pure function, may not need mocks)

**LabStatus.Tests.ps1** (10 functions):
- `Get-LabStatus` — test status retrieval with mocked Get-VM
- `Show-LabStatus` — test display output (mock Write-Host or verify no throw)
- `Write-LabStatus` — test status writing
- `Write-RunArtifact` — test artifact file creation (use TestDrive:)
- `Wait-LabVMReady` — test wait polling with mock
- `Connect-LabVM` — test connection setup
- `Reset-Lab` — test lab reset orchestration
- `New-LabSSHKey` — test SSH key generation with mocked ssh-keygen
- `Test-HyperVEnabled` — test Hyper-V detection
- `Test-LabIso` — test ISO validation

**Per-function test pattern:**
1. Read the actual source file first to understand parameters, error handling, and return types
2. `Describe 'FunctionName'` block
3. `BeforeEach` calls `Register-HyperVMocks` plus any function-specific mock overrides
4. At minimum test: (a) happy path with valid inputs, (b) error/throw on missing required params, (c) correct mock cmdlet invocations via `Should -Invoke`
5. Use `$script:` scope for `BeforeAll` variables per Pester 5.x pattern
6. Use `Set-ItResult -Skipped -Because 'reason'` for functions that truly cannot be tested without Hyper-V runtime

**Important conventions:**
- PowerShell 5.1 compatible (nested `Join-Path` for 3+ segments)
- `Set-StrictMode -Version Latest` is NOT set in test files (Pester handles it)
- Use `$script:repoRoot = Split-Path -Parent $PSScriptRoot` in `BeforeAll`
- Mock external commands, NOT the function under test
- Prefer `Should -Invoke -CommandName X -Times 1 -Exactly` for verifying behavior
  </action>
  <verify>
Run each test file individually to verify all tests pass:
```powershell
Invoke-Pester -Path Tests/VMLifecycle.Tests.ps1 -Output Detailed
Invoke-Pester -Path Tests/Checkpoints.Tests.ps1 -Output Detailed
Invoke-Pester -Path Tests/NetworkInfra.Tests.ps1 -Output Detailed
Invoke-Pester -Path Tests/DomainSetup.Tests.ps1 -Output Detailed
Invoke-Pester -Path Tests/LinuxPublic.Tests.ps1 -Output Detailed
Invoke-Pester -Path Tests/LabStatus.Tests.ps1 -Output Detailed
```

Then run full suite: `Invoke-Pester -Path Tests/ -Output Detailed` — all existing + new tests pass with zero failures.
  </verify>
  <done>6 test files exist covering 47 Public functions. All tests pass. No existing tests broken. 20+ previously untested functions now have passing tests.</done>
</task>

</tasks>

<verification>
- [ ] TestHelpers.ps1 exists and loads without errors
- [ ] 6 new test files exist in Tests/ directory
- [ ] All 47 Public functions have at least one Describe block
- [ ] Each test mocks Hyper-V cmdlets (no real Hyper-V needed)
- [ ] Full Pester suite passes: `Invoke-Pester -Path Tests/ -Output Detailed`
- [ ] No existing tests broken by new files
- [ ] 20+ previously untested functions confirmed with passing tests
</verification>

<success_criteria>
- 47 Public functions have unit tests across 6 organized test files
- Shared TestHelpers.ps1 provides reusable mock infrastructure
- All tests pass in CI-like environment (no Hyper-V)
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-coverage-expansion/13-01-SUMMARY.md`
</output>
