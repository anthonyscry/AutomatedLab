---
phase: 13-test-coverage-expansion
plan: 03
type: execute
wave: 3
depends_on: [13-01, 13-02]
files_modified:
  - Tests/E2ESmoke.Tests.ps1
  - Tests/E2EMocks.ps1
autonomous: true
requirements: [TEST-03]

must_haves:
  truths:
    - "E2E smoke test exercises bootstrap/deploy/teardown path through OpenCodeLab-App.ps1"
    - "Test runs in CI without Hyper-V via pure PowerShell mocking"
    - "Test verifies exit codes, run artifacts, and expected log messages"
    - "Test completes under 60 seconds wall-clock"
    - "Assertions map back to lifecycle requirements (LIFE-01 through LIFE-05)"
  artifacts:
    - path: "Tests/E2ESmoke.Tests.ps1"
      provides: "End-to-end smoke test for lifecycle path"
      contains: "Describe 'E2E Smoke'"
      min_lines: 100
    - path: "Tests/E2EMocks.ps1"
      provides: "Comprehensive mock layer for orchestrator E2E testing"
      contains: "function Register-E2EMocks"
      min_lines: 50
  key_links:
    - from: "Tests/E2ESmoke.Tests.ps1"
      to: "OpenCodeLab-App.ps1"
      via: "dot-source or invocation of orchestrator entry point"
      pattern: "OpenCodeLab-App"
    - from: "Tests/E2EMocks.ps1"
      to: "Tests/TestHelpers.ps1"
      via: "extends shared mock infrastructure"
      pattern: "TestHelpers\\.ps1"
    - from: "Tests/E2ESmoke.Tests.ps1"
      to: "Tests/E2EMocks.ps1"
      via: "dot-source in BeforeAll"
      pattern: "E2EMocks\\.ps1"
---

<objective>
Create an E2E smoke test that exercises the full bootstrap/deploy/teardown lifecycle path through OpenCodeLab-App.ps1 in simulation mode, verifying exit codes, run artifacts, and state transitions without requiring Hyper-V.

Purpose: Satisfy TEST-03 requirement (E2E smoke test validates bootstrap/deploy/teardown outcome with stable exit conditions). Maps assertions to lifecycle requirements LIFE-01 through LIFE-05.
Output: E2E smoke test and dedicated mock layer in Tests/ directory.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-test-coverage-expansion/13-CONTEXT.md
@.planning/phases/13-test-coverage-expansion/13-01-SUMMARY.md
@.planning/phases/13-test-coverage-expansion/13-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2EMocks.ps1 with comprehensive orchestrator mock layer</name>
  <files>Tests/E2EMocks.ps1</files>
  <action>
Create `Tests/E2EMocks.ps1` extending the shared TestHelpers.ps1 mock infrastructure with orchestrator-level mocks needed for E2E testing.

1. **Dot-source TestHelpers.ps1** at the top for base mock patterns.

2. **`Register-E2EMocks` function** that registers all mocks needed to run OpenCodeLab-App.ps1 actions without real infrastructure:

   **Hyper-V layer** (extend from TestHelpers):
   - `Get-VM` returns mock VMs matching `$GlobalLabConfig.CoreVMNames` (dc1, svr1, ws1) in Running state
   - `Get-VMSwitch` returns mock switch matching lab config name
   - `Get-VMSnapshot` returns mock LabReady snapshots
   - `New-VM`, `Set-VM`, `Start-VM`, `Stop-VM`, `Remove-VM` — track calls via `$script:` counters

   **Network layer:**
   - `Get-NetNat` returns mock NAT matching config
   - `Test-Connection` returns `$true`
   - `Resolve-DnsName` returns mock DNS result

   **SSH/Remote layer:**
   - `Invoke-Command` returns success results
   - Mock `ssh`, `ssh-keygen` commands

   **File system layer:**
   - Mock `Test-Path` selectively for ISO/VHD paths to return `$true`
   - DO NOT globally mock Test-Path — only for specific paths that represent lab infrastructure

   **Config layer:**
   - Provide a `$script:TestLabConfig` hashtable matching `$GlobalLabConfig` structure with test values (lab name, VM names, paths, network settings)
   - Include `Set-Variable -Name GlobalLabConfig -Value $script:TestLabConfig -Scope Script` in setup

3. **`New-E2ERunLogDir` function** that creates a temp directory (using `TestDrive:` or `$env:TEMP`) for run artifacts and returns the path.

4. **Call tracking** — Use `$script:E2ECalls` hashtable to track which major operations were invoked (bootstrap, deploy, teardown). Each mock increments its counter.

**Important:** This mock layer must be comprehensive enough that OpenCodeLab-App.ps1 can be dot-sourced and its action routing invoked without any real Hyper-V or network operations. Focus on preventing runtime errors, not on simulating perfect behavior.
  </action>
  <verify>
Dot-source the file and verify:
- `Register-E2EMocks` function exists and is callable
- `$script:TestLabConfig` has the expected structure (Keys: Name, CoreVMNames, Paths, Network, Credentials)
- `New-E2ERunLogDir` creates and returns a valid temp path
  </verify>
  <done>E2EMocks.ps1 provides comprehensive mock layer for orchestrator E2E testing. All orchestrator-level dependencies are intercepted.</done>
</task>

<task type="auto">
  <name>Task 2: Create E2ESmoke.Tests.ps1 exercising bootstrap/deploy/teardown lifecycle</name>
  <files>Tests/E2ESmoke.Tests.ps1</files>
  <action>
Create `Tests/E2ESmoke.Tests.ps1` — the E2E smoke test that exercises the full lifecycle path.

**Structure:**

```
BeforeAll {
    $script:repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $PSScriptRoot 'E2EMocks.ps1')
    # Source orchestration helpers used by OpenCodeLab-App.ps1
    # Read OpenCodeLab-App.ps1 to find $OrchestrationHelperPaths and source the same set
}
```

**Test approach:** Rather than invoking `OpenCodeLab-App.ps1` as a full script (which sets StrictMode, has param blocks, etc.), source the orchestration helper functions and test the action routing through the extracted Private functions. This avoids script-level param/exit complications while still exercising the real orchestration code path.

**Describe blocks mapping to lifecycle requirements:**

1. **`Describe 'E2E: Bootstrap Action (LIFE-01)'`**
   - Set up E2E mocks via `Register-E2EMocks`
   - Invoke the bootstrap action path (call the bootstrap-related Private functions in sequence)
   - Assert: no terminating errors thrown
   - Assert: prerequisite validation functions were called (via `Should -Invoke` or `$script:E2ECalls`)
   - Assert: environment setup functions executed

2. **`Describe 'E2E: Deploy Action (LIFE-02)'`**
   - Register E2E mocks
   - Invoke the deploy action path (full mode)
   - Assert: VM creation functions called for each VM in config
   - Assert: network setup functions called
   - Assert: no terminating errors
   - Assert: run artifacts directory is created (if applicable)

3. **`Describe 'E2E: Quick Mode (LIFE-03)'`**
   - Register E2E mocks with LabReady snapshots available
   - Invoke quick mode path
   - Assert: snapshot restore attempted (not full deploy)
   - Assert: auto-heal logic invoked when infrastructure gaps detected

4. **`Describe 'E2E: Teardown Action (LIFE-04)'`**
   - Register E2E mocks with existing VMs
   - Invoke teardown action path
   - Assert: VM removal functions called
   - Assert: switch/NAT cleanup attempted
   - Assert: no orphan resources (all cleanup functions called)

5. **`Describe 'E2E: Idempotent Redeploy (LIFE-05)'`**
   - Run teardown then deploy in sequence
   - Assert: second deploy succeeds without errors from leftover state

6. **`Describe 'E2E: Exit Code Contract'`**
   - Test that action functions return expected status objects
   - Verify success returns have `.Success -eq $true` or equivalent
   - Verify error conditions produce structured error results (not raw exceptions)

7. **`Describe 'E2E: Timing'`**
   - Measure total execution time of all E2E describe blocks
   - Assert: total < 60 seconds (CONTEXT.md requirement)

**Traceability comments:** Each Describe block includes a comment referencing the requirement ID it validates (e.g., `# Validates: LIFE-01 — Bootstrap installs prerequisites and validates environment`).

**Important considerations:**
- Use `$ErrorActionPreference = 'Stop'` in BeforeAll to catch silent failures
- Clean up temp directories in AfterAll
- If a function cannot be tested without deep orchestrator coupling, mark the It block as `-Skip` with reason and add a comment explaining what would need to change
- Keep wall-clock under 60 seconds total — these are mock-backed, so they should be fast
- PowerShell 5.1 compatible (nested Join-Path)
  </action>
  <verify>
Run the E2E smoke test:
```powershell
$stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
Invoke-Pester -Path Tests/E2ESmoke.Tests.ps1 -Output Detailed
$stopwatch.Stop()
Write-Host "E2E duration: $($stopwatch.Elapsed.TotalSeconds)s"
```

Verify:
- All non-skipped tests pass
- Total execution under 60 seconds
- Each lifecycle stage (bootstrap, deploy, quick, teardown, redeploy) has at least one passing assertion
- Full suite still passes: `Invoke-Pester -Path Tests/ -Output Detailed`
  </verify>
  <done>E2E smoke test exercises bootstrap/deploy/teardown lifecycle path. All non-skipped tests pass under 60 seconds. Assertions map to LIFE-01 through LIFE-05. No existing tests broken.</done>
</task>

</tasks>

<verification>
- [ ] E2EMocks.ps1 exists with Register-E2EMocks function
- [ ] E2ESmoke.Tests.ps1 exists with Describe blocks for each lifecycle stage
- [ ] Each Describe block maps to a lifecycle requirement (LIFE-01 through LIFE-05)
- [ ] All non-skipped tests pass
- [ ] Total E2E execution under 60 seconds
- [ ] Tests run without Hyper-V (CI compatible)
- [ ] Full Pester suite passes: `Invoke-Pester -Path Tests/ -Output Detailed`
- [ ] No existing tests broken
</verification>

<success_criteria>
- E2E smoke test validates bootstrap/deploy/teardown lifecycle in simulation mode
- Assertions trace back to LIFE-01 through LIFE-05 requirements
- Test runs in CI without Hyper-V
- Wall-clock under 60 seconds
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-coverage-expansion/13-03-SUMMARY.md`
</output>
