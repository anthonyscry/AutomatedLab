---
phase: 13-test-coverage-expansion
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - .github/workflows/pr-tests.yml
  - Tests/Run.Tests.ps1
autonomous: true
requirements: [TEST-02]

must_haves:
  truths:
    - "Coverage report is uploaded as a PR artifact alongside test results"
    - "PR check fails if code coverage drops below the defined threshold"
    - "Coverage summary is visible in the PR checks UI"
    - "Threshold starts at 15% and can be raised incrementally"
  artifacts:
    - path: ".github/workflows/pr-tests.yml"
      provides: "Coverage artifact upload and threshold enforcement"
      contains: "coverage.xml"
    - path: "Tests/Run.Tests.ps1"
      provides: "JaCoCo coverage output with configurable threshold"
      contains: "CoveragePercentTarget"
  key_links:
    - from: ".github/workflows/pr-tests.yml"
      to: "Tests/Run.Tests.ps1"
      via: "workflow step invocation"
      pattern: "Run\\.Tests\\.ps1"
    - from: ".github/workflows/pr-tests.yml"
      to: "Tests/coverage.xml"
      via: "artifact upload"
      pattern: "upload-artifact.*coverage"
---

<objective>
Add coverage reporting as a PR artifact and enforce a coverage threshold in CI so PRs that drop coverage below the minimum are blocked.

Purpose: Satisfy TEST-02 requirement (coverage reporting runs in CI and enforces a defined threshold). Builds on the PR test workflow from Phase 12 and the new tests from 13-01.
Output: Updated pr-tests.yml with coverage artifact upload and summary, updated Run.Tests.ps1 with threshold enforcement exit code.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-test-coverage-expansion/13-CONTEXT.md
@.planning/phases/13-test-coverage-expansion/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Run.Tests.ps1 to enforce coverage threshold and expose coverage results</name>
  <files>Tests/Run.Tests.ps1</files>
  <action>
Update `Tests/Run.Tests.ps1` to properly enforce the coverage threshold and report results:

1. **Add `-CoverageThreshold` parameter** with default value `15` (current baseline). This makes it easy to raise the threshold later without editing the script.

2. **After `Invoke-Pester` returns**, check `$result.CodeCoverage.CoveragePercent` against the threshold. If coverage is below threshold, write a clear error message:
   ```
   Write-Host "COVERAGE FAILED: $coveragePercent% is below threshold of $CoverageThreshold%" -ForegroundColor Red
   ```

3. **Exit code logic**: Exit with `$result.FailedCount` if tests fail. If tests pass but coverage is below threshold, exit with `1`. If both pass, exit with `0`. This ensures CI fails on either test failures OR coverage regression.

4. **Write a coverage summary to stdout** that GitHub Actions can capture:
   ```
   Write-Host "Coverage: $coveragePercent% (threshold: $CoverageThreshold%)" -ForegroundColor $(if ($coveragePercent -ge $CoverageThreshold) { 'Green' } else { 'Red' })
   ```

5. **Keep the existing JaCoCo output** at `Tests/coverage.xml` (already configured).

6. **Keep `CoveragePercentTarget` in the Pester config** at 15 as the Pester-internal threshold (informational), but use the script-level check for the actual exit code enforcement — Pester's built-in threshold only writes a warning, it does not fail the run.

**Do NOT change:** Test discovery, output paths, CI format detection, or Pester configuration beyond the coverage threshold handling.
  </action>
  <verify>
Run `Tests/Run.Tests.ps1 -Verbosity Normal` locally and verify:
- Coverage percentage is printed to stdout
- Script exits with 0 if tests pass and coverage meets threshold
- `Tests/coverage.xml` is produced
  </verify>
  <done>Run.Tests.ps1 enforces coverage threshold via exit code, prints coverage summary, and accepts configurable -CoverageThreshold parameter</done>
</task>

<task type="auto">
  <name>Task 2: Update pr-tests.yml to upload coverage artifact and post coverage summary</name>
  <files>.github/workflows/pr-tests.yml</files>
  <action>
Update `.github/workflows/pr-tests.yml` to add coverage reporting steps:

1. **Upload coverage.xml as a PR artifact** — Add a new step after the test run:
   ```yaml
   - name: Upload coverage report
     if: always()
     uses: actions/upload-artifact@v4
     with:
       name: coverage-report
       path: Tests/coverage.xml
   ```

2. **Add a coverage summary step** that reads the Pester output and writes to `$GITHUB_STEP_SUMMARY`:
   ```yaml
   - name: Coverage summary
     if: always()
     shell: pwsh
     run: |
       if (Test-Path Tests/coverage.xml) {
         [xml]$coverage = Get-Content Tests/coverage.xml
         $counters = $coverage.report.counter | Where-Object { $_.type -eq 'LINE' }
         if ($counters) {
           $missed = [int]$counters.missed
           $covered = [int]$counters.covered
           $total = $missed + $covered
           $pct = if ($total -gt 0) { [math]::Round(($covered / $total) * 100, 1) } else { 0 }
           $icon = if ($pct -ge 15) { ':white_check_mark:' } else { ':x:' }
           "## $icon Code Coverage: ${pct}%" | Out-File -Append $env:GITHUB_STEP_SUMMARY
           "| Metric | Value |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
           "|--------|-------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY
           "| Lines covered | $covered / $total |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
           "| Coverage | ${pct}% |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
           "| Threshold | 15% |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
         }
       }
   ```

3. **Keep existing steps unchanged**: checkout, install Pester, run tests, upload test results, publish test summary.

4. **Ordering of new steps**: Place coverage upload and summary AFTER test results upload but BEFORE the test-reporter step (both use `if: always()`).

**Important:** The test run step already fails if coverage is below threshold (handled by Run.Tests.ps1 exit code from Task 1). The coverage summary step is informational — it provides visibility, not enforcement.
  </action>
  <verify>
Validate the YAML is syntactically correct:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/pr-tests.yml'))"
```

Verify the workflow file contains: coverage.xml artifact upload step, GITHUB_STEP_SUMMARY coverage table, and all original steps still present.
  </verify>
  <done>pr-tests.yml uploads coverage.xml as artifact and posts coverage summary table to PR checks. Coverage threshold enforcement happens via Run.Tests.ps1 exit code.</done>
</task>

</tasks>

<verification>
- [ ] Run.Tests.ps1 has -CoverageThreshold parameter defaulting to 15
- [ ] Run.Tests.ps1 exit code reflects coverage threshold enforcement
- [ ] pr-tests.yml uploads coverage.xml as artifact
- [ ] pr-tests.yml writes coverage summary to GITHUB_STEP_SUMMARY
- [ ] All existing workflow steps preserved
- [ ] YAML syntax is valid
- [ ] Full test suite still passes: `Invoke-Pester -Path Tests/ -Output Detailed`
</verification>

<success_criteria>
- Coverage report produced and uploaded as CI artifact
- PR checks show coverage summary with percentage and threshold
- CI fails if coverage drops below 15% threshold
- Threshold is configurable for incremental raises
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-coverage-expansion/13-02-SUMMARY.md`
</output>
