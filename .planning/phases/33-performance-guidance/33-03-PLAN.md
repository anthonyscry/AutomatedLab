---
phase: 33-performance-guidance
plan: 03
type: execute
wave: 3
depends_on: ["33-01", "33-02"]
files_modified:
  - Private/Get-LabPerformanceInsights.ps1
  - Private/Get-LabPerformanceBaseline.ps1
  - Public/Get-LabPerformanceRecommendation.ps1
  - Tests/LabPerformanceInsights.Tests.ps1
autonomous: true
requirements:
  - PERF-02

must_haves:
  truths:
    - "System provides optimization suggestions when performance degrades"
    - "Comparisons against historical baselines detect anomalies"
    - "Recommendations include specific actionable guidance"
    - "Insights cover slow operations, resource patterns, and trends"
    - "Baseline calculation uses configurable sample size and threshold"
  artifacts:
    - path: "Private/Get-LabPerformanceInsights.ps1"
      provides: "Performance analysis and anomaly detection"
      min_lines: 120
    - path: "Private/Get-LabPerformanceBaseline.ps1"
      provides: "Historical baseline calculation"
      min_lines: 80
    - path: "Public/Get-LabPerformanceRecommendation.ps1"
      provides: "Public API for optimization suggestions"
      exports: ["Get-LabPerformanceRecommendation"]
      min_lines: 70
    - path: "Tests/LabPerformanceInsights.Tests.ps1"
      provides: "Unit tests for insights and recommendations"
      min_lines: 100
  key_links:
    - from: "Get-LabPerformanceRecommendation.ps1"
      to: "Get-LabPerformanceInsights.ps1"
      via: "Calls insights analyzer for recommendations"
      pattern: "Get-LabPerformanceInsights"
    - from: "Get-LabPerformanceInsights.ps1"
      to: "Get-LabPerformanceBaseline.ps1"
      via: "Calculates baselines for comparison"
      pattern: "Get-LabPerformanceBaseline"
    - from: "Get-LabPerformanceInsights.ps1"
      to: "Get-LabPerformanceMetricsCore.ps1"
      via: "Queries metrics for analysis"
      pattern: "Get-LabPerformanceMetricsCore"
---

<objective>
Create performance optimization guidance system that analyzes VM operation metrics, detects performance degradation against historical baselines, and provides actionable recommendations for improving lab performance.

Purpose: Help operators identify and resolve performance issues by automatically detecting anomalies, comparing current performance against historical baselines, and suggesting specific optimizations for slow operations or patterns indicating resource constraints.

Output: Performance insights analyzer with anomaly detection, baseline calculation function, public recommendation API, and unit tests covering insight generation and recommendation scenarios.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-performance-guidance/33-01-PLAN.md
@.planning/phases/33-performance-guidance/33-02-PLAN.md

# Existing patterns from codebase (for reference, not to copy)
Private/Invoke-LabQuickModeHeal.ps1 - Shows diagnostic suggestion pattern
Private/Test-LabDomainHealth.ps1 - Shows health check recommendations
Public/Test-LabNetworkHealth.ps1 - Shows network diagnostic suggestions
Private/Get-LabPerformanceMetricsCore.ps1 - Shows metrics aggregation for baseline
</context>

<tasks>

<task type="auto">
  <name>Create Get-LabPerformanceBaseline baseline calculation function</name>
  <files>Private/Get-LabPerformanceBaseline.ps1</files>
  <action>
Create Private/Get-LabPerformanceBaseline.ps1 with baseline calculation logic:

```powershell
function Get-LabPerformanceBaseline {
    <#
    .SYNOPSIS
        Calculates historical performance baselines from metrics.

    .DESCRIPTION
        Get-LabPerformanceBaseline analyzes historical performance metrics to
        establish baseline values for different operation types. Baselines include
        average, median, and threshold values used for anomaly detection.

    .PARAMETER Metrics
        Array of performance metrics to analyze.

    .PARAMETER MinSamples
        Minimum number of samples required to establish baseline (default: 5).

    .PARAMETER ThresholdMultiplier
        Multiplier for standard deviation to determine anomaly threshold (default: 2.5).

    .OUTPUTS
        [pscustomobject] with operation type baselines including Average, Median,
        StdDev, UpperThreshold, and SampleCount.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [Parameter(Mandatory)]
        [pscustomobject[]]$Metrics,

        [int]$MinSamples = 5,

        [double]$ThresholdMultiplier = 2.5
    )

    # Group by operation type
    $grouped = @{}

    foreach ($metric in $Metrics) {
        $success = if ($metric.Metadata -and $null -ne $metric.Metadata.Success) { $metric.Metadata.Success } else { $true }

        if (-not $success) {
            continue
        }

        $op = $metric.Operation

        if (-not $grouped.ContainsKey($op)) {
            $grouped[$op] = [System.Collections.Generic.List[double]]::new()
        }

        $grouped[$op].Add($metric.DurationSec)
    }

    $results = [System.Collections.Generic.List[pscustomobject]]::new()

    foreach ($op in $grouped.Keys) {
        $values = $grouped[$op]

        if ($values.Count -lt $MinSamples) {
            Write-Verbose "Get-LabPerformanceBaseline: Skipping $op - insufficient samples ($($values.Count) < $MinSamples)"
            continue
        }

        $avg = ($values | Measure-Object -Average).Average
        $sorted = $values | Sort-Object
        $median = $sorted[[math]::Floor($sorted.Count / 2)]

        # Calculate standard deviation
        $varianceSum = 0
        foreach ($v in $values) {
            $varianceSum += [math]::Pow($v - $avg, 2)
        }
        $stdDev = [math]::Sqrt($varianceSum / $values.Count)

        # Threshold for anomaly detection (mean + N * stddev)
        $upperThreshold = $avg + ($ThresholdMultiplier * $stdDev)

        $baseline = [pscustomobject]@{
            Operation         = $op
            AverageDuration   = [math]::Round($avg, 3)
            MedianDuration    = [math]::Round($median, 3)
            StdDev            = [math]::Round($stdDev, 3)
            UpperThreshold    = [math]::Round($upperThreshold, 3)
            SampleCount       = $values.Count
            MinSamplesMet     = $true
        }

        $results.Add($baseline)
    }

    return @($results)
}
```

This function calculates statistical baselines for each operation type from historical metrics. It uses mean and standard deviation to establish an upper threshold for anomaly detection. The threshold multiplier (default 2.5 sigma) determines how many standard deviations above the mean constitutes an anomaly. Operations with insufficient samples are skipped to ensure reliable baselines.
  </action>
  <verify>Get-LabPerformanceBaseline -Metrics $testMetrics returns baseline objects with AverageDuration, MedianDuration, StdDev, UpperThreshold</verify>
  <done>Get-LabPerformanceBaseline function exists and calculates baselines from metrics</done>
</task>

<task type="auto">
  <name>Create Get-LabPerformanceInsights analysis function</name>
  <files>Private/Get-LabPerformanceInsights.ps1</files>
  <action>
Create Private/Get-LabPerformanceInsights.ps1 with analysis logic:

```powershell
function Get-LabPerformanceInsights {
    <#
    .SYNOPSIS
        Analyzes performance metrics for anomalies and optimization opportunities.

    .DESCRIPTION
        Get-LabPerformanceInsights examines performance metrics to detect
        anomalies against baselines, identify slow operations, and suggest
        optimization opportunities. Returns insights with severity levels and
        actionable recommendations.

    .PARAMETER Metrics
        Array of performance metrics to analyze.

    .PARAMETER Baseline
        Pre-calculated baseline (optional, calculates if not provided).

    .PARAMETER RecentHours
        Only consider metrics from the last N hours for recent anomalies (default: 24).

    .OUTPUTS
        [pscustomobject[]] with insights including Type, Severity, Message,
        Recommendation, and AffectedVMs.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [Parameter(Mandatory)]
        [pscustomobject[]]$Metrics,

        [pscustomobject[]]$Baseline,

        [int]$RecentHours = 24
    )

    $insights = [System.Collections.Generic.List[pscustomobject]]::new()

    # Calculate baseline if not provided
    if (-not $Baseline) {
        $Baseline = Get-LabPerformanceBaseline -Metrics $Metrics -MinSamples 5
    }

    # Create baseline lookup
    $baselineLookup = @{}
    foreach ($bl in $Baseline) {
        $baselineLookup[$bl.Operation] = $bl
    }

    # Filter for recent metrics
    $cutoffTime = (Get-Date).AddHours(-$RecentHours)
    $recentMetrics = @($Metrics | Where-Object {
        try {
            $metricTime = [DateTime]::Parse($_.StartTime)
            $metricTime -ge $cutoffTime
        }
        catch { $false }
    })

    # Detect anomalies (operations exceeding baseline threshold)
    foreach ($metric in $recentMetrics) {
        $success = if ($metric.Metadata -and $null -ne $metric.Metadata.Success) { $metric.Metadata.Success } else { $true }

        if (-not $success) {
            continue
        }

        if ($baselineLookup.ContainsKey($metric.Operation)) {
            $bl = $baselineLookup[$metric.Operation]

            if ($metric.DurationSec -gt $bl.UpperThreshold) {
                $severity = switch ($metric.DurationSec) {
                    { $_ -gt $bl.UpperThreshold * 2 } { 'Critical' }
                    { $_ -gt $bl.UpperThreshold * 1.5 } { 'High' }
                    default { 'Medium' }
                }

                $recommendation = Get-PerformanceRecommendation -Operation $metric.Operation -Duration $metric.DurationSec -Baseline $bl

                $insight = [pscustomobject]@{
                    Type            = 'Anomaly'
                    Severity        = $severity
                    Operation       = $metric.Operation
                    VMName          = $metric.VMName
                    Duration        = $metric.DurationSec
                    BaselineAvg     = $bl.AverageDuration
                    Threshold       = $bl.UpperThreshold
                    Message         = "$($metric.Operation) on $($metric.VMName) took $([math]::Round($metric.DurationSec, 2))s, exceeding baseline threshold of $([math]::Round($bl.UpperThreshold, 2))s"
                    Recommendation  = $recommendation
                    Timestamp       = try { [DateTime]::Parse($metric.StartTime) } catch { $null }
                }

                $insights.Add($insight)
            }
        }
    }

    # Detect consistently slow operations (high failure rate or consistently above average)
    $operationGroups = @{}
    foreach ($metric in $recentMetrics) {
        $op = $metric.Operation
        if (-not $operationGroups.ContainsKey($op)) {
            $operationGroups[$op] = @{
                Count    = 0
                Failures = 0
                TotalDur = 0.0
                VMs      = @{}
            }
        }

        $operationGroups[$op].Count++
        $operationGroups[$op].TotalDur += $metric.DurationSec

        $success = if ($metric.Metadata -and $null -ne $metric.Metadata.Success) { $metric.Metadata.Success } else { $true }
        if (-not $success) {
            $operationGroups[$op].Failures++
        }

        if (-not $operationGroups[$op].VMs.ContainsKey($metric.VMName)) {
            $operationGroups[$op].VMs[$metric.VMName] = 0
        }
        $operationGroups[$op].VMs[$metric.VMName]++
    }

    # Generate insights for problematic patterns
    foreach ($op in $operationGroups.Keys) {
        $group = $operationGroups[$op]

        # High failure rate
        if ($group.Count -ge 3 -and $group.Failures -gt 0) {
            $failureRate = $group.Failures / $group.Count

            if ($failureRate -gt 0.3) {
                $insight = [pscustomobject]@{
                    Type           = 'HighFailureRate'
                    Severity       = if ($failureRate -gt 0.5) { 'Critical' } else { 'High' }
                    Operation      = $op
                    FailureRate    = [math]::Round($failureRate * 100, 1)
                    AffectedVMs    = @($group.VMs.Keys)
                    Message        = "$op has a $([math]::Round($failureRate * 100, 1))% failure rate ($($group.Failures)/$($group.Count) operations)"
                    Recommendation = Get-FailureRateRecommendation -Operation $op -FailureRate $failureRate
                }

                $insights.Add($insight)
            }
        }

        # Consistently above baseline (if baseline exists)
        if ($baselineLookup.ContainsKey($op)) {
            $bl = $baselineLookup[$op]
            $avg = $group.TotalDur / $group.Count

            if ($avg -gt $bl.AverageDuration * 1.5) {
                $insight = [pscustomobject]@{
                    Type           = 'PerformanceDegradation'
                    Severity       = 'Medium'
                    Operation      = $op
                    CurrentAvg     = [math]::Round($avg, 3)
                    BaselineAvg    = $bl.AverageDuration
                    Degradation    = [math]::Round((($avg - $bl.AverageDuration) / $bl.AverageDuration) * 100, 1)
                    Message        = "$op average duration ($([math]::Round($avg, 2))s) is $([math]::Round((($avg - $bl.AverageDuration) / $bl.AverageDuration) * 100, 1))% above baseline"
                    Recommendation = Get-DegradationRecommendation -Operation $op -CurrentAvg $avg -BaselineAvg $bl.AverageDuration
                }

                $insights.Add($insight)
            }
        }
    }

    return @($insights)
}

function Get-PerformanceRecommendation {
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [string]$Operation,
        [double]$Duration,
        [pscustomobject]$Baseline
    )

    $recommendations = @{
        'Provision'   = "Consider using faster storage (SSD/NVMe), reducing VM memory/CPU allocation, or checking host resource availability. Provision time of $([math]::Round($Duration, 1))s is significantly above baseline."
        'Start'       = "VM may be resource-constrained or experiencing disk I/O bottleneck. Consider assigning more memory or moving to faster storage. Startup time of $([math]::Round($Duration, 1))s is unusually long."
        'Stop'        = "VM may be running heavy workloads or experiencing shutdown hooks delays. Check for hung applications or services. Stop time of $([math]::Round($Duration, 1))s exceeds normal."
        'Suspend'     = "Memory write operations to disk are slow. Consider faster storage or reducing VM memory allocation. Suspend time of $([math]::Round($Duration, 1))s is above baseline."
        'Checkpoint'  = "Disk I/O performance is impacting checkpoint creation. Use faster storage or reduce disk activity during checkpoint. Checkpoint time of $([math]::Round($Duration, 1))s is slow."
        'Restore'     = "Checkpoint restore is disk I/O bound. Consider faster storage or smaller checkpoint size. Restore time of $([math]::Round($Duration, 1))s exceeds baseline."
        'NetworkInit' = "Network configuration may be slow due to switch creation or DNS delays. Check Hyper-V virtual switch configuration. NetworkInit time of $([math]::Round($Duration, 1))s is slow."
        'DomainJoin'  = "Domain join may be delayed by DC availability or network issues. Ensure domain controller is responsive and DNS is working correctly. DomainJoin time of $([math]::Round($Duration, 1))s is above baseline."
        'BulkOperation' = "Parallel execution may be overwhelming host resources. Consider reducing parallelism or running during off-peak hours. Bulk operation time of $([math]::Round($Duration, 1))s is slow."
        'Workflow'     = "Workflow contains slow operations. Review individual step performance and optimize bottlenecks. Workflow time of $([math]::Round($Duration, 1))s exceeds baseline."
    }

    if ($recommendations.ContainsKey($Operation)) {
        return $recommendations[$Operation]
    }

    return "Operation $Operation took $([math]::Round($Duration, 1))s which is above the baseline of $([math]::Round($Baseline.AverageDuration, 2))s. Review host resource availability and consider reducing workload."
}

function Get-FailureRateRecommendation {
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [string]$Operation,
        [double]$FailureRate
    )

    $recommendations = @{
        'Provision'   = "Provisioning failures may indicate insufficient disk space, memory, or corrupted ISO images. Check host resources and validate media."
        'Start'       = "VM start failures often indicate resource exhaustion or corrupted VM state. Check available memory and disk space."
        'Suspend'     = "Suspend failures suggest disk space issues or file system problems. Ensure sufficient storage for saved state files."
        'Checkpoint'  = "Checkpoint failures typically indicate disk I/O errors or insufficient space. Check storage availability and health."
        'Restore'     = "Restore failures may indicate missing checkpoint files or disk corruption. Verify checkpoint files exist and storage is healthy."
    }

    if ($recommendations.ContainsKey($Operation)) {
        return $recommendations[$Operation]
    }

    return "High failure rate on $Operation suggests underlying resource or configuration issues. Review host logs and resource availability."
}

function Get-DegradationRecommendation {
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [string]$Operation,
        [double]$CurrentAvg,
        [double]$BaselineAvg
    )

    $pctDiff = [math]::Round((($CurrentAvg - $BaselineAvg) / $BaselineAvg) * 100, 1)

    return "$Operation performance has degraded by $pctDiff% compared to historical baseline. This may indicate host resource contention, storage fragmentation, or increased workload. Review resource utilization and consider scaling host capacity."
}
```

This comprehensive analysis function detects multiple types of performance issues: anomalies (single operations exceeding thresholds), high failure rates, and general performance degradation. Each insight includes a severity level, detailed message, and actionable recommendation. The recommendation functions provide specific guidance based on the operation type and nature of the issue.
  </action>
  <verify>Get-LabPerformanceInsights -Metrics $testMetrics returns insights with Type, Severity, Message, and Recommendation properties</verify>
  <done>Get-LabPerformanceInsights function exists and analyzes metrics for performance issues</done>
</task>

<task type="auto">
  <name>Create Get-LabPerformanceRecommendation public API</name>
  <files>Public/Get-LabPerformanceRecommendation.ps1</files>
  <action>
Create Public/Get-LabPerformanceRecommendation.ps1 as the public API:

```powershell
function Get-LabPerformanceRecommendation {
    <#
    .SYNOPSIS
        Provides performance optimization recommendations for lab operations.

    .DESCRIPTION
        Get-LabPerformanceRecommendation analyzes historical performance data
        to detect anomalies, identify trends, and suggest specific optimizations.
        Recommendations include severity levels and actionable guidance for
        improving VM operation performance.

    .PARAMETER VMName
        Analyze performance for a specific VM (optional).

    .PARAMETER Operation
        Analyze performance for a specific operation type (optional).

    .PARAMETER RecentHours
        Only consider metrics from the last N hours (default: 24).

    .PARAMETER Severity
        Filter by severity level: Critical, High, Medium, Low (optional).

    .EXAMPLE
        Get-LabPerformanceRecommendation
        Returns all performance recommendations from the last 24 hours.

    .EXAMPLE
        Get-LabPerformanceRecommendation -VMName 'dc1' -Severity Critical
        Returns critical performance issues for VM 'dc1'.

    .EXAMPLE
        Get-LabPerformanceRecommendation -Operation 'Provision' -RecentHours 168
        Returns provision performance issues from the last 7 days.

    .OUTPUTS
        [pscustomobject[]] with performance insights including Type, Severity,
        Message, Recommendation, and affected VM/operation details.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [string]$VMName,

        [ValidateSet('Provision', 'Start', 'Stop', 'Suspend', 'Checkpoint', 'Restore', 'Remove', 'NetworkInit', 'DomainJoin', 'BulkOperation', 'Workflow')]
        [string]$Operation,

        [int]$RecentHours = 24,

        [ValidateSet('Critical', 'High', 'Medium', 'Low')]
        [string]$Severity
    )

    try {
        $perfConfig = Get-LabPerformanceConfig
        $storagePath = $perfConfig.StoragePath

        if (-not (Test-Path $storagePath)) {
            Write-Warning "Get-LabPerformanceRecommendation: No metrics file found at '$storagePath'"
            return @()
        }

        $content = Get-Content -Raw -Path $storagePath | ConvertFrom-Json

        if (-not $content.metrics -or $content.metrics.Count -eq 0) {
            Write-Verbose "Get-LabPerformanceRecommendation: No metrics found in '$storagePath'"
            return @()
        }

        $metrics = @($content.metrics)

        # Apply filters
        if ($PSBoundParameters.ContainsKey('VMName')) {
            $metrics = @($metrics | Where-Object { $_.VMName -like $VMName })
        }

        if ($PSBoundParameters.ContainsKey('Operation')) {
            $metrics = @($metrics | Where-Object { $_.Operation -eq $Operation })
        }

        # Get insights
        $insights = Get-LabPerformanceInsights -Metrics $metrics -RecentHours $RecentHours

        # Apply severity filter
        if ($PSBoundParameters.ContainsKey('Severity')) {
            $insights = @($insights | Where-Object { $_.Severity -eq $Severity })
        }

        if ($insights.Count -eq 0) {
            Write-Host "No performance issues detected." -ForegroundColor Green
            return @()
        }

        return @($insights)
    }
    catch {
        $PSCmdlet.WriteError(
            [System.Management.Automation.ErrorRecord]::new(
                [System.Exception]::new("Get-LabPerformanceRecommendation: failed to analyze performance - $_", $_.Exception),
                'Get-LabPerformanceRecommendation.Failure',
                [System.Management.Automation.ErrorCategory]::NotSpecified,
                $null
            )
        )
        return @()
    }
}
```

This public API provides a simple interface for operators to get performance recommendations. It filters metrics, calls the insights analyzer, applies severity filtering, and provides a friendly message when no issues are detected. The verbose examples demonstrate filtering by VM, operation type, severity, and time range.
  </action>
  <verify>Get-LabPerformanceRecommendation returns insights array or displays "No performance issues detected" message</verify>
  <done>Get-LabPerformanceRecommendation public API exists for performance optimization guidance</done>
</task>

<task type="auto">
  <name>Create unit tests for insights and recommendations</name>
  <files>Tests/LabPerformanceInsights.Tests.ps1</files>
  <action>
Create Tests/LabPerformanceInsights.Tests.ps1 with unit tests:

```powershell
Describe 'Get-LabPerformanceBaseline' {
    BeforeAll {
        $moduleRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
        Import-Module "$moduleRoot\SimpleLab\SimpleLab.psd1" -Force

        . "$moduleRoot\Private\Get-LabPerformanceBaseline.ps1"
    }

    Context 'Baseline calculation' {
        It 'Calculates baseline for operations with sufficient samples' {
            $metrics = @()
            1..10 | ForEach-Object {
                $metrics += [pscustomobject]@{
                    Timestamp = "2026-02-21T10:$($_):00Z"
                    Operation = 'Start'
                    VMName = 'test'
                    DurationSec = [double](5 + (Get-Random -Maximum 2))
                    StartTime = "2026-02-21T10:$($_):00Z"
                    EndTime = "2026-02-21T10:$($_):00Z"
                    Metadata = @{ Success = $true }
                }
            }

            $baseline = Get-LabPerformanceBaseline -Metrics $metrics -MinSamples 5

            $baseline.Count | Should -Be 1
            $baseline[0].Operation | Should -Be 'Start'
            $baseline[0].SampleCount | Should -BeGreaterOrEqual 5
            $baseline[0].AverageDuration | Should -Not -BeNullOrEmpty
        }

        It 'Skips operations with insufficient samples' {
            $metrics = @(
                [pscustomobject]@{
                    Timestamp = '2026-02-21T10:00:00Z'
                    Operation = 'Start'
                    VMName = 'test'
                    DurationSec = 5.0
                    StartTime = '2026-02-21T10:00:00Z'
                    EndTime = '2026-02-21T10:00:05Z'
                    Metadata = @{ Success = $true }
                }
            )

            $baseline = Get-LabPerformanceBaseline -Metrics $metrics -MinSamples 5

            $baseline.Count | Should -Be 0
        }

        It 'Calculates threshold using standard deviation multiplier' {
            $metrics = @()
            1..20 | ForEach-Object {
                $metrics += [pscustomobject]@{
                    Timestamp = "2026-02-21T10:$($_):00Z"
                    Operation = 'Provision'
                    VMName = 'test'
                    DurationSec = [double]120
                    StartTime = "2026-02-21T10:$($_):00Z"
                    EndTime = "2026-02-21T10:02:00Z"
                    Metadata = @{ Success = $true }
                }
            }

            $baseline = Get-LabPerformanceBaseline -Metrics $metrics -ThresholdMultiplier 2.0

            $baseline[0].UpperThreshold | Should -Not -BeNullOrEmpty
            $baseline[0].UpperThreshold | Should -BeGreaterThan $baseline[0].AverageDuration
        }
    }
}

Describe 'Get-LabPerformanceInsights' {
    BeforeAll {
        $moduleRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
        Import-Module "$moduleRoot\SimpleLab\SimpleLab.psd1" -Force

        . "$moduleRoot\Private\Get-LabPerformanceBaseline.ps1"
        . "$moduleRoot\Private\Get-LabPerformanceInsights.ps1"
    }

    Context 'Anomaly detection' {
        It 'Detects operations exceeding threshold' {
            $baseline = @(
                [pscustomobject]@{
                    Operation       = 'Start'
                    AverageDuration = 5.0
                    MedianDuration  = 4.8
                    StdDev          = 1.0
                    UpperThreshold  = 7.5
                    SampleCount     = 10
                    MinSamplesMet   = $true
                }
            )

            $metrics = @(
                [pscustomobject]@{
                    Timestamp = '2026-02-21T10:00:00Z'
                    Operation = 'Start'
                    VMName = 'slow-vm'
                    DurationSec = 15.0
                    StartTime = '2026-02-21T10:00:00Z'
                    EndTime = '2026-02-21T10:00:15Z'
                    Metadata = @{ Success = $true }
                }
            )

            $insights = Get-LabPerformanceInsights -Metrics $metrics -Baseline $baseline -RecentHours 24

            $insights.Count | Should -BeGreaterOrEqual 1
            $anomaly = $insights | Where-Object { $_.Type -eq 'Anomaly' }
            $anomaly | Should -Not -BeNullOrEmpty
            $anomaly.Severity | Should -Be 'Critical'
        }

        It 'Assigns correct severity based on threshold exceeded' {
            $baseline = @(
                [pscustomobject]@{
                    Operation       = 'Stop'
                    AverageDuration = 2.0
                    UpperThreshold  = 5.0
                    SampleCount     = 10
                }
            )

            $metrics = @(
                [pscustomobject]@{
                    Timestamp = '2026-02-21T10:00:00Z'
                    Operation = 'Stop'
                    VMName = 'vm1'
                    DurationSec = 6.0
                    StartTime = '2026-02-21T10:00:00Z'
                    EndTime = '2026-02-21T10:00:06Z'
                    Metadata = @{ Success = $true }
                }
            )

            $insights = Get-LabPerformanceInsights -Metrics $metrics -Baseline $baseline -RecentHours 24

            $insights[0].Severity | Should -Be 'Medium'
        }
    }

    Context 'Failure rate detection' {
        It 'Detects high failure rate' {
            $metrics = @()
            1..5 | ForEach-Object {
                $success = $_ -le 2
                $metrics += [pscustomobject]@{
                    Timestamp = "2026-02-21T10:0$_:00Z"
                    Operation = 'Checkpoint'
                    VMName = 'flaky-vm'
                    DurationSec = 10.0
                    StartTime = "2026-02-21T10:0$_:00Z"
                    EndTime = "2026-02-21T10:0$_:10Z"
                    Metadata = @{ Success = $success }
                }
            }

            $insights = Get-LabPerformanceInsights -Metrics $metrics -RecentHours 24

            $failureInsight = $insights | Where-Object { $_.Type -eq 'HighFailureRate' }
            $failureInsight | Should -Not -BeNullOrEmpty
            $failureInsight.FailureRate | Should -BeGreaterThan 30
        }
    }

    Context 'Recommendations' {
        It 'Provides actionable recommendation for anomalies' {
            $baseline = @(
                [pscustomobject]@{
                    Operation       = 'Provision'
                    AverageDuration = 60.0
                    UpperThreshold  = 90.0
                    SampleCount     = 10
                }
            )

            $metrics = @(
                [pscustomobject]@{
                    Timestamp = '2026-02-21T10:00:00Z'
                    Operation = 'Provision'
                    VMName = 'vm1'
                    DurationSec = 180.0
                    StartTime = '2026-02-21T10:00:00Z'
                    EndTime = '2026-02-21T10:03:00Z'
                    Metadata = @{ Success = $true }
                }
            )

            $insights = Get-LabPerformanceInsights -Metrics $metrics -Baseline $baseline -RecentHours 24

            $insights[0].Recommendation | Should -Not -BeNullOrEmpty
            $insights[0].Recommendation | Should -Match 'storage|memory|resource'
        }
    }
}

Describe 'Get-LabPerformanceRecommendation' {
    BeforeAll {
        $moduleRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
        Import-Module "$moduleRoot\SimpleLab\SimpleLab.psd1" -Force

        Mock Get-LabPerformanceConfig {
            return [pscustomobject]@{
                Enabled       = $true
                StoragePath   = 'TestDrive:\test-metrics.json'
                RetentionDays = 90
            }
        }
    }

    Context 'Public API' {
        It 'Returns empty array when no metrics file exists' {
            Mock Test-Path { return $false }

            $result = Get-LabPerformanceRecommendation
            $result | Should -Be @()
        }

        It 'Returns insights with severity and recommendations' {
            $testContent = [pscustomobject]@{
                metrics = @(
                    [pscustomobject]@{
                        Timestamp = '2026-02-21T10:00:00Z'
                        Operation = 'Start'
                        VMName = 'slow-vm'
                        LabName = 'TestLab'
                        DurationMs = 20000
                        DurationSec = 20.0
                        StartTime = '2026-02-21T10:00:00Z'
                        EndTime = '2026-02-21T10:00:20Z'
                        Host = 'HOST1'
                        Metadata = @{ Success = $true }
                    },
                    [pscustomobject]@{
                        Timestamp = '2026-02-21T10:01:00Z'
                        Operation = 'Start'
                        VMName = 'normal-vm'
                        LabName = 'TestLab'
                        DurationMs = 5000
                        DurationSec = 5.0
                        StartTime = '2026-02-21T10:01:00Z'
                        EndTime = '2026-02-21T10:01:05Z'
                        Host = 'HOST1'
                        Metadata = @{ Success = $true }
                    }
                )
            }

            Mock Test-Path { return $true }
            Mock Get-Content { return $testContent | ConvertTo-Json -Depth 8 }

            $result = Get-LabPerformanceRecommendation

            # With only 2 samples and both for Start operation, insights may be generated
            # depending on threshold calculations
            $result | Should -Not -BeNullOrEmpty
        }
    }
}
```

These tests verify the performance insights and recommendation functionality. Tests cover baseline calculation with sufficient and insufficient samples, anomaly detection with severity assignment, high failure rate detection, and recommendation generation. The public API tests verify empty results when no data exists and proper insight generation.
  </action>
  <verify>Invoke-Pester Tests/LabPerformanceInsights.Tests.ps1 -PassThru | Select-Object -ExpandProperty PassedCount is greater than 0</verify>
  <done>Unit tests exist and verify performance insights and recommendations</done>
</task>

<task type="auto">
  <name>Add Get-LabPerformanceRecommendation to module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Update both SimpleLab.psm1 and SimpleLab.psd1 to export Get-LabPerformanceRecommendation.

In SimpleLab.psm1, add 'Get-LabPerformanceRecommendation' to the Export-ModuleMember array.
In SimpleLab.psd1, add 'Get-LabPerformanceRecommendation' to the FunctionsToExport array.

This follows the established pattern for public API functions.
  </action>
  <verify>Get-Command Get-LabPerformanceRecommendation -Module SimpleLab returns command info</verify>
  <done>Get-LabPerformanceRecommendation is exported from the SimpleLab module</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1` succeeds
2. Test baseline: Get-LabPerformanceBaseline calculates statistics and thresholds
3. Test insights: Get-LabPerformanceInsights detects anomalies and issues
4. Test recommendations: Get-LabPerformanceRecommendation returns actionable guidance
5. Test severity: Insights include appropriate severity levels (Critical/High/Medium)
6. Test filtering: Recommendations can be filtered by VM, operation, severity
7. Run tests: Pester tests for insights and recommendations pass
</verification>

<success_criteria>
1. Get-LabPerformanceBaseline calculates Average, Median, StdDev, and UpperThreshold
2. Get-LabPerformanceInsights detects anomalies, high failure rates, and degradation
3. Insights include Type, Severity, Message, and Recommendation properties
4. Recommendations are specific to operation type (Provision, Start, etc.)
5. Severity levels are assigned based on threshold deviation
6. Get-LabPerformanceRecommendation provides public API with filtering
7. Unit tests verify baseline calculation, anomaly detection, and recommendations
8. Get-LabPerformanceRecommendation is exported from SimpleLab module
</success_criteria>

<output>
After completion, create `.planning/phases/33-performance-guidance/33-03-SUMMARY.md` with:
- Actual files created with line counts
- Insight types and recommendation examples
- Test coverage summary
- Any deviations from plan
- Phase 33 completion notes and v1.7 milestone status
</output>
