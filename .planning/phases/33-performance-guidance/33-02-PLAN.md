---
phase: 33-performance-guidance
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - Public/Get-LabPerformanceMetrics.ps1
  - Private/Get-LabPerformanceMetricsCore.ps1
  - Tests/LabPerformanceMetricsQuery.Tests.ps1
autonomous: true
requirements:
  - PERF-01

must_haves:
  truths:
    - "Operator can query performance metrics for VM operations"
    - "Metrics can be filtered by VM name, operation type, and date range"
    - "Query returns provision time, snapshot duration, and operation timestamps"
    - "Results include statistical summaries (average, min, max, percentiles)"
    - "Query supports grouping by operation type or VM name"
  artifacts:
    - path: "Private/Get-LabPerformanceMetricsCore.ps1"
      provides: "Core metrics query and aggregation logic"
      min_lines: 100
    - path: "Public/Get-LabPerformanceMetrics.ps1"
      provides: "Public API for querying performance metrics"
      exports: ["Get-LabPerformanceMetrics"]
      min_lines: 80
    - path: "Tests/LabPerformanceMetricsQuery.Tests.ps1"
      provides: "Unit tests for metrics querying"
      min_lines: 80
  key_links:
    - from: "Get-LabPerformanceMetrics.ps1"
      to: "Get-LabPerformanceMetricsCore.ps1"
      via: "Delegates to core function for query execution"
      pattern: "Get-LabPerformanceMetricsCore"
    - from: "Get-LabPerformanceMetricsCore.ps1"
      to: "Write-LabPerformanceMetric.ps1"
      via: "Reads metrics written by storage function"
      pattern: "performance-metrics.json"
    - from: "Get-LabPerformanceMetricsCore.ps1"
      to: "Private/Get-LabUsageTrendsCore.ps1"
      via: "Similar aggregation pattern for reference"
      pattern: "Measure-Object"
---

<objective>
Create performance metrics query infrastructure that enables operators to retrieve and analyze historical VM operation performance data with filtering, grouping, and statistical summaries.

Purpose: Allow operators to view and analyze performance metrics for VM operations, enabling identification of trends, bottlenecks, and performance degradation over time through flexible querying with statistical aggregation.

Output: Core metrics query function with filtering and aggregation logic, public API with parameters for filtering/grouping, and unit tests covering query scenarios and statistical calculations.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-performance-guidance/33-01-PLAN.md

# Existing patterns from codebase (for reference, not to copy)
Private/Get-LabUsageTrendsCore.ps1 - Shows aggregation and grouping patterns
Private/Get-LabRunArtifactSummary.ps1 - Shows metric query and summary patterns
Public/Get-LabRunHistory.ps1 - Shows query API with filtering parameters
Public/Get-LabUsageTrends.ps1 - Shows trend aggregation with period grouping
</context>

<tasks>

<task type="auto">
  <name>Create Get-LabPerformanceMetricsCore query function</name>
  <files>Private/Get-LabPerformanceMetricsCore.ps1</files>
  <action>
Create Private/Get-LabPerformanceMetricsCore.ps1 with core query logic:

```powershell
function Get-LabPerformanceMetricsCore {
    <#
    .SYNOPSIS
        Queries and aggregates performance metrics from storage.

    .DESCRIPTION
        Get-LabPerformanceMetricsCore reads performance metrics from JSON storage
        and applies filtering, grouping, and statistical aggregation. Supports
        filtering by VM name, operation type, and date range. Returns detailed
        metrics and optional statistical summaries.

    .PARAMETER Metrics
        Array of metric objects (from JSON storage).

    .PARAMETER VMName
        Filter by VM name (optional, wildcard supported).

    .PARAMETER Operation
        Filter by operation type (optional).

    .PARAMETER StartTime
        Filter metrics after this time (optional).

    .PARAMETER EndTime
        Filter metrics before this time (optional).

    .PARAMETER GroupBy
        Group results by: 'None', 'Operation', 'VMName', 'Date'.

    .PARAMETER IncludeStatistics
        Include statistical summary (avg, min, max, percentiles).

    .OUTPUTS
        [pscustomobject[]] with metric records or grouped aggregates.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [Parameter(Mandatory)]
        [pscustomobject[]]$Metrics,

        [string]$VMName,

        [ValidateSet('Provision', 'Start', 'Stop', 'Suspend', 'Checkpoint', 'Restore', 'Remove', 'NetworkInit', 'DomainJoin', 'BulkOperation', 'Workflow')]
        [string]$Operation,

        [DateTime]$StartTime,

        [DateTime]$EndTime,

        [ValidateSet('None', 'Operation', 'VMName', 'Date')]
        [string]$GroupBy = 'None',

        [switch]$IncludeStatistics
    )

    # Apply filters
    $filtered = @($Metrics)

    if (-not [string]::IsNullOrWhiteSpace($VMName)) {
        $filtered = @($filtered | Where-Object { $_.VMName -like $VMName })
    }

    if ($PSBoundParameters.ContainsKey('Operation')) {
        $filtered = @($filtered | Where-Object { $_.Operation -eq $Operation })
    }

    if ($StartTime) {
        $filtered = @($filtered | Where-Object {
            try {
                $metricTime = [DateTime]::Parse($_.StartTime)
                $metricTime -ge $StartTime
            }
            catch { $false }
        })
    }

    if ($EndTime) {
        $filtered = @($filtered | Where-Object {
            try {
                $metricTime = [DateTime]::Parse($_.StartTime)
                $metricTime -le $EndTime
            }
            catch { $false }
        })
    }

    if ($GroupBy -eq 'None') {
        $results = [System.Collections.Generic.List[pscustomobject]]::new()

        foreach ($metric in $filtered) {
            $result = [pscustomobject]@{
                Timestamp    = try { [DateTime]::Parse($metric.Timestamp) } catch { $null }
                Operation    = $metric.Operation
                VMName       = $metric.VMName
                LabName      = $metric.LabName
                DurationSec  = $metric.DurationSec
                DurationMs   = $metric.DurationMs
                StartTime    = try { [DateTime]::Parse($metric.StartTime) } catch { $null }
                EndTime      = try { [DateTime]::Parse($metric.EndTime) } catch { $null }
                Host         = $metric.Host
                Success      = if ($metric.Metadata -and $null -ne $metric.Metadata.Success) { $metric.Metadata.Success } else { $true }
                Error        = if ($metric.Metadata -and $metric.Metadata.Error) { $metric.Metadata.Error } else { $null }
            }
            $results.Add($result)
        }

        if ($IncludeStatistics -and $results.Count -gt 0) {
            $stats = Get-LabPerformanceStatistics -Metrics $results
            return @($results) + $stats
        }

        return @($results)
    }

    # Grouping logic
    $groups = @{}

    foreach ($metric in $filtered) {
        $groupKey = switch ($GroupBy) {
            'Operation' { $metric.Operation }
            'VMName'    { $metric.VMName }
            'Date'      {
                try {
                    [DateTime]::Parse($metric.StartTime).ToString('yyyy-MM-dd')
                }
                catch {
                    'Unknown'
                }
            }
        }

        if (-not $groups.ContainsKey($groupKey)) {
            $groups[$groupKey] = [System.Collections.Generic.List[pscustomobject]]::new()
        }

        $duration = $metric.DurationSec
        $groups[$groupKey].Add([pscustomobject]@{
            Timestamp   = try { [DateTime]::Parse($metric.Timestamp) } catch { $null }
            Operation   = $metric.Operation
            VMName      = $metric.VMName
            DurationSec = $duration
            Success     = if ($metric.Metadata -and $null -ne $metric.Metadata.Success) { $metric.Metadata.Success } else { $true }
        })
    }

    $results = [System.Collections.Generic.List[pscustomobject]]::new()

    foreach ($key in $groups.Keys | Sort-Object) {
        $groupMetrics = $groups[$key]
        $successMetrics = @($groupMetrics | Where-Object { $_.Success })
        $durations = @($successMetrics | ForEach-Object { $_.DurationSec })

        if ($durations.Count -eq 0) {
            continue
        }

        $result = [pscustomobject]@{
            Group          = $key
            Count          = $groupMetrics.Count
            SuccessCount   = $successMetrics.Count
            AvgDuration    = [math]::Round(($durations | Measure-Object -Average).Average, 3)
            MinDuration    = [math]::Round(($durations | Measure-Object -Minimum).Minimum, 3)
            MaxDuration    = [math]::Round(($durations | Measure-Object -Maximum).Maximum, 3)
            TotalDuration  = [math]::Round(($durations | Measure-Object -Sum).Sum, 3)
        }

        if ($IncludeStatistics -and $durations.Count -ge 4) {
            $sorted = $durations | Sort-Object
            $result.P50 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.50)], 3)
            $result.P75 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.75)], 3)
            $result.P90 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.90)], 3)
            $result.P95 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.95)], 3)
        }

        $results.Add($result)
    }

    return @($results)
}

function Get-LabPerformanceStatistics {
    <#
    .SYNOPSIS
        Calculates statistics from performance metrics.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [Parameter(Mandatory)]
        [pscustomobject[]]$Metrics
    )

    $successMetrics = @($Metrics | Where-Object { $_.Success })
    $durations = @($successMetrics | ForEach-Object { $_.DurationSec })

    if ($durations.Count -eq 0) {
        return [pscustomobject]@{
            Type        = 'Statistics'
            Count       = 0
            AvgDuration = $null
            MinDuration = $null
            MaxDuration = $null
        }
    }

    $stats = [pscustomobject]@{
        Type        = 'Statistics'
        Count       = $durations.Count
        AvgDuration = [math]::Round(($durations | Measure-Object -Average).Average, 3)
        MinDuration = [math]::Round(($durations | Measure-Object -Minimum).Minimum, 3)
        MaxDuration = [math]::Round(($durations | Measure-Object -Maximum).Maximum, 3)
    }

    if ($durations.Count -ge 4) {
        $sorted = $durations | Sort-Object
        $stats.P50 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.50)], 3)
        $stats.P75 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.75)], 3)
        $stats.P90 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.90)], 3)
        $stats.P95 = [math]::Round($sorted[[math]::Floor($sorted.Count * 0.95)], 3)
    }

    return $stats
}
```

This core function provides flexible querying of performance metrics with multiple filtering options, grouping by different dimensions, and statistical summarization. The grouping feature enables analyzing performance by operation type, VM name, or date. Statistics include average, min, max, and percentiles (P50, P75, P90, P95) when sufficient data exists.
  </action>
  <verify>Get-LabPerformanceMetricsCore -Metrics $testMetrics returns filtered and aggregated results</verify>
  <done>Get-LabPerformanceMetricsCore function exists and queries metrics with filtering and aggregation</done>
</task>

<task type="auto">
  <name>Create Get-LabPerformanceMetrics public API</name>
  <files>Public/Get-LabPerformanceMetrics.ps1</files>
  <action>
Create Public/Get-LabPerformanceMetrics.ps1 as the public API:

```powershell
function Get-LabPerformanceMetrics {
    <#
    .SYNOPSIS
        Retrieves performance metrics for VM operations.

    .DESCRIPTION
        Get-LabPerformanceMetrics queries historical performance data for VM
        operations including provision time, snapshot duration, startup/shutdown
        times, and more. Results can be filtered by VM, operation type, date range,
        and grouped for statistical analysis.

    .PARAMETER VMName
        Filter by VM name. Supports wildcards.

    .PARAMETER Operation
        Filter by operation type (Provision, Start, Stop, etc.).

    .PARAMETER StartTime
        Include only metrics after this time.

    .PARAMETER EndTime
        Include only metrics before this time.

    .PARAMETER GroupBy
        Group results by: None (default), Operation, VMName, or Date.

    .PARAMETER IncludeStatistics
        Include statistical summary (average, min, max, percentiles).

    .PARAMETER LabName
        Filter by lab name (optional).

    .EXAMPLE
        Get-LabPerformanceMetrics -VMName 'dc1' -Operation 'Start'
        Returns all start operations for VM 'dc1'.

    .EXAMPLE
        Get-LabPerformanceMetrics -StartTime (Get-Date).AddDays(-7) -GroupBy Operation -IncludeStatistics
        Returns metrics from the last 7 days grouped by operation with statistics.

    .EXAMPLE
        Get-LabPerformanceMetrics -VMName 'svr*' -Operation 'Provision' | Sort-Object DurationSec -Descending
        Returns all provision operations for VMs starting with 'svr', sorted by duration.

    .OUTPUTS
        [pscustomobject[]] with performance metric records or grouped aggregates.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [string]$VMName,

        [ValidateSet('Provision', 'Start', 'Stop', 'Suspend', 'Checkpoint', 'Restore', 'Remove', 'NetworkInit', 'DomainJoin', 'BulkOperation', 'Workflow')]
        [string]$Operation,

        [DateTime]$StartTime,

        [DateTime]$EndTime,

        [ValidateSet('None', 'Operation', 'VMName', 'Date')]
        [string]$GroupBy = 'None',

        [switch]$IncludeStatistics,

        [string]$LabName
    )

    try {
        $perfConfig = Get-LabPerformanceConfig
        $storagePath = $perfConfig.StoragePath

        if (-not (Test-Path $storagePath)) {
            Write-Warning "Get-LabPerformanceMetrics: No metrics file found at '$storagePath'"
            return @()
        }

        $content = Get-Content -Raw -Path $storagePath | ConvertFrom-Json

        if (-not $content.metrics -or $content.metrics.Count -eq 0) {
            Write-Verbose "Get-LabPerformanceMetrics: No metrics found in '$storagePath'"
            return @()
        }

        $metrics = @($content.metrics)

        if ($PSBoundParameters.ContainsKey('LabName')) {
            $metrics = @($metrics | Where-Object { $_.LabName -eq $LabName })
        }

        $params = @{
            Metrics = $metrics
        }

        if ($PSBoundParameters.ContainsKey('VMName')) {
            $params.VMName = $VMName
        }

        if ($PSBoundParameters.ContainsKey('Operation')) {
            $params.Operation = $Operation
        }

        if ($PSBoundParameters.ContainsKey('StartTime')) {
            $params.StartTime = $StartTime
        }

        if ($PSBoundParameters.ContainsKey('EndTime')) {
            $params.EndTime = $EndTime
        }

        $params.GroupBy = $GroupBy

        if ($IncludeStatistics) {
            $params.IncludeStatistics = $true
        }

        return Get-LabPerformanceMetricsCore @params
    }
    catch {
        $PSCmdlet.WriteError(
            [System.Management.Automation.ErrorRecord]::new(
                [System.Exception]::new("Get-LabPerformanceMetrics: failed to query metrics - $_", $_.Exception),
                'Get-LabPerformanceMetrics.Failure',
                [System.Management.Automation.ErrorCategory]::NotSpecified,
                $null
            )
        )
        return @()
    }
}
```

This public API provides a user-friendly interface for querying performance metrics. It handles storage path discovery, JSON parsing, and parameter delegation to the core function. The verbose examples demonstrate common usage patterns including filtering, grouping, and statistical analysis.
  </action>
  <verify>Get-LabPerformanceMetrics returns array of metric objects or grouped results</verify>
  <done>Get-LabPerformanceMetrics public API exists for querying metrics</done>
</task>

<task type="auto">
  <name>Create unit tests for metrics querying</name>
  <files>Tests/LabPerformanceMetricsQuery.Tests.ps1</files>
  <action>
Create Tests/LabPerformanceMetricsQuery.Tests.ps1 with unit tests:

```powershell
Describe 'Get-LabPerformanceMetricsCore' {
    BeforeAll {
        $moduleRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
        Import-Module "$moduleRoot\SimpleLab\SimpleLab.psd1" -Force

        . "$moduleRoot\Private\Get-LabPerformanceMetricsCore.ps1"

        $testMetrics = @(
            [pscustomobject]@{
                Timestamp = '2026-02-21T10:00:00Z'
                Operation = 'Start'
                VMName = 'dc1'
                LabName = 'TestLab'
                DurationMs = 5000
                DurationSec = 5.0
                StartTime = '2026-02-21T10:00:00Z'
                EndTime = '2026-02-21T10:00:05Z'
                Host = 'HOST1'
                Metadata = @{ Success = $true }
            },
            [pscustomobject]@{
                Timestamp = '2026-02-21T10:01:00Z'
                Operation = 'Start'
                VMName = 'svr1'
                LabName = 'TestLab'
                DurationMs = 3500
                DurationSec = 3.5
                StartTime = '2026-02-21T10:01:00Z'
                EndTime = '2026-02-21T10:01:03.5Z'
                Host = 'HOST1'
                Metadata = @{ Success = $true }
            },
            [pscustomobject]@{
                Timestamp = '2026-02-21T10:02:00Z'
                Operation = 'Stop'
                VMName = 'dc1'
                LabName = 'TestLab'
                DurationMs = 2000
                DurationSec = 2.0
                StartTime = '2026-02-21T10:02:00Z'
                EndTime = '2026-02-21T10:02:02Z'
                Host = 'HOST1'
                Metadata = @{ Success = $true }
            }
        )
    }

    Context 'Filtering' {
        It 'Filters by VMName' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -VMName 'dc1'

            $result.Count | Should -Be 2
            ($result | Where-Object { $_.Type -ne 'Statistics' }).VMName | Should -Contain 'dc1'
        }

        It 'Filters by Operation' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -Operation 'Start'

            $result.Count | Should -Be 2
            ($result | Where-Object { $_.Type -ne 'Statistics' }).Operation | Should -Not -Contain 'Stop'
        }

        It 'Filters by StartTime' {
            $startTime = [DateTime]::Parse('2026-02-21T10:01:30Z')
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -StartTime $startTime

            ($result | Where-Object { $_.Type -ne 'Statistics' }).Count | Should -Be 1
        }

        It 'Combines multiple filters' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -VMName 'dc1' -Operation 'Start'

            ($result | Where-Object { $_.Type -ne 'Statistics' }).Count | Should -Be 1
        }
    }

    Context 'Grouping' {
        It 'Groups by Operation' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -GroupBy 'Operation'

            $result.Count | Should -Be 2
            $result.Group | Should -Contain 'Start'
            $result.Group | Should -Contain 'Stop'
        }

        It 'Groups by VMName' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -GroupBy 'VMName'

            $result.Count | Should -Be 2
            $result.Group | Should -Contain 'dc1'
            $result.Group | Should -Contain 'svr1'
        }

        It 'Calculates group statistics' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -GroupBy 'Operation'

            $startGroup = $result | Where-Object { $_.Group -eq 'Start' }
            $startGroup.Count | Should -Be 2
            $startGroup.AvgDuration | Should -Be 4.25
        }
    }

    Context 'Statistics' {
        It 'Includes statistics when requested' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -IncludeStatistics

            $stats = $result | Where-Object { $_.Type -eq 'Statistics' }
            $stats | Should -Not -BeNullOrEmpty
            $stats.Count | Should -Be 3
        }

        It 'Calculates correct average' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -IncludeStatistics
            $stats = $result | Where-Object { $_.Type -eq 'Statistics' }

            $stats.AvgDuration | Should -Be 3.5
        }

        It 'Calculates min and max' {
            $result = Get-LabPerformanceMetricsCore -Metrics $testMetrics -IncludeStatistics
            $stats = $result | Where-Object { $_.Type -eq 'Statistics' }

            $stats.MinDuration | Should -Be 2.0
            $stats.MaxDuration | Should -Be 5.0
        }

        It 'Calculates percentiles with sufficient data' {
            $manyMetrics = @()
            1..20 | ForEach-Object {
                $manyMetrics += [pscustomobject]@{
                    Timestamp = "2026-02-21T10:$($_):00Z"
                    Operation = 'Start'
                    VMName = 'test'
                    LabName = 'TestLab'
                    DurationMs = $_ * 1000
                    DurationSec = [double]$_
                    StartTime = "2026-02-21T10:$($_):00Z"
                    EndTime = "2026-02-21T10:$($_):00Z"
                    Host = 'HOST1'
                    Metadata = @{ Success = $true }
                }
            }

            $result = Get-LabPerformanceMetricsCore -Metrics $manyMetrics -IncludeStatistics
            $stats = $result | Where-Object { $_.Type -eq 'Statistics' }

            $stats.P50 | Should -Not -BeNullOrEmpty
            $stats.P90 | Should -Not -BeNullOrEmpty
            $stats.P95 | Should -Not -BeNullOrEmpty
        }
    }
}

Describe 'Get-LabPerformanceMetrics' {
    BeforeAll {
        $moduleRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)

        Mock Get-LabPerformanceConfig {
            return [pscustomobject]@{
                Enabled       = $true
                StoragePath   = 'TestDrive:\test-metrics.json'
                RetentionDays = 90
            }
        }
    }

    Context 'Public API' {
        It 'Returns empty array when no metrics file exists' {
            Mock Test-Path { return $false }

            $result = Get-LabPerformanceMetrics
            $result | Should -Be @()
        }

        It 'Delegates to core function with correct parameters' {
            $testContent = [pscustomobject]@{
                metrics = @(
                    [pscustomobject]@{
                        Timestamp = '2026-02-21T10:00:00Z'
                        Operation = 'Start'
                        VMName = 'dc1'
                        LabName = 'TestLab'
                        DurationMs = 5000
                        DurationSec = 5.0
                        StartTime = '2026-02-21T10:00:00Z'
                        EndTime = '2026-02-21T10:00:05Z'
                        Host = 'HOST1'
                        Metadata = @{ Success = $true }
                    }
                )
            }

            Mock Test-Path { return $true }
            Mock Get-Content { return $testContent | ConvertTo-Json -Depth 8 }
            Mock Get-LabPerformanceMetricsCore { return @([pscustomobject]@{ Test = 'Result' }) }

            $result = Get-LabPerformanceMetrics -VMName 'dc1' -Operation 'Start' -IncludeStatistics

            Should -Invoke Get-LabPerformanceMetricsCore -Times 1 -Scope It -ParameterFilter {
                $VMName -eq 'dc1' -and $Operation -eq 'Start' -and $IncludeStatistics -eq $true
            }
        }

        It 'Filters by LabName when specified' {
            $testContent = [pscustomobject]@{
                metrics = @(
                    [pscustomobject]@{
                        Timestamp = '2026-02-21T10:00:00Z'
                        Operation = 'Start'
                        VMName = 'dc1'
                        LabName = 'MyLab'
                        DurationMs = 5000
                        DurationSec = 5.0
                        StartTime = '2026-02-21T10:00:00Z'
                        EndTime = '2026-02-21T10:00:05Z'
                        Host = 'HOST1'
                        Metadata = @{ Success = $true }
                    },
                    [pscustomobject]@{
                        Timestamp = '2026-02-21T10:01:00Z'
                        Operation = 'Start'
                        VMName = 'dc1'
                        LabName = 'OtherLab'
                        DurationMs = 3000
                        DurationSec = 3.0
                        StartTime = '2026-02-21T10:01:00Z'
                        EndTime = '2026-02-21T10:01:03Z'
                        Host = 'HOST1'
                        Metadata = @{ Success = $true }
                    }
                )
            }

            Mock Test-Path { return $true }
            Mock Get-Content { return $testContent | ConvertTo-Json -Depth 8 }
            Mock Get-LabPerformanceMetricsCore {
                param($Metrics)
                return @($Metrics | ForEach-Object { [pscustomobject]@{ VMName = $_.VMName; LabName = $_.LabName } })
            }

            $result = Get-LabPerformanceMetrics -LabName 'MyLab'

            $result.Count | Should -Be 1
            $result[0].LabName | Should -Be 'MyLab'
        }
    }
}
```

These tests verify the metrics query functionality across filtering, grouping, and statistical analysis scenarios. Tests cover single and combined filters, grouping by different dimensions, statistical calculations including percentiles, and the public API's delegation to the core function.
  </action>
  <verify>Invoke-Pester Tests/LabPerformanceMetricsQuery.Tests.ps1 -PassThru | Select-Object -ExpandProperty PassedCount is greater than 0</verify>
  <done>Unit tests exist and verify metrics querying functionality</done>
</task>

<task type="auto">
  <name>Add Get-LabPerformanceMetrics to module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Update both SimpleLab.psm1 and SimpleLab.psd1 to export Get-LabPerformanceMetrics.

In SimpleLab.psm1, add 'Get-LabPerformanceMetrics' to the Export-ModuleMember array.
In SimpleLab.psd1, add 'Get-LabPerformanceMetrics' to the FunctionsToExport array.

This follows the established pattern for public API functions.
  </action>
  <verify>Get-Command Get-LabPerformanceMetrics -Module SimpleLab returns command info</verify>
  <done>Get-LabPerformanceMetrics is exported from the SimpleLab module</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1` succeeds
2. Test core query: Get-LabPerformanceMetricsCore filters and aggregates metrics
3. Test grouping: Results can be grouped by Operation, VMName, or Date
4. Test statistics: Statistical summaries include avg, min, max, percentiles
5. Test public API: Get-LabPerformanceMetrics returns query results
6. Test filters: VMName, Operation, StartTime, EndTime filters work correctly
7. Run tests: Pester tests for metrics querying pass
</verification>

<success_criteria>
1. Get-LabPerformanceMetricsCore filters by VMName, Operation, StartTime, EndTime
2. Grouping by Operation, VMName, or Date produces aggregated results
3. Statistical summaries include average, min, max durations
4. Percentiles (P50, P75, P90, P95) calculated when sufficient data exists
5. Get-LabPerformanceMetrics provides public API for querying metrics
6. LabName filter works at public API level
7. Unit tests verify filtering, grouping, and statistics
8. Get-LabPerformanceMetrics is exported from SimpleLab module
</success_criteria>

<output>
After completion, create `.planning/phases/33-performance-guidance/33-02-SUMMARY.md` with:
- Actual files created with line counts
- Query examples and use cases
- Test coverage summary
- Any deviations from plan
- Next steps for Plan 33-03
</output>
