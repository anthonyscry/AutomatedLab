---
phase: 20-gui-log-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GUI/Views/LogsView.xaml
  - GUI/Start-OpenCodeLabGUI.ps1
autonomous: true
requirements: [LOGV-01, LOGV-02, LOGV-03]

must_haves:
  truths:
    - "Logs view shows a Run History section with recent runs from Get-LabRunHistory"
    - "Operator selects an action type filter (All, deploy, teardown, snapshot) and the list narrows to matching entries"
    - "Operator clicks Export and a text file is saved containing the currently visible run history entries"
  artifacts:
    - path: "GUI/Views/LogsView.xaml"
      provides: "Run history panel with DataGrid, action filter ComboBox, and Export button"
      contains: "runHistoryGrid"
    - path: "GUI/Start-OpenCodeLabGUI.ps1"
      provides: "Initialize-LogsView wiring for run history load, filter, and export"
      contains: "Get-LabRunHistory"
  key_links:
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: "Get-LabRunHistory"
      via: "function call in Initialize-LogsView"
      pattern: "Get-LabRunHistory"
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: "GUI/Views/LogsView.xaml"
      via: "FindName for runHistoryGrid, cmbRunHistoryFilter, btnExportHistory"
      pattern: "FindName.*runHistory"
---

<objective>
Add a dedicated run history panel to the GUI Logs view that displays recent run history entries from Get-LabRunHistory, supports action-type filtering, and allows exporting visible entries to a text file.

Purpose: Operators can review, filter, and export deployment history directly from the GUI without switching to a terminal.
Output: Updated LogsView.xaml with run history section, updated Initialize-LogsView in Start-OpenCodeLabGUI.ps1 with data loading, filtering, and export wiring.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@GUI/Views/LogsView.xaml
@GUI/Start-OpenCodeLabGUI.ps1
@Public/Get-LabRunHistory.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add run history XAML panel to LogsView.xaml</name>
  <files>GUI/Views/LogsView.xaml</files>
  <action>
Restructure LogsView.xaml to contain TWO sections stacked vertically inside the DockPanel:

1. **Run History section** (top ~60% of space) — new content:
   - A header row with:
     - TextBlock "Run History" using `Style="{DynamicResource HeaderLabel}"`
     - ComboBox `x:Name="cmbRunHistoryFilter"` (Width="140") with `Style="{DynamicResource ModernComboBox}"` for action type filtering
     - Button `x:Name="btnRefreshHistory"` Content="Refresh" with `Style="{DynamicResource ModernButton}"` Padding="12,6"
     - Button `x:Name="btnExportHistory"` Content="Export" with `Style="{DynamicResource ModernButton}"` Padding="12,6"
   - A DataGrid `x:Name="runHistoryGrid"` inside a Border with `Style="{DynamicResource CardBorder}"`:
     - AutoGenerateColumns="False", IsReadOnly="True", HeadersVisibility="Column"
     - Set Background, Foreground, RowBackground, AlternatingRowBackground, BorderThickness="0", GridLinesVisibility="None" to use DynamicResource theme brushes (CardBackgroundBrush, TextPrimaryBrush, SurfaceBrush, BorderBrush)
     - ColumnHeaderStyle that sets Background to SurfaceBrush and Foreground to TextPrimaryBrush
     - Columns: RunId (Width="120"), Action (Width="90"), Mode (Width="70"), Success (Width="60"), Duration (Width="80", header "Duration(s)"), EndedUtc (Width="160", header "Ended (UTC)"), Error (Width="*")
   - A TextBlock `x:Name="txtNoHistory"` with Text="No run history found. Deploy or teardown the lab to generate entries." Foreground="{DynamicResource TextSecondaryBrush}" centered, Margin="0,16,0,0" — this is shown when the grid is empty

2. **Session Log section** (bottom ~40%) — preserve the existing XAML content exactly (cmbLogFilter, btnClearLogs, logScroller, txtLogOutput) but wrap it with a "Session Log" header TextBlock.

Use a Grid with two RowDefinitions (first row Height="3*", second row Height="2*") as the top-level container inside the DockPanel to split the two sections. Put a small Margin between sections.

IMPORTANT: DataGrid requires `xmlns:dg="http://schemas.microsoft.com/winfx/2006/xaml/presentation"` — it is already in the default namespace so no extra xmlns needed. Just use `<DataGrid ...>` directly.

Do NOT use CellStyle with Setter for Foreground on the DataGrid — PS 5.1 WPF DataGrid inherits Foreground from the DataGrid element itself. Set Foreground on the DataGrid directly.
  </action>
  <verify>Open LogsView.xaml and confirm it is valid XML with all named elements present: cmbRunHistoryFilter, btnRefreshHistory, btnExportHistory, runHistoryGrid, txtNoHistory, cmbLogFilter, btnClearLogs, logScroller, txtLogOutput.</verify>
  <done>LogsView.xaml contains both Run History section (DataGrid + filter + export button) and Session Log section (existing content preserved).</done>
</task>

<task type="auto">
  <name>Task 2: Wire run history loading, filtering, and export in Initialize-LogsView</name>
  <files>GUI/Start-OpenCodeLabGUI.ps1</files>
  <action>
Update the `Initialize-LogsView` function in Start-OpenCodeLabGUI.ps1 to add run history functionality ABOVE the existing session log wiring (keep all existing cmbLogFilter, btnClearLogs, Render-LogEntries logic intact).

Add these new elements to Initialize-LogsView:

1. **Resolve new named elements** from the view:
   ```
   $runHistoryGrid       = $viewElement.FindName('runHistoryGrid')
   $cmbRunHistoryFilter  = $viewElement.FindName('cmbRunHistoryFilter')
   $btnRefreshHistory    = $viewElement.FindName('btnRefreshHistory')
   $btnExportHistory     = $viewElement.FindName('btnExportHistory')
   $txtNoHistory         = $viewElement.FindName('txtNoHistory')
   ```

2. **Populate the action filter ComboBox** with items: 'All', 'deploy', 'teardown', 'snapshot'. Set SelectedIndex = 0.

3. **Create a script-scoped variable** `$script:RunHistoryData` (a List[PSCustomObject]) to store currently loaded run history entries so Export can access them.

4. **Create a `$loadRunHistory` closure** that:
   - Calls `Get-LabRunHistory -Last 50` inside a try/catch (silently handle errors with a fallback empty array)
   - Stores result in `$script:RunHistoryData`
   - Reads the filter ComboBox selected item
   - If filter is not 'All', filters entries where `$_.Action -eq $filter`
   - Sets `$runHistoryGrid.ItemsSource` to the filtered array (cast to `[System.Collections.Generic.IEnumerable[PSCustomObject]]` or just assign the array — WPF DataGrid accepts arrays)
   - Toggles visibility: if filtered results count > 0, hide txtNoHistory and show runHistoryGrid; else show txtNoHistory and hide runHistoryGrid (use `[System.Windows.Visibility]::Visible` / `::Collapsed`)

5. **Wire cmbRunHistoryFilter.Add_SelectionChanged** to re-filter from `$script:RunHistoryData` without re-calling Get-LabRunHistory (just filter the cached data and reassign ItemsSource).

6. **Wire btnRefreshHistory.Add_Click** to call `& $loadRunHistory` (full reload from disk).

7. **Wire btnExportHistory.Add_Click** to:
   - Get the currently visible items from `$runHistoryGrid.ItemsSource`
   - If no items, show a MessageBox "No entries to export." and return
   - Use `[System.Windows.Forms.SaveFileDialog]` (Add-Type -AssemblyName System.Windows.Forms is already loaded in Initialize-SettingsView, but add it here too defensively) with Title "Export Run History", Filter "Text Files (*.txt)|*.txt|CSV Files (*.csv)|*.csv|All Files (*.*)|*.*", DefaultExt ".txt"
   - If user confirms, build export content:
     - Header line: "RunId`tAction`tMode`tSuccess`tDuration(s)`tEnded (UTC)`tError"
     - One line per entry with tab-separated values
   - Write to selected path using `Set-Content -Encoding UTF8`
   - Show success MessageBox "Exported {N} entries to {path}"
   - Add-LogEntry "Exported run history ({N} entries) to {filename}" -Level 'Success' (guard with Get-Command check)

8. **Call `& $loadRunHistory`** at the end of initialization to populate on view load.

IMPORTANT patterns to follow:
- Use `.GetNewClosure()` on all script blocks that reference outer variables (consistent with existing code)
- Guard Get-LabRunHistory call with try/catch — the LogRoot may not exist on all machines
- Use `Add-Type -AssemblyName System.Windows.Forms` before SaveFileDialog (defensive, may already be loaded)
- All WPF visibility changes use `[System.Windows.Visibility]::Collapsed` and `::Visible`
  </action>
  <verify>
Search the file for: (1) FindName.*runHistoryGrid, (2) Get-LabRunHistory, (3) btnExportHistory, (4) SaveFileDialog, (5) cmbRunHistoryFilter. All five patterns must be present. Confirm Initialize-LogsView still contains existing session log wiring (cmbLogFilter, btnClearLogs, Render-LogEntries).
  </verify>
  <done>Initialize-LogsView loads run history from Get-LabRunHistory, supports action-type filtering via ComboBox, and exports visible entries to a text file via SaveFileDialog. Existing session log functionality is preserved.</done>
</task>

</tasks>

<verification>
1. Open GUI/Views/LogsView.xaml — must be well-formed XML with both run history and session log sections
2. Search GUI/Start-OpenCodeLabGUI.ps1 for "Get-LabRunHistory" — must appear in Initialize-LogsView
3. Search for "btnExportHistory" — must have Add_Click handler with SaveFileDialog
4. Search for "cmbRunHistoryFilter" — must have Add_SelectionChanged handler
5. Confirm existing session log elements (cmbLogFilter, btnClearLogs, Render-LogEntries) still present and functional
</verification>

<success_criteria>
- LogsView.xaml has a DataGrid-based run history panel with filter ComboBox and Export button
- Initialize-LogsView calls Get-LabRunHistory to populate the grid on view load
- Selecting a filter value (All/deploy/teardown/snapshot) narrows the displayed entries
- Export button opens a SaveFileDialog and writes tab-separated run history to a text file
- Existing session log (Add-LogEntry / Render-LogEntries) continues to work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/20-gui-log-viewer/20-01-SUMMARY.md`
</output>
