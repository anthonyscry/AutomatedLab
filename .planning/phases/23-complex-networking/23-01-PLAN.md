---
phase: 23-complex-networking
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - Lab-Config.ps1
  - Private/Get-LabNetworkConfig.ps1
  - Public/New-LabSwitch.ps1
  - Public/New-LabNAT.ps1
  - Private/Test-LabVirtualSwitchSubnetConflict.ps1
  - Tests/ComplexNetworking-MultiSwitch.Tests.ps1
autonomous: true
requirements:
  - NET-01
  - NET-05

must_haves:
  truths:
    - "Lab config supports a Switches array with named switches, each having distinct subnets"
    - "New-LabSwitch creates multiple named switches from config in a single call"
    - "New-LabNAT configures NAT for each switch in the Switches array"
    - "Pre-deployment validation detects subnet overlap between any two switches"
    - "Backward compatible: single-switch config (SwitchName/AddressSpace) still works"
  artifacts:
    - path: "Lab-Config.ps1"
      provides: "Network.Switches array with named switch definitions"
      contains: "Switches"
    - path: "Private/Get-LabNetworkConfig.ps1"
      provides: "Returns switches array from config, or builds single-switch fallback"
      contains: "Switches"
    - path: "Public/New-LabSwitch.ps1"
      provides: "Creates one or many switches from config or parameters"
      contains: "Switches"
    - path: "Private/Test-LabVirtualSwitchSubnetConflict.ps1"
      provides: "Cross-switch subnet overlap detection"
      contains: "Switches"
    - path: "Tests/ComplexNetworking-MultiSwitch.Tests.ps1"
      provides: "Tests for multi-switch config, creation, and validation"
      min_lines: 80
  key_links:
    - from: "Lab-Config.ps1"
      to: "Private/Get-LabNetworkConfig.ps1"
      via: "Network.Switches array consumed by Get-LabNetworkConfig"
      pattern: "Switches"
    - from: "Private/Get-LabNetworkConfig.ps1"
      to: "Public/New-LabSwitch.ps1"
      via: "Switches array passed to New-LabSwitch"
      pattern: "Get-LabNetworkConfig"
    - from: "Private/Test-LabVirtualSwitchSubnetConflict.ps1"
      to: "Private/Get-LabNetworkConfig.ps1"
      via: "Reads switches to check pairwise subnet overlap"
      pattern: "Switches"
---

<objective>
Add multi-switch support to lab configuration and implement pairwise subnet conflict detection across named switches.

Purpose: NET-01 requires named switches array (not just a single SwitchName) and NET-05 requires pre-deployment validation that catches subnet overlap across multiple switches. This plan extends the config schema, updates Get-LabNetworkConfig to expose the switches array, updates New-LabSwitch and New-LabNAT to handle multiple switches, and extends Test-LabVirtualSwitchSubnetConflict to validate cross-switch overlap.

Output: Multi-switch config in Lab-Config.ps1, updated Get-LabNetworkConfig, multi-switch-aware New-LabSwitch and New-LabNAT, pairwise subnet overlap validation, and comprehensive tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Lab-Config.ps1
@Private/Get-LabNetworkConfig.ps1
@Public/New-LabSwitch.ps1
@Public/New-LabNAT.ps1
@Private/Test-LabVirtualSwitchSubnetConflict.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema and Get-LabNetworkConfig for multi-switch support</name>
  <files>Lab-Config.ps1, Private/Get-LabNetworkConfig.ps1</files>
  <action>
**Lab-Config.ps1:**
Add a `Switches` array inside `$GlobalLabConfig.Network`. Each switch entry is a hashtable with keys: `Name` (string), `AddressSpace` (CIDR string), `GatewayIp` (string), `NatName` (string, optional, defaults to "${Name}NAT"). Keep the existing flat `SwitchName`, `AddressSpace`, `GatewayIp`, `NatName` keys for backward compatibility. The `Switches` array is the new canonical source; the flat keys remain as the single-switch default.

Example addition inside `Network = @{`:
```powershell
# Multi-switch definitions for complex networking.
# Each entry defines a named vSwitch with its own subnet.
# When Switches is present, these are used instead of the flat SwitchName/AddressSpace.
Switches = @(
    @{
        Name         = 'LabCorpNet'
        AddressSpace = '10.0.10.0/24'
        GatewayIp    = '10.0.10.1'
        NatName      = 'LabCorpNetNAT'
    }
    @{
        Name         = 'LabDMZ'
        AddressSpace = '10.0.20.0/24'
        GatewayIp    = '10.0.20.1'
        NatName      = 'LabDMZNAT'
    }
)
```

Also add to `Test-LabConfigRequired` a validation for the Switches array entries if present: each entry must have `Name` and `AddressSpace` keys with non-empty values.

**Private/Get-LabNetworkConfig.ps1:**
Update `Get-LabNetworkConfig` to return a `Switches` property on the result object. Logic:
1. If `$labConfig.NetworkConfiguration.Switches` exists (from Lab-Config.ps1 via Get-LabConfig), use it directly.
2. Else if `$GlobalLabConfig.Network.Switches` exists and has entries, use it.
3. Else build a single-entry array from the flat SwitchName/AddressSpace/GatewayIp/NatName (backward compat).

The returned object should still have the existing flat properties (Subnet, PrefixLength, Gateway, DNSServers, VMIPs) plus the new `Switches` property.

Each switch in the `Switches` array should be normalized to a `[PSCustomObject]` with properties: Name, AddressSpace, GatewayIp, NatName (defaulting NatName to "${Name}NAT" if not provided).
  </action>
  <verify>
Write Pester tests in Tests/ComplexNetworking-MultiSwitch.Tests.ps1 (RED phase):
- Test that Get-LabNetworkConfig returns a Switches array when multi-switch config is present
- Test backward compat: single-switch config still returns a 1-element Switches array
- Test NatName defaults to "${Name}NAT" when omitted
- Test that Lab-Config.ps1 Switches array entries have required keys

Run: `pwsh -Command "Invoke-Pester Tests/ComplexNetworking-MultiSwitch.Tests.ps1 -Output Detailed"` -- expect RED first, then GREEN after implementation.
  </verify>
  <done>Get-LabNetworkConfig returns a Switches array in all scenarios (multi-switch, single-switch, defaults). Lab-Config.ps1 has example multi-switch definitions. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update New-LabSwitch, New-LabNAT, and subnet conflict validation for multi-switch</name>
  <files>Public/New-LabSwitch.ps1, Public/New-LabNAT.ps1, Private/Test-LabVirtualSwitchSubnetConflict.ps1, Tests/ComplexNetworking-MultiSwitch.Tests.ps1</files>
  <action>
**Public/New-LabSwitch.ps1:**
Add a `-Switches` parameter (array of hashtable/PSCustomObject, optional). When provided, iterate over each switch entry and create an internal vSwitch for each. Return an array of result objects (one per switch). When `-Switches` is not provided, fall back to existing single-switch behavior using `-SwitchName`. Add a `-All` switch that reads switches from `Get-LabNetworkConfig` and creates them all. Pattern:
```powershell
param(
    [Parameter(Position = 0)]
    [string]$SwitchName = "SimpleLab",
    [Parameter()]
    [object[]]$Switches,
    [switch]$All,
    [switch]$Force
)
```
If `-All`, call `Get-LabNetworkConfig` and use its `.Switches` array. If `-Switches`, use the provided array. Otherwise, single-switch mode (existing behavior).

**Public/New-LabNAT.ps1:**
Add similar `-Switches` and `-All` parameters. When multiple switches are provided, configure NAT for each one (vSwitch + gateway IP + NAT object). Return an array of results. Single-switch backward compatibility preserved.

**Private/Test-LabVirtualSwitchSubnetConflict.ps1:**
Add a new public function `Test-LabMultiSwitchSubnetOverlap` (or extend the existing function with a `-Switches` parameter). This function takes an array of switch definitions and checks every pair for subnet overlap using the existing `Get-CidrRange` helper (extract it to a reusable scope or keep it as a nested function). Return a result object with:
- `HasOverlap` (bool)
- `Overlaps` (array of objects with Switch1, Switch2, Subnet1, Subnet2)
- `Message` (string)

The existing `Test-LabVirtualSwitchSubnetConflict` (single-switch against live adapters) should remain unchanged. The new function checks config-level overlap before any switches are created.

**Tests:**
Add to Tests/ComplexNetworking-MultiSwitch.Tests.ps1:
- Test New-LabSwitch with -Switches parameter creates multiple switches (mock Get-VMSwitch, New-VMSwitch)
- Test New-LabSwitch -All reads from Get-LabNetworkConfig
- Test New-LabNAT with -Switches parameter configures multiple NATs (mock network cmdlets)
- Test pairwise subnet overlap detection: overlapping subnets detected, non-overlapping subnets pass
- Test edge case: identical subnets on different switches flagged as overlap
- Test edge case: partial overlap (e.g., 10.0.10.0/24 vs 10.0.10.0/25) detected

RED-GREEN-REFACTOR: Write tests first (expect RED), then implement, then verify GREEN.
  </action>
  <verify>Run: `pwsh -Command "Invoke-Pester Tests/ComplexNetworking-MultiSwitch.Tests.ps1 -Output Detailed"` -- all tests pass (GREEN).</verify>
  <done>New-LabSwitch and New-LabNAT support multi-switch creation via -Switches or -All parameters. Pairwise subnet overlap validation catches conflicts before deployment. All existing single-switch behavior preserved. All tests pass.</done>
</task>

</tasks>

<verification>
1. `pwsh -Command "Invoke-Pester Tests/ComplexNetworking-MultiSwitch.Tests.ps1 -Output Detailed"` -- all tests pass
2. Lab-Config.ps1 parses without error: `pwsh -Command ". ./Lab-Config.ps1; $GlobalLabConfig.Network.Switches.Count"` returns 2+
3. Get-LabNetworkConfig returns Switches array: `pwsh -Command ". ./Lab-Common.ps1; (Get-LabNetworkConfig).Switches.Count"` returns 2+
4. Backward compat: removing Switches from config still returns valid single-switch result
</verification>

<success_criteria>
- Lab-Config.ps1 has Network.Switches array with 2+ named switch definitions
- Get-LabNetworkConfig returns Switches property in all scenarios
- New-LabSwitch -All creates all configured switches
- New-LabNAT -All configures NAT for all configured switches
- Pairwise subnet overlap detected before deployment
- All existing single-switch behavior unchanged
- All Pester tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-complex-networking/23-01-SUMMARY.md`
</output>
