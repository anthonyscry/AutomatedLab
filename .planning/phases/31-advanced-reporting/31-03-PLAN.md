---
phase: 31-advanced-reporting
plan: 03
type: execute
wave: 3
depends_on: ["31-01", "31-02"]
files_modified:
  - Public/Schedule-LabReport.ps1
  - Public/Get-LabReportSchedule.ps1
  - Public/Remove-LabReportSchedule.ps1
  - Lab-Config.ps1
autonomous: true
requirements:
  - RPT-03

must_haves:
  truths:
    - "Operator can schedule automated report generation for compliance and resource reports"
    - "Schedules support daily and weekly frequencies with configurable time"
    - "Scheduled reports are generated via Windows Scheduled Tasks (survives PowerShell session termination)"
    - "Scheduled tasks run reports and save to configured output paths"
    - "Operators can list, remove, and manage existing report schedules"
  artifacts:
    - path: "Public/Schedule-LabReport.ps1"
      provides: "Public API for creating scheduled report tasks"
      exports: ["Schedule-LabReport"]
      min_lines: 120
    - path: "Public/Get-LabReportSchedule.ps1"
      provides: "Public API for listing report schedules"
      exports: ["Get-LabReportSchedule"]
      min_lines: 60
    - path: "Public/Remove-LabReportSchedule.ps1"
      provides: "Public API for removing report schedules"
      exports: ["Remove-LabReportSchedule"]
      min_lines: 50
    - path: "Private/Invoke-ScheduledReport.ps1"
      provides: "Core script invoked by scheduled tasks"
      min_lines: 80
  key_links:
    - from: "Schedule-LabReport.ps1"
      to: "Invoke-LabTTLMonitor.ps1"
      via: "Reuses Windows Scheduled Task pattern from Phase 26"
      pattern: "ScheduledTask|Register-ScheduledTask"
    - from: "Schedule-LabReport.ps1"
      to: "Get-LabComplianceReport.ps1"
      via: "Generates compliance reports on schedule"
      pattern: "Get-LabComplianceReport"
    - from: "Schedule-LabReport.ps1"
      to: "Get-LabResourceReport.ps1"
      via: "Generates resource reports on schedule"
      pattern: "Get-LabResourceReport"
    - from: "Invoke-ScheduledReport.ps1"
      to: "SimpleLab.psm1"
      via: "Imports module to run report commands"
      pattern: "Import-Module"
---

<objective>
Create scheduled report generation functionality that automatically generates compliance and resource reports on daily or weekly schedules using Windows Scheduled Tasks.

Purpose: Enable operators to automate regular reporting for compliance audits and operational monitoring without manual intervention. Scheduled reports provide consistent audit trails and reduce manual overhead for regular reporting requirements.

Output: Schedule-LabReport public API, Get-LabReportSchedule listing API, Remove-LabReportSchedule removal API, Invoke-ScheduledReport core script, and unit tests for schedule management.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-lab-ttl-lifecycle-monitoring/26-02-PLAN.md
@.planning/phases/31-advanced-reporting/31-01-PLAN.md
@.planning/phases/31-advanced-reporting/31-02-PLAN.md

# Existing patterns from codebase (for reference, not to copy)
Private/Invoke-LabTTLMonitor.ps1 (Phase 26) - Shows Windows Scheduled Task creation and registration
Public/Set-LabTTL.ps1 (Phase 26) - Shows scheduled task management with task naming patterns
Public/Get-LabTTL.ps1 (Phase 26) - Shows listing existing scheduled tasks
Public/Remove-LabTTL.ps1 (Phase 26) - Shows removing scheduled tasks
Private/Invoke-LabTTLMonitor.ps1 uses Register-ScheduledTask with Trigger and Action patterns
</context>

<tasks>

<task type="auto">
  <name>Add ReportSchedule configuration block to Lab-Config.ps1</name>
  <files>Lab-Config.ps1</files>
  <action>
Add the ReportSchedule configuration block to Lab-Config.ps1 after the Reports block.

The configuration should follow the existing pattern:
```powershell
    ReportSchedule = @{
        # Changing Enabled toggles whether scheduled reports can be created.
        Enabled = $true
        # Changing TaskPrefix sets the prefix for scheduled report task names.
        TaskPrefix = 'AutomatedLabReport'
        # Changing OutputBasePath sets the base directory where scheduled reports are saved.
        OutputBasePath = '.planning/reports/scheduled'
    }
```

This matches the pattern used for TTL monitoring in Phase 26. Enabled defaults to true for report scheduling (operators want automation by default, can opt out). TaskPrefix provides consistent task naming for identification. OutputBasePath organizes scheduled reports separately from manually generated reports.
  </action>
  <verify>Test-Path variable:LabConfig.ReportSchedule returns $true after dot-sourcing Lab-Config.ps1</verify>
  <done>ReportSchedule block exists in Lab-Config.ps1 with Enabled, TaskPrefix, and OutputBasePath keys</done>
</task>

<task type="auto">
  <name>Create Get-LabReportScheduleConfig helper function</name>
  <files>Private/Get-LabReportScheduleConfig.ps1</files>
  <action>
Create Private/Get-LabReportScheduleConfig.ps1 following the established config helper pattern:

```powershell
function Get-LabReportScheduleConfig {
    <#
    .SYNOPSIS
        Reads report schedule configuration from global lab config.

    .DESCRIPTION
        Get-LabReportScheduleConfig returns a ReportSchedule configuration object
        with safe defaults when keys are missing from $GlobalLabConfig. Contains
        ContainsKey guards for all nested keys to prevent errors under StrictMode.

    .OUTPUTS
        [pscustomobject] with Enabled, TaskPrefix, OutputBasePath properties.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $config = $GlobalLabConfig

    $enabled = if ($config.ContainsKey('ReportSchedule') -and $config.ReportSchedule.ContainsKey('Enabled')) {
        [bool]$config.ReportSchedule.Enabled
    } else {
        $true
    }

    $taskPrefix = if ($config.ContainsKey('ReportSchedule') -and $config.ReportSchedule.ContainsKey('TaskPrefix')) {
        [string]$config.ReportSchedule.TaskPrefix
    } else {
        'AutomatedLabReport'
    }

    $outputBasePath = if ($config.ContainsKey('ReportSchedule') -and $config.ReportSchedule.ContainsKey('OutputBasePath')) {
        [string]$config.ReportSchedule.OutputBasePath
    } else {
        '.planning/reports/scheduled'
    }

    return [pscustomobject]@{
        Enabled         = $enabled
        TaskPrefix      = $taskPrefix
        OutputBasePath  = $outputBasePath
    }
}
```

This function follows the established config helper pattern from Phases 26-31. It provides ContainsKey guards for safe config access under StrictMode, returns type-casted values with safe defaults, and exports a PSCustomObject with all configuration fields.
  </action>
  <verify>Get-LabReportScheduleConfig returns PSCustomObject with Enabled=$true, TaskPrefix='AutomatedLabReport', OutputBasePath='.planning/reports/scheduled' when ReportSchedule block missing from $GlobalLabConfig</verify>
  <done>Get-LabReportScheduleConfig helper exists and follows established config helper pattern</done>
</task>

<task type="auto">
  <name>Create Invoke-ScheduledReport core script</name>
  <files>Private/Invoke-ScheduledReport.ps1</files>
  <action>
Create Private/Invoke-ScheduledReport.ps1 that is invoked by scheduled tasks:

```powershell
function Invoke-ScheduledReport {
    <#
    .SYNOPSIS
        Executes a scheduled report generation.

    .DESCRIPTION
        Invoke-ScheduledReport is called by Windows Scheduled Tasks to generate
        reports on a schedule. It imports the SimpleLab module, runs the specified
        report type, and saves the output to the scheduled reports directory.
        Errors are logged but do not throw to prevent task failures.

    .PARAMETER ReportType
        Type of report to generate: 'Compliance' or 'Resource'.

    .PARAMETER OutputPath
        Directory where the report file will be saved.

    .PARAMETER LabName
        Name of the lab for the report header.

    .PARAMETER Format
        Output format for the report (default: 'Html').

    .EXAMPLE
        Invoke-ScheduledReport -ReportType Compliance -OutputPath '.planning/reports/scheduled'
        Generates a compliance HTML report in the scheduled reports directory.
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [ValidateSet('Compliance', 'Resource')]
        [string]$ReportType,

        [Parameter(Mandatory)]
        [string]$OutputPath,

        [string]$LabName = 'AutomatedLab',

        [ValidateSet('Console', 'Html', 'Csv', 'Json')]
        [string]$Format = 'Html'
    )

    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    $logEntry = "[$timestamp] ScheduledReport: $ReportType report requested"

    try {
        $modulePath = Join-Path (Join-Path $PSScriptRoot '..') SimpleLab 'SimpleLab.psm1'

        if (-not (Test-Path $modulePath)) {
            throw "Module not found at '$modulePath'"
        }

        Import-Module $modulePath -Force

        $dateStamp = Get-Date -Format 'yyyyMMdd-HHmmss'
        $extension = switch ($Format) {
            'Html' { '.html' }
            'Csv'  { '.csv' }
            'Json' { '.json' }
        }

        $fileName = "$ReportType-$dateStamp$extension"
        $fullOutputPath = Join-Path $OutputPath $fileName

        $null = New-Item -Path $OutputPath -ItemType Directory -Force -ErrorAction SilentlyContinue

        switch ($ReportType) {
            'Compliance' {
                $null = Get-LabComplianceReport -Format $Format -LabName $LabName -OutputPath $fullOutputPath
            }
            'Resource' {
                $null = Get-LabResourceReport -Format $Format -LabName $LabName -OutputPath $fullOutputPath
            }
        }

        if (Test-Path $fullOutputPath) {
            Write-Host "Scheduled $ReportType report generated: $fullOutputPath"
        } else {
            Write-Warning "Scheduled $ReportType report may have failed - output file not found"
        }
    }
    catch {
        Write-Error "Invoke-ScheduledReport failed for $ReportType report: $($_.Exception.Message)"
    }
}
```

This function follows the pattern from Invoke-LabTTLMonitor.ps1 (Phase 26). It imports the SimpleLab module dynamically, generates the specified report type, creates the output directory if needed, and logs errors without throwing to prevent scheduled task failures. The function supports both Compliance and Resource report types with configurable output formats.
  </action>
  <verify>Invoke-ScheduledReport -ReportType Compliance -OutputPath 'TestDrive:/reports' generates a compliance HTML report</verify>
  <done>Invoke-ScheduledReport function exists and can generate both compliance and resource reports</done>
</task>

<task type="auto">
  <name>Create Schedule-LabReport public API</name>
  <files>Public/Schedule-LabReport.ps1</files>
  <action>
Create Public/Schedule-LabReport.ps1 for creating scheduled report tasks:

```powershell
function Schedule-LabReport {
    <#
    .SYNOPSIS
        Creates a scheduled task for automatic report generation.

    .DESCRIPTION
        Schedule-LabReport creates a Windows Scheduled Task that automatically
        generates compliance or resource reports on a daily or weekly schedule.
        Reports are saved to the scheduled reports directory. The task runs
        under the current user context and survives PowerShell session termination.

    .PARAMETER ReportType
        Type of report to generate: 'Compliance' or 'Resource'.

    .PARAMETER Frequency
        Schedule frequency: 'Daily' or 'Weekly'.

    .PARAMETER Time
        Time of day to run the report (default: '02:00').

    .PARAMETER DaysOfWeek
        Days of week for weekly schedules (default: 'Monday').

    .PARAMETER OutputPath
        Directory where scheduled reports are saved. Defaults to the
        OutputBasePath setting from Get-LabReportScheduleConfig.

    .PARAMETER LabName
        Name of the lab for the report header.

    .PARAMETER Format
        Output format for the report (default: 'Html').

    .EXAMPLE
        Schedule-LabReport -ReportType Compliance -Frequency Daily
        Creates a daily compliance report scheduled for 2:00 AM.

    .EXAMPLE
        Schedule-LabReport -ReportType Resource -Frequency Weekly -DaysOfWeek Monday, Friday
        Creates a weekly resource report scheduled for Monday and Friday at 2:00 AM.

    .OUTPUTS
        [string] Name of the created scheduled task.
    #>
    [CmdletBinding(SupportsShouldProcess)]
    [OutputType([string])]
    param(
        [Parameter(Mandatory)]
        [ValidateSet('Compliance', 'Resource')]
        [string]$ReportType,

        [Parameter(Mandatory)]
        [ValidateSet('Daily', 'Weekly')]
        [string]$Frequency,

        [string]$Time = '02:00',

        [ValidateSet('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday')]
        [string[]]$DaysOfWeek = @('Monday'),

        [string]$OutputPath,

        [string]$LabName,

        [ValidateSet('Html', 'Csv', 'Json')]
        [string]$Format = 'Html'
    )

    $scheduleConfig = Get-LabReportScheduleConfig

    if (-not $scheduleConfig.Enabled) {
        Write-Warning "Report scheduling is disabled. Enable it in Lab-Config.ps1 by setting ReportSchedule.Enabled = `$true"
        return $null
    }

    if (-not $PSBoundParameters.ContainsKey('LabName')) {
        $LabName = if (Test-Path variable:GlobalLabConfig -and $GlobalLabConfig.ContainsKey('Lab') -and $GlobalLabConfig.Lab.ContainsKey('LabName')) {
            $GlobalLabConfig.Lab.LabName
        } else {
            'AutomatedLab'
        }
    }

    if (-not $PSBoundParameters.ContainsKey('OutputPath')) {
        $OutputPath = $scheduleConfig.OutputBasePath
    }

    $taskName = '{0}_{1}_{2}' -f $scheduleConfig.TaskPrefix, $ReportType, $Frequency.ToLower()

    $timeSpan = [TimeSpan]::Parse($Time)

    $trigger = switch ($Frequency) {
        'Daily' {
            New-ScheduledTaskTrigger -Daily -At $timeSpan
        }
        'Weekly' {
            New-ScheduledTaskTrigger -Weekly -DaysOfWeek $DaysOfWeek -At $timeSpan
        }
    }

    $modulePath = Join-Path (Join-Path $PSScriptRoot '..') SimpleLab 'SimpleLab.psm1'
    $scriptPath = Join-Path (Join-Path $PSScriptRoot '..') Private 'Invoke-ScheduledReport.ps1'

    $actionScript = @"
Import-Module '$modulePath' -Force
& '$scriptPath' -ReportType '$ReportType' -OutputPath '$OutputPath' -LabName '$LabName' -Format '$Format'
"@

    $action = New-ScheduledTaskAction -Execute 'PowerShell.exe' -Argument "-NoProfile -ExecutionPolicy Bypass -Command `"$actionScript`""

    $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable

    $principal = New-ScheduledTaskPrincipal -UserId $env:USERNAME -LogonType Interactive -RunLevel Highest

    if ($PSCmdlet.ShouldProcess($taskName, 'Create scheduled report task')) {
        try {
            Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -Principal $principal -Force | Out-Null
            Write-Host "`n  Scheduled task created: $taskName" -ForegroundColor Green
            Write-Host "  Report Type:   $ReportType" -ForegroundColor DarkGray
            Write-Host "  Frequency:     $Frequency" -ForegroundColor DarkGray
            if ($Frequency -eq 'Weekly') {
                Write-Host "  Days:          $($DaysOfWeek -join ', ')" -ForegroundColor DarkGray
            }
            Write-Host "  Time:          $Time" -ForegroundColor DarkGray
            Write-Host "  Output Path:   $OutputPath" -ForegroundColor DarkGray

            return $taskName
        }
        catch {
            $PSCmdlet.WriteError(
                [System.Management.Automation.ErrorRecord]::new(
                    [System.Exception]::new("Failed to create scheduled task '$taskName' - $_", $_.Exception),
                    'Schedule-LabReport.Failure',
                    [System.Management.Automation.ErrorCategory]::FromStdErr,
                    $null
                )
            )
            return $null
        }
    }

    return $null
}
```

This function follows the scheduled task pattern from Set-LabTTL.ps1 (Phase 26). It uses Register-ScheduledTask with appropriate triggers (Daily/Weekly), creates a PowerShell action that invokes Invoke-ScheduledReport, configures task settings for battery and availability scenarios, and provides clear console output showing the created task details.
  </action>
  <verify>Schedule-LabReport -ReportType Compliance -Frequency Daily creates a Windows Scheduled Task with the correct trigger and action</verify>
  <done>Schedule-LabReport function exists and creates scheduled tasks for both compliance and resource reports</done>
</task>

<task type="auto">
  <name>Create Get-LabReportSchedule public API</name>
  <files>Public/Get-LabReportSchedule.ps1</files>
  <action>
Create Public/Get-LabReportSchedule.ps1 for listing scheduled report tasks:

```powershell
function Get-LabReportSchedule {
    <#
    .SYNOPSIS
        Lists scheduled report tasks.

    .DESCRIPTION
        Get-LabReportSchedule retrieves all AutomatedLab report scheduled tasks
        and displays their configuration including report type, frequency, and
        next run time. Returns scheduled task objects for further processing.

    .PARAMETER TaskName
        Specific task name to retrieve (optional). If not specified, returns all
        report scheduled tasks.

    .EXAMPLE
        Get-LabReportSchedule
        Lists all report scheduled tasks.

    .EXAMPLE
        Get-LabReportSchedule -TaskName 'AutomatedLabReport_Compliance_daily'
        Returns details for the specific compliance daily task.

    .OUTPUTS
        [Microsoft.Management.Infrastructure.CimInstance[]] Scheduled task objects.
    #>
    [CmdletBinding()]
    [OutputType([Microsoft.Management.Infrastructure.CimInstance[]])]
    param(
        [string]$TaskName
    )

    $scheduleConfig = Get-LabReportScheduleConfig
    $taskPrefix = $scheduleConfig.TaskPrefix

    $allTasks = Get-ScheduledTask -ErrorAction SilentlyContinue

    if ($null -eq $allTasks) {
        Write-Host "`n  No report scheduled tasks found." -ForegroundColor Yellow
        return @()
    }

    $reportTasks = if ($PSBoundParameters.ContainsKey('TaskName')) {
        @($allTasks | Where-Object { $_.TaskName -eq $TaskName })
    } else {
        @($allTasks | Where-Object { $_.TaskName -like "$taskPrefix*" })
    }

    if ($reportTasks.Count -eq 0) {
        Write-Host "`n  No report scheduled tasks found." -ForegroundColor Yellow
        return @()
    }

    Write-Host "`n  Report Scheduled Tasks:" -ForegroundColor Cyan
    Write-Host '  ----------------------' -ForegroundColor Cyan

    foreach ($task in $reportTasks) {
        $nextRun = if ($task.Triggers) {
            $task.Triggers[0].StartBoundary
        } else {
            'Unknown'
        }

        $frequency = if ($task.Triggers -and $task.Triggers[0].Daily) {
            'Daily'
        } elseif ($task.Triggers -and $task.Triggers[0].Weekly) {
            'Weekly'
        } else {
            'Unknown'
        }

        $reportType = if ($task.TaskName -match '_(Compliance|Resource)_') {
            $matches[1]
        } else {
            'Unknown'
        }

        Write-Host "`n  Task Name:    $($task.TaskName)" -ForegroundColor White
        Write-Host "  Report Type:  $reportType" -ForegroundColor DarkGray
        Write-Host "  Frequency:    $frequency" -ForegroundColor DarkGray
        Write-Host "  Next Run:     $nextRun" -ForegroundColor DarkGray
        Write-Host "  State:        $($task.State)" -ForegroundColor DarkGray
    }

    Write-Host ''

    return $reportTasks
}
```

This function follows the pattern from Get-LabTTL.ps1 (Phase 26). It retrieves scheduled tasks matching the report task prefix, extracts and displays task configuration including report type, frequency, and next run time, and returns the task objects for further processing.
  </action>
  <verify>Get-LabReportSchedule lists all report scheduled tasks with their configuration</verify>
  <done>Get-LabReportSchedule function exists and lists scheduled report tasks</done>
</task>

<task type="auto">
  <name>Create Remove-LabReportSchedule public API</name>
  <files>Public/Remove-LabReportSchedule.ps1</files>
  <action>
Create Public/Remove-LabReportSchedule.ps1 for removing scheduled report tasks:

```powershell
function Remove-LabReportSchedule {
    <#
    .SYNOPSIS
        Removes a scheduled report task.

    .DESCRIPTION
        Remove-LabReportSchedule unregisters a scheduled report task, stopping
        automatic report generation. Supports ShouldProcess for confirmation and
        -WhatIf for safe preview of the operation.

    .PARAMETER TaskName
        Name of the scheduled task to remove.

    .EXAMPLE
        Remove-LabReportSchedule -TaskName 'AutomatedLabReport_Compliance_daily'
        Removes the daily compliance report schedule.

    .EXAMPLE
        Get-LabReportSchedule | Remove-LabReportSchedule
        Removes all report scheduled tasks (with confirmation).

    .OUTPUTS
        [bool] True if task was removed, false otherwise.
    #>
    [CmdletBinding(SupportsShouldProcess)]
    [OutputType([bool])]
    param(
        [Parameter(Mandatory, ValueFromPipeline, ValueFromPipelineByPropertyName)]
        [string]$TaskName
    )

    begin {
        $removedCount = 0
    }

    process {
        $task = Get-ScheduledTask -TaskName $TaskName -ErrorAction SilentlyContinue

        if ($null -eq $task) {
            Write-Warning "Scheduled task '$TaskName' not found"
            return $false
        }

        if ($PSCmdlet.ShouldProcess($TaskName, 'Remove scheduled report task')) {
            try {
                Unregister-ScheduledTask -TaskName $TaskName -Confirm:$false -ErrorAction Stop
                Write-Host "`n  Removed scheduled task: $TaskName" -ForegroundColor Green
                $removedCount++
                return $true
            }
            catch {
                $PSCmdlet.WriteError(
                    [System.Management.Automation.ErrorRecord]::new(
                        [System.Exception]::new("Failed to remove scheduled task '$TaskName' - $_", $_.Exception),
                        'Remove-LabReportSchedule.Failure',
                        [System.Management.Automation.ErrorCategory]::FromStdErr,
                        $null
                    )
                )
                return $false
            }
        }

        return $false
    }

    end {
        if ($removedCount -gt 1) {
            Write-Host "`n  Removed $removedCount scheduled report tasks." -ForegroundColor Green
        }
    }
}
```

This function follows the pattern from Remove-LabTTL.ps1 (Phase 26). It supports pipeline input for batch removal, includes ShouldProcess for confirmation, provides -WhatIf support for safe preview, and returns boolean success status. The function handles missing tasks gracefully with a warning message.
  </action>
  <verify>Remove-LabReportSchedule -TaskName 'AutomatedLabReport_Compliance_daily' removes the scheduled task</verify>
  <done>Remove-LabReportSchedule function exists and removes scheduled report tasks</done>
</task>

<task type="auto">
  <name>Add report schedule functions to module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Update both SimpleLab.psm1 and SimpleLab.psd1 to export the three new public functions.

In SimpleLab.psm1 (around line 45), add 'Schedule-LabReport', 'Get-LabReportSchedule', 'Remove-LabReportSchedule' to the Export-ModuleMember array. Maintain alphabetical ordering within the exports list.

In SimpleLab.psd1, add these three functions to the FunctionsToExport array in the same position.

This follows the established pattern for public API functions from Phases 26-31.
  </action>
  <verify>Get-Command Schedule-LabReport, Get-LabReportSchedule, Remove-LabReportSchedule -Module SimpleLab all return command info</verify>
  <done>All three report schedule functions are exported from the SimpleLab module</done>
</task>

<task type="auto">
  <name>Create unit tests for scheduled report functionality</name>
  <files>Tests/LabReportSchedule.Tests.ps1</files>
  <action>
Create Tests/LabReportSchedule.Tests.ps1 with comprehensive test coverage:

```powershell
BeforeAll {
    $ModulePath = Join-Path (Join-Path (Join-Path $PSScriptRoot '..') SimpleLab) 'SimpleLab.psm1'
    Import-Module $ModulePath -Force

    . (Join-Path (Join-Path $PSScriptRoot '..') Private) 'Get-LabReportScheduleConfig.ps1'

    $GlobalLabConfig = @{
        ReportSchedule = @{
            Enabled         = $true
            TaskPrefix      = 'TestAutomatedLabReport'
            OutputBasePath  = 'TestDrive:/reports/scheduled'
        }
        Lab = @{
            LabName = 'TestLab'
        }
    }

    $testTaskName = 'TestAutomatedLabReport_Compliance_daily'
}

AfterEach {
    Get-ScheduledTask -TaskName $testTaskName -ErrorAction SilentlyContinue | Unregister-ScheduledTask -Confirm:$false -ErrorAction SilentlyContinue
}

Describe 'Get-LabReportScheduleConfig' {
    It 'Returns report schedule configuration with all properties' {
        $config = Get-LabReportScheduleConfig

        $config.Enabled | Should -Be $true
        $config.TaskPrefix | Should -Be 'TestAutomatedLabReport'
        $config.OutputBasePath | Should -Be 'TestDrive:/reports/scheduled'
    }

    It 'Provides safe defaults when ReportSchedule block is missing' {
        $GlobalLabConfig.Remove('ReportSchedule')

        $config = Get-LabReportScheduleConfig

        $config.Enabled | Should -Be $true
        $config.TaskPrefix | Should -Be 'AutomatedLabReport'
        $config.OutputBasePath | Should -Be '.planning/reports/scheduled'
    }
}

Describe 'Invoke-ScheduledReport' {
    It 'Generates compliance report when invoked' {
        Mock Get-LabComplianceReport { return 'TestDrive:/compliance.html' }

        Invoke-ScheduledReport -ReportType Compliance -OutputPath 'TestDrive:/reports' -LabName 'TestLab'

        Should -Invoke Get-LabComplianceReport -Times 1 -Exactly
    }

    It 'Generates resource report when invoked' {
        Mock Get-LabResourceReport { return 'TestDrive:/resources.html' }

        Invoke-ScheduledReport -ReportType Resource -OutputPath 'TestDrive:/reports' -LabName 'TestLab'

        Should -Invoke Get-LabResourceReport -Times 1 -Exactly
    }
}

Describe 'Schedule-LabReport' {
    It 'Creates daily scheduled task for compliance report' {
        $taskName = Schedule-LabReport -ReportType Compliance -Frequency Daily

        $taskName | Should -Not -BeNullOrEmpty

        $task = Get-ScheduledTask -TaskName $taskName
        $task | Should -Not -BeNullOrEmpty
        $task.Triggers | Should -Not -BeNullOrEmpty
    }

    It 'Creates weekly scheduled task for resource report' {
        $taskName = Schedule-LabReport -ReportType Resource -Frequency Weekly -DaysOfWeek Monday, Friday

        $taskName | Should -Not -BeNullOrEmpty

        $task = Get-ScheduledTask -TaskName $taskName
        $task | Should -Not -BeNullOrEmpty
        $task.Triggers[0].DaysOfWeek | Should -HaveCount 2
    }

    It 'Returns null when report scheduling is disabled' {
        $GlobalLabConfig.ReportSchedule.Enabled = $false

        $taskName = Schedule-LabReport -ReportType Compliance -Frequency Daily

        $taskName | Should -BeNullOrEmpty
    }

    It 'Supports -WhatIf for safe preview' {
        $taskName = Schedule-LabReport -ReportType Compliance -Frequency Daily -WhatIf

        $taskName | Should -BeNullOrEmpty

        $task = Get-ScheduledTask -TaskName "$($GlobalLabConfig.ReportSchedule.TaskPrefix)_Compliance_daily" -ErrorAction SilentlyContinue
        $task | Should -BeNullOrEmpty
    }
}

Describe 'Get-LabReportSchedule' {
    BeforeEach {
        Schedule-LabReport -ReportType Compliance -Frequency Daily | Out-Null
    }

    AfterEach {
        Get-ScheduledTask -TaskName "$($GlobalLabConfig.ReportSchedule.TaskPrefix)_Compliance_daily" -ErrorAction SilentlyContinue | Unregister-ScheduledTask -Confirm:$false -ErrorAction SilentlyContinue
    }

    It 'Lists all report scheduled tasks' {
        $tasks = Get-LabReportSchedule

        $tasks | Should -HaveCount 1
        $tasks[0].TaskName | Should -BeLike '*Compliance*'
    }

    It 'Returns empty array when no tasks exist' {
        Get-ScheduledTask -TaskName "$($GlobalLabConfig.ReportSchedule.TaskPrefix)_Compliance_daily" -ErrorAction SilentlyContinue | Unregister-ScheduledTask -Confirm:$false -ErrorAction SilentlyContinue

        $tasks = Get-LabReportSchedule

        $tasks | Should -BeOfType [System.Object[]]
        $tasks.Count | Should -Be 0
    }
}

Describe 'Remove-LabReportSchedule' {
    BeforeEach {
        Schedule-LabReport -ReportType Compliance -Frequency Daily | Out-Null
    }

    It 'Removes scheduled report task' {
        $taskName = "$($GlobalLabConfig.ReportSchedule.TaskPrefix)_Compliance_daily"

        $result = Remove-LabReportSchedule -TaskName $taskName

        $result | Should -Be $true

        $task = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
        $task | Should -BeNullOrEmpty
    }

    It 'Supports pipeline input' {
        $tasks = Get-LabReportSchedule

        $tasks | Remove-LabReportSchedule

        $remainingTasks = Get-ScheduledTask -TaskName "$($GlobalLabConfig.ReportSchedule.TaskPrefix)*" -ErrorAction SilentlyContinue
        $remainingTasks | Should -BeNullOrEmpty
    }

    It 'Returns false when task does not exist' {
        $result = Remove-LabReportSchedule -TaskName 'NonExistentTask'

        $result | Should -Be $false
    }
}
```

These tests follow the Pester 5.x pattern established in Phase 26-30. They verify config reading with safe defaults, scheduled task creation for daily and weekly frequencies, task listing, task removal, ShouldProcess/-WhatIf support, and error handling for missing or disabled configurations.
  </action>
  <verify>Invoke-Pester -Path Tests/LabReportSchedule.Tests.ps1 passes all tests</verify>
  <done>Unit tests exist and pass for scheduled report functionality</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1` succeeds
2. Test config: Get-LabReportScheduleConfig returns object with Enabled, TaskPrefix, OutputBasePath
3. Test schedule creation: Schedule-LabReport -ReportType Compliance -Frequency Daily creates a Windows Scheduled Task
4. Test weekly schedule: Schedule-LabReport -ReportType Resource -Frequency Weekly -DaysOfWeek Monday,Friday creates a task with correct trigger
5. Test schedule listing: Get-LabReportSchedule lists all report scheduled tasks
6. Test schedule removal: Remove-LabReportSchedule removes a scheduled task
7. Test Invoke-ScheduledReport: Invoke-ScheduledReport generates a report when called
8. Test module exports: All three functions are exported from SimpleLab module
</verification>

<success_criteria>
1. ReportSchedule configuration block exists in Lab-Config.ps1
2. Get-LabReportScheduleConfig helper reads configuration with safe defaults
3. Schedule-LabReport creates Windows Scheduled Tasks for daily and weekly report generation
4. Get-LabReportSchedule lists all report scheduled tasks with configuration details
5. Remove-LabReportSchedule removes scheduled tasks with ShouldProcess support
6. Invoke-ScheduledReport generates both compliance and resource reports
7. All three public functions are exported from SimpleLab module
8. Unit tests verify scheduled task creation, listing, and removal
</success_criteria>

<output>
After completion, create `.planning/phases/31-advanced-reporting/31-03-SUMMARY.md` with:
- Actual files created with line counts
- Scheduled task naming convention documentation
- Task trigger configuration examples
- Any deviations from plan
- Next steps for Plan 31-04
</output>
