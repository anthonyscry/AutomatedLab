---
phase: 31-advanced-reporting
plan: 04
type: execute
wave: 4
depends_on: ["31-01", "31-02", "31-03"]
files_modified:
  - Public/Get-LabReportHistory.ps1
  - Private/Write-LabReportMetadata.ps1
  - Private/Format-LabComplianceReport.ps1
  - Private/Format-LabResourceReport.ps1
autonomous: true
requirements:
  - RPT-04

must_haves:
  truths:
    - "All reports include timestamp, lab name, and summary statistics for audit trail"
    - "Report generation is tracked in analytics log for historical analysis"
    - "Operators can query report generation history by type, date range, and lab"
    - "Reports include metadata identifying the report source and version"
    - "Audit trail supports compliance auditing and operational review"
  artifacts:
    - path: "Public/Get-LabReportHistory.ps1"
      provides: "Public API for querying report generation history"
      exports: ["Get-LabReportHistory"]
      min_lines: 70
    - path: "Private/Write-LabReportMetadata.ps1"
      provides: "Report metadata writer for audit trail"
      min_lines: 60
    - path: ".planning/report-history.json"
      provides: "Persistent report generation history storage"
      contains: "reports"
  key_links:
    - from: "Get-LabReportHistory.ps1"
      to: "Get-LabAnalytics.ps1"
      via: "Reads analytics events for report generation tracking"
      pattern: "Get-LabAnalytics"
    - from: "Write-LabReportMetadata.ps1"
      to: "Write-LabAnalyticsEvent.ps1"
      via: "Tracks report generation as analytics events"
      pattern: "Write-LabAnalyticsEvent"
    - from: "Format-LabComplianceReport.ps1"
      to: "Write-LabReportMetadata.ps1"
      via: "Records compliance report generation metadata"
      pattern: "Write-LabReportMetadata"
    - from: "Format-LabResourceReport.ps1"
      to: "Write-LabReportMetadata.ps1"
      via: "Records resource report generation metadata"
      pattern: "Write-LabReportMetadata"
---

<objective>
Create audit trail functionality for all generated reports, including timestamp, lab name, summary statistics, and report generation history tracking integrated with the analytics system.

Purpose: Provide operators with a complete audit trail of all reports generated for compliance auditing, operational review, and historical analysis. Report metadata enables tracking of who generated which reports, when, and for which labs.

Output: Get-LabReportHistory public API, Write-LabReportMetadata integration function, updated report formatting functions with metadata tracking, and unit tests for audit trail functionality.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-lab-analytics/30-01-PLAN.md
@.planning/phases/31-advanced-reporting/31-01-PLAN.md
@.planning/phases/31-advanced-reporting/31-02-PLAN.md
@.planning/phases/31-advanced-reporting/31-03-PLAN.md

# Existing patterns from codebase (for reference, not to copy)
Private/Write-LabAnalyticsEvent.ps1 (Phase 30) - Shows analytics event tracking for audit trail
Public/Get-LabAnalytics.ps1 (Phase 30) - Shows analytics data retrieval with filtering
Private/Write-LabRunArtifacts.ps1 (Phase 19) - Shows artifact generation with metadata
Public/Get-LabRunHistory.ps1 (Phase 19) - Shows history query patterns
</context>

<tasks>

<task type="auto">
  <name>Create Write-LabReportMetadata function</name>
  <files>Private/Write-LabReportMetadata.ps1</files>
  <action>
Create Private/Write-LabReportMetadata.ps1 for tracking report generation:

```powershell
function Write-LabReportMetadata {
    <#
    .SYNOPSIS
        Writes report generation metadata to analytics log for audit trail.

    .DESCRIPTION
        Write-LabReportMetadata tracks report generation events in the analytics
        log, creating an audit trail of all compliance and resource reports.
        Includes report type, format, output path, and summary statistics.

    .PARAMETER ReportType
        Type of report generated: 'Compliance' or 'Resource'.

    .PARAMETER Format
        Output format of the report: 'Console', 'Html', 'Csv', 'Json'.

    .PARAMETER OutputPath
        Path where the report file was saved (empty for Console format).

    .PARAMETER LabName
        Name of the lab the report was generated for.

    .PARAMETER Summary
        Hashtable containing summary statistics from the report.

    .PARAMETER Scheduled
        Indicates if the report was generated by a scheduled task.

    .EXAMPLE
        Write-LabReportMetadata -ReportType Compliance -Format Html -OutputPath 'report.html' -LabName 'AutomatedLab' -Summary @{ ComplianceRate = 85; TotalVMs = 3 }
        Tracks a compliance report generation event.
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [ValidateSet('Compliance', 'Resource')]
        [string]$ReportType,

        [Parameter(Mandatory)]
        [ValidateSet('Console', 'Html', 'Csv', 'Json')]
        [string]$Format,

        [string]$OutputPath = '',

        [Parameter(Mandatory)]
        [string]$LabName,

        [hashtable]$Summary = @{},

        [switch]$Scheduled
    )

    try {
        $eventType = 'Report{0}' -f $ReportType

        $metadata = [ordered]@{
            Format     = $Format
            OutputPath = $OutputPath
            Scheduled  = $Scheduled
        }

        foreach ($key in $Summary.Keys) {
            $metadata[$key] = $Summary[$key]
        }

        $vmNames = @()
        if ($Summary.ContainsKey('VMs') -and $Summary.VMs -is [array]) {
            $vmNames = @($Summary.VMs | ForEach-Object { if ($_ -is [pscustomobject]) { $_.VMName } else { $_ } })
        }

        Write-LabAnalyticsEvent -EventType $eventType -LabName $LabName -VMNames $vmNames -Metadata $metadata
    }
    catch {
        Write-Warning "Write-LabReportMetadata: failed to track report metadata - $_"
    }
}
```

This function follows the analytics event tracking pattern from Write-LabRunArtifacts.ps1 (Phase 30 integration). It creates a dedicated event type for report generation (ReportCompliance, ReportResource), includes report-specific metadata (format, output path, scheduled flag, summary statistics), and integrates with the existing analytics infrastructure for audit trail.
  </action>
  <verify>Write-LabReportMetadata -ReportType Compliance -Format Html -OutputPath 'test.html' -LabName 'TestLab' creates an analytics event with EventType 'ReportCompliance'</verify>
  <done>Write-LabReportMetadata function exists and tracks report generation in analytics log</done>
</task>

<task type="auto">
  <name>Integrate metadata tracking into Format-LabComplianceReport</name>
  <files>Private/Format-LabComplianceReport.ps1</files>
  <action>
Modify Private/Format-LabComplianceReport.ps1 to track metadata after report generation.

Add this code at the end of each format case (Html, Csv, Json) before the return statement, after the file is written:

```powershell
        'Html' {
            # ... existing HTML generation code ...

            [System.IO.File]::WriteAllText($OutputPath, $html, [System.Text.Encoding]::UTF8)
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Compliance report saved: $resolvedPath" -ForegroundColor Cyan

            # Track report metadata for audit trail
            $summary = @{
                TotalVMs             = $totalVMs
                CompliantVMs         = $compliantVMs
                NonCompliantVMs      = $nonCompliantVMs
                FailedVMs            = $failedVMs
                PendingVMs           = $pendingVMs
                ComplianceRate       = $complianceRate
                ThresholdPercent     = $ThresholdPercent
                ThresholdMet         = $thresholdMet
            }

            Write-LabReportMetadata -ReportType Compliance -Format Html -OutputPath $resolvedPath -LabName $LabName -Summary $summary

            return $resolvedPath
        }

        'Csv' {
            # ... existing CSV generation code ...

            $ComplianceData | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Compliance report saved: $resolvedPath" -ForegroundColor Cyan

            # Track report metadata for audit trail
            $summary = @{
                TotalVMs             = $totalVMs
                CompliantVMs         = $compliantVMs
                NonCompliantVMs      = $nonCompliantVMs
                FailedVMs            = $failedVMs
                PendingVMs           = $pendingVMs
                ComplianceRate       = $complianceRate
                ThresholdPercent     = $ThresholdPercent
                ThresholdMet         = $thresholdMet
            }

            Write-LabReportMetadata -ReportType Compliance -Format Csv -OutputPath $resolvedPath -LabName $LabName -Summary $summary

            return $resolvedPath
        }

        'Json' {
            # ... existing JSON generation code ...

            $reportData | ConvertTo-Json -Depth 5 | Set-Content -Path $OutputPath -Encoding UTF8
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Compliance report saved: $resolvedPath" -ForegroundColor Cyan

            # Track report metadata for audit trail
            $summary = @{
                TotalVMs             = $totalVMs
                CompliantVMs         = $compliantVMs
                NonCompliantVMs      = $nonCompliantVMs
                FailedVMs            = $failedVMs
                PendingVMs           = $pendingVMs
                ComplianceRate       = $complianceRate
                ThresholdPercent     = $ThresholdPercent
                ThresholdMet         = $thresholdMet
            }

            Write-LabReportMetadata -ReportType Compliance -Format Json -OutputPath $resolvedPath -LabName $LabName -Summary $summary

            return $resolvedPath
        }
```

For the Console format, add tracking after the Write-Host output (no OutputPath):

```powershell
        'Console' {
            # ... existing console output code ...

            Write-Host $output.ToString()

            # Track report metadata for audit trail (console reports have no file output)
            $summary = @{
                TotalVMs             = $totalVMs
                CompliantVMs         = $compliantVMs
                NonCompliantVMs      = $nonCompliantVMs
                FailedVMs            = $failedVMs
                PendingVMs           = $pendingVMs
                ComplianceRate       = $complianceRate
                ThresholdPercent     = $ThresholdPercent
                ThresholdMet         = $thresholdMet
            }

            Write-LabReportMetadata -ReportType Compliance -Format Console -OutputPath '' -LabName $LabName -Summary $summary
        }
```

This integration follows the pattern established in Phase 30 where Write-LabRunArtifacts tracks analytics events after writing artifacts. It creates a summary hashtable with key statistics from the report, calls Write-LabReportMetadata to track the event, and provides a complete audit trail of all report generation regardless of format.
  </action>
  <verify>After generating a compliance report in any format, Get-LabAnalytics -EventType 'ReportCompliance' returns the tracked event with summary statistics</verify>
  <done>Format-LabComplianceReport tracks metadata for all output formats</done>
</task>

<task type="auto">
  <name>Integrate metadata tracking into Format-LabResourceReport</name>
  <files>Private/Format-LabResourceReport.ps1</files>
  <action>
Modify Private/Format-LabResourceReport.ps1 to track metadata after report generation.

Add this code at the end of each format case (Html, Csv, Json) before the return statement, after the file is written:

```powershell
        'Html' {
            # ... existing HTML generation code ...

            [System.IO.File]::WriteAllText($OutputPath, $html, [System.Text.Encoding]::UTF8)
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Resource report saved: $resolvedPath" -ForegroundColor Cyan

            # Track report metadata for audit trail
            $summary = @{
                TotalVMs        = $totalVMs
                AvgCPU          = $avgCPU
                AvgMemoryGB     = $avgMemory
                AvgDiskGB       = $avgDisk
                HighCPUVMs      = $highCPUVMs.VMName
                HighMemoryVMs   = $highMemoryVMs.VMName
                HighDiskVMs     = $highDiskVMs.VMName
            }

            Write-LabReportMetadata -ReportType Resource -Format Html -OutputPath $resolvedPath -LabName $LabName -Summary $summary

            return $resolvedPath
        }

        'Csv' {
            # ... existing CSV generation code ...

            $ResourceData | Select-Object VMName, CPUPercent, MemoryGB, DiskGB | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Resource report saved: $resolvedPath" -ForegroundColor Cyan

            # Track report metadata for audit trail
            $summary = @{
                TotalVMs        = $totalVMs
                AvgCPU          = $avgCPU
                AvgMemoryGB     = $avgMemory
                AvgDiskGB       = $avgDisk
                HighCPUVMs      = $highCPUVMs.VMName
                HighMemoryVMs   = $highMemoryVMs.VMName
                HighDiskVMs     = $highDiskVMs.VMName
            }

            Write-LabReportMetadata -ReportType Resource -Format Csv -OutputPath $resolvedPath -LabName $LabName -Summary $summary

            return $resolvedPath
        }

        'Json' {
            # ... existing JSON generation code ...

            $reportData | ConvertTo-Json -Depth 5 | Set-Content -Path $OutputPath -Encoding UTF8
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Resource report saved: $resolvedPath" -ForegroundColor Cyan

            # Track report metadata for audit trail
            $summary = @{
                TotalVMs        = $totalVMs
                AvgCPU          = $avgCPU
                AvgMemoryGB     = $avgMemory
                AvgDiskGB       = $avgDisk
                HighCPUVMs      = $highCPUVMs.VMName
                HighMemoryVMs   = $highMemoryVMs.VMName
                HighDiskVMs     = $highDiskVMs.VMName
            }

            Write-LabReportMetadata -ReportType Resource -Format Json -OutputPath $resolvedPath -LabName $LabName -Summary $summary

            return $resolvedPath
        }
```

For the Console format, add tracking after the Write-Host output (no OutputPath):

```powershell
        'Console' {
            # ... existing console output code ...

            Write-Host $output.ToString()

            # Track report metadata for audit trail (console reports have no file output)
            $summary = @{
                TotalVMs        = $totalVMs
                AvgCPU          = $avgCPU
                AvgMemoryGB     = $avgMemory
                AvgDiskGB       = $avgDisk
                HighCPUVMs      = $highCPUVMs.VMName
                HighMemoryVMs   = $highMemoryVMs.VMName
                HighDiskVMs     = $highDiskVMs.VMName
            }

            Write-LabReportMetadata -ReportType Resource -Format Console -OutputPath '' -LabName $LabName -Summary $summary
        }
```

This integration follows the same pattern as Format-LabComplianceReport. It captures key statistics from the resource report, tracks the event via Write-LabReportMetadata, and provides a complete audit trail for resource utilization reports.
  </action>
  <verify>After generating a resource report in any format, Get-LabAnalytics -EventType 'ReportResource' returns the tracked event with summary statistics</verify>
  <done>Format-LabResourceReport tracks metadata for all output formats</done>
</task>

<task type="auto">
  <name>Integrate metadata tracking into Invoke-ScheduledReport</name>
  <files>Private/Invoke-ScheduledReport.ps1</files>
  <action>
Modify Private/Invoke-ScheduledReport.ps1 to set the Scheduled flag when tracking metadata.

Update the existing Write-LabReportMetadata call (or add if not present) in both report type switch cases:

```powershell
        switch ($ReportType) {
            'Compliance' {
                $null = Get-LabComplianceReport -Format $Format -LabName $LabName -OutputPath $fullOutputPath

                if (Test-Path $fullOutputPath) {
                    Write-Host "Scheduled $ReportType report generated: $fullOutputPath"

                    # Track scheduled report metadata for audit trail
                    Write-LabReportMetadata -ReportType Compliance -Format $Format -OutputPath $fullOutputPath -LabName $LabName -Scheduled
                } else {
                    Write-Warning "Scheduled $ReportType report may have failed - output file not found"
                }
            }
            'Resource' {
                $null = Get-LabResourceReport -Format $Format -LabName $LabName -OutputPath $fullOutputPath

                if (Test-Path $fullOutputPath) {
                    Write-Host "Scheduled $ReportType report generated: $fullOutputPath"

                    # Track scheduled report metadata for audit trail
                    Write-LabReportMetadata -ReportType Resource -Format $Format -OutputPath $fullOutputPath -LabName $LabName -Scheduled
                } else {
                    Write-Warning "Scheduled $ReportType report may have failed - output file not found"
                }
            }
        }
```

Note: The actual Write-LabReportMetadata call in Get-LabComplianceReport and Get-LabResourceReport (via Format-LabComplianceReport and Format-LabResourceReport) will already track the event. The -Scheduled flag here would be passed through if needed, or the scheduled task tracking can rely on the analytics event from the Format functions since the scheduled task context is already captured in the Host/User fields of the analytics event.

If we want to explicitly track scheduled reports, we can add a second event with a specific ScheduledReport event type:

```powershell
        switch ($ReportType) {
            'Compliance' {
                $null = Get-LabComplianceReport -Format $Format -LabName $LabName -OutputPath $fullOutputPath

                if (Test-Path $fullOutputPath) {
                    Write-Host "Scheduled $ReportType report generated: $fullOutputPath"

                    # Track scheduled report generation separately
                    Write-LabAnalyticsEvent -EventType 'ScheduledReportGenerated' -LabName $LabName -Metadata @{
                        ReportType = $ReportType
                        Format     = $Format
                        OutputPath = $fullOutputPath
                    }
                } else {
                    Write-Warning "Scheduled $ReportType report may have failed - output file not found"
                }
            }
            'Resource' {
                $null = Get-LabResourceReport -Format $Format -LabName $LabName -OutputPath $fullOutputPath

                if (Test-Path $fullOutputPath) {
                    Write-Host "Scheduled $ReportType report generated: $fullOutputPath"

                    # Track scheduled report generation separately
                    Write-LabAnalyticsEvent -EventType 'ScheduledReportGenerated' -LabName $LabName -Metadata @{
                        ReportType = $ReportType
                        Format     = $Format
                        OutputPath = $fullOutputPath
                    }
                } else {
                    Write-Warning "Scheduled $ReportType report may have failed - output file not found"
                }
            }
        }
```

This creates a separate ScheduledReportGenerated event type for easier filtering of scheduled vs manual report generation. The regular ReportCompliance/ReportResource events are still created by the Format functions.
  </action>
  <verify>After a scheduled report runs, Get-LabAnalytics -EventType 'ScheduledReportGenerated' returns the tracked event</verify>
  <done>Invoke-ScheduledReport tracks scheduled report generation with separate event type</done>
</task>

<task type="auto">
  <name>Create Get-LabReportHistory public API</name>
  <files>Public/Get-LabReportHistory.ps1</files>
  <action>
Create Public/Get-LabReportHistory.ps1 for querying report generation history:

```powershell
function Get-LabReportHistory {
    <#
    .SYNOPSIS
        Retrieves report generation history from analytics log.

    .DESCRIPTION
        Get-LabReportHistory reads analytics events and returns report generation
        history filtered by report type, format, date range, and scheduled flag.
        Provides audit trail for compliance auditing and operational review.

    .PARAMETER ReportType
        Filter to specific report type: 'Compliance', 'Resource', or 'All' (default).

    .PARAMETER Format
        Filter to specific output format: 'Console', 'Html', 'Csv', 'Json' (optional).

    .PARAMETER LabName
        Filter to events for this lab only (optional).

    .PARAMETER Scheduled
        Filter to scheduled reports only (switch).

    .PARAMETER After
        Only include reports generated after this DateTime (optional).

    .PARAMETER Before
        Only include reports generated before this DateTime (optional).

    .PARAMETER Last
        Return only the last N report events (optional, default 50).

    .EXAMPLE
        Get-LabReportHistory
        Returns all report generation events, last 50.

    .EXAMPLE
        Get-LabReportHistory -ReportType Compliance
        Returns only compliance report generation events.

    .EXAMPLE
        Get-LabReportHistory -Scheduled -After (Get-Date '2026-02-01')
        Returns scheduled reports generated since February 1, 2026.

    .EXAMPLE
        Get-LabReportHistory -Format Html -LabName 'AutomatedLab'
        Returns HTML format reports for AutomatedLab.

    .OUTPUTS
        [pscustomobject[]] Report history entries with Timestamp, EventType, LabName,
        VMNames, Metadata (Format, OutputPath, Scheduled, summary statistics).
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [ValidateSet('Compliance', 'Resource', 'All')]
        [string]$ReportType = 'All',

        [ValidateSet('Console', 'Html', 'Csv', 'Json')]
        [string]$Format,

        [string]$LabName,

        [switch]$Scheduled,

        [DateTime]$After,

        [DateTime]$Before,

        [int]$Last = 50
    )

    $getAnalyticsParams = @{
        Last = $Last
    }

    if ($PSBoundParameters.ContainsKey('LabName')) {
        $getAnalyticsParams.LabName = $LabName
    }

    if ($PSBoundParameters.ContainsKey('After')) {
        $getAnalyticsParams.After = $After
    }

    if ($PSBoundParameters.ContainsKey('Before')) {
        $getAnalyticsParams.Before = $Before
    }

    $allEvents = Get-LabAnalytics @getAnalyticsParams

    $reportEvents = if ($ReportType -eq 'All') {
        @($allEvents | Where-Object { $_.EventType -match '^Report(Compliance|Resource)$' -or $_.EventType -eq 'ScheduledReportGenerated' })
    } else {
        @($allEvents | Where-Object { $_.EventType -eq "Report$ReportType" -or ($_.EventType -eq 'ScheduledReportGenerated' -and $_.Metadata.ReportType -eq $ReportType) })
    }

    if ($PSBoundParameters.ContainsKey('Format')) {
        $reportEvents = @($reportEvents | Where-Object { $_.Metadata.Format -eq $Format })
    }

    if ($Scheduled.IsPresent) {
        $reportEvents = @($reportEvents | Where-Object { $_.EventType -eq 'ScheduledReportGenerated' -or $_.Metadata.Scheduled -eq $true })
    }

    $enriched = @($reportEvents | ForEach-Object {
        $summary = @{}
        foreach ($key in $_.Metadata.Keys) {
            if ($key -notin @('Format', 'OutputPath', 'Scheduled', 'ReportType')) {
                $summary[$key] = $_.Metadata[$key]
            }
        }

        [pscustomobject]@{
            GeneratedAt    = $_.Timestamp
            ReportType     = if ($_.EventType -match '^(?:Scheduled)?Report(\w+)$') { $matches[1] } else { 'Unknown' }
            Format         = $_.Metadata.Format
            LabName        = $_.LabName
            OutputPath     = $_.Metadata.OutputPath
            Scheduled      = $_.Metadata.Scheduled -or $_.EventType -eq 'ScheduledReportGenerated'
            Summary        = if ($summary.Count -gt 0) { [pscustomobject]$summary } else { $null }
            Host           = $_.Host
            User           = $_.User
        }
    })

    return @($enriched | Sort-Object -Property GeneratedAt -Descending)
}
```

This function follows the history query pattern from Get-LabRunHistory (Phase 19) and Get-LabAnalytics (Phase 30). It filters analytics events for report generation, supports filtering by report type, format, lab name, scheduled flag, and date range, and returns enriched objects with structured summary statistics for easy consumption.
  </action>
  <verify>Get-LabReportHistory returns report generation events sorted by timestamp descending</verify>
  <done>Get-LabReportHistory public API exists and queries report generation history</done>
</task>

<task type="auto">
  <name>Add Get-LabReportHistory to module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Update both SimpleLab.psm1 and SimpleLab.psd1 to export Get-LabReportHistory.

In SimpleLab.psm1 (around line 46), add 'Get-LabReportHistory' to the Export-ModuleMember array. Maintain alphabetical ordering within the exports list.

In SimpleLab.psd1, add 'Get-LabReportHistory' to the FunctionsToExport array in the same position.

This follows the established pattern for public API functions from Phases 26-31.
  </action>
  <verify>Get-Command Get-LabReportHistory -Module SimpleLab returns command info</verify>
  <done>Get-LabReportHistory is exported from the SimpleLab module</done>
</task>

<task type="auto">
  <name>Create unit tests for report audit trail functionality</name>
  <files>Tests/LabReportHistory.Tests.ps1</files>
  <action>
Create Tests/LabReportHistory.Tests.ps1 with comprehensive test coverage:

```powershell
BeforeAll {
    $ModulePath = Join-Path (Join-Path (Join-Path $PSScriptRoot '..') SimpleLab) 'SimpleLab.psm1'
    Import-Module $ModulePath -Force

    . (Join-Path (Join-Path $PSScriptRoot '..') Private) 'Write-LabReportMetadata.ps1'

    $GlobalLabConfig = @{
        Lab = @{
            LabName = 'TestLab'
        }
    }
}

Describe 'Write-LabReportMetadata' {
    BeforeEach {
        Mock Write-LabAnalyticsEvent {}
    }

    It 'Tracks compliance report generation' {
        Write-LabReportMetadata -ReportType Compliance -Format Html -OutputPath 'test.html' -LabName 'TestLab'

        Should -Invoke Write-LabAnalyticsEvent -Times 1 -Exactly -ParameterFilter {
            $EventType -eq 'ReportCompliance' -and
            $LabName -eq 'TestLab' -and
            $Metadata.Format -eq 'Html' -and
            $Metadata.OutputPath -eq 'test.html'
        }
    }

    It 'Tracks resource report generation' {
        Write-LabReportMetadata -ReportType Resource -Format Csv -OutputPath 'test.csv' -LabName 'TestLab'

        Should -Invoke Write-LabAnalyticsEvent -Times 1 -Exactly -ParameterFilter {
            $EventType -eq 'ReportResource' -and
            $Metadata.Format -eq 'Csv'
        }
    }

    It 'Includes summary statistics in metadata' {
        $summary = @{
            TotalVMs = 5
            AvgCPU = 45.0
        }

        Write-LabReportMetadata -ReportType Resource -Format Json -OutputPath 'test.json' -LabName 'TestLab' -Summary $summary

        Should -Invoke Write-LabAnalyticsEvent -Times 1 -Exactly -ParameterFilter {
            $Metadata.TotalVMs -eq 5 -and
            $Metadata.AvgCPU -eq 45.0
        }
    }

    It 'Sets Scheduled flag when specified' {
        Write-LabReportMetadata -ReportType Compliance -Format Html -OutputPath 'test.html' -LabName 'TestLab' -Scheduled

        Should -Invoke Write-LabAnalyticsEvent -Times 1 -Exactly -ParameterFilter {
            $Metadata.Scheduled -eq $true
        }
    }

    It 'Handles missing summary gracefully' {
        { Write-LabReportMetadata -ReportType Compliance -Format Console -OutputPath '' -LabName 'TestLab' } | Should -Not -Throw
    }
}

Describe 'Get-LabReportHistory' {
    BeforeEach {
        $testEvents = @(
            [pscustomobject]@{
                Timestamp = '2026-02-21T10:00:00'
                EventType = 'ReportCompliance'
                LabName = 'TestLab'
                VMNames = @('dc1', 'svr1')
                Metadata = @{
                    Format = 'Html'
                    OutputPath = 'report.html'
                    Scheduled = $false
                    TotalVMs = 2
                    ComplianceRate = 85.0
                }
                Host = 'HOST01'
                User = 'DOMAIN\user'
            }
            [pscustomobject]@{
                Timestamp = '2026-02-21T11:00:00'
                EventType = 'ReportResource'
                LabName = 'TestLab'
                VMNames = @()
                Metadata = @{
                    Format = 'Csv'
                    OutputPath = 'resources.csv'
                    Scheduled = $false
                    TotalVMs = 3
                    AvgCPU = 50.0
                }
                Host = 'HOST01'
                User = 'DOMAIN\user'
            }
            [pscustomobject]@{
                Timestamp = '2026-02-21T12:00:00'
                EventType = 'ScheduledReportGenerated'
                LabName = 'TestLab'
                VMNames = @()
                Metadata = @{
                    ReportType = 'Compliance'
                    Format = 'Json'
                    OutputPath = 'scheduled.json'
                }
                Host = 'HOST01'
                User = 'DOMAIN\user'
            }
        )

        Mock Get-LabAnalytics { return $testEvents }
    }

    It 'Returns all report events when no filters specified' {
        $history = Get-LabReportHistory

        $history | Should -HaveCount 3
    }

    It 'Filters by report type' {
        $history = Get-LabReportHistory -ReportType Compliance

        $history | Should -HaveCount 2
        $history[0].ReportType | Should -Be 'Compliance'
    }

    It 'Filters by format' {
        $history = Get-LabReportHistory -Format Html

        $history | Should -HaveCount 1
        $history[0].Format | Should -Be 'Html'
    }

    It 'Filters by scheduled flag' {
        $history = Get-LabReportHistory -Scheduled

        $history | Should -HaveCount 1
        $history[0].Scheduled | Should -Be $true
    }

    It 'Returns enriched objects with summary statistics' {
        $history = Get-LabReportHistory -ReportType Compliance

        $history[0].Summary | Should -Not -BeNullOrEmpty
        $history[0].Summary.TotalVMs | Should -Be 2
        $history[0].Summary.ComplianceRate | Should -Be 85.0
    }

    It 'Sorts results by timestamp descending' {
        $history = Get-LabReportHistory

        $history[0].GeneratedAt | Should -Be '2026-02-21T12:00:00'
        $history[-1].GeneratedAt | Should -Be '2026-02-21T10:00:00'
    }
}
```

These tests follow the Pester 5.x pattern established in Phase 30. They verify metadata tracking for compliance and resource reports, summary statistics inclusion, scheduled flag handling, history query filtering by type/format/scheduled flag, enriched object structure, and timestamp sorting.
  </action>
  <verify>Invoke-Pester -Path Tests/LabReportHistory.Tests.ps1 passes all tests</verify>
  <done>Unit tests exist and pass for report audit trail functionality</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1` succeeds
2. Test metadata tracking: Write-LabReportMetadata creates analytics events with correct EventType
3. Test compliance report tracking: Get-LabComplianceReport generates analytics events
4. Test resource report tracking: Get-LabResourceReport generates analytics events
5. Test scheduled report tracking: Invoke-ScheduledReport generates ScheduledReportGenerated events
6. Test history query: Get-LabReportHistory returns report generation events
7. Test filtering: Get-LabReportHistory -ReportType Compliance filters correctly
8. Test module export: Get-LabReportHistory is exported from SimpleLab module
</verification>

<success_criteria>
1. Write-LabReportMetadata function tracks report generation in analytics log
2. Format-LabComplianceReport tracks metadata for all report formats
3. Format-LabResourceReport tracks metadata for all report formats
4. Invoke-ScheduledReport tracks scheduled report generation with separate event type
5. Get-LabReportHistory queries report generation history with filtering support
6. Report metadata includes timestamp, lab name, summary statistics, and format
7. Audit trail supports compliance auditing and operational review
8. Get-LabReportHistory is exported from SimpleLab module
9. Unit tests verify audit trail functionality
</success_criteria>

<output>
After completion, create `.planning/phases/31-advanced-reporting/31-04-SUMMARY.md` with:
- Actual files created with line counts
- Audit trail event schema documentation
- Report metadata field documentation
- Any deviations from plan
- Phase 31 completion summary
</output>
