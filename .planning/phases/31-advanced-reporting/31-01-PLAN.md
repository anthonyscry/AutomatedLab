---
phase: 31-advanced-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Public/Get-LabSTIGCompliance.ps1
  - Private/Get-LabSTIGConfig.ps1
  - Lab-Config.ps1
autonomous: true
requirements:
  - RPT-01

must_haves:
  truths:
    - "Operator can generate compliance reports showing STIG status across all VMs"
    - "Compliance reports include pass/fail summary statistics"
    - "Reports can be generated in multiple formats (console, HTML, CSV, JSON)"
    - "Compliance data is read from the STIG compliance cache written in Phase 27"
    - "Reports group by VM, role, and compliance status for easy scanning"
  artifacts:
    - path: "Public/Get-LabComplianceReport.ps1"
      provides: "Public API for generating compliance reports"
      exports: ["Get-LabComplianceReport"]
      min_lines: 80
    - path: "Private/Format-LabComplianceReport.ps1"
      provides: "Core report formatting logic for multiple output formats"
      min_lines: 120
    - path: "Lab-Config.ps1"
      provides: "Reports configuration block"
      contains: "Reports"
  key_links:
    - from: "Get-LabComplianceReport.ps1"
      to: "Get-LabSTIGCompliance.ps1"
      via: "Reads STIG compliance cache for report data"
      pattern: "Get-LabSTIGCompliance"
    - from: "Get-LabComplianceReport.ps1"
      to: "Get-LabSTIGConfig.ps1"
      via: "Reads STIG configuration for report settings"
      pattern: "Get-LabSTIGConfig"
    - from: "Format-LabComplianceReport.ps1"
      to: "New-LabDeploymentReport.ps1"
      via: "Reuses HTML formatting patterns from deployment reports"
      pattern: "HTML|format"
---

<objective>
Create compliance report generation functionality that produces STIG compliance summaries across all lab VMs with pass/fail statistics and multiple output formats.

Purpose: Enable operators to quickly assess the security posture of their lab environment by generating comprehensive compliance reports that aggregate STIG status data collected during Phase 27 baseline application.

Output: Get-LabComplianceReport public API, Format-LabComplianceReport core formatting function, Reports configuration block in Lab-Config.ps1, and unit tests for report generation.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-powerstig-dsc-baselines/27-CONTEXT.md
@.planning/phases/27-powerstig-dsc-baselines/27-RESEARCH.md

# Existing patterns from codebase (for reference, not to copy)
Public/Get-LabSTIGCompliance.ps1 (Phase 27) - Shows STIG compliance cache reading
Private/New-LabDeploymentReport.ps1 - Shows HTML report generation patterns
Public/Get-LabAnalytics.ps1 (Phase 30) - Shows data reading with filtering support
Private/Format-LabComplianceReport.ps1 will follow New-LabDeploymentReport.ps1 patterns for HTML generation
</context>

<tasks>

<task type="auto">
  <name>Add Reports configuration block to Lab-Config.ps1</name>
  <files>Lab-Config.ps1</files>
  <action>
Add the Reports configuration block to Lab-Config.ps1 after the Analytics block (around line 268).

The configuration should follow the existing pattern:
```powershell
    Reports = @{
        # Changing ComplianceReportPath sets where compliance reports are saved.
        ComplianceReportPath = '.planning/reports/compliance'
        # Changing IncludeDetailedResults toggles verbose rule-level details in reports.
        IncludeDetailedResults = $false
        # Changing ComplianceThresholdPercent sets the warning threshold for compliance rate.
        ComplianceThresholdPercent = 80
        # Changing ReportFormats sets default output formats for compliance reports.
        # Valid values: 'Console', 'Html', 'Csv', 'Json'
        ReportFormats = @('Console', 'Html')
    }
```

This matches the pattern used for TTL, STIG, ADMX, Dashboard, and Analytics configuration blocks. ComplianceReportPath uses .planning/reports/ subdirectory for organized report storage. IncludeDetailedResults defaults to false to keep reports concise. ComplianceThresholdPercent provides a configurable warning threshold. ReportFormats allows operators to specify their preferred default output formats.
  </action>
  <verify>Test-Path variable:LabConfig.Reports returns $true after dot-sourcing Lab-Config.ps1</verify>
  <done>Reports block exists in Lab-Config.ps1 with ComplianceReportPath, IncludeDetailedResults, ComplianceThresholdPercent, and ReportFormats keys</done>
</task>

<task type="auto">
  <name>Create Get-LabReportsConfig helper function</name>
  <files>Private/Get-LabReportsConfig.ps1</files>
  <action>
Create Private/Get-LabReportsConfig.ps1 following the exact pattern of Get-LabSTIGConfig and Get-LabAnalyticsConfig:

```powershell
function Get-LabReportsConfig {
    <#
    .SYNOPSIS
        Reads reports configuration from global lab config.

    .DESCRIPTION
        Get-LabReportsConfig returns a Reports configuration object with safe
        defaults when keys are missing from $GlobalLabConfig. Contains ContainsKey
        guards for all nested keys to prevent errors under StrictMode.

    .OUTPUTS
        [pscustomobject] with ComplianceReportPath, IncludeDetailedResults,
        ComplianceThresholdPercent, ReportFormats properties.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $config = $GlobalLabConfig

    $complianceReportPath = if ($config.ContainsKey('Reports') -and $config.Reports.ContainsKey('ComplianceReportPath')) {
        [string]$config.Reports.ComplianceReportPath
    } else {
        '.planning/reports/compliance'
    }

    $includeDetailedResults = if ($config.ContainsKey('Reports') -and $config.Reports.ContainsKey('IncludeDetailedResults')) {
        [bool]$config.Reports.IncludeDetailedResults
    } else {
        $false
    }

    $complianceThresholdPercent = if ($config.ContainsKey('Reports') -and $config.Reports.ContainsKey('ComplianceThresholdPercent')) {
        [int]$config.Reports.ComplianceThresholdPercent
    } else {
        80
    }

    $reportFormats = if ($config.ContainsKey('Reports') -and $config.Reports.ContainsKey('ReportFormats')) {
        @([string[]]$config.Reports.ReportFormats)
    } else {
        @('Console', 'Html')
    }

    return [pscustomobject]@{
        ComplianceReportPath       = $complianceReportPath
        IncludeDetailedResults     = $includeDetailedResults
        ComplianceThresholdPercent = $complianceThresholdPercent
        ReportFormats              = $reportFormats
    }
}
```

This function follows the established config helper pattern from Phases 26-30. It provides ContainsKey guards for safe config access under StrictMode, returns type-casted values with safe defaults, and exports a PSCustomObject with all configuration fields.
  </action>
  <verify>Get-LabReportsConfig returns PSCustomObject with ComplianceReportPath='.planning/reports/compliance', IncludeDetailedResults=$false, ComplianceThresholdPercent=80, ReportFormats=@('Console', 'Html') when Reports block missing from $GlobalLabConfig</verify>
  <done>Get-LabReportsConfig helper exists and follows established config helper pattern</done>
</task>

<task type="auto">
  <name>Create Format-LabComplianceReport core formatting function</name>
  <files>Private/Format-LabComplianceReport.ps1</files>
  <action>
Create Private/Format-LabComplianceReport.ps1 with core report formatting logic:

```powershell
function Format-LabComplianceReport {
    <#
    .SYNOPSIS
        Formats compliance data into console, HTML, CSV, or JSON output.

    .DESCRIPTION
        Format-LabComplianceReport takes processed compliance data and generates
        formatted output in the specified format. Supports console tables,
        HTML reports with styling, CSV exports, and JSON exports. Includes
        pass/fail summary statistics and compliance rate calculations.

    .PARAMETER ComplianceData
        Processed compliance data with VMName, Role, Status, STIGVersion fields.

    .PARAMETER Format
        Output format: 'Console', 'Html', 'Csv', 'Json'.

    .PARAMETER LabName
        Name of the lab for the report header.

    .PARAMETER ThresholdPercent
        Compliance threshold percentage for warnings.

    .PARAMETER OutputPath
        Path to save the report file (required for Html, Csv, Json formats).

    .PARAMETER IncludeDetails
        Include detailed rule-level information if available.

    .OUTPUTS
        For Console: Formatted string output
        For Html/Csv/Json: Path to saved file
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [pscustomobject[]]$ComplianceData,

        [Parameter(Mandatory)]
        [ValidateSet('Console', 'Html', 'Csv', 'Json')]
        [string]$Format,

        [string]$LabName = 'AutomatedLab',

        [int]$ThresholdPercent = 80,

        [string]$OutputPath,

        [switch]$IncludeDetails
    )

    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    $totalVMs = $ComplianceData.Count
    $compliantVMs = @($ComplianceData | Where-Object { $_.Status -eq 'Compliant' }).Count
    $nonCompliantVMs = @($ComplianceData | Where-Object { $_.Status -eq 'NonCompliant' }).Count
    $failedVMs = @($ComplianceData | Where-Object { $_.Status -eq 'Failed' }).Count
    $pendingVMs = @($ComplianceData | Where-Object { $_.Status -eq 'Pending' }).Count

    $complianceRate = if ($totalVMs -gt 0) {
        [math]::Round(($compliantVMs / $totalVMs) * 100, 1)
    } else {
        0.0
    }

    $thresholdMet = $complianceRate -ge $ThresholdPercent

    switch ($Format) {
        'Console' {
            $output = [System.Text.StringBuilder]::new()
            [void]$output.AppendLine('')
            [void]$output.AppendLine('  +--------------------------------------------------------------+')
            [void]$output.AppendLine('  |                    COMPLIANCE REPORT                       |')
            [void]$output.AppendLine('  +--------------------------------------------------------------+')
            [void]$output.AppendLine("  Lab:           $LabName")
            [void]$output.AppendLine("  Generated:     $timestamp")
            [void]$output.AppendLine('')
            [void]$output.AppendLine('  SUMMARY')
            [void]$output.AppendLine('  -------')
            [void]$output.AppendLine("  Total VMs:         $totalVMs")
            [void]$output.AppendLine("  Compliant:         $compliantVMs")
            [void]$output.AppendLine("  Non-Compliant:     $nonCompliantVMs")
            [void]$output.AppendLine("  Failed:            $failedVMs")
            [void]$output.AppendLine("  Pending:           $pendingVMs")
            [void]$output.AppendLine("  Compliance Rate:   $complianceRate% (Threshold: $ThresholdPercent%)")

            if (-not $thresholdMet) {
                [void]$output.AppendLine('')
                [void]$output.AppendLine("  WARNING: Compliance rate below threshold of $ThresholdPercent%")
            }

            [void]$output.AppendLine('')
            [void]$output.AppendLine('  VM DETAILS')
            [void]$output.AppendLine('  -----------')
            [void]$output.AppendLine('  VM Name      Role      STIG Ver.   Status           Exceptions    Last Checked')
            [void]$output.AppendLine('  -------      ----      --------   ------           ----------    -----------')

            foreach ($vm in $ComplianceData) {
                $statusColor = switch ($vm.Status) {
                    'Compliant'     { 'OK' }
                    'NonCompliant'  { 'WARN' }
                    'Failed'        { 'FAIL' }
                    'Pending'       { 'PEND' }
                }

                [void]$output.AppendLine(("  {0,-12} {1,-8} {2,-10} {3,-16} {4,-12} {5}" -f
                    $vm.VMName,
                    $vm.Role,
                    $vm.STIGVersion,
                    $statusColor,
                    $vm.ExceptionsApplied,
                    $vm.LastChecked))
            }

            Write-Host $output.ToString()
        }

        'Html' {
            if (-not $OutputPath) {
                Write-Error "OutputPath is required for Html format"
                return
            }

            $statusColor = switch ($complianceRate) {
                { $_ -ge 90 } { '#a6e3a1' }
                { $_ -ge 80 } { '#f9e2af' }
                { $_ -ge 70 } { '#fab387' }
                default      { '#f38ba8' }
            }

            $vmRows = ($ComplianceData | ForEach-Object {
                $statusClass = switch ($_.Status) {
                    'Compliant'     { 'compliant' }
                    'NonCompliant'  { 'noncompliant' }
                    'Failed'        { 'failed' }
                    'Pending'       { 'pending' }
                }
                ("        <tr class=`"$statusClass`"><td>$($_.VMName)</td><td>$($_.Role)</td><td>$($_.STIGVersion)</td><td>$($_.Status)</td><td>$($_.ExceptionsApplied)</td><td>$($_.LastChecked)</td></tr>")
            }) -join "`n"

            $html = @"
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Compliance Report - $LabName</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 40px; background: #1e1e2e; color: #cdd6f4; }
  h1 { color: #cba6f7; border-bottom: 2px solid #45475a; padding-bottom: 10px; }
  .meta { color: #a6adc8; margin-bottom: 20px; }
  .meta span { display: inline-block; margin-right: 30px; }
  .summary { background: #313244; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
  .summary h2 { margin-top: 0; color: #89b4fa; }
  .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
  .stat-box { background: #45475a; padding: 15px; border-radius: 6px; text-align: center; }
  .stat-value { font-size: 2em; font-weight: bold; color: #f38ba8; }
  .stat-label { color: #a6adc8; font-size: 0.9em; }
  .compliance-rate { text-align: center; padding: 20px; }
  .rate-value { font-size: 3em; font-weight: bold; color: $statusColor; }
  .rate-label { color: #a6adc8; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th { background: #313244; color: #cba6f7; padding: 10px 15px; text-align: left; }
  td { padding: 8px 15px; border-bottom: 1px solid #45475a; }
  tr.compliant td:last-child { color: #a6e3a1; font-weight: bold; }
  tr.noncompliant td:last-child { color: #f9e2af; font-weight: bold; }
  tr.failed td:last-child { color: #f38ba8; font-weight: bold; }
  tr.pending td:last-child { color: #94e2d5; font-weight: bold; }
  .footer { margin-top: 30px; color: #6c7086; font-size: 0.85em; }
</style>
</head>
<body>
  <h1>STIG Compliance Report</h1>
  <div class="meta">
    <span>Lab: <strong>$LabName</strong></span>
    <span>Generated: <strong>$timestamp</strong></span>
  </div>

  <div class="summary">
    <h2>Compliance Summary</h2>
    <div class="stat-grid">
      <div class="stat-box">
        <div class="stat-value">$totalVMs</div>
        <div class="stat-label">Total VMs</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">$compliantVMs</div>
        <div class="stat-label">Compliant</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">$nonCompliantVMs</div>
        <div class="stat-label">Non-Compliant</div>
      </div>
    </div>
  </div>

  <div class="compliance-rate">
    <div class="rate-value">$complianceRate%</div>
    <div class="rate-label">Compliance Rate (Threshold: $ThresholdPercent%)</div>
  </div>

  <table>
    <thead>
      <tr><th>VM Name</th><th>Role</th><th>STIG Version</th><th>Status</th><th>Exceptions</th><th>Last Checked</th></tr>
    </thead>
    <tbody>
$vmRows
    </tbody>
  </table>

  <div class="footer">Generated by AutomatedLab on $timestamp</div>
</body>
</html>
"@

            $parentDir = Split-Path -Parent $OutputPath
            if (-not [string]::IsNullOrWhiteSpace($parentDir) -and -not (Test-Path $parentDir)) {
                $null = New-Item -Path $parentDir -ItemType Directory -Force
            }

            [System.IO.File]::WriteAllText($OutputPath, $html, [System.Text.Encoding]::UTF8)
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Compliance report saved: $resolvedPath" -ForegroundColor Cyan
            return $resolvedPath
        }

        'Csv' {
            if (-not $OutputPath) {
                Write-Error "OutputPath is required for Csv format"
                return
            }

            $ComplianceData | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Compliance report saved: $resolvedPath" -ForegroundColor Cyan
            return $resolvedPath
        }

        'Json' {
            if (-not $OutputPath) {
                Write-Error "OutputPath is required for Json format"
                return
            }

            $reportData = [pscustomobject]@{
                LabName            = $LabName
                GeneratedAt        = $timestamp
                Summary            = [pscustomobject]@{
                    TotalVMs             = $totalVMs
                    CompliantVMs         = $compliantVMs
                    NonCompliantVMs      = $nonCompliantVMs
                    FailedVMs            = $failedVMs
                    PendingVMs           = $pendingVMs
                    ComplianceRate       = $complianceRate
                    ThresholdPercent     = $ThresholdPercent
                    ThresholdMet         = $thresholdMet
                }
                VMs                = $ComplianceData
            }

            $reportData | ConvertTo-Json -Depth 5 | Set-Content -Path $OutputPath -Encoding UTF8
            $resolvedPath = (Resolve-Path $OutputPath).Path
            Write-Host "`n  Compliance report saved: $resolvedPath" -ForegroundColor Cyan
            return $resolvedPath
        }
    }
}
```

This function follows the HTML formatting pattern from New-LabDeploymentReport.ps1. It provides consistent styling with the existing report format, calculates summary statistics including compliance rate against threshold, and supports multiple output formats (Console, Html, Csv, Json). The HTML output uses the same color scheme as deployment reports for consistency.
  </action>
  <verify>Format-LabComplianceReport -Format Console -ComplianceData @() displays console output with summary statistics</verify>
  <done>Format-LabComplianceReport function exists and generates reports in all four formats</done>
</task>

<task type="auto">
  <name>Create Get-LabComplianceReport public API</name>
  <files>Public/Get-LabComplianceReport.ps1</files>
  <action>
Create Public/Get-LabComplianceReport.ps1 for generating compliance reports:

```powershell
function Get-LabComplianceReport {
    <#
    .SYNOPSIS
        Generates a STIG compliance report for the lab.

    .DESCRIPTION
        Get-LabComplianceReport reads the STIG compliance cache and generates
        a comprehensive compliance report. Reports include pass/fail summary,
        compliance rate calculation, and per-VM status details. Supports
        multiple output formats including console, HTML, CSV, and JSON.

    .PARAMETER Format
        Output format: 'Console', 'Html', 'Csv', 'Json'. Defaults to the
        ReportFormats setting from Get-LabReportsConfig.

    .PARAMETER LabName
        Name of the lab for the report header. Defaults to reading from
        $GlobalLabConfig.Lab.LabName.

    .PARAMETER OutputPath
        Path to save the report file. Required for Html, Csv, Json formats.
        For Console format, this parameter is ignored.

    .PARAMETER ThresholdPercent
        Compliance threshold percentage for warnings. Defaults to the
        ComplianceThresholdPercent setting from Get-LabReportsConfig.

    .PARAMETER IncludeDetails
        Include detailed rule-level information. Not yet implemented.

    .PARAMETER CachePath
        Override path to the STIG compliance cache file. Defaults to the
        ComplianceCachePath setting from Get-LabSTIGConfig.

    .EXAMPLE
        Get-LabComplianceReport
        Displays a console compliance report with default settings.

    .EXAMPLE
        Get-LabComplianceReport -Format Html -OutputPath 'compliance.html'
        Generates an HTML compliance report.

    .EXAMPLE
        Get-LabComplianceReport -Format Csv -OutputPath 'compliance.csv'
        Exports compliance data to CSV for Excel analysis.

    .OUTPUTS
        For Console format: Console output (no return value)
        For Html/Csv/Json format: Path to saved report file
    #>
    [CmdletBinding()]
    param(
        [ValidateSet('Console', 'Html', 'Csv', 'Json')]
        [string]$Format,

        [string]$LabName,

        [string]$OutputPath,

        [int]$ThresholdPercent,

        [switch]$IncludeDetails,

        [string]$CachePath
    )

    $reportsConfig = Get-LabReportsConfig

    if (-not $PSBoundParameters.ContainsKey('Format')) {
        $Format = if ($reportsConfig.ReportFormats.Count -gt 0) {
            $reportsConfig.ReportFormats[0]
        } else {
            'Console'
        }
    }

    if (-not $PSBoundParameters.ContainsKey('LabName')) {
        $LabName = if (Test-Path variable:GlobalLabConfig -and $GlobalLabConfig.ContainsKey('Lab') -and $GlobalLabConfig.Lab.ContainsKey('LabName')) {
            $GlobalLabConfig.Lab.LabName
        } else {
            'AutomatedLab'
        }
    }

    if (-not $PSBoundParameters.ContainsKey('ThresholdPercent')) {
        $ThresholdPercent = $reportsConfig.ComplianceThresholdPercent
    }

    $complianceData = Get-LabSTIGCompliance -CachePath $CachePath

    if ($complianceData.Count -eq 0) {
        Write-Warning "No STIG compliance data found. Run Invoke-LabSTIGBaseline to generate compliance data."
        return $null
    }

    $formatParams = @{
        ComplianceData    = $complianceData
        Format            = $Format
        LabName           = $LabName
        ThresholdPercent  = $ThresholdPercent
        IncludeDetails    = $IncludeDetails
    }

    if ($Format -ne 'Console') {
        if ([string]::IsNullOrWhiteSpace($OutputPath)) {
            $dateStamp = Get-Date -Format 'yyyyMMdd-HHmmss'
            $extension = switch ($Format) {
                'Html' { '.html' }
                'Csv'  { '.csv' }
                'Json' { '.json' }
            }
            $OutputPath = Join-Path $reportsConfig.ComplianceReportPath "compliance-$dateStamp$extension"
        }
        $formatParams.OutputPath = $OutputPath
    }

    return Format-LabComplianceReport @formatParams
}
```

This function follows the public API pattern established in Phase 30 (Get-LabAnalytics, Get-LabUsageTrends, Export-LabAnalyticsData). It reads configuration from Get-LabReportsConfig for defaults, delegates core formatting to Format-LabComplianceReport, supports parameter override with PSBoundParameters checks, and auto-generates output filenames when not specified.
  </action>
  <verify>Get-LabComplianceReport -Format Console displays console output with compliance summary</verify>
  <done>Get-LabComplianceReport public API exists with support for all output formats</done>
</task>

<task type="auto">
  <name>Add Get-LabComplianceReport to module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Update both SimpleLab.psm1 and SimpleLab.psd1 to export Get-LabComplianceReport.

In SimpleLab.psm1 (around line 43), add 'Get-LabComplianceReport' to the Export-ModuleMember array. Maintain alphabetical ordering within the exports list.

In SimpleLab.psd1, add 'Get-LabComplianceReport' to the FunctionsToExport array in the same position.

This follows the established pattern for public API functions from Phases 29-30. The function is now available for operators to generate compliance reports directly from PowerShell.
  </action>
  <verify>Get-Command Get-LabComplianceReport -Module SimpleLab returns command info</verify>
  <done>Get-LabComplianceReport is exported from the SimpleLab module</done>
</task>

<task type="auto">
  <name>Create unit tests for compliance report generation</name>
  <files>Tests/LabComplianceReport.Tests.ps1</files>
  <action>
Create Tests/LabComplianceReport.Tests.ps1 with comprehensive test coverage:

```powershell
BeforeAll {
    $ModulePath = Join-Path (Join-Path (Join-Path $PSScriptRoot '..') SimpleLab) 'SimpleLab.psm1'
    Import-Module $ModulePath -Force

    . (Join-Path (Join-Path $PSScriptRoot '..') Private) 'Get-LabReportsConfig.ps1'
    . (Join-Path (Join-Path $PSScriptRoot '..') Private) 'Format-LabComplianceReport.ps1'

    $GlobalLabConfig = @{
        Reports = @{
            ComplianceReportPath       = 'TestDrive:/reports'
            IncludeDetailedResults     = $false
            ComplianceThresholdPercent = 80
            ReportFormats              = @('Console', 'Html')
        }
        Lab = @{
            LabName = 'TestLab'
        }
    }
}

Describe 'Get-LabReportsConfig' {
    It 'Returns reports configuration with all properties' {
        $config = Get-LabReportsConfig

        $config.ComplianceReportPath | Should -Be 'TestDrive:/reports'
        $config.IncludeDetailedResults | Should -Be $false
        $config.ComplianceThresholdPercent | Should -Be 80
        $config.ReportFormats | Should -HaveCount 2
    }

    It 'Provides safe defaults when Reports block is missing' {
        $GlobalLabConfig.Remove('Reports')

        $config = Get-LabReportsConfig

        $config.ComplianceReportPath | Should -Be '.planning/reports/compliance'
        $config.IncludeDetailedResults | Should -Be $false
        $config.ComplianceThresholdPercent | Should -Be 80
        $config.ReportFormats | Should -HaveCount 2
    }
}

Describe 'Format-LabComplianceReport' {
    BeforeEach {
        $testData = @(
            [pscustomobject]@{ VMName = 'dc1'; Role = 'DC'; STIGVersion = '2019'; Status = 'Compliant'; ExceptionsApplied = 0; LastChecked = '2026-02-21T10:00:00' }
            [pscustomobject]@{ VMName = 'svr1'; Role = 'MS'; STIGVersion = '2019'; Status = 'NonCompliant'; ExceptionsApplied = 2; LastChecked = '2026-02-21T10:00:00' }
            [pscustomobject]@{ VMName = 'ws1'; Role = 'MS'; STIGVersion = '2022'; Status = 'Pending'; ExceptionsApplied = 0; LastChecked = '2026-02-21T10:00:00' }
        )
    }

    It 'Generates console output with summary statistics' {
        $output = Format-LabComplianceReport -ComplianceData $testData -Format Console -LabName 'TestLab' 6>&1

        $output | Should -Not -BeNullOrEmpty
        $output | Should -Match 'COMPLIANCE REPORT'
        $output | Should -Match 'Total VMs:\s+3'
        $output | Should -Match 'Compliant:\s+1'
        $output | Should -Match 'Non-Compliant:\s+1'
        $output |Should -Match 'Pending:\s+1'
    }

    It 'Calculates compliance rate correctly' {
        $null = Format-LabComplianceReport -ComplianceData $testData -Format Console -LabName 'TestLab' 6>&1

        # Compliance rate = 1/3 = 33.3%
        # This would be validated in the output
    }

    It 'Generates HTML report file' {
        $htmlPath = 'TestDrive:/compliance.html'

        $result = Format-LabComplianceReport -ComplianceData $testData -Format Html -LabName 'TestLab' -OutputPath $htmlPath

        $result | Should -Be $htmlPath
        Test-Path $htmlPath | Should -Be $true

        $content = Get-Content $htmlPath -Raw
        $content | Should -Match '<!DOCTYPE html>'
        $content | Should -Match 'STIG Compliance Report'
        $content | Should -Match 'dc1'
        $content | Should -Match 'TestLab'
    }

    It 'Generates CSV report file' {
        $csvPath = 'TestDrive:/compliance.csv'

        $result = Format-LabComplianceReport -ComplianceData $testData -Format Csv -LabName 'TestLab' -OutputPath $csvPath

        $result | Should -Be $csvPath
        Test-Path $csvPath | Should -Be $true

        $content = Get-Content $csvPath -Raw
        $content | Should -Match 'VMName'
        $content | Should -Match 'dc1'
    }

    It 'Generates JSON report file' {
        $jsonPath = 'TestDrive:/compliance.json'

        $result = Format-LabComplianceReport -ComplianceData $testData -Format Json -LabName 'TestLab' -OutputPath $jsonPath

        $result | Should -Be $jsonPath
        Test-Path $jsonPath | Should -Be $true

        $content = Get-Content $jsonPath -Raw | ConvertFrom-Json
        $content.LabName | Should -Be 'TestLab'
        $content.Summary.TotalVMs | Should -Be 3
        $content.VMs.Count | Should -Be 3
    }
}

Describe 'Get-LabComplianceReport Integration' {
    It 'Uses defaults from Get-LabReportsConfig' {
        Mock Get-LabSTIGCompliance { return @() }
        Mock Format-LabComplianceReport { return $null }

        Get-LabComplianceReport

        Should -Invoke Get-LabSTIGCompliance -Times 1 -Exactly
        Should -Invoke Format-LabComplianceReport -Times 1 -Exactly
    }
}
```

These tests follow the Pester 5.x pattern established in Phase 30. They verify config reading with safe defaults, console output generation, HTML/CSV/JSON file creation with correct content, summary statistics calculation, and integration between the public API and core formatting function.
  </action>
  <verify>Invoke-Pester -Path Tests/LabComplianceReport.Tests.ps1 passes all tests</verify>
  <done>Unit tests exist and pass for compliance report generation</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1` succeeds
2. Test config: Get-LabReportsConfig returns object with ComplianceReportPath, IncludeDetailedResults, ComplianceThresholdPercent, ReportFormats
3. Test console report: Get-LabComplianceReport -Format Console displays formatted output
4. Test HTML report: Get-LabComplianceReport -Format Html -OutputPath 'test.html' creates HTML file
5. Test CSV export: Get-LabComplianceReport -Format Csv -OutputPath 'test.csv' creates CSV file
6. Test JSON export: Get-LabComplianceReport -Format Json -OutputPath 'test.json' creates JSON file
7. Test module export: Get-Command Get-LabComplianceReport returns command info
</verification>

<success_criteria>
1. Reports configuration block exists in Lab-Config.ps1
2. Get-LabReportsConfig helper function reads configuration with safe defaults
3. Format-LabComplianceReport generates reports in Console, HTML, CSV, and JSON formats
4. Get-LabComplianceReport public API provides operator-facing report generation
5. Compliance reports include pass/fail summary and compliance rate calculation
6. Get-LabComplianceReport is exported from SimpleLab module
7. Unit tests verify report generation functionality
</success_criteria>

<output>
After completion, create `.planning/phases/31-advanced-reporting/31-01-SUMMARY.md` with:
- Actual files created with line counts
- Compliance report schema documentation
- Output format examples
- Any deviations from plan
- Next steps for Plan 31-02
</output>
