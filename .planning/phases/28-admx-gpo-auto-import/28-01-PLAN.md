---
phase: 28
plan: 01
title: ADMX Configuration Block and Config Reader
type: standard
wave: 1
depends_on: []
files_modified:
  - Lab-Config.ps1
  - Private/Get-LabADMXConfig.ps1
autonomous: true
requirements:
  - GPO-01
  - GPO-04
must_haves:
  - ADMX configuration block in Lab-Config.ps1 after STIG block
  - Get-LabADMXConfig helper following Get-LabSTIGConfig pattern with ContainsKey guards
  - Enabled defaults to $true, CreateBaselineGPO defaults to $false, ThirdPartyADMX defaults to @()
  - Unit tests covering all config branches (missing keys, partial keys, type casting, StrictMode)
---

## Objective

Add the ADMX configuration block to Lab-Config.ps1 and create the Get-LabADMXConfig helper function that reads ADMX settings safely with ContainsKey guards. This establishes the configuration foundation for all ADMX/GPO operations.

## Context

@phase-context: .planning/phases/28-admx-gpo-auto-import/28-CONTEXT.md
@research: .planning/phases/28-admx-gpo-auto-import/28-RESEARCH.md
@config-pattern: Lab-Config.ps1 (STIG block lines 219-229)
@helper-pattern: Private/Get-LabSTIGConfig.ps1
@test-pattern: Tests/LabSTIGConfig.Tests.ps1

Per CONTEXT.md decision: Add ADMX = @{...} block to $GlobalLabConfig after the STIG block with keys: Enabled (bool, default $true), CreateBaselineGPO (bool, default $false), ThirdPartyADMX (array of hashtables, default @()). ThirdPartyADMX entry format: @{ Name = 'Chrome'; Path = 'C:\ADMX\Chrome' }.

## Tasks

### Task 1: Add ADMX configuration block to Lab-Config.ps1

**Type:** auto

**Files:**
- Lab-Config.ps1

**Action:**
Add the ADMX configuration block to Lab-Config.ps1 immediately after the STIG block (after line 229). Use this exact structure:

```powershell
    ADMX = @{
        # Changing Enabled toggles whether ADMX Central Store is populated after DC promotion.
        Enabled = $true
        # Changing CreateBaselineGPO toggles whether baseline GPOs are created from JSON templates.
        CreateBaselineGPO = $false
        # Changing ThirdPartyADMX adds custom ADMX bundles to import (operator-provided local paths).
        # Example: ThirdPartyADMX = @(@{ Name = 'Chrome'; Path = 'C:\ADMX\Chrome' })
        ThirdPartyADMX = @()
    }
```

Do NOT add any additional keys beyond Enabled, CreateBaselineGPO, and ThirdPartyADMX. The block must be placed after STIG and before SSH to maintain the established config block ordering.

**Verify:**
- Lab-Config.ps1 loads without error using `. .\Lab-Config.ps1`
- `$GlobalLabConfig.ADMX.Enabled` returns `$true`
- `$GlobalLabConfig.ADMX.CreateBaselineGPO` returns `$false`
- `$GlobalLabConfig.ADMX.ThirdPartyADMX` is an empty array

**Done:**
ADMX block exists in Lab-Config.ps1 with correct structure, placement after STIG block, and default values match CONTEXT.md specification.

### Task 2: Create Get-LabADMXConfig helper function

**Type:** auto

**Files:**
- Private/Get-LabADMXConfig.ps1

**Action:**
Create Private/Get-LabADMXConfig.ps1 following the exact pattern from Private/Get-LabSTIGConfig.ps1:

```powershell
function Get-LabADMXConfig {
    <#
    .SYNOPSIS
        Reads ADMX configuration from GlobalLabConfig with safe defaults.

    .DESCRIPTION
        Returns a PSCustomObject with ADMX settings. Uses ContainsKey guards on
        every read to prevent StrictMode failures when keys are absent.
        Returns safe defaults when the ADMX block or individual keys are missing.

    .OUTPUTS
        PSCustomObject with Enabled, CreateBaselineGPO, ThirdPartyADMX fields.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $admxBlock = if (Test-Path variable:GlobalLabConfig) {
        if ($GlobalLabConfig.ContainsKey('ADMX')) { $GlobalLabConfig.ADMX } else { @{} }
    } else { @{} }

    [pscustomobject]@{
        Enabled            = if ($admxBlock.ContainsKey('Enabled'))            { [bool]$admxBlock.Enabled }             else { $true }
        CreateBaselineGPO  = if ($admxBlock.ContainsKey('CreateBaselineGPO')) { [bool]$admxBlock.CreateBaselineGPO }  else { $false }
        ThirdPartyADMX     = if ($admxBlock.ContainsKey('ThirdPartyADMX'))     { $admxBlock.ThirdPartyADMX }            else { @() }
    }
}
```

Key implementation details:
- Nested ContainsKey checks: first check GlobalLabConfig exists, then check ADMX key exists
- Return `$true` for Enabled default (ADMX import runs by default per CONTEXT.md)
- Return `$false` for CreateBaselineGPO default (baseline GPO creation opt-in)
- Return `@()` for ThirdPartyADMX default (no third-party ADMX by default)
- Type cast all values explicitly ([bool], [bool], array as-is)

**Verify:**
- Function loads without error when dot-sourced
- Returns all defaults when GlobalLabConfig variable does not exist
- Returns all defaults when GlobalLabConfig exists but has no ADMX key
- Returns all defaults when ADMX block exists but is empty hashtable
- Returns operator values when all ADMX keys are present
- Handles partial keys (e.g., only Enabled present) with defaults for missing keys
- Type casts correctly (string 'true' to bool $true, integer 1 to bool $true)

**Done:**
Get-LabADMXConfig.ps1 exists in Private/, follows STIG config pattern exactly, and uses ContainsKey guards on all reads.

### Task 3: Create unit tests for Get-LabADMXConfig

**Type:** auto

**Files:**
- Tests/LabADMXConfig.Tests.ps1

**Action:**
Create Tests/LabADMXConfig.Tests.ps1 following the exact pattern from Tests/LabSTIGConfig.Tests.ps1. Include these test cases:

1. **returns defaults when GlobalLabConfig variable does not exist**
   - Remove-Variable GlobalLabConfig if present
   - Call Get-LabADMXConfig
   - Assert Enabled = $false (note: STIG uses $false default, ADMX uses $true - update accordingly)

2. **returns defaults when GlobalLabConfig exists but has no ADMX key**
   - Set GlobalLabConfig with Lab block only
   - Assert all defaults returned

3. **returns defaults when ADMX block exists but is empty hashtable**
   - Set GlobalLabConfig.ADMX = @{}
   - Assert all defaults returned

4. **returns operator values when all ADMX keys are present**
   - Set all three keys with test values
   - Assert values match exactly

5. **returns partial defaults when only some ADMX keys are present**
   - Set only Enabled = $true
   - Assert CreateBaselineGPO = $false, ThirdPartyADMX = @()

6. **casts types correctly**
   - Set Enabled = 1 (integer), CreateBaselineGPO = 0 (integer)
   - Assert both return as [bool] type

7. **does not throw under Set-StrictMode -Version Latest with missing keys**
   - Enable StrictMode -Version Latest
   - Call Get-LabADMXConfig with partial config
   - Assert no exception thrown

8. **parses ThirdPartyADMX array correctly**
   - Set ThirdPartyADMX = @(@{ Name = 'Chrome'; Path = 'C:\ADMX\Chrome' })
   - Assert array contains one entry with correct structure

9. **returns empty array for ThirdPartyADMX when key is absent**
   - Set ADMX with only Enabled key
   - Assert ThirdPartyADMX is empty array

10. **handles ThirdPartyADMX with multiple entries**
    - Set array with 2-3 entries
    - Assert count matches

Use AfterEach block to clean up GlobalLabConfig between tests (same pattern as STIG tests).

**Verify:**
- `Invoke-Pester Tests/LabADMXConfig.Tests.ps1` passes all 10 tests
- Code coverage for Get-LabADMXConfig is 100%
- Tests clean up GlobalLabConfig properly (no cross-test pollution)

**Done:**
LabADMXConfig.Tests.ps1 exists with 10 test cases covering all config branches, all tests pass.

## Verification

Run all tests for this plan:

```powershell
# Load config to verify syntax
. .\Lab-Config.ps1

# Verify ADMX block is accessible
$GlobalLabConfig.ADMX.Enabled | Should -BeTrue
$GlobalLabConfig.ADMX.CreateBaselineGPO | Should -BeFalse

# Run unit tests
Invoke-Pester Tests/LabADMXConfig.Tests.ps1
```

Expected results:
- Lab-Config.ps1 loads without error
- ADMX block exists with correct default values
- All 10 tests pass
- Code coverage 100% for Get-LabADMXConfig

## Success Criteria

1. ADMX configuration block exists in Lab-Config.ps1 after STIG block
2. Get-LabADMXConfig helper reads config safely with ContainsKey guards
3. Defaults match CONTEXT.md: Enabled=$true, CreateBaselineGPO=$false, ThirdPartyADMX=@()
4. All 10 unit tests pass with full code coverage
5. No StrictMode failures when config keys are missing

## Output

- Lab-Config.ps1 modified with ADMX block
- Private/Get-LabADMXConfig.ps1 created
- Tests/LabADMXConfig.Tests.ps1 created with 10 passing tests
