---
phase: 28
plan: 03
title: GPO JSON Templates and Baseline Creation
type: standard
wave: 3
depends_on:
  - 28-02
files_modified:
  - Templates/GPO/password-policy.json
  - Templates/GPO/account-lockout.json
  - Templates/GPO/audit-policy.json
  - Templates/GPO/applocker.json
  - Private/Invoke-LabADMXImport.ps1 (modified to add GPO creation)
autonomous: true
requirements:
  - GPO-02
  - GPO-03
must_haves:
  - Four baseline GPO JSON templates (password, lockout, audit, AppLocker)
  - GPO creation logic in Invoke-LabADMXImport using New-GPO, Set-GPRegistryValue, New-GPLink
  - FQDN to DN conversion helper for domain root link target
  - GPO creation gated by CreateBaselineGPO config flag
---

## Objective

Create four baseline GPO JSON templates following the documented schema and extend Invoke-LabADMXImport to create and link GPOs when CreateBaselineGPO is enabled. This implements the baseline GPO creation requirement using PowerShell GroupPolicy module cmdlets.

## Context

@phase-context: .planning/phases/28-admx-gpo-auto-import/28-CONTEXT.md
@research: .planning/phases/28-admx-gpo-auto-import/28-RESEARCH.md
@existing-import: Private/Invoke-LabADMXImport.ps1 (from 28-02)
@postinstall-pattern: LabBuilder/Roles/DC.ps1 (lines 78-101)

Per CONTEXT.md decision: Four pre-built templates ship with the project in Templates/GPO/: password-policy.json, account-lockout.json, audit-policy.json, applocker.json. Each JSON template specifies: Name, LinkTarget (domain root DN), Settings array of registry-based policy values.

Per CONTEXT.md Claude's Discretion: Exact JSON schema beyond documented fields (Name, LinkTarget, Settings) is at my discretion. I will use this schema:

```json
{
  "Name": "GPO Display Name",
  "LinkTarget": "DC=simplelab,DC=local",
  "Settings": [
    {
      "Key": "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System",
      "ValueName": "MinimumPasswordAge",
      "Value": 1,
      "Type": "DWord"
    }
  ]
}
```

Per RESEARCH.md: Use Set-GPRegistryValue (not Set-GPPrefRegistryValue) for policy settings. The -Key parameter accepts HKLM\ and HKCU\ prefixes.

## Tasks

### Task 1: Create GPO template directory and four baseline templates

**Type:** auto

**Files:**
- Templates/GPO/password-policy.json
- Templates/GPO/account-lockout.json
- Templates/GPO/audit-policy.json
- Templates/GPO/applocker.json

**Action:**
Create the Templates/GPO directory and four JSON template files with these exact contents:

**Templates/GPO/password-policy.json:**
```json
{
  "Name": "Baseline Password Policy",
  "LinkTarget": "DC=simplelab,DC=local",
  "Settings": [
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "MinimumPasswordAge",
      "Value": 1,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "MaximumPasswordAge",
      "Value": 42,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "MinimumPasswordLength",
      "Value": 12,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "PasswordHistorySize",
      "Value": 24,
      "Type": "DWord"
    }
  ]
}
```

**Templates/GPO/account-lockout.json:**
```json
{
  "Name": "Baseline Account Lockout",
  "LinkTarget": "DC=simplelab,DC=local",
  "Settings": [
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "LockoutBadCount",
      "Value": 5,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "LockoutDuration",
      "Value": 15,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SeCPolicy\\System",
      "ValueName": "ResetLockoutCount",
      "Value": 15,
      "Type": "DWord"
    }
  ]
}
```

**Templates/GPO/audit-policy.json:**
```json
{
  "Name": "Baseline Audit Policy",
  "LinkTarget": "DC=simplelab,DC=local",
  "Settings": [
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Audit",
      "ValueName": "AuditLogonEvents",
      "Value": 3,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Audit",
      "ValueName": "AuditObjectAccess",
      "Value": 3,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Audit",
      "ValueName": "AuditPolicyChange",
      "Value": 3,
      "Type": "DWord"
    },
    {
      "Key": "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Audit",
      "ValueName": "AuditPrivilegeUse",
      "Value": 2,
      "Type": "DWord"
    }
  ]
}
```

**Templates/GPO/applocker.json:**
```json
{
  "Name": "Baseline AppLocker",
  "LinkTarget": "DC=simplelab,DC=local",
  "Settings": [
    {
      "Key": "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\SrpGV2",
      "ValueName": "EnforceRules",
      "Value": 1,
      "Type": "DWord"
    }
  ]
}
```

Implementation notes:
- LinkTarget uses DN format (DC=simplelab,DC=local) - this is the DEFAULT domain name from Lab-Config.ps1
- Registry keys use HKLM\ prefix for Computer Configuration policies
- Type values: DWord (4-byte integer), String, MultiString, ExpandString, QWord, Binary
- Audit policy values: 0=None, 1=Success, 2=Failure, 3=Success+Failure
- These are baseline values appropriate for a lab environment (not production-grade security)

**Verify:**
- All four JSON files exist in Templates/GPO/
- Each file is valid JSON (Test-Path + ConvertFrom-Json succeeds)
- Each file has Name, LinkTarget, and Settings array with at least one entry
- Settings entries have Key, ValueName, Value, Type fields

**Done:**
Templates/GPO/ directory exists with four valid baseline GPO JSON templates.

### Task 2: Add FQDN to DN conversion helper

**Type:** auto

**Files:**
- Private/ConvertTo-DomainDN.ps1

**Action:**
Create Private/ConvertTo-DomainDN.ps1 to convert FQDN to distinguished name format:

```powershell
function ConvertTo-DomainDN {
    <#
    .SYNOPSIS
        Converts a domain FQDN to distinguished name (DN) format.

    .DESCRIPTION
        Converts 'domain.tld' to 'DC=domain,DC=tld' format for use in
        Active Directory operations like New-GPLink -Target.

    .PARAMETER DomainFQDN
        The domain fully-qualified domain name (e.g., 'simplelab.local').

    .OUTPUTS
        String in distinguished name format (e.g., 'DC=simplelab,DC=local').
    #>
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [Parameter(Mandatory)]
        [string]$DomainFQDN
    )

    $parts = $DomainFQDN -split '\.'
    $dnParts = $parts | ForEach-Object { "DC=$_" }
    return $dnParts -join ','
}
```

Key implementation details:
- Split FQDN on dots: 'simplelab.local' -> @('simplelab', 'local')
- Prefix each part with 'DC=': @('DC=simplelab', 'DC=local')
- Join with commas: 'DC=simplelab,DC=local'
- Returns string for use with New-GPLink -Target parameter

**Verify:**
- Function loads without error when dot-sourced
- 'simplelab.local' returns 'DC=simplelab,DC=local'
- 'contoso.com' returns 'DC=contoso,DC=com'
- 'sub.domain.co.uk' returns 'DC=sub,DC=domain,DC=co,DC=uk'

**Done:**
ConvertTo-DomainDN.ps1 exists in Private/ and correctly converts FQDN to DN format.

### Task 3: Extend Invoke-LabADMXImport with GPO creation

**Type:** auto

**Files:**
- Private/Invoke-LabADMXImport.ps1

**Action:**
Modify Private/Invoke-LabADMXImport.ps1 to add GPO creation when CreateBaselineGPO is enabled. Add this logic AFTER the third-party ADMX processing but BEFORE the result object return:

```powershell
        # Process third-party ADMX bundles if configured
        # ... (existing third-party code remains unchanged) ...

        # Create baseline GPOs from templates if enabled
        if ($config.CreateBaselineGPO) {
            Write-Verbose "[Invoke-LabADMXImport] Creating baseline GPOs..."

            # Determine repository root (find .git directory or assume current working directory)
            $repoRoot = if (Get-Command -Name Invoke-BuildGitRoot -ErrorAction SilentlyContinue) {
                Invoke-BuildGitRoot
            } else {
                $PSScriptRoot | Split-Path -Parent
            }

            $gpoTemplatePath = Join-Path $repoRoot 'Templates\GPO'

            if (-not (Test-Path $gpoTemplatePath)) {
                Write-Warning "[Invoke-LabADMXImport] GPO template path not found: $gpoTemplatePath. Skipping GPO creation."
            }
            else {
                # Convert domain FQDN to DN for link target
                $domainDN = ConvertTo-DomainDN -DomainFQDN $DomainName
                Write-Verbose "[Invoke-LabADMXImport] Domain DN for GPO links: $domainDN"

                # Get all JSON template files
                $gpoTemplates = Get-ChildItem -Path $gpoTemplatePath -Filter '*.json' -File

                foreach ($templateFile in $gpoTemplates) {
                    Write-Verbose "[Invoke-LabADMXImport] Processing GPO template: $($templateFile.Name)"

                    try {
                        # Load JSON template
                        $templateJson = Get-Content $templateFile.FullName -Raw | ConvertFrom-Json

                        $gpoName = $templateJson.Name
                        $linkTarget = if ($templateJson.LinkTarget) {
                            $templateJson.LinkTarget
                        } else {
                            $domainDN  # Use default domain DN if LinkTarget not specified
                        }

                        Write-Verbose "[Invoke-LabADMXImport] Creating GPO: $gpoName"

                        # Create GPO on the DC
                        $gpo = New-GPO -Name $gpoName -ErrorAction Stop

                        # Apply each registry setting from template
                        foreach ($setting in $templateJson.Settings) {
                            $key = $setting.Key
                            $valueName = $setting.ValueName
                            $value = $setting.Value
                            $type = $setting.Type

                            # Remove HKLM\ or HKCU\ prefix for Set-GPRegistryValue (it infers hive from Key content)
                            $keyForGPO = $key -replace '^HK[LMCU]\\', ''

                            $params = @{
                                Name      = $gpoName
                                Key       = $keyForGPO
                                ValueName = $valueName
                                Value     = $value
                                Type      = $type
                            }

                            Set-GPRegistryValue @params -ErrorAction Stop | Out-Null
                            Write-Verbose "[Invoke-LabADMXImport] Applied registry setting: $keyForGPO\$valueName = $value"
                        }

                        # Link GPO to domain root
                        New-GPLink -Name $gpoName -Target $linkTarget -ErrorAction Stop | Out-Null
                        Write-Verbose "[Invoke-LabADMXImport] Linked GPO '$gpoName' to $linkTarget"

                        $filesImported++  # Count GPOs in FilesImported metric
                    }
                    catch {
                        Write-Warning "[Invoke-LabADMXImport] Failed to create GPO from template $($templateFile.Name): $($_.Exception.Message)"
                    }
                }
            }
        }

        $success = $true
    }
    catch {
```

Key implementation details:
- Check `$config.CreateBaselineGPO` before creating GPOs (opt-in feature)
- Templates path: `<repoRoot>/Templates/GPO/` (same level as .planning/)
- Default LinkTarget uses ConvertTo-DomainDN if not specified in template
- Each template processed independently (failure on one doesn't block others)
- Set-GPRegistryValue with Key (without HKLM\ prefix), ValueName, Value, Type
- New-GPLink links GPO to domain root DN
- Count GPOs in FilesImported metric (each GPO counts as 1 "file" processed)

**Verify:**
- Invoke-LabADMXImport loads without error
- When CreateBaselineGPO=$false, no GPOs are created (existing behavior preserved)
- When CreateBaselineGPO=$true, templates are loaded and GPOs created
- Each GPO is linked to domain root via New-GPLink
- Registry settings applied via Set-GPRegistryValue

**Done:**
Invoke-LabADMXImport.ps1 extended with GPO creation logic gated by CreateBaselineGPO config flag.

### Task 4: Create unit tests for GPO creation

**Type:** auto

**Files:**
- Tests/LabADMXGPO.Tests.ps1

**Action:**
Create Tests/LabADMXGPO.Tests.ps1 with these test cases:

1. **does not create GPOs when CreateBaselineGPO is false**
   - Mock Get-LabADMXConfig to return CreateBaselineGPO = $false
   - Mock Invoke-Command for OS copy
   - Assert New-GPO never called

2. **creates GPOs when CreateBaselineGPO is true**
   - Mock Get-LabADMXConfig to return CreateBaselineGPO = $true
   - Mock Test-Path for GPO template directory (returns $true)
   - Mock Get-ChildItem to return 4 JSON files
   - Mock Get-Content for template loading
   - Mock ConvertTo-DomainDN to return 'DC=simplelab,DC=local'
   - Mock New-GPO, Set-GPRegistryValue, New-GPLink
   - Assert New-GPO called 4 times, New-GPLink called 4 times

3. **applies all registry settings from template**
   - Mock Get-LabADMXConfig with CreateBaselineGPO = $true
   - Mock template JSON with 3 settings
   - Mock New-GPO, Set-GPRegistryValue
   - Assert Set-GPRegistryValue called 3 times with correct parameters

4. **links GPO to domain root DN**
   - Mock Get-LabADMXConfig with CreateBaselineGPO = $true
   - Mock template with LinkTarget = 'DC=test,DC=local'
   - Mock New-GPO, New-GPLink
   - Assert New-GPLink called with Target = 'DC=test,DC=local'

5. **continues processing after one GPO creation fails**
   - Mock Get-LabADMXConfig with CreateBaselineGPO = $true
   - Mock Get-ChildItem to return 2 templates
   - First template: Mock New-GPO to throw
   - Second template: Mock all successful
   - Assert 1 GPO created, warning logged for failed template

6. **skips GPO creation when template directory not found**
   - Mock Get-LabADMXConfig with CreateBaselineGPO = $true
   - Mock Test-Path for GPO template directory (returns $false)
   - Assert warning logged, New-GPO never called

7. **uses default domain DN when template LinkTarget is empty**
   - Mock Get-LabADMXConfig with CreateBaselineGPO = $true
   - Mock template with LinkTarget = $null
   - Mock ConvertTo-DomainDN to return 'DC=default,DC=local'
   - Mock New-GPLink
   - Assert New-GPLink called with Target = 'DC=default,DC=local'

8. **counts GPOs in FilesImported metric**
   - Mock Get-LabADMXConfig with CreateBaselineGPO = $true
   - Mock 2 templates with successful creation
   - Mock Invoke-Command for OS copy to return 100 files
   - Assert result.FilesImported = 102 (100 + 2 GPOs)

Use BeforeAll to dot-source Invoke-LabADMXImport and ConvertTo-DomainDN. Mock all external dependencies (Get-LabADMXConfig, Test-Path, Get-ChildItem, Get-Content, New-GPO, Set-GPRegistryValue, New-GPLink).

**Verify:**
- `Invoke-Pester Tests/LabADMXGPO.Tests.ps1` passes all 8 tests
- All GroupPolicy cmdlets mocked (no actual GPO operations during test)
- Tests cover enabled/disabled flag, template loading, error handling, metrics

**Done:**
LabADMXGPO.Tests.ps1 exists with 8 test cases covering GPO creation behavior, error handling, and metrics.

## Verification

Run all tests for this plan:

```powershell
# Load helpers to verify syntax
. .\Private\ConvertTo-DomainDN.ps1
. .\Private\Invoke-LabADMXImport.ps1

# Verify ConvertTo-DomainDN
ConvertTo-DomainDN -DomainFQDN 'simplelab.local' | Should -Be 'DC=simplelab,DC=local'
ConvertTo-DomainDN -DomainFQDN 'contoso.com' | Should -Be 'DC=contoso,DC=com'

# Verify GPO templates exist and are valid JSON
Get-ChildItem Templates\GPO\*.json | ForEach-Object {
    $json = Get-Content $_.FullName -Raw | ConvertFrom-Json
    $json.Name | Should -Not -BeNullOrEmpty
    $json.Settings.Count | Should -BeGreaterThan 0
}

# Run unit tests
Invoke-Pester Tests/LabADMXGPO.Tests.ps1
```

Expected results:
- ConvertTo-DomainDN correctly converts FQDN to DN format
- All four GPO templates exist and are valid JSON
- Each template has Name and Settings array
- All 8 tests pass

## Success Criteria

1. Four baseline GPO JSON templates exist in Templates/GPO/
2. ConvertTo-DomainDN helper converts FQDN to DN format correctly
3. Invoke-LabADMXImport creates GPOs when CreateBaselineGPO=$true
4. GPO creation uses New-GPO, Set-GPRegistryValue, New-GPLink cmdlets
5. GPO creation is skipped when CreateBaselineGPO=$false (default behavior)
6. All 8 unit tests pass with full dependency mocking

## Output

- Templates/GPO/password-policy.json created
- Templates/GPO/account-lockout.json created
- Templates/GPO/audit-policy.json created
- Templates/GPO/applocker.json created
- Private/ConvertTo-DomainDN.ps1 created
- Private/Invoke-LabADMXImport.ps1 modified to add GPO creation logic
- Tests/LabADMXGPO.Tests.ps1 created with 8 passing tests
