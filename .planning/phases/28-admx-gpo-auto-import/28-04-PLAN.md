---
phase: 28
plan: 04
title: PostInstall Integration and Final Testing
type: standard
wave: 4
depends_on:
  - 28-03
files_modified:
  - LabBuilder/Roles/DC.ps1
  - Tests/LabDCPostInstall.Tests.ps1
autonomous: true
requirements:
  - GPO-01
  - GPO-02
must_haves:
  - ADMX/GPO operations added to DC PostInstall step after STIG step
  - Wait-LabADReady gating before ADMX/GPO operations
  - Try-catch error handling following STIG pattern
  - Integration test covering full DC PostInstall flow
---

## Objective

Integrate ADMX/GPO operations into the DC PostInstall workflow and create integration tests that verify the complete flow from DC promotion through ADMX import and GPO creation.

## Context

@phase-context: .planning/phases/28-admx-gpo-auto-import/28-CONTEXT.md
@research: .planning/phases/28-admx-gpo-auto-import/28-RESEARCH.md
@dc-role: LabBuilder/Roles/DC.ps1 (lines 78-101)
@stig-pattern: LabBuilder/Roles/DC.ps1 (PostInstall step 3, lines 78-101)

Per CONTEXT.md decision: ADMX/GPO operations run as PostInstall step in LabBuilder/Roles/DC.ps1, after the STIG step (Phase 27) completes. Gated on $GlobalLabConfig.ADMX.Enabled. Follows same try-catch pattern: ADMX failure does not abort DC deployment. Calls Wait-LabADReady first, then Invoke-LabADMXImport.

## Tasks

### Task 1: Add ADMX/GPO step to DC PostInstall

**Type:** auto

**Files:**
- LabBuilder/Roles/DC.ps1

**Action:**
Modify LabBuilder/Roles/DC.ps1 to add ADMX/GPO operations as step 4 in the PostInstall scriptblock. Add this code AFTER the STIG step 3 block (after the closing brace of the STIG if block, around line 101):

```powershell
                # 4. Populate ADMX Central Store and create baseline GPOs (if enabled)
                if (Test-Path variable:GlobalLabConfig) {
                    if ($GlobalLabConfig.ContainsKey('ADMX') -and $GlobalLabConfig.ADMX.ContainsKey('Enabled') -and $GlobalLabConfig.ADMX.Enabled) {
                        try {
                            Write-Host "  Waiting for ADWS readiness..." -ForegroundColor Cyan
                            $adReady = Wait-LabADReady -DomainName $LabConfig.DomainName
                            if (-not $adReady.Ready) {
                                Write-Warning "DC role: ADWS did not become ready within timeout. Skipping ADMX/GPO operations."
                            }
                            else {
                                Write-Host "  Populating ADMX Central Store and creating baseline GPOs..." -ForegroundColor Cyan
                                $admxResult = Invoke-LabADMXImport -DCName $dcName -DomainName $LabConfig.DomainName
                                if ($admxResult.Success) {
                                    Write-Host "  [OK] ADMX import complete: $($admxResult.FilesImported) files imported, $($admxResult.ThirdPartyBundlesProcessed) third-party bundles processed." -ForegroundColor Green
                                }
                                else {
                                    Write-Warning "DC role: ADMX import failed: $($admxResult.Message)"
                                }
                            }
                        }
                        catch {
                            Write-Warning "DC role: ADMX/GPO operations failed on ${dcName}: $($_.Exception.Message). Lab deployment continues."
                        }
                    }
                }
```

Key implementation details:
- Add this as a NEW step 4 (STIG is step 3, DNS/services validation is step 2)
- Use same ContainsKey guard pattern as STIG step
- Call Wait-LabADReady first to gate on ADWS readiness
- Call Invoke-LabADMXImport with DCName and DomainName parameters
- Check admxResult.Success and output appropriate messages
- Wrap entire step in try-catch to prevent ADMX failure from aborting DC deployment
- Use Write-Host with ForegroundColor Cyan for progress messages
- Use Write-Warning for error conditions

**Verify:**
- LabBuilder/Roles/DC.ps1 loads without error
- PostInstall scriptblock has 4 steps (DNS/services validation, STIG, ADMX/GPO, existing error handling)
- ADMX step follows STIG step structure exactly (ContainsKey guards, try-catch)
- Wait-LabADReady called before Invoke-LabADMXImport
- Appropriate messages output for success, failure, timeout scenarios

**Done:**
DC.ps1 PostInstall extended with step 4 for ADMX/GPO operations following the STIG pattern exactly.

### Task 2: Create integration tests for DC PostInstall ADMX/GPO flow

**Type:** auto

**Files:**
- Tests/LabDCPostInstall.Tests.ps1

**Action:**
Create Tests/LabDCPostInstall.Tests.ps1 with integration-style tests for the DC PostInstall ADMX/GPO workflow. These are unit tests that mock external dependencies but verify the wiring is correct:

```powershell
# LabDCPostInstall tests - ADMX/GPO integration

BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabADMXConfig.ps1')
    . (Join-Path $repoRoot 'Private/Wait-LabADReady.ps1')
    . (Join-Path $repoRoot 'Private/Invoke-LabADMXImport.ps1')
    . (Join-Path $repoRoot 'Private/ConvertTo-DomainDN.ps1')
}

Describe 'LabDC PostInstall - ADMX/GPO Integration' {
    BeforeEach {
        # Clean up GlobalLabConfig between tests
        if (Test-Path variable:GlobalLabConfig) {
            Remove-Variable -Name GlobalLabConfig -Scope Script -ErrorAction SilentlyContinue
        }
    }

    It 'skips ADMX/GPO operations when ADMX.Enabled is false' {
        # Arrange
        $script:GlobalLabConfig = @{
            ADMX = @{
                Enabled = $false
            }
        }

        Mock Wait-LabADReady { return [pscustomobject]@{ Ready = $true } }
        Mock Invoke-LabADMXImport { return [pscustomobject]@{ Success = $true } }

        # Act (simulate the PostInstall step 4 logic)
        $skipADMX = -not (
            (Test-Path variable:GlobalLabConfig) -and
            $GlobalLabConfig.ContainsKey('ADMX') -and
            $GlobalLabConfig.ADMX.ContainsKey('Enabled') -and
            $GlobalLabConfig.ADMX.Enabled
        )

        # Assert
        $skipADMX | Should -BeTrue
        Should -Invoke Wait-LabADReady -Times 0 -Scope It
        Should -Invoke Invoke-LabADMXImport -Times 0 -Scope It
    }

    It 'executes ADMX/GPO operations when ADMX.Enabled is true' {
        # Arrange
        $script:GlobalLabConfig = @{
            ADMX = @{
                Enabled = $true
            }
        }

        Mock Wait-LabADReady {
            return [pscustomobject]@{
                Ready = $true
                DomainName = 'simplelab.local'
                WaitSeconds = 5
            }
        }
        Mock Invoke-LabADMXImport {
            return [pscustomobject]@{
                Success = $true
                FilesImported = 150
                ThirdPartyBundlesProcessed = 0
                CentralStorePath = '\\simplelab.local\SYSVOL\simplelab.local\Policies\PolicyDefinitions'
                DurationSeconds = 10
                Message = ''
            }
        }

        $dcName = 'dc1'
        $domainName = 'simplelab.local'

        # Act (simulate the PostInstall step 4 logic)
        $shouldRunADMX = (
            (Test-Path variable:GlobalLabConfig) -and
            $GlobalLabConfig.ContainsKey('ADMX') -and
            $GlobalLabConfig.ADMX.ContainsKey('Enabled') -and
            $GlobalLabConfig.ADMX.Enabled
        )

        if ($shouldRunADMX) {
            $adReady = Wait-LabADReady -DomainName $domainName
            if ($adReady.Ready) {
                $admxResult = Invoke-LabADMXImport -DCName $dcName -DomainName $domainName
            }
        }

        # Assert
        $shouldRunADMX | Should -BeTrue
        Should -Invoke Wait-LabADReady -Times 1 -Scope It -ParameterFilter {
            $DomainName -eq 'simplelab.local'
        }
        Should -Invoke Invoke-LabADMXImport -Times 1 -Scope It -ParameterFilter {
            $DCName -eq 'dc1' -and $DomainName -eq 'simplelab.local'
        }
    }

    It 'skips ADMX import when Wait-LabADReady returns Ready=false' {
        # Arrange
        $script:GlobalLabConfig = @{
            ADMX = @{
                Enabled = $true
            }
        }

        Mock Wait-LabADReady {
            return [pscustomobject]@{
                Ready = $false
                DomainName = 'simplelab.local'
                WaitSeconds = 120
            }
        }
        Mock Invoke-LabADMXImport {
            throw 'Should not be called'
        }

        $domainName = 'simplelab.local'

        # Act (simulate the PostInstall step 4 logic)
        $adReady = Wait-LabADReady -DomainName $domainName
        if ($adReady.Ready) {
            Invoke-LabADMXImport -DCName 'dc1' -DomainName $domainName
        }

        # Assert
        $adReady.Ready | Should -BeFalse
        Should -Invoke Wait-LabADReady -Times 1 -Scope It
        Should -Invoke Invoke-LabADMXImport -Times 0 -Scope It
    }

    It 'handles Invoke-LabADMXImport failure gracefully' {
        # Arrange
        $script:GlobalLabConfig = @{
            ADMX = @{
                Enabled = $true
            }
        }

        Mock Wait-LabADReady {
            return [pscustomobject]@{ Ready = $true }
        }
        Mock Invoke-LabADMXImport {
            return [pscustomobject]@{
                Success = $false
                Message = 'Access denied to Central Store path'
            }
        }

        $dcName = 'dc1'
        $domainName = 'simplelab.local'

        # Act (simulate the PostInstall step 4 logic with try-catch)
        try {
            $adReady = Wait-LabADReady -DomainName $domainName
            if ($adReady.Ready) {
                $admxResult = Invoke-LabADMXImport -DCName $dcName -DomainName $domainName
                if (-not $admxResult.Success) {
                    # This is where the warning would be logged
                    $errorLogged = $true
                }
            }
        }
        catch {
            # Should not reach here - Invoke-LabADMXImport returns object, doesn't throw
            $errorLogged = $false
        }

        # Assert
        Should -Invoke Wait-LabADReady -Times 1 -Scope It
        Should -Invoke Invoke-LabADMXImport -Times 1 -Scope It
        $errorLogged | Should -BeTrue
    }

    It 'handles Wait-LabADReady exception with try-catch' {
        # Arrange
        $script:GlobalLabConfig = @{
            ADMX = @{
                Enabled = $true
            }
        }

        Mock Wait-LabADReady {
            throw 'Get-ADDomain: The server is not operational'
        }
        Mock Invoke-LabADMXImport {
            throw 'Should not be called'
        }

        $domainName = 'simplelab.local'
        $exceptionCaught = $false

        # Act (simulate the PostInstall step 4 logic with try-catch)
        try {
            $adReady = Wait-LabADReady -DomainName $domainName
            if ($adReady.Ready) {
                Invoke-LabADMXImport -DCName 'dc1' -DomainName $domainName
            }
        }
        catch {
            $exceptionCaught = $true
        }

        # Assert
        Should -Invoke Wait-LabADReady -Times 1 -Scope It
        Should -Invoke Invoke-LabADMXImport -Times 0 -Scope It
        $exceptionCaught | Should -BeTrue
    }
}
```

Key implementation details:
- Tests simulate the PostInstall step 4 logic (not full DC.ps1 loading)
- Mock Wait-LabADReady and Invoke-LabADMXImport to test control flow
- Test branches: disabled, enabled+success, enabled+timeout, enabled+failure, exception handling
- Verify ContainsKey guard logic works correctly
- Verify parameter passing (DCName, DomainName) to helpers

**Verify:**
- `Invoke-Pester Tests/LabDCPostInstall.Tests.ps1` passes all 5 tests
- Tests verify correct wiring between config, Wait-LabADReady, and Invoke-LabADMXImport
- All external dependencies mocked (no real AD/DC operations)

**Done:**
LabDCPostInstall.Tests.ps1 exists with 5 integration-style tests covering ADMX/GPO flow in DC PostInstall.

### Task 3: Run full phase 28 test suite

**Type:** checkpoint:human-verify

**Files:**
- All Tests/LabADMX*.ps1, Tests/Wait-LabADReady.Tests.ps1, Tests/LabDCPostInstall.Tests.ps1

**Action:**
Run the complete test suite for Phase 28 to verify all components work together:

```powershell
# Run all ADMX/GPO tests
Invoke-Pester Tests/LabADMXConfig.Tests.ps1
Invoke-Pester Tests/Wait-LabADReady.Tests.ps1
Invoke-Pester Tests/LabADMXImport.Tests.ps1
Invoke-Pester Tests/LabADMXGPO.Tests.ps1
Invoke-Pester Tests/LabDCPostInstall.Tests.ps1

# Run all tests together
Invoke-Pester -Path Tests\*ADMX*.ps1
Invoke-Pester -Path Tests\*GPO*.ps1
```

Expected results:
- All 10 LabADMXConfig tests pass
- All 6 Wait-LabADReady tests pass
- All 10 LabADMXImport tests pass
- All 8 LabADMXGPO tests pass
- All 5 LabDCPostInstall tests pass
- Total: 39 passing tests for Phase 28

**Verify:**
- All 39 tests pass
- Code coverage for all new helpers is 100% or close to it
- No test failures or skipped tests

**Done:**
Complete Phase 28 test suite passes with 39 tests covering config, AD readiness, ADMX import, GPO creation, and PostInstall integration.

## Verification

Verify the complete Phase 28 implementation:

```powershell
# 1. Verify config block exists in Lab-Config.ps1
Get-Content Lab-Config.ps1 | Select-String -Pattern 'ADMX = @{' -Context 0,10

# 2. Verify helpers exist and load correctly
Get-ChildItem Private\*ADMX*.ps1, Private\Wait-LabADReady.ps1, Private\ConvertTo-DomainDN.ps1 | ForEach-Object {
    . $_.FullName
    Write-Host "Loaded: $($_.Name)" -ForegroundColor Green
}

# 3. Verify GPO templates exist
Get-ChildItem Templates\GPO\*.json | ForEach-Object {
    $json = Get-Content $_.FullName -Raw | ConvertFrom-Json
    Write-Host "Template: $($json.Name) with $($json.Settings.Count) settings" -ForegroundColor Cyan
}

# 4. Run all Phase 28 tests
$totalTests = 0
$totalPassed = 0
@TestFiles = 'LabADMXConfig','Wait-LabADReady','LabADMXImport','LabADMXGPO','LabDCPostInstall'
foreach ($test in $TestFiles) {
    $result = Invoke-Pester "Tests\${test}.Tests.ps1" -PassThru
    $totalTests += $result.TotalCount
    $totalPassed += $result.PassedCount
}
Write-Host "Phase 28 Tests: $totalPassed/$totalTests passed" -ForegroundColor Green

# 5. Verify DC.ps1 PostInstall has ADMX step
Get-Content LabBuilder\Roles\DC.ps1 | Select-String -Pattern 'ADMX' -Context 2,2
```

Expected results:
- ADMX block visible in Lab-Config.ps1 with Enabled, CreateBaselineGPO, ThirdPartyADMX keys
- All 5 helpers load without error
- All 4 GPO templates exist and are valid JSON
- All 39 tests pass
- DC.ps1 PostInstall contains ADMX step 4 with ContainsKey guards and try-catch

## Success Criteria

1. Lab-Config.ps1 has ADMX configuration block after STIG block
2. All helpers (Get-LabADMXConfig, Wait-LabADReady, Invoke-LabADMXImport, ConvertTo-DomainDN) exist and load correctly
3. Four baseline GPO templates exist in Templates/GPO/
4. DC.ps1 PostInstall has step 4 for ADMX/GPO operations after STIG step
5. All 39 unit/integration tests pass
6. ADMX/GPO operations are gated by config and use ContainsKey guards
7. Error handling matches STIG pattern (try-catch, doesn't abort deployment)

## Output

- LabBuilder/Roles/DC.ps1 modified with PostInstall step 4
- Tests/LabDCPostInstall.Tests.ps1 created with 5 passing tests
- All 39 Phase 28 tests passing
