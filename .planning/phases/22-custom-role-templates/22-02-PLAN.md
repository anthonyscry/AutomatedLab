---
phase: 22-custom-role-templates
plan: 02
type: execute
wave: 2
depends_on:
  - 22-01
files_modified:
  - LabBuilder/Build-LabFromSelection.ps1
  - LabBuilder/Invoke-LabBuilder.ps1
  - LabBuilder/Select-LabRoles.ps1
  - Tests/CustomRoleIntegration.Tests.ps1
autonomous: true
requirements:
  - ROLE-03

must_haves:
  truths:
    - "Custom roles appear in Select-LabRoles interactive menu alongside built-in roles"
    - "Custom roles can be specified via CLI with -Roles parameter in Invoke-LabBuilder"
    - "Build-LabFromSelection loads and provisions custom roles using the same pipeline as built-in roles"
  artifacts:
    - path: "LabBuilder/Build-LabFromSelection.ps1"
      provides: "Custom role loading integrated into role script pipeline"
      contains: "Get-LabCustomRole"
    - path: "LabBuilder/Invoke-LabBuilder.ps1"
      provides: "Custom role tags accepted in -Roles validation"
      contains: "Get-LabCustomRole"
    - path: "LabBuilder/Select-LabRoles.ps1"
      provides: "Custom roles displayed in interactive menu"
      contains: "Get-LabCustomRole"
    - path: "Tests/CustomRoleIntegration.Tests.ps1"
      provides: "Integration tests for custom role workflow"
      min_lines: 60
  key_links:
    - from: "LabBuilder/Build-LabFromSelection.ps1"
      to: "Private/Get-LabCustomRole.ps1"
      via: "dot-source and call for custom role tags"
      pattern: "Get-LabCustomRole.*-Name"
    - from: "LabBuilder/Invoke-LabBuilder.ps1"
      to: "Private/Get-LabCustomRole.ps1"
      via: "dynamic valid tags expansion"
      pattern: "Get-LabCustomRole.*-List"
    - from: "LabBuilder/Select-LabRoles.ps1"
      to: "Private/Get-LabCustomRole.ps1"
      via: "appending custom roles to menu"
      pattern: "Get-LabCustomRole.*-List"
---

<objective>
Integrate custom role templates into the existing LabBuilder workflows: interactive menu (Select-LabRoles), CLI validation (Invoke-LabBuilder), and build pipeline (Build-LabFromSelection).

Purpose: Custom roles defined as JSON become first-class citizens in all LabBuilder entry points, appearing alongside built-in roles without special handling by the operator.

Output: Updated LabBuilder entry points and integration tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-custom-role-templates/22-01-SUMMARY.md
@LabBuilder/Build-LabFromSelection.ps1
@LabBuilder/Invoke-LabBuilder.ps1
@LabBuilder/Select-LabRoles.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate custom roles into Build-LabFromSelection and Invoke-LabBuilder</name>
  <files>
    LabBuilder/Build-LabFromSelection.ps1
    LabBuilder/Invoke-LabBuilder.ps1
  </files>
  <action>
**Build-LabFromSelection.ps1 changes:**

In Phase 7 (Load Role Scripts), after the hardcoded `$roleScriptMap` block and the foreach loop that loads built-in roles, add a section that handles custom role tags:

```powershell
# Load custom roles (tags not in $roleScriptMap)
$customRoleLoaderPath = Join-Path (Split-Path $PSScriptRoot -Parent) 'Private'
$customRoleLoaderPath = Join-Path $customRoleLoaderPath 'Get-LabCustomRole.ps1'
$customValidatorPath = Join-Path (Split-Path $PSScriptRoot -Parent) 'Private'
$customValidatorPath = Join-Path $customValidatorPath 'Test-LabCustomRoleSchema.ps1'

$customTags = @($SelectedRoles | Where-Object { -not $roleScriptMap.ContainsKey($_) })
if ($customTags.Count -gt 0) {
    if (Test-Path $customRoleLoaderPath) {
        . $customValidatorPath
        . $customRoleLoaderPath
        foreach ($customTag in $customTags) {
            $customRole = Get-LabCustomRole -Name $customTag -Config $Config
            if (-not $customRole) {
                throw "Custom role not found: $customTag"
            }
            $roleDefs += $customRole
            Write-Host "    [OK] Loaded custom role: $customTag -> $($customRole.VMName)" -ForegroundColor Green
        }
    } else {
        throw "Custom role tags specified ($($customTags -join ', ')) but Get-LabCustomRole.ps1 not found at $customRoleLoaderPath"
    }
}
```

Also, in the Phase 9 machine definitions loop, for custom roles, skip adding AutomatedLab built-in roles but still add the machine definition. Custom role post-install will be handled differently -- custom roles use `ProvisioningSteps` instead of `PostInstall` scriptblocks. Add a block in Phase 11 (Post-Install) to handle custom role provisioning:

```powershell
# Custom role provisioning (after Windows post-installs, before Linux)
$customPostInstallRoles = @($roleDefs | Where-Object { $_.IsCustomRole -eq $true })
foreach ($rd in $customPostInstallRoles) {
    Write-Host "    Running custom role provisioning: $($rd.VMName) [$($rd.Tag)]..." -ForegroundColor Yellow
    try {
        foreach ($step in $rd.ProvisioningSteps) {
            switch ($step.type) {
                'windowsFeature' {
                    Invoke-LabCommand -ComputerName $rd.VMName -ActivityName "CustomRole-$($step.name)" -ScriptBlock {
                        param($FeatureName)
                        Install-WindowsFeature -Name $FeatureName -IncludeManagementTools -ErrorAction Stop
                    } -ArgumentList $step.value -Retries 2 -RetryIntervalInSeconds 15
                }
                'powershellScript' {
                    Invoke-LabCommand -ComputerName $rd.VMName -ActivityName "CustomRole-$($step.name)" -ScriptBlock ([scriptblock]::Create($step.value)) -Retries 2 -RetryIntervalInSeconds 15
                }
                'linuxCommand' {
                    # Linux commands via SSH - only if IsLinux
                    Write-Warning "Custom role step type 'linuxCommand' not yet wired for $($rd.VMName). Step '$($step.name)' skipped."
                }
                default {
                    Write-Warning "Unknown provisioning step type '$($step.type)' in custom role $($rd.Tag). Step '$($step.name)' skipped."
                }
            }
            Write-Host "      [OK] Step: $($step.name)" -ForegroundColor Green
        }
        $postInstallResults += @{ VMName = $rd.VMName; Tag = $rd.Tag; Status = 'OK'; Error = '' }
    } catch {
        Write-Warning "Custom role provisioning for $($rd.VMName) failed: $($_.Exception.Message)"
        $postInstallResults += @{ VMName = $rd.VMName; Tag = $rd.Tag; Status = 'FAIL'; Error = $_.Exception.Message }
    }
}
```

**Invoke-LabBuilder.ps1 changes:**

In the 'Build' operation block, after defining `$validTags`, dynamically expand it with custom role tags:

```powershell
# Expand valid tags with custom roles
$customRoleLoaderPath = Join-Path $RepoRoot 'Private'
$customRoleLoaderPath = Join-Path $customRoleLoaderPath 'Get-LabCustomRole.ps1'
$customValidatorPath = Join-Path $RepoRoot 'Private'
$customValidatorPath = Join-Path $customValidatorPath 'Test-LabCustomRoleSchema.ps1'
if (Test-Path $customRoleLoaderPath) {
    . $customValidatorPath
    . $customRoleLoaderPath
    $customRoles = Get-LabCustomRole -List
    if ($customRoles) {
        $validTags += @($customRoles | ForEach-Object { $_.Tag })
    }
}
```

Place this AFTER the `$validTags = @(...)` definition and BEFORE the `$invalid = @($Roles | Where-Object { $_ -notin $validTags })` check.

Use PS 5.1-safe patterns throughout (nested Join-Path, no ternary operator).
  </action>
  <verify>
    Run: `pwsh -NoProfile -Command "$errors = $null; [void][System.Management.Automation.Language.Parser]::ParseFile('./LabBuilder/Build-LabFromSelection.ps1', [ref]$null, [ref]$errors); $errors.Count"` -- should be 0.
    Run same for Invoke-LabBuilder.ps1.
  </verify>
  <done>
    Build-LabFromSelection.ps1 loads custom roles alongside built-in roles and provisions them via ProvisioningSteps. Invoke-LabBuilder.ps1 accepts custom role tags in -Roles parameter. Both files parse without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate custom roles into Select-LabRoles interactive menu</name>
  <files>
    LabBuilder/Select-LabRoles.ps1
  </files>
  <action>
In `Select-LabRoles.ps1`, after loading the config's `$roleMenu`, append custom roles as a new section.

After the line `$roleMenu = $Config.RoleMenu` and before `$count = $roleMenu.Count`, add:

```powershell
# Append custom roles (auto-discovered from .planning/roles/)
$customRoleLoaderPath = Join-Path (Split-Path $PSScriptRoot -Parent) 'Private'
$customValidatorPath = Join-Path $customRoleLoaderPath 'Test-LabCustomRoleSchema.ps1'
$customRoleLoaderPath = Join-Path $customRoleLoaderPath 'Get-LabCustomRole.ps1'
if (Test-Path $customRoleLoaderPath) {
    . $customValidatorPath
    . $customRoleLoaderPath
    $customRoles = Get-LabCustomRole -List
    if ($customRoles -and $customRoles.Count -gt 0) {
        # Add separator before custom roles
        $roleMenu += @(@{ Separator = $true; Label = '-- Custom Roles --' })
        foreach ($cr in $customRoles) {
            $label = "$($cr.Name) ($($cr.Description))"
            if ($label.Length -gt 50) {
                $label = $label.Substring(0, 47) + '...'
            }
            $roleMenu += @(@{ Tag = $cr.Tag; Label = $label; Locked = $false; IsCustomRole = $true })
        }
    }
}
# Convert to array if it was modified (ArrayList issue in PS 5.1)
$roleMenu = @($roleMenu)
```

This ensures custom roles appear in the interactive menu with their own separator section, togglable like built-in roles. The `IsCustomRole` flag on menu entries is informational only.

Also update the help section (the `'?'` command handler) to add a line:
```powershell
Write-Host '    Custom roles are auto-discovered from .planning/roles/*.json' -ForegroundColor Gray
```
Add this after the last built-in role help line and before the empty Write-Host.
  </action>
  <verify>
    Run: `pwsh -NoProfile -Command "$errors = $null; [void][System.Management.Automation.Language.Parser]::ParseFile('./LabBuilder/Select-LabRoles.ps1', [ref]$null, [ref]$errors); $errors.Count"` -- should be 0.
  </verify>
  <done>
    Custom roles appear in Select-LabRoles menu under a "Custom Roles" separator. They can be toggled on/off like built-in roles. Help text mentions custom role auto-discovery.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create integration tests for custom role workflow</name>
  <files>
    Tests/CustomRoleIntegration.Tests.ps1
  </files>
  <action>
Create `Tests/CustomRoleIntegration.Tests.ps1` with Pester 5 integration tests.

**Test structure:**
```powershell
Set-StrictMode -Version Latest

BeforeAll {
    $script:RepoRoot = Split-Path $PSScriptRoot -Parent
    $script:PrivateDir = Join-Path $script:RepoRoot 'Private'
    . (Join-Path $script:PrivateDir 'Test-LabCustomRoleSchema.ps1')
    . (Join-Path $script:PrivateDir 'Get-LabCustomRole.ps1')
}
```

**Test cases:**

Describe 'Custom Role Integration - Invoke-LabBuilder validation':
1. Parse Invoke-LabBuilder.ps1 and verify it contains 'Get-LabCustomRole' (static analysis via Select-String)
2. Parse Invoke-LabBuilder.ps1 and verify it still has the built-in validTags array

Describe 'Custom Role Integration - Build-LabFromSelection pipeline':
1. Parse Build-LabFromSelection.ps1 and verify it contains 'Get-LabCustomRole' reference
2. Parse Build-LabFromSelection.ps1 and verify it contains 'IsCustomRole' handling
3. Parse Build-LabFromSelection.ps1 and verify it contains 'ProvisioningSteps' handling

Describe 'Custom Role Integration - Select-LabRoles menu':
1. Parse Select-LabRoles.ps1 and verify it contains 'Get-LabCustomRole' reference
2. Parse Select-LabRoles.ps1 and verify it contains 'Custom Roles' separator text

Describe 'Custom Role End-to-End - Discovery to Role Def':
1. Create a valid custom role JSON in $TestDrive, call Get-LabCustomRole -Name with mock Config, verify returned hashtable has all standard role definition keys (Tag, VMName, OS, IP, Memory, etc.)
2. Create a valid custom role JSON in $TestDrive, call Get-LabCustomRole -List, verify it has Name, Tag, Description, OS, Resources properties
3. Verify the example role at .planning/roles/example-role.json loads correctly via Get-LabCustomRole -List -RolesPath

Describe 'Custom Role Provisioning Step Types':
1. Verify windowsFeature step type is recognized (static analysis of Build-LabFromSelection for switch case)
2. Verify powershellScript step type is recognized
3. Verify unknown step type produces warning (static analysis for Write-Warning)

Follow project patterns: `$script:` scope, Context blocks, Select-String for static analysis patterns (same as SecurityGaps tests pattern from Phase 7).
  </action>
  <verify>
    Run: `pwsh -NoProfile -Command "Invoke-Pester ./Tests/CustomRoleIntegration.Tests.ps1 -Output Detailed"` -- all tests pass.
  </verify>
  <done>
    All integration tests pass. Tests verify custom role references exist in all three LabBuilder entry points, end-to-end discovery-to-role-def works, and provisioning step types are handled.
  </done>
</task>

</tasks>

<verification>
1. `pwsh -NoProfile -Command "Invoke-Pester ./Tests/CustomRoleIntegration.Tests.ps1 -Output Detailed"` -- all pass
2. `pwsh -NoProfile -Command "Invoke-Pester ./Tests/CustomRoles.Tests.ps1 -Output Detailed"` -- all still pass (regression)
3. All three LabBuilder files parse without syntax errors
4. Custom role tag in .planning/roles/ would be accepted by Invoke-LabBuilder -Roles validation
</verification>

<success_criteria>
- Custom roles appear in Select-LabRoles interactive menu under "Custom Roles" separator
- Invoke-LabBuilder -Operation Build -Roles DC,MonitoringServer accepts custom role tags
- Build-LabFromSelection loads custom roles and provisions via ProvisioningSteps
- All integration tests pass (10+ tests)
- All Plan 01 tests still pass (regression)
</success_criteria>

<output>
After completion, create `.planning/phases/22-custom-role-templates/22-02-SUMMARY.md`
</output>
