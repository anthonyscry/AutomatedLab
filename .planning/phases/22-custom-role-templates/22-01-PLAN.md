---
phase: 22-custom-role-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Get-LabCustomRole.ps1
  - Private/Test-LabCustomRoleSchema.ps1
  - Tests/CustomRoles.Tests.ps1
  - .planning/roles/example-role.json
autonomous: true
requirements:
  - ROLE-01
  - ROLE-02
  - ROLE-04
  - ROLE-05

must_haves:
  truths:
    - "Operator can define a custom role as a JSON file with provisioning steps"
    - "JSON role files in .planning/roles/ are auto-discovered at runtime without code changes"
    - "Malformed role JSON is rejected with a clear error message naming the missing field"
    - "Get-LabCustomRole -List returns available custom roles with name, description, and resource requirements"
  artifacts:
    - path: "Private/Get-LabCustomRole.ps1"
      provides: "Custom role loading, discovery, and listing"
      exports: ["Get-LabCustomRole"]
    - path: "Private/Test-LabCustomRoleSchema.ps1"
      provides: "JSON schema validation for custom role templates"
      exports: ["Test-LabCustomRoleSchema"]
    - path: "Tests/CustomRoles.Tests.ps1"
      provides: "Pester tests for custom role engine"
      min_lines: 80
    - path: ".planning/roles/example-role.json"
      provides: "Example custom role template showing schema"
  key_links:
    - from: "Private/Get-LabCustomRole.ps1"
      to: ".planning/roles/*.json"
      via: "Get-ChildItem directory scan"
      pattern: "Get-ChildItem.*\\.json"
    - from: "Private/Get-LabCustomRole.ps1"
      to: "Private/Test-LabCustomRoleSchema.ps1"
      via: "validation call on each loaded role"
      pattern: "Test-LabCustomRoleSchema"
---

<objective>
Build the custom role template engine: JSON schema definition, auto-discovery from `.planning/roles/`, validation, and listing via `Get-LabCustomRole`.

Purpose: Enable operators to define custom roles as JSON files that are automatically discovered and validated at runtime, without modifying any PowerShell code.

Output: Two Private/ helper functions (`Get-LabCustomRole`, `Test-LabCustomRoleSchema`), an example role JSON, and comprehensive Pester tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@LabBuilder/Roles/DC.ps1
@LabBuilder/Roles/Jumpbox.ps1
@LabBuilder/Build-LabFromSelection.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON role schema, validator, and example role</name>
  <files>
    Private/Test-LabCustomRoleSchema.ps1
    .planning/roles/example-role.json
  </files>
  <action>
Create the JSON role schema and validator function.

**JSON Schema** (`.planning/roles/example-role.json`):
The JSON schema for custom roles should mirror the hashtable returned by existing `Get-LabRole_*` functions. Required fields:
```json
{
  "name": "MyCustomRole",
  "tag": "MyCustomRole",
  "description": "Description of what this role does",
  "os": "windows|linux",
  "resources": {
    "memory": "4GB",
    "minMemory": "2GB",
    "maxMemory": "6GB",
    "processors": 4
  },
  "provisioningSteps": [
    {
      "name": "Install-Feature",
      "type": "windowsFeature|powershellScript|linuxCommand",
      "value": "Web-Server"
    }
  ],
  "vmNameDefault": "CUSTOM1",
  "autoLabRoles": []
}
```

Create the example role file at `.planning/roles/example-role.json` with a simple "MonitoringServer" role that installs SNMP feature (Windows).

**Validator** (`Private/Test-LabCustomRoleSchema.ps1`):
- Function: `Test-LabCustomRoleSchema`
- `[CmdletBinding()]` with `param([Parameter(Mandatory)][hashtable]$RoleData, [Parameter(Mandatory)][string]$FilePath)`
- Returns `[pscustomobject]@{ Valid = [bool]; Errors = [string[]] }`
- Required fields check: name, tag, description, os, provisioningSteps
- Tag must be alphanumeric (no spaces, no special chars except hyphen/underscore)
- os must be 'windows' or 'linux'
- provisioningSteps must be non-empty array, each step must have name, type, value
- type must be one of: windowsFeature, powershellScript, linuxCommand
- Use `Set-StrictMode -Version Latest`
- Error messages must name the specific missing/invalid field and the file path, e.g.: "Custom role 'path/file.json': missing required field 'description'"
- Follow project pattern: try-catch with function-name-prefixed errors

Do NOT use `Test-Path variable:` here since all params are mandatory.
  </action>
  <verify>
    Run: `pwsh -NoProfile -Command "Set-StrictMode -Version Latest; . ./Private/Test-LabCustomRoleSchema.ps1; $r = Test-LabCustomRoleSchema -RoleData @{name='x'} -FilePath 'test.json'; $r.Valid; $r.Errors.Count"` -- should return False and errors > 0.
  </verify>
  <done>
    Test-LabCustomRoleSchema rejects incomplete role data with specific field-level error messages. Example role JSON exists at .planning/roles/example-role.json with all required fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Get-LabCustomRole loader with auto-discovery and listing</name>
  <files>
    Private/Get-LabCustomRole.ps1
  </files>
  <action>
Create `Private/Get-LabCustomRole.ps1` with function `Get-LabCustomRole`.

**Function signature:**
```powershell
function Get-LabCustomRole {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $false)]
        [string]$Name,

        [Parameter(Mandatory = $false)]
        [switch]$List,

        [Parameter(Mandatory = $false)]
        [string]$RolesPath,

        [Parameter(Mandatory = $false)]
        [hashtable]$Config
    )
```

**Behavior:**

1. **Path resolution:** If `$RolesPath` not provided, derive from repo root: `Join-Path (Join-Path $PSScriptRoot '..') '.planning' | Join-Path -ChildPath 'roles'` (PS 5.1 nested Join-Path pattern). If directory doesn't exist, return empty array (for -List) or $null (for -Name) with no error.

2. **Auto-discovery:** Use `Get-ChildItem -Path $RolesPath -Filter '*.json' -File` to find all JSON role files. For each file:
   - Read with `Get-Content -Raw | ConvertFrom-Json`
   - Convert PSCustomObject to hashtable (iterate NoteProperties)
   - Dot-source `Test-LabCustomRoleSchema.ps1` if not already loaded (use `Get-Command Test-LabCustomRoleSchema -ErrorAction SilentlyContinue` check)
   - Call `Test-LabCustomRoleSchema` -- if invalid, Write-Warning with errors and skip (do NOT throw)
   - Store valid roles in array

3. **-List mode:** Return array of `[pscustomobject]@{ Name; Tag; Description; OS; Resources; FilePath; ProvisioningStepCount }` for each valid role. Sort by Name.

4. **-Name mode:** Return single role hashtable matching `$Name` (case-insensitive match on tag or name). Return $null if not found. The returned hashtable should be in the same shape as existing `Get-LabRole_*` output:
   ```
   @{
       Tag        = $role.tag
       VMName     = <from Config.VMNames[$tag] or role.vmNameDefault>
       Roles      = <from role.autoLabRoles or @()>
       OS         = <from Config based on role.os>
       IP         = <from Config.IPPlan[$tag] or ''>
       Gateway    = <from Config.Network.Gateway or ''>
       DnsServer1 = <from Config.IPPlan.DC or ''>
       Memory     = <parse role.resources.memory>
       MinMemory  = <parse role.resources.minMemory>
       MaxMemory  = <parse role.resources.maxMemory>
       Processors = <role.resources.processors>
       DomainName = <from Config.DomainName or ''>
       Network    = <from Config.Network.SwitchName or ''>
       IsCustomRole = $true
       ProvisioningSteps = $role.provisioningSteps
       SourceFile = <file path>
   }
   ```

5. **Memory parsing:** Create a local helper to convert strings like "4GB", "2GB", "512MB" to numeric values. Use regex `'^(\d+)(GB|MB)$'` and multiply accordingly.

6. **Error handling:** try-catch around JSON parsing per file. Write-Warning for individual file failures, continue to next file. Only throw on truly fatal errors (impossible state).

7. `Set-StrictMode -Version Latest` at top.
  </action>
  <verify>
    Run: `pwsh -NoProfile -Command "Set-StrictMode -Version Latest; . ./Private/Test-LabCustomRoleSchema.ps1; . ./Private/Get-LabCustomRole.ps1; $roles = Get-LabCustomRole -List -RolesPath '.planning/roles'; $roles.Count; $roles[0].Name"` -- should find the example role.
  </verify>
  <done>
    Get-LabCustomRole -List discovers and returns all valid custom roles from .planning/roles/. Get-LabCustomRole -Name 'MonitoringServer' returns a role hashtable compatible with existing Get-LabRole_* output shape. Invalid JSON files produce warnings but don't halt discovery.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Pester tests for custom role engine</name>
  <files>
    Tests/CustomRoles.Tests.ps1
  </files>
  <action>
Create comprehensive Pester 5 tests at `Tests/CustomRoles.Tests.ps1`.

**Structure:**
```powershell
Set-StrictMode -Version Latest

BeforeAll {
    $script:RepoRoot = Split-Path $PSScriptRoot -Parent
    $script:PrivateDir = Join-Path $script:RepoRoot 'Private'
    . (Join-Path $script:PrivateDir 'Test-LabCustomRoleSchema.ps1')
    . (Join-Path $script:PrivateDir 'Get-LabCustomRole.ps1')
}
```

**Test cases for Test-LabCustomRoleSchema:**
1. Valid complete role data returns Valid=$true, Errors empty
2. Missing 'name' field returns Valid=$false with error mentioning 'name'
3. Missing 'tag' field returns error mentioning 'tag'
4. Missing 'description' returns error mentioning 'description'
5. Missing 'os' returns error mentioning 'os'
6. Invalid 'os' value (not windows/linux) returns error
7. Missing 'provisioningSteps' returns error
8. Empty provisioningSteps array returns error
9. Step missing 'type' returns error
10. Invalid step type returns error
11. Tag with spaces returns error
12. Multiple missing fields returns multiple errors

**Test cases for Get-LabCustomRole:**
1. -List with valid roles directory returns role objects with correct properties
2. -List with nonexistent directory returns empty array
3. -List skips invalid JSON files with warning (create temp bad JSON in TestDrive)
4. -Name returns matching role hashtable (case-insensitive)
5. -Name with nonexistent role returns $null
6. Returned role hashtable has IsCustomRole=$true
7. Returned role hashtable has ProvisioningSteps array
8. -List returns sorted by Name
9. Memory string parsing works for GB and MB values
10. Example role file at .planning/roles/ parses successfully

Use `$TestDrive` for temp files (Pester built-in). Create valid/invalid JSON fixtures in BeforeAll or BeforeEach as needed.

Follow project patterns: `$script:` scope for BeforeAll variables, Context blocks per function.
  </action>
  <verify>
    Run: `pwsh -NoProfile -Command "Invoke-Pester ./Tests/CustomRoles.Tests.ps1 -Output Detailed"` -- all tests pass.
  </verify>
  <done>
    All CustomRoles.Tests.ps1 tests pass. Coverage includes schema validation (12+ cases), discovery/listing (8+ cases), and edge cases (invalid JSON, missing directories).
  </done>
</task>

</tasks>

<verification>
1. `pwsh -NoProfile -Command "Invoke-Pester ./Tests/CustomRoles.Tests.ps1 -Output Detailed"` -- all tests pass
2. Example role at `.planning/roles/example-role.json` is valid JSON and passes schema validation
3. `Get-LabCustomRole -List` returns at least one role (the example)
4. `Get-LabCustomRole -Name 'MonitoringServer'` returns a hashtable with IsCustomRole=$true
5. Invalid JSON triggers a warning, not an exception
</verification>

<success_criteria>
- Test-LabCustomRoleSchema validates all required fields and returns specific error messages
- Get-LabCustomRole auto-discovers .json files from .planning/roles/ without code changes
- Get-LabCustomRole -List shows roles with metadata (name, description, OS, resources)
- All Pester tests pass (20+ tests)
- Example role JSON demonstrates the schema
</success_criteria>

<output>
After completion, create `.planning/phases/22-custom-role-templates/22-01-SUMMARY.md`
</output>
