---
phase: 14-lab-scenario-templates
plan: 02
type: execute
wave: 2
depends_on:
  - 14-01
files_modified:
  - OpenCodeLab-App.ps1
  - Deploy.ps1
  - Private/Invoke-LabOrchestrationActionCore.ps1
  - Tests/ScenarioDeployIntegration.Tests.ps1
autonomous: true
requirements:
  - TMPL-04
  - TMPL-01
  - TMPL-02
  - TMPL-03
  - TMPL-05

must_haves:
  truths:
    - "Operator can pass -Scenario SecurityLab on a deploy command and the correct template is activated"
    - "Operator can pass -Scenario MultiTierApp on a deploy command and the correct template is activated"
    - "Operator can pass -Scenario MinimalAD on a deploy command and the correct template is activated"
    - "Operator sees RAM, disk, and CPU requirements printed to console before any VMs are created"
    - "Deploy flow uses scenario template VM definitions instead of default or hardcoded VMs when -Scenario is specified"
    - "Invalid -Scenario value produces a clear error with available scenario names"
  artifacts:
    - path: "OpenCodeLab-App.ps1"
      provides: "-Scenario parameter on orchestrator"
      contains: "Scenario"
    - path: "Deploy.ps1"
      provides: "-Scenario parameter on deploy script with resource estimate output"
      contains: "Scenario"
    - path: "Private/Invoke-LabOrchestrationActionCore.ps1"
      provides: "Scenario passthrough from orchestrator to Deploy.ps1"
      contains: "Scenario"
    - path: "Tests/ScenarioDeployIntegration.Tests.ps1"
      provides: "Integration tests for scenario deploy flow"
      contains: "Describe"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Invoke-LabOrchestrationActionCore.ps1"
      via: "passes -Scenario parameter through to orchestration action core"
      pattern: "-Scenario.*\\$Scenario"
    - from: "Private/Invoke-LabOrchestrationActionCore.ps1"
      to: "Deploy.ps1"
      via: "includes -Scenario in deploy argument list"
      pattern: "Scenario"
    - from: "Deploy.ps1"
      to: "Private/Get-LabScenarioTemplate.ps1"
      via: "calls Get-LabScenarioTemplate when -Scenario is specified"
      pattern: "Get-LabScenarioTemplate"
    - from: "Deploy.ps1"
      to: "Private/Get-LabScenarioResourceEstimate.ps1"
      via: "calls Get-LabScenarioResourceEstimate to print requirements before deployment"
      pattern: "Get-LabScenarioResourceEstimate"
---

<objective>
Wire the `-Scenario` parameter through the CLI orchestrator and deploy script so operators can select a named scenario template at deploy time. Print resource requirements to console before VM creation begins.

Purpose: Completes the end-to-end scenario template flow. After this plan, operators can run a single command with `-Scenario SecurityLab` and get a fully provisioned lab with resource requirements shown upfront.

Output: Updated orchestrator, deploy script, and action core with -Scenario parameter, plus integration tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-lab-scenario-templates/14-01-SUMMARY.md
@OpenCodeLab-App.ps1
@Deploy.ps1
@Private/Invoke-LabOrchestrationActionCore.ps1
@Private/Get-LabScenarioTemplate.ps1
@Private/Get-LabScenarioResourceEstimate.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add -Scenario parameter to orchestrator, action core, and Deploy.ps1</name>
  <files>OpenCodeLab-App.ps1, Private/Invoke-LabOrchestrationActionCore.ps1, Deploy.ps1</files>
  <action>
    **OpenCodeLab-App.ps1:**
    1. Add `[string]$Scenario` parameter to the param block (after $Mode, no [ValidateSet] — validation happens in Get-LabScenarioTemplate at runtime so new scenarios added as JSON files are auto-discovered)
    2. Pass `-Scenario $Scenario` to all `Invoke-LabOrchestrationActionCore` calls (there are 3 call sites, around lines 732, 812, 820). Only pass when `$PSBoundParameters.ContainsKey('Scenario')` to avoid sending empty string.
    3. In the NoExecute/SkipRuntimeBootstrap block (around line 80-116), no changes needed — the Private helpers are already loaded there.

    **Private/Invoke-LabOrchestrationActionCore.ps1:**
    1. Add `[Parameter()][string]$Scenario` parameter to the function
    2. In the deploy action path, if `$Scenario` is non-empty, add `-Scenario $Scenario` to the Deploy.ps1 invocation arguments. Look at how existing parameters like `-Mode`, `-NonInteractive`, `-Force` are passed through.

    **Deploy.ps1:**
    1. Add `[string]$Scenario` parameter to the param block (after $AdminPassword)
    2. Dot-source the two new Private helpers after the existing `$templateHelperPath` dot-source block (around line 22-26):
       ```powershell
       $scenarioHelperPath = Join-Path $ScriptDir 'Private\Get-LabScenarioTemplate.ps1'
       $resourceEstimateHelperPath = Join-Path $ScriptDir 'Private\Get-LabScenarioResourceEstimate.ps1'
       if (Test-Path $scenarioHelperPath) { . $scenarioHelperPath }
       if (Test-Path $resourceEstimateHelperPath) { . $resourceEstimateHelperPath }
       ```
    3. In the MACHINE DEFINITIONS section (around line 274-338), BEFORE the existing `$templateConfig = $null` block, add scenario handling:
       ```powershell
       # Scenario template override — takes precedence over active template
       if (-not [string]::IsNullOrWhiteSpace($Scenario)) {
           if (Get-Command -Name 'Get-LabScenarioResourceEstimate' -ErrorAction SilentlyContinue) {
               $estimate = Get-LabScenarioResourceEstimate -Scenario $Scenario -TemplatesRoot (Join-Path (Join-Path $ScriptDir '.planning') 'templates')
               Write-Host "`n===== Scenario Resource Requirements: $Scenario =====" -ForegroundColor Cyan
               Write-Host "  VMs:         $($estimate.VMCount)" -ForegroundColor White
               Write-Host "  Total RAM:   $($estimate.TotalRAMGB) GB" -ForegroundColor White
               Write-Host "  Total Disk:  $($estimate.TotalDiskGB) GB (estimated)" -ForegroundColor White
               Write-Host "  Total CPUs:  $($estimate.TotalProcessors)" -ForegroundColor White
               Write-Host "=================================================" -ForegroundColor Cyan
               Write-Host ""
           }
           if (Get-Command -Name 'Get-LabScenarioTemplate' -ErrorAction SilentlyContinue) {
               $templateConfig = Get-LabScenarioTemplate -Scenario $Scenario -TemplatesRoot (Join-Path (Join-Path $ScriptDir '.planning') 'templates')
           }
       }
       ```
       Then modify the existing `$templateConfig = $null` line to only set null when NOT using a scenario:
       ```powershell
       if ([string]::IsNullOrWhiteSpace($Scenario)) {
           $templateConfig = $null
           if (Get-Command -Name 'Get-ActiveTemplateConfig' -ErrorAction SilentlyContinue) {
               $templateConfig = Get-ActiveTemplateConfig -RepoRoot $ScriptDir
           }
       }
       ```
       This way, scenario selection takes precedence over active template, but both paths feed into the same template-driven VM definition loop that already exists in Deploy.ps1.

    Use nested `Join-Path` calls for PS 5.1 compatibility (2 args only). Follow existing error handling patterns — try/catch with function-name prefixed messages.
  </action>
  <verify>
    Run: `pwsh -Command "& { \$env:OPENCODELAB_SKIP_RUNTIME_BOOTSTRAP = '1'; . ./OpenCodeLab-App.ps1 -Action deploy -Scenario SecurityLab -NoExecute }"` — should not throw (NoExecute mode prevents actual deployment but validates parameter acceptance).
    Verify -Scenario parameter exists: `pwsh -Command "(Get-Command ./Deploy.ps1).Parameters.Keys -contains 'Scenario'"` returns True.
    Verify -Scenario parameter on App: `pwsh -Command "(Get-Command ./OpenCodeLab-App.ps1).Parameters.Keys -contains 'Scenario'"` returns True.
  </verify>
  <done>-Scenario parameter accepted by OpenCodeLab-App.ps1, passed through Invoke-LabOrchestrationActionCore, and handled by Deploy.ps1. Resource requirements printed to console when scenario specified. Scenario template takes precedence over active template.</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for scenario deploy flow</name>
  <files>Tests/ScenarioDeployIntegration.Tests.ps1</files>
  <action>
    Create Pester 5.x integration test suite `Tests/ScenarioDeployIntegration.Tests.ps1`:

    **BeforeAll:**
    - `$repoRoot = Split-Path -Parent $PSScriptRoot`
    - Dot-source: `Private/Test-LabTemplateData.ps1`, `Private/Get-LabScenarioTemplate.ps1`, `Private/Get-LabScenarioResourceEstimate.ps1`, `Private/Get-ActiveTemplateConfig.ps1`

    **Describe 'Deploy.ps1 Scenario Parameter':**
    - Test: Deploy.ps1 has a Scenario parameter (parse the file, check param block)
    - Test: Deploy.ps1 dot-sources Get-LabScenarioTemplate helper (Select-String for the dot-source line)
    - Test: Deploy.ps1 dot-sources Get-LabScenarioResourceEstimate helper
    - Test: Deploy.ps1 calls Get-LabScenarioResourceEstimate when Scenario is provided (Select-String for the call)
    - Test: Deploy.ps1 calls Get-LabScenarioTemplate when Scenario is provided

    **Describe 'OpenCodeLab-App.ps1 Scenario Parameter':**
    - Test: App has a Scenario parameter (Select-String on param block)
    - Test: App passes Scenario to Invoke-LabOrchestrationActionCore (Select-String for `-Scenario`)

    **Describe 'Invoke-LabOrchestrationActionCore Scenario Parameter':**
    - Test: Function has Scenario parameter (parse the file)
    - Test: Function passes Scenario to deploy invocation

    **Describe 'End-to-End Scenario Resolution':**
    - Context 'SecurityLab scenario':
      - Test: Get-LabScenarioTemplate returns 3 VMs with roles DC, Client, Ubuntu
      - Test: Get-LabScenarioResourceEstimate returns TotalRAMGB = 10, TotalProcessors = 8
    - Context 'MultiTierApp scenario':
      - Test: Get-LabScenarioTemplate returns 4 VMs with roles DC, SQL, IIS, Client
      - Test: Get-LabScenarioResourceEstimate returns TotalRAMGB = 20, TotalProcessors = 12
    - Context 'MinimalAD scenario':
      - Test: Get-LabScenarioTemplate returns 1 VM with role DC
      - Test: Get-LabScenarioResourceEstimate returns TotalRAMGB = 2, TotalProcessors = 2
    - Context 'Invalid scenario':
      - Test: Throws with descriptive error message
      - Test: Error message lists available scenario names

    Use `Select-String` static analysis pattern from project conventions for testing code structure (no runtime deploy execution needed). Use `$repoRoot` for all path resolution.
  </action>
  <verify>
    Run: `pwsh -Command "Invoke-Pester -Path Tests/ScenarioDeployIntegration.Tests.ps1 -Output Detailed"` — all tests pass.
  </verify>
  <done>Integration test suite has 18+ tests covering parameter existence, helper wiring, and end-to-end scenario resolution for all three scenarios. All tests pass.</done>
</task>

</tasks>

<verification>
1. `OpenCodeLab-App.ps1 -Action deploy -Scenario SecurityLab` accepts the parameter without error
2. Deploy.ps1 prints resource requirements (RAM, disk, CPU) to console when -Scenario is specified
3. Deploy.ps1 uses scenario template VM definitions when -Scenario is provided
4. Invalid -Scenario values produce clear error messages listing available scenarios
5. All tests in `Tests/ScenarioDeployIntegration.Tests.ps1` pass
6. All tests in `Tests/ScenarioTemplates.Tests.ps1` still pass (from Plan 01)
7. Existing deploy flow without -Scenario is unaffected (active template or hardcoded fallback still works)
</verification>

<success_criteria>
- -Scenario parameter wired end-to-end: App.ps1 -> ActionCore -> Deploy.ps1
- Resource estimate printed before VM creation for all scenario deployments
- Scenario override takes precedence over active template
- Existing non-scenario deploy flow unchanged
- 18+ integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-lab-scenario-templates/14-02-SUMMARY.md`
</output>
