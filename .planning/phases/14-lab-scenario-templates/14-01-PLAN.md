---
phase: 14-lab-scenario-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/templates/SecurityLab.json
  - .planning/templates/MultiTierApp.json
  - .planning/templates/MinimalAD.json
  - Private/Get-LabScenarioTemplate.ps1
  - Private/Get-LabScenarioResourceEstimate.ps1
  - Tests/ScenarioTemplates.Tests.ps1
autonomous: true
requirements:
  - TMPL-01
  - TMPL-02
  - TMPL-03
  - TMPL-05

must_haves:
  truths:
    - "SecurityLab scenario resolves to a DC + client + Ubuntu attack VM template definition"
    - "MultiTierApp scenario resolves to a DC + SQL + IIS + client template definition"
    - "MinimalAD scenario resolves to a single DC with minimum resource allocation"
    - "Resource estimate returns total RAM, disk, and CPU requirements for any scenario"
    - "Invalid scenario name produces a clear error listing available scenarios"
  artifacts:
    - path: ".planning/templates/SecurityLab.json"
      provides: "Security testing lab scenario template"
      contains: "SecurityLab"
    - path: ".planning/templates/MultiTierApp.json"
      provides: "Multi-tier application lab scenario template"
      contains: "MultiTierApp"
    - path: ".planning/templates/MinimalAD.json"
      provides: "Minimal AD lab scenario template"
      contains: "MinimalAD"
    - path: "Private/Get-LabScenarioTemplate.ps1"
      provides: "Scenario name to template resolver"
      contains: "function Get-LabScenarioTemplate"
    - path: "Private/Get-LabScenarioResourceEstimate.ps1"
      provides: "Resource estimation from template definitions"
      contains: "function Get-LabScenarioResourceEstimate"
    - path: "Tests/ScenarioTemplates.Tests.ps1"
      provides: "Pester tests for scenario templates and resource estimation"
      contains: "Describe"
  key_links:
    - from: "Private/Get-LabScenarioTemplate.ps1"
      to: ".planning/templates/*.json"
      via: "reads scenario JSON files by name"
      pattern: "Get-Content.*ConvertFrom-Json"
    - from: "Private/Get-LabScenarioResourceEstimate.ps1"
      to: "Private/Get-LabScenarioTemplate.ps1"
      via: "calls Get-LabScenarioTemplate to get VM definitions"
      pattern: "Get-LabScenarioTemplate"
---

<objective>
Create three scenario template JSON files and two Private helper functions: one to resolve a scenario name to its template definition, and one to estimate total resource requirements for a scenario.

Purpose: Provides the data layer and lookup logic that the CLI integration (Plan 02) will wire into the deploy flow. Operators will be able to query available scenarios and see resource costs before committing to a deployment.

Output: Three scenario JSON files, two Private helpers, and a comprehensive Pester test suite.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/templates/default.json
@Private/Get-ActiveTemplateConfig.ps1
@Private/Test-LabTemplateData.ps1
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scenario template JSON files and resolver function</name>
  <files>.planning/templates/SecurityLab.json, .planning/templates/MultiTierApp.json, .planning/templates/MinimalAD.json, Private/Get-LabScenarioTemplate.ps1</files>
  <action>
    Create three scenario template JSON files following the exact structure of `.planning/templates/default.json` (name, description, vms array with name/role/ip/memoryGB/processors).

    **SecurityLab.json** (TMPL-01):
    - name: "SecurityLab"
    - description: "Security testing lab: DC, Windows client, Ubuntu attack VM"
    - VMs:
      - dc1: role DC, ip 10.0.10.10, 4GB RAM, 4 processors
      - ws1: role Client, ip 10.0.10.30, 4GB RAM, 2 processors
      - attack1: role Ubuntu, ip 10.0.10.50, 2GB RAM, 2 processors
    - Total: 10GB RAM, 8 CPUs

    **MultiTierApp.json** (TMPL-02):
    - name: "MultiTierApp"
    - description: "Multi-tier application lab: DC, SQL Server, IIS web server, client"
    - VMs:
      - dc1: role DC, ip 10.0.10.10, 4GB RAM, 4 processors
      - sql1: role SQL, ip 10.0.10.40, 8GB RAM, 4 processors
      - web1: role IIS, ip 10.0.10.41, 4GB RAM, 2 processors
      - ws1: role Client, ip 10.0.10.30, 4GB RAM, 2 processors
    - Total: 20GB RAM, 12 CPUs

    **MinimalAD.json** (TMPL-03):
    - name: "MinimalAD"
    - description: "Minimal Active Directory lab: single DC with minimum resources"
    - VMs:
      - dc1: role DC, ip 10.0.10.10, 2GB RAM, 2 processors
    - Total: 2GB RAM, 2 CPUs

    **Private/Get-LabScenarioTemplate.ps1:**
    Create a function `Get-LabScenarioTemplate` with `[CmdletBinding()]` and `[OutputType([PSCustomObject])]`:
    - Parameters:
      - `[Parameter(Mandatory)][string]$Scenario` — scenario name (SecurityLab, MultiTierApp, MinimalAD)
      - `[Parameter()][string]$TemplatesRoot` — path to templates directory, defaults to `Join-Path (Join-Path $PSScriptRoot '..') '.planning/templates'` (PS 5.1 nested Join-Path)
    - Logic:
      1. Build path: `Join-Path $TemplatesRoot "$Scenario.json"`
      2. If file not found, get available scenarios by listing `*.json` files in $TemplatesRoot, filtering out `default.json`, extract base names. Throw with message: "Get-LabScenarioTemplate: Scenario '$Scenario' not found. Available scenarios: $available"
      3. Read and parse JSON with try/catch (throw on invalid JSON with function-name prefix)
      4. Call `Test-LabTemplateData` if available (same pattern as Get-ActiveTemplateConfig)
      5. Build and return PSCustomObject array of VM definitions (same shape as Get-ActiveTemplateConfig: Name, Role, Ip, MemoryGB, Processors)
    - Error handling: try/catch with `throw "Get-LabScenarioTemplate: context - $_"` pattern per project conventions
    - Include full comment-based help (.SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE, .OUTPUTS)

    Use the same VM definition PSCustomObject shape as Get-ActiveTemplateConfig for compatibility with Deploy.ps1.
  </action>
  <verify>
    Run: `pwsh -Command "& { . ./Private/Test-LabTemplateData.ps1; . ./Private/Get-LabScenarioTemplate.ps1; Get-LabScenarioTemplate -Scenario SecurityLab -TemplatesRoot '.planning/templates' }"` — should return 3 VM objects.
    Verify each JSON file is valid: `pwsh -Command "Get-Content '.planning/templates/SecurityLab.json' | ConvertFrom-Json"` for each file.
  </verify>
  <done>Three scenario JSON files exist with correct VM definitions. Get-LabScenarioTemplate resolves scenario names to VM definition arrays. Invalid names produce error listing available scenarios.</done>
</task>

<task type="auto">
  <name>Task 2: Create resource estimator function and Pester test suite</name>
  <files>Private/Get-LabScenarioResourceEstimate.ps1, Tests/ScenarioTemplates.Tests.ps1</files>
  <action>
    **Private/Get-LabScenarioResourceEstimate.ps1** (TMPL-05):
    Create function `Get-LabScenarioResourceEstimate` with `[CmdletBinding()]` and `[OutputType([PSCustomObject])]`:
    - Parameters:
      - `[Parameter(Mandatory)][string]$Scenario` — scenario name
      - `[Parameter()][string]$TemplatesRoot` — templates directory (same default as Get-LabScenarioTemplate)
    - Logic:
      1. Call `Get-LabScenarioTemplate -Scenario $Scenario -TemplatesRoot $TemplatesRoot` to get VM definitions
      2. Sum up: TotalRAMGB (sum of MemoryGB), TotalProcessors (sum of Processors), VMCount (count of VMs)
      3. Estimate TotalDiskGB: use a role-based lookup: DC=80, SQL=100, IIS=60, Server=60, Client=60, Ubuntu=40, default=60. Sum per VM.
      4. Return PSCustomObject:
         ```
         [PSCustomObject]@{
             Scenario       = $Scenario
             VMCount        = $vmCount
             TotalRAMGB     = $totalRam
             TotalDiskGB    = $totalDisk
             TotalProcessors = $totalCpus
             VMs            = $vmDefs
         }
         ```
    - Error handling: try/catch wrapping the entire function body, throw with function-name prefix
    - Include full comment-based help

    **Tests/ScenarioTemplates.Tests.ps1:**
    Create Pester 5.x test suite with these Describe blocks:

    1. `Describe 'Scenario Template JSON Files'`:
       - Context per scenario (SecurityLab, MultiTierApp, MinimalAD)
       - Tests: file exists, valid JSON, has name/description/vms properties, vms is non-empty array, each VM has required properties (name, role, ip, memoryGB, processors), memoryGB and processors are positive integers, IPs match 10.0.10.x pattern
       - SecurityLab: has exactly 3 VMs with roles DC, Client, Ubuntu
       - MultiTierApp: has exactly 4 VMs with roles DC, SQL, IIS, Client
       - MinimalAD: has exactly 1 VM with role DC

    2. `Describe 'Get-LabScenarioTemplate'`:
       - BeforeAll: dot-source both `Private/Test-LabTemplateData.ps1` and `Private/Get-LabScenarioTemplate.ps1`
       - Tests:
         - Returns VM definitions for SecurityLab (count = 3)
         - Returns VM definitions for MultiTierApp (count = 4)
         - Returns VM definitions for MinimalAD (count = 1)
         - Each returned object has Name, Role, Ip, MemoryGB, Processors properties
         - Throws on invalid scenario name
         - Error message contains available scenario names
         - Throws on missing TemplatesRoot directory

    3. `Describe 'Get-LabScenarioResourceEstimate'`:
       - BeforeAll: dot-source Get-LabScenarioTemplate, Get-LabScenarioResourceEstimate, Test-LabTemplateData
       - Tests:
         - SecurityLab: TotalRAMGB = 10, VMCount = 3, TotalProcessors = 8
         - MultiTierApp: TotalRAMGB = 20, VMCount = 4, TotalProcessors = 12
         - MinimalAD: TotalRAMGB = 2, VMCount = 1, TotalProcessors = 2
         - Returns Scenario, VMCount, TotalRAMGB, TotalDiskGB, TotalProcessors, VMs properties
         - TotalDiskGB is a positive integer for all scenarios
         - Throws on invalid scenario name

    Use `$repoRoot = Split-Path -Parent $PSScriptRoot` pattern in BeforeAll. Use `-TemplatesRoot (Join-Path $repoRoot '.planning/templates')` to pass explicit paths.
  </action>
  <verify>
    Run: `pwsh -Command "Invoke-Pester -Path Tests/ScenarioTemplates.Tests.ps1 -Output Detailed"` — all tests pass.
  </verify>
  <done>Get-LabScenarioResourceEstimate returns correct totals for all three scenarios. Pester suite has 25+ tests covering template JSON structure, resolver, and estimator. All tests pass.</done>
</task>

</tasks>

<verification>
1. Three scenario JSON files exist in `.planning/templates/` with valid structure
2. `Get-LabScenarioTemplate` resolves all three scenario names correctly
3. `Get-LabScenarioResourceEstimate` returns accurate resource totals
4. Invalid scenario names produce clear error messages with available options
5. All Pester tests in `Tests/ScenarioTemplates.Tests.ps1` pass
6. VM definition objects match the shape used by `Deploy.ps1` (Name, Role, Ip, MemoryGB, Processors)
</verification>

<success_criteria>
- SecurityLab, MultiTierApp, and MinimalAD JSON templates exist with correct VM definitions
- Get-LabScenarioTemplate resolves names to VM definition arrays compatible with Deploy.ps1
- Get-LabScenarioResourceEstimate returns RAM, disk, CPU totals per scenario
- 25+ Pester tests pass covering all scenarios and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/14-lab-scenario-templates/14-01-SUMMARY.md`
</output>
