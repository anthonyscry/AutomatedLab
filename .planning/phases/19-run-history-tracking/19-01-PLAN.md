---
phase: 19-run-history-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Public/Get-LabRunHistory.ps1
  - SimpleLab.psm1
  - SimpleLab.psd1
autonomous: true
requirements: [HIST-01, HIST-02, HIST-03]

must_haves:
  truths:
    - "Operator runs Get-LabRunHistory and sees a formatted table of last N runs"
    - "Operator runs Get-LabRunHistory -RunId <id> and sees full detail for that run"
    - "Run history entries show timestamp, action type, outcome, and duration"
    - "Get-LabRunHistory is exported from SimpleLab module"
  artifacts:
    - path: "Public/Get-LabRunHistory.ps1"
      provides: "Run history query cmdlet with table and detail views"
      exports: ["Get-LabRunHistory"]
    - path: "SimpleLab.psm1"
      provides: "Module export registration"
      contains: "Get-LabRunHistory"
    - path: "SimpleLab.psd1"
      provides: "Manifest export registration"
      contains: "Get-LabRunHistory"
  key_links:
    - from: "Public/Get-LabRunHistory.ps1"
      to: "Private/Get-LabRunArtifactSummary.ps1"
      via: "calls Get-LabRunArtifactPaths and Get-LabRunArtifactSummary"
      pattern: "Get-LabRunArtifact(Paths|Summary)"
    - from: "SimpleLab.psm1"
      to: "Public/Get-LabRunHistory.ps1"
      via: "Export-ModuleMember includes Get-LabRunHistory"
      pattern: "Get-LabRunHistory"
---

<objective>
Create the Get-LabRunHistory Public cmdlet that reads existing run artifact JSON files and presents them as either a formatted summary table (last N runs) or a detailed single-run view.

Purpose: Operators need a simple CLI command to review deployment history without manually parsing JSON log files in C:\LabSources\Logs.
Output: Public/Get-LabRunHistory.ps1 cmdlet registered in module exports.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@Private/Get-LabRunArtifactSummary.ps1
@Private/Write-LabRunArtifacts.ps1
@SimpleLab.psm1
@SimpleLab.psd1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabRunHistory Public cmdlet</name>
  <files>Public/Get-LabRunHistory.ps1</files>
  <action>
Create Public/Get-LabRunHistory.ps1 with full comment-based help (.SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE, .OUTPUTS).

The function signature:
```
function Get-LabRunHistory {
    [CmdletBinding()]
    [OutputType([PSCustomObject[]])]
    param(
        [string]$RunId,
        [int]$Last = 20,
        [string]$LogRoot = 'C:\LabSources\Logs'
    )
```

**List mode (no -RunId):**
1. Call Get-LabRunArtifactPaths -LogRoot $LogRoot to get all artifact file paths
2. Filter to .json files only (skip .txt duplicates)
3. For each JSON path, call Get-LabRunArtifactSummary -ArtifactPath $path inside try/catch (skip corrupt files with Write-Warning, matching the profile pattern)
4. Sort results by EndedUtc descending (newest first)
5. Take only the first $Last results
6. Return array of PSCustomObject with properties: RunId, Action, Mode, Success, DurationSeconds, EndedUtc, Error
7. Use Format-Table -AutoSize hint via a default display property set or just let the caller format it (PowerShell default table display handles 7 properties well)

**Detail mode (-RunId provided):**
1. Call Get-LabRunArtifactPaths -LogRoot $LogRoot
2. Filter to .json files matching pattern "*$RunId*"
3. If no match found, throw "Run '$RunId' not found in '$LogRoot'"
4. Read the full JSON with Get-Content -Raw | ConvertFrom-Json
5. Return the full PSCustomObject from the JSON (all fields: run_id, action, dispatch_mode, execution_outcome, requested_mode, effective_mode, started_utc, ended_utc, duration_seconds, success, error, host, user, events, etc.)

**Important conventions:**
- Use [CmdletBinding()] and [OutputType()]
- Use Join-Path with only 2 args for PS 5.1 compatibility (though here we just pass $LogRoot directly)
- Wrap file reads in try/catch with Write-Warning for corrupt files (never crash the whole listing)
- Follow existing Private helper signatures: Get-LabRunArtifactPaths accepts -LogRoot, Get-LabRunArtifactSummary accepts -ArtifactPath
  </action>
  <verify>Confirm file exists: Test-Path Public/Get-LabRunHistory.ps1. Verify it contains 'function Get-LabRunHistory', '[CmdletBinding()]', and '.SYNOPSIS'.</verify>
  <done>Public/Get-LabRunHistory.ps1 exists with list mode (last N summaries sorted newest-first) and detail mode (full JSON for a specific RunId), following all project conventions.</done>
</task>

<task type="auto">
  <name>Task 2: Register Get-LabRunHistory in module exports</name>
  <files>SimpleLab.psm1, SimpleLab.psd1</files>
  <action>
Add 'Get-LabRunHistory' to the Export-ModuleMember list in SimpleLab.psm1. Place it after 'Write-RunArtifact' in the VM management section (or add a new comment line "# Run history" before it for clarity).

Add 'Get-LabRunHistory' to the FunctionsToExport array in SimpleLab.psd1 in the same position.

Both files already have existing entries — just add the new function name to the arrays. Keep alphabetical/logical grouping consistent with what's already there.
  </action>
  <verify>Run: Select-String -Path SimpleLab.psm1,SimpleLab.psd1 -Pattern 'Get-LabRunHistory' — both files should match.</verify>
  <done>Get-LabRunHistory appears in both SimpleLab.psm1 Export-ModuleMember and SimpleLab.psd1 FunctionsToExport arrays.</done>
</task>

</tasks>

<verification>
- Public/Get-LabRunHistory.ps1 exists and defines a function with CmdletBinding
- SimpleLab.psm1 exports Get-LabRunHistory
- SimpleLab.psd1 exports Get-LabRunHistory
- Function accepts -RunId, -Last, -LogRoot parameters
- Function calls existing Private helpers (Get-LabRunArtifactPaths, Get-LabRunArtifactSummary)
</verification>

<success_criteria>
Get-LabRunHistory cmdlet is created and registered in the module. List mode returns summary table of last N runs. Detail mode returns full run data for a specific RunId. Existing run artifact infrastructure is reused without modification.
</success_criteria>

<output>
After completion, create `.planning/phases/19-run-history-tracking/19-01-SUMMARY.md`
</output>
