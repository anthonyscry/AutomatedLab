---
phase: 29
plan: 04
title: VMCard XAML Updates for Enriched Metrics
type: standard
wave: 3
depends_on: ["29-03"]
files_modified:
  - GUI/Components/VMCard.xaml
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
  - DASH-04
must_haves:
  - Four new metric rows added to VMCard.xaml (snapshot, disk, uptime, STIG)
  - Icon + Label + Value + Status Badge format for each metric
  - Emoji status badges (ğŸŸ¢, ğŸŸ¡, ğŸ”´, âšª)
  - RowDefs added to accommodate new content
  - XAML validates successfully
---

## Objective

Update the VMCard.xaml component to display the four new metrics (snapshot age, disk usage, uptime, STIG compliance). Each metric is displayed as a compact row with icon, label, value, and status badge.

## Context

@phase-context: .planning/phases/29-dashboard-enrichment/29-CONTEXT.md
@research: .planning/phases/29-dashboard-enrichment/29-RESEARCH.md
@vmcard-pattern: GUI/Components/VMCard.xaml (existing 5-row layout)
@thresholds: Private/Get-LabDashboardConfig.ps1 (from plan 29-01)

Per CONTEXT.md decision: Four rows added below existing Row 3 (CPU+Memory). Format: Icon + Label + Value + Status Badge. Emoji badges: ğŸŸ¢ (green), ğŸŸ¡ (yellow), ğŸ”´ (red), âšª (white/gray). Thresholds match config defaults.

## Tasks

### Task 1: Update VMCard.xaml Grid RowDefinitions

**Type:** auto

**Files:**
- GUI/Components/VMCard.xaml

**Action:**
Update the Grid.RowDefinitions in VMCard.xaml to add 4 new rows (expand from 5 to 9 rows):

```xml
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Row 0: Status dot + VM name (unchanged) -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,4">
            <!-- ... existing content ... -->
        </StackPanel>

        <!-- Row 1: Role (unchanged) -->
        <TextBlock Grid.Row="1" ... />

        <!-- Row 2: IP address (unchanged) -->
        <TextBlock Grid.Row="2" ... />

        <!-- Row 3: CPU + Memory (unchanged) -->
        <StackPanel Grid.Row="3" ... />

        <!-- Row 4: Snapshot age (NEW) -->
        <!-- Content added in Task 2 -->

        <!-- Row 5: Disk usage (NEW) -->
        <!-- Content added in Task 2 -->

        <!-- Row 6: VM uptime (NEW) -->
        <!-- Content added in Task 2 -->

        <!-- Row 7: STIG compliance (NEW) -->
        <!-- Content added in Task 2 -->

        <!-- Row 8: Action buttons (moved from Row 4) -->
        <StackPanel Grid.Row="8" ... />
    </Grid>
```

Key changes:
- Add 4 new RowDefinition entries (rows 4-7)
- Move action buttons from Row 4 to Row 8
- Keep existing rows 0-3 unchanged

**Verify:**
- Grid.RowDefinitions has 9 entries total
- Action buttons Grid.Row changes from 4 to 8

**Done:**
VMCard.xaml has 9 row definitions with existing content rows preserved and slots for 4 new metric rows.

### Task 2: Add four metric rows to VMCard.xaml

**Type:** auto

**Files:**
- GUI/Components/VMCard.xaml

**Action:**
Add the four metric rows after Row 3 (CPU+Memory) and before the action buttons. Insert these rows:

```xml
        <!-- Row 4: Snapshot age -->
        <TextBlock Grid.Row="4"
                   x:Name="txtSnapshotAge"
                   Text="ğŸ’¾ Snapshot: -- [âšª]"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   FontSize="11"
                   Margin="0,0,0,3" />

        <!-- Row 5: Disk usage -->
        <TextBlock Grid.Row="5"
                   x:Name="txtDiskUsage"
                   Text="ğŸ’¾ Disk: -- [âšª]"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   FontSize="11"
                   Margin="0,0,0,3" />

        <!-- Row 6: VM uptime -->
        <TextBlock Grid.Row="6"
                   x:Name="txtUptime"
                   Text="â±ï¸ Uptime: -- [âšª]"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   FontSize="11"
                   Margin="0,0,0,3" />

        <!-- Row 7: STIG compliance -->
        <TextBlock Grid.Row="7"
                   x:Name="txtSTIGStatus"
                   Text="ğŸ”’ STIG: Unknown [âšª]"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   FontSize="11"
                   Margin="0,0,0,6" />
```

Then update the action buttons Row from 4 to 8:

```xml
        <!-- Row 8: Action buttons -->
        <StackPanel Grid.Row="8" Orientation="Horizontal">
```

Key design notes:
- Icons: ğŸ’¾ (snapshot/disk), â±ï¸ (uptime), ğŸ”’ (STIG)
- Default text shows "Unknown" with âšª (white/gray) badge
- FontSize 11 (smaller than existing 12 for compact display)
- Margin 0,0,0,3 for tight spacing (last row uses 6 for more space before buttons)

**Verify:**
- All four TextBlock elements exist with correct x:Name values
- Grid.Row values are sequential (4, 5, 6, 7)
- Action buttons moved to Grid.Row="8"
- All TextBlock attributes match specification (FontSize, Margin, Foreground)

**Done:**
Four metric rows added to VMCard.xaml with icon+label+value+badge format, action buttons moved to Row 8.

### Task 3: Create Get-StatusBadgeForMetric helper

**Type:** auto

**Files:**
- GUI/Start-OpenCodeLabGUI.ps1

**Action:**
Add the Get-StatusBadgeForMetric helper function after Get-StatusColor (around line 330):

```powershell
# â”€â”€ Status badge lookup for dashboard metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Get-StatusBadgeForMetric {
    <#
    .SYNOPSIS
        Returns an emoji status badge based on metric value and threshold.

    .DESCRIPTION
        Maps metric values to emoji badges (ğŸŸ¢, ğŸŸ¡, ğŸ”´, âšª) based on
        configured thresholds from Get-LabDashboardConfig. Used by
        Update-VMCardWithMetrics to display status indicators.

    .PARAMETER MetricType
        Type of metric: 'Snapshot', 'Disk', 'Uptime', or 'STIG'.

    .PARAMETER Value
        Numeric value for Snapshot/Disk/Uptime, or string status for STIG.

    .OUTPUTS
        String containing emoji badge character.
    #>
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [Parameter(Mandatory)]
        [ValidateSet('Snapshot', 'Disk', 'Uptime', 'STIG')]
        [string]$MetricType,

        [Parameter(Mandatory)]
        $Value
    )

    $config = Get-LabDashboardConfig

    switch ($MetricType) {
        'Snapshot' {
            if ($null -eq $Value) { return 'âšª' }
            if ($Value -ge $config.SnapshotStaleCritical) { return 'ğŸ”´' }
            if ($Value -ge $config.SnapshotStaleDays) { return 'ğŸŸ¡' }
            return 'ğŸŸ¢'
        }
        'Disk' {
            if ($null -eq $Value) { return 'âšª' }
            if ($Value -ge $config.DiskUsageCritical) { return 'ğŸ”´' }
            if ($Value -ge $config.DiskUsagePercent) { return 'ğŸŸ¡' }
            return 'ğŸŸ¢'
        }
        'Uptime' {
            if ($null -eq $Value) { return 'âšª' }
            if ($Value -ge $config.UptimeStaleHours) { return 'ğŸŸ¡' }
            return 'ğŸŸ¢'
        }
        'STIG' {
            switch ($Value) {
                'Compliant'    { return 'ğŸŸ¢' }
                'NonCompliant' { return 'ğŸ”´' }
                'Applying'     { return 'ğŸŸ¡' }
                default        { return 'âšª' }
            }
        }
    }
}
```

Key implementation notes:
- Uses Get-LabDashboardConfig for thresholds (from plan 29-01)
- Returns âšª (white/gray) for null/unknown values
- STIG uses string status matching, not numeric comparison
- ValidateSet prevents typos in MetricType parameter

**Verify:**
- Function exists in GUI/Start-OpenCodeLabGUI.ps1
- Returns correct emoji for each threshold level
- Handles null values by returning âšª

**Done:**
Get-StatusBadgeForMetric helper provides emoji badge lookup based on metric type and threshold comparison.

### Task 4: Create Update-VMCardWithMetrics function

**Type:** auto

**Files:**
- GUI/Start-OpenCodeLabGUI.ps1

**Action:**
Add the Update-VMCardWithMetrics function after Update-VMCard (around line 403):

```powershell
# â”€â”€ Update VM card with enriched dashboard metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Update-VMCardWithMetrics {
    <#
    .SYNOPSIS
        Updates a VM card with the four enriched dashboard metrics.

    .DESCRIPTION
        Reads metrics from the synchronized hashtable populated by the
        background runspace and updates the VM card TextBlocks with
        formatted values and status badges. Handles missing data gracefully.

    .PARAMETER Card
        The VM card WPF element to update.

    .PARAMETER VMName
        Name of the VM to read metrics for.
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [System.Windows.FrameworkElement]$Card,

        [Parameter(Mandatory)]
        [string]$VMName
    )

    # Read metrics from synchronized hashtable
    $metrics = if ($script:DashboardMetrics.ContainsKey($VMName)) {
        $script:DashboardMetrics[$VMName]
    } else {
        @{}
    }

    # Snapshot age
    $snapshotAge = $metrics.SnapshotAge
    $snapshotBadge = Get-StatusBadgeForMetric -MetricType 'Snapshot' -Value $snapshotAge
    $snapshotText = if ($null -eq $snapshotAge) {
        'ğŸ’¾ Snapshot: No snapshots [âšª]'
    } else {
        "ğŸ’¾ Snapshot: $snapshotAge days [$snapshotBadge]"
    }
    $Card.FindName('txtSnapshotAge').Text = $snapshotText

    # Disk usage
    $diskGB = $metrics.DiskUsageGB
    $diskPercent = $metrics.DiskUsagePercent
    $diskBadge = Get-StatusBadgeForMetric -MetricType 'Disk' -Value $diskPercent
    $diskText = if ($null -eq $diskGB) {
        'ğŸ’¾ Disk: -- [âšª]'
    } else {
        "ğŸ’¾ Disk: $diskGB GB ($diskPercent%) [$diskBadge]"
    }
    $Card.FindName('txtDiskUsage').Text = $diskText

    # Uptime
    $uptimeHours = $metrics.UptimeHours
    $uptimeBadge = Get-StatusBadgeForMetric -MetricType 'Uptime' -Value $uptimeHours
    $uptimeText = if ($null -eq $uptimeHours) {
        'â±ï¸ Uptime: -- [âšª]'
    } else {
        $uptimeStr = if ($uptimeHours -ge 24) {
            "$([math]::Floor($uptimeHours / 24))d $($uptimeHours % 24)h"
        } else {
            "$([math]::Round($uptimeHours, 1))h"
        }
        "â±ï¸ Uptime: $uptimeStr [$uptimeBadge]"
    }
    $Card.FindName('txtUptime').Text = $uptimeText

    # STIG status
    $stigStatus = $metrics.STIGStatus
    $stigBadge = Get-StatusBadgeForMetric -MetricType 'STIG' -Value $stigStatus
    $stigText = if ($null -eq $stigStatus -or $stigStatus -eq 'Unknown') {
        'ğŸ”’ STIG: Unknown [âšª]'
    } else {
        "ğŸ”’ STIG: $stigStatus [$stigBadge]"
    }
    $Card.FindName('txtSTIGStatus').Text = $stigText
}
```

Key implementation notes:
- Reads from $script:DashboardMetrics hashtable
- Uses Get-StatusBadgeForMetric for emoji lookup
- Formats uptime as "Xd Yh" for >= 24 hours, "Xh" for < 24 hours
- Shows "No snapshots" when snapshot age is null
- Includes disk percentage alongside GB value

**Verify:**
- Function exists in GUI/Start-OpenCodeLabGUI.ps1
- Updates all four TextBlock elements in the VM card
- Handles missing metrics data gracefully (shows -- or Unknown)

**Done:**
Update-VMCardWithMetrics function reads from synchronized hashtable and updates VM card with formatted metrics and status badges.

### Task 5: Validate XAML syntax

**Type:** manual

**Files:**
- GUI/Components/VMCard.xaml

**Action:**
Validate the XAML file loads without errors:

```powershell
# From GUI directory
Add-Type -AssemblyName PresentationFramework
$reader = [System.Xml.XmlReader]::Create((Join-Path $PSScriptRoot 'Components/VMCard.xaml'))
try {
    [System.Windows.Markup.XamlReader]::Load($reader)
    Write-Host "VMCard.xaml is valid"
}
finally {
    $reader.Close()
}
```

**Verify:**
- XAML loads without XML parsing errors
- All TextBlock x:Name values are unique
- Grid.Row values are sequential 0-8

**Done:**
VMCard.xaml validates successfully. All four metric rows added with correct syntax and placement.

---

## Verification Criteria

1. **VMCard.xaml**: 9 row definitions, 4 new metric rows (snapshot, disk, uptime, STIG), action buttons moved to Row 8
2. **Metric Rows**: Icon + Label + Value + Badge format, emoji badges (ğŸŸ¢, ğŸŸ¡, ğŸ”´, âšª), FontSize 11, tight spacing
3. **Badge Helper**: Get-StatusBadgeForMetric returns correct emoji based on thresholds
4. **Update Function**: Update-VMCardWithMetrics reads from hashtable and updates all four TextBlocks
5. **XAML Valid**: VMCard.xaml loads without errors, all x:Name values unique

## Success Metrics

- VMCard.xaml loads via XamlReader without throwing
- All four TextBlock elements have unique x:Name values (txtSnapshotAge, txtDiskUsage, txtUptime, txtSTIGStatus)
- Get-StatusBadgeForMetric returns ğŸŸ¢ for values below warning threshold
- Get-StatusBadgeForMetric returns ğŸŸ¡ for values at warning threshold
- Get-StatusBadgeForMetric returns ğŸ”´ for values at critical threshold
- Get-StatusBadgeForMetric returns âšª for null values
- Update-VMCardWithMetrics updates all four TextBlocks when called
