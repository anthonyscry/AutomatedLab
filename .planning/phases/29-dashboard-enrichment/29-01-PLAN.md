---
phase: 29
plan: 01
title: Dashboard Configuration Block and Config Reader
type: standard
wave: 1
depends_on: []
files_modified:
  - Lab-Config.ps1
  - Private/Get-LabDashboardConfig.ps1
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
must_haves:
  - Dashboard configuration block in Lab-Config.ps1 after ADMX block
  - Get-LabDashboardConfig helper following Get-LabTTLConfig pattern with ContainsKey guards
  - Default thresholds match CONTEXT.md (SnapshotStaleDays=7/30, DiskUsagePercent=80/95, UptimeStaleHours=72)
  - Unit tests covering all config branches (missing keys, partial keys, type casting, StrictMode)
---

## Objective

Add the Dashboard configuration block to Lab-Config.ps1 and create the Get-LabDashboardConfig helper function that reads dashboard threshold settings safely with ContainsKey guards. This establishes the configuration foundation for all dashboard enrichment operations.

## Context

@phase-context: .planning/phases/29-dashboard-enrichment/29-CONTEXT.md
@research: .planning/phases/29-dashboard-enrichment/29-RESEARCH.md
@config-pattern: Lab-Config.ps1 (ADMX block lines 231-239)
@helper-pattern: Private/Get-LabTTLConfig.ps1
@test-pattern: Tests/LabTTLConfig.Tests.ps1

Per CONTEXT.md decision: Add Dashboard = @{...} block to $GlobalLabConfig after the ADMX block (after line 239) with keys: SnapshotStaleDays (int, default 7), SnapshotStaleCritical (int, default 30), DiskUsagePercent (int, default 80), DiskUsageCritical (int, default 95), UptimeStaleHours (int, default 72).

## Tasks

### Task 1: Add Dashboard configuration block to Lab-Config.ps1

**Type:** auto

**Files:**
- Lab-Config.ps1

**Action:**
Add the Dashboard configuration block to Lab-Config.ps1 immediately after the ADMX block (after line 239). Use this exact structure:

```powershell
    Dashboard = @{
        # Changing SnapshotStaleDays sets the warning threshold for snapshot age (in days).
        SnapshotStaleDays = 7
        # Changing SnapshotStaleCritical sets the critical threshold for snapshot age (in days).
        SnapshotStaleCritical = 30
        # Changing DiskUsagePercent sets the warning threshold for VHDx usage (in percent).
        DiskUsagePercent = 80
        # Changing DiskUsageCritical sets the critical threshold for VHDx usage (in percent).
        DiskUsageCritical = 95
        # Changing UptimeStaleHours sets the stale threshold for VM uptime (in hours).
        UptimeStaleHours = 72
    }
```

Do NOT add any additional keys beyond SnapshotStaleDays, SnapshotStaleCritical, DiskUsagePercent, DiskUsageCritical, and UptimeStaleHours. The block must be placed after ADMX and before SSH to maintain the established config block ordering.

**Verify:**
- Lab-Config.ps1 loads without error using `. .\Lab-Config.ps1`
- `$GlobalLabConfig.Dashboard.SnapshotStaleDays` returns `7`
- `$GlobalLabConfig.Dashboard.SnapshotStaleCritical` returns `30`
- `$GlobalLabConfig.Dashboard.DiskUsagePercent` returns `80`
- `$GlobalLabConfig.Dashboard.DiskUsageCritical` returns `95`
- `$GlobalLabConfig.Dashboard.UptimeStaleHours` returns `72`

**Done:**
Dashboard block exists in Lab-Config.ps1 with correct structure, placement after ADMX block, and default values match CONTEXT.md specification.

### Task 2: Create Get-LabDashboardConfig helper function

**Type:** auto

**Files:**
- Private/Get-LabDashboardConfig.ps1

**Action:**
Create Private/Get-LabDashboardConfig.ps1 following the exact pattern from Private/Get-LabTTLConfig.ps1:

```powershell
function Get-LabDashboardConfig {
    <#
    .SYNOPSIS
        Reads Dashboard configuration from GlobalLabConfig with safe defaults.

    .DESCRIPTION
        Returns a PSCustomObject with Dashboard threshold settings. Uses ContainsKey guards on
        every read to prevent StrictMode failures when keys are absent.
        Returns safe defaults when the Dashboard block or individual keys are missing.

    .OUTPUTS
        PSCustomObject with SnapshotStaleDays, SnapshotStaleCritical, DiskUsagePercent,
        DiskUsageCritical, UptimeStaleHours fields.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $dashBlock = if (Test-Path variable:GlobalLabConfig) {
        if ($GlobalLabConfig.ContainsKey('Dashboard')) { $GlobalLabConfig.Dashboard } else { @{} }
    } else { @{} }

    [pscustomobject]@{
        SnapshotStaleDays  = if ($dashBlock.ContainsKey('SnapshotStaleDays'))  { [int]$dashBlock.SnapshotStaleDays }     else { 7 }
        SnapshotStaleCritical = if ($dashBlock.ContainsKey('SnapshotStaleCritical')) { [int]$dashBlock.SnapshotStaleCritical } else { 30 }
        DiskUsagePercent   = if ($dashBlock.ContainsKey('DiskUsagePercent'))   { [int]$dashBlock.DiskUsagePercent }    else { 80 }
        DiskUsageCritical  = if ($dashBlock.ContainsKey('DiskUsageCritical'))  { [int]$dashBlock.DiskUsageCritical }   else { 95 }
        UptimeStaleHours   = if ($dashBlock.ContainsKey('UptimeStaleHours'))   { [int]$dashBlock.UptimeStaleHours }    else { 72 }
    }
}
```

Key pattern notes:
- Use `Test-Path variable:GlobalLabConfig` to check variable existence under StrictMode
- Nested ContainsKey guards: first check for 'Dashboard' key, then check each subkey
- Type cast to [int] on every value read to ensure numeric types
- Use PS 5.1 compatible if/else (no ternary operator)

**Verify:**
- Function exists at Private/Get-LabDashboardConfig.ps1
- `Get-LabDashboardConfig` returns PSCustomObject with all 5 properties
- When Dashboard block missing: returns defaults (7, 30, 80, 95, 72)
- When partial keys present: returns mix of configured and default values
- `Set-StrictMode -Version Latest` does not throw when calling function with missing keys

**Done:**
Get-LabDashboardConfig exists in Private/, follows Get-LabTTLConfig pattern exactly, returns PSCustomObject with all 5 threshold properties, ContainsKey guards prevent StrictMode failures.

### Task 3: Create unit tests for Get-LabDashboardConfig

**Type:** auto

**Files:**
- Tests/LabDashboardConfig.Tests.ps1

**Action:**
Create Tests/LabDashboardConfig.Tests.ps1 following the pattern from Tests/LabTTLConfig.Tests.ps1. Test all branches:

```powershell
BeforeAll {
    . $PSScriptRoot/../Private/Get-LabDashboardConfig.ps1
}

Describe 'Get-LabDashboardConfig' {
    It 'Returns default values when GlobalLabConfig missing' {
        $original = $null
        if (Test-Path variable:GlobalLabConfig) {
            $original = $GlobalLabConfig
            Remove-Variable -Name GlobalLabConfig -Scope Global
        }

        try {
            Set-StrictMode -Version Latest
            $config = Get-LabDashboardConfig

            $config.SnapshotStaleDays | Should -Be 7
            $config.SnapshotStaleCritical | Should -Be 30
            $config.DiskUsagePercent | Should -Be 80
            $config.DiskUsageCritical | Should -Be 95
            $config.UptimeStaleHours | Should -Be 72
        }
        finally {
            if ($null -ne $original) {
                $GlobalLabConfig = $original
            }
        }
    }

    It 'Returns default values when Dashboard block missing' {
        $GlobalLabConfig = @{ Lab = @{} }

        Set-StrictMode -Version Latest
        $config = Get-LabDashboardConfig

        $config.SnapshotStaleDays | Should -Be 7
        $config.SnapshotStaleCritical | Should -Be 30
        $config.DiskUsagePercent | Should -Be 80
        $config.DiskUsageCritical | Should -Be 95
        $config.UptimeStaleHours | Should -Be 72
    }

    It 'Returns configured values when all keys present' {
        $GlobalLabConfig = @{
            Dashboard = @{
                SnapshotStaleDays = 14
                SnapshotStaleCritical = 60
                DiskUsagePercent = 85
                DiskUsageCritical = 98
                UptimeStaleHours = 48
            }
        }

        Set-StrictMode -Version Latest
        $config = Get-LabDashboardConfig

        $config.SnapshotStaleDays | Should -Be 14
        $config.SnapshotStaleCritical | Should -Be 60
        $config.DiskUsagePercent | Should -Be 85
        $config.DiskUsageCritical | Should -Be 98
        $config.UptimeStaleHours | Should -Be 48
    }

    It 'Handles partial keys (mix of configured and default)' {
        $GlobalLabConfig = @{
            Dashboard = @{
                SnapshotStaleDays = 21
                # Missing SnapshotStaleCritical
                DiskUsagePercent = 90
                # Missing DiskUsageCritical, UptimeStaleHours
            }
        }

        Set-StrictMode -Version Latest
        $config = Get-LabDashboardConfig

        $config.SnapshotStaleDays | Should -Be 21
        $config.SnapshotStaleCritical | Should -Be 30  # default
        $config.DiskUsagePercent | Should -Be 90
        $config.DiskUsageCritical | Should -Be 95     # default
        $config.UptimeStaleHours | Should -Be 72      # default
    }

    It 'Type casts values to integers' {
        $GlobalLabConfig = @{
            Dashboard = @{
                SnapshotStaleDays = '5'
                DiskUsagePercent = '75'
            }
        }

        $config = Get-LabDashboardConfig

        $config.SnapshotStaleDays | Should -BeOfType [int]
        $config.DiskUsagePercent | Should -BeOfType [int]
    }
}
```

**Verify:**
- All 5 tests pass under `Set-StrictMode -Version Latest`
- Test coverage includes: missing GlobalLabConfig, missing Dashboard block, all keys present, partial keys, type casting
- Running `Invoke-Pester Tests/LabDashboardConfig.Tests.ps1` shows 5 passed tests

**Done:**
LabDashboardConfig.Tests.ps1 created with 5 tests covering all config branches. All tests pass under StrictMode. Coverage matches LabTTLConfig.Tests.ps1 pattern.

### Task 4: Run full test suite to verify no regressions

**Type:** manual

**Files:**
- None (verification task)

**Action:**
Run the full Pester test suite to ensure no regressions from new config block and helper:

```powershell
# From repo root
Invoke-Pester -Tests .
```

**Verify:**
- All existing tests still pass
- New LabDashboardConfig.Tests.ps1 tests pass
- No test failures related to Lab-Config.ps1 loading

**Done:**
Full test suite passes with no regressions. New config block and helper integrate cleanly with existing codebase.

---

## Verification Criteria

1. **Config Block**: Dashboard block exists in Lab-Config.ps1 after ADMX block with all 5 keys and correct default values
2. **Helper Function**: Get-LabDashboardConfig in Private/ follows Get-LabTTLConfig pattern with ContainsKey guards
3. **Unit Tests**: LabDashboardConfig.Tests.ps1 with 5 tests covering all branches, all passing under StrictMode
4. **No Regressions**: Full test suite passes with no failures

## Success Metrics

- `Get-LabDashboardConfig` returns PSCustomObject with correct types ([int] for all numeric values)
- `Set-StrictMode -Version Latest; Get-LabDashboardConfig` throws no errors when Dashboard block missing
- Lab-Config.ps1 loads successfully with Dashboard block present
- All 5 unit tests pass on first run
