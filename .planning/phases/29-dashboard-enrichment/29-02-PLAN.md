---
phase: 29
plan: 02
title: Metric Collection Helpers (Snapshot Age, Disk Usage, Uptime, STIG)
type: standard
wave: 2
depends_on: ["29-01"]
files_modified:
  - Private/Get-LabSnapshotAge.ps1
  - Private/Get-LabVMDiskUsage.ps1
  - Private/Get-LabVMMetrics.ps1
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
  - DASH-04
must_haves:
  - Get-LabSnapshotAge helper returns age in days with error handling
  - Get-LabVMDiskUsage helper returns GB used and usage percent
  - Get-LabVMMetrics orchestrates all metrics collection per VM
  - Unit tests for all three functions with Hyper-V mocks
  - STIG compliance reads from cache (Get-LabSTIGCompliance), uptime from Get-LabUptime
---

## Objective

Create helper functions that collect the four enriched dashboard metrics: snapshot age, disk usage, VM uptime, and STIG compliance status. These helpers will be called by the background runspace to populate the synchronized hashtable.

## Context

@phase-context: .planning/phases/29-dashboard-enrichment/29-CONTEXT.md
@research: .planning/phases/29-dashboard-enrichment/29-RESEARCH.md
@stig-pattern: Public/Get-LabSTIGCompliance.ps1 (reads .planning/stig-compliance.json)
@uptime-pattern: Public/Get-LabUptime.ps1 (reads .planning/lab-ttl-state.json)
@config-pattern: Private/Get-LabDashboardConfig.ps1 (created in plan 29-01)

Per CONTEXT.md decision: Snapshot age calculated from Get-VMSnapshot CreationTime, disk usage from Get-VHD FileSize/Size, uptime from Phase 26 Get-LabUptime, STIG from Phase 27 Get-LabSTIGCompliance cache. All helpers must handle missing data gracefully (return null or Unknown status).

## Tasks

### Task 1: Create Get-LabSnapshotAge helper

**Type:** auto

**Files:**
- Private/Get-LabSnapshotAge.ps1

**Action:**
Create Private/Get-LabSnapshotAge.ps1 to calculate the age of the oldest snapshot for a VM:

```powershell
function Get-LabSnapshotAge {
    <#
    .SYNOPSIS
        Returns the age of the oldest snapshot for a VM in days.

    .DESCRIPTION
        Queries Get-VMSnapshot for the specified VM and calculates the age
        of the oldest snapshot based on CreationTime. Returns null if no
        snapshots exist or on error.

    .PARAMETER VMName
        Name of the virtual machine to query.

    .OUTPUTS
        [int] Age in days, or $null if no snapshots or on error.
    #>
    [CmdletBinding()]
    [OutputType([int])]
    param(
        [Parameter(Mandatory)]
        [string]$VMName
    )

    try {
        $snapshots = Get-VMSnapshot -VMName $VMName -ErrorAction SilentlyContinue
        if (-not $snapshots -or @($snapshots).Count -eq 0) {
            return $null
        }

        # Find oldest snapshot (earliest CreationTime)
        $oldest = $snapshots | Sort-Object -Property CreationTime | Select-Object -First 1
        $age = (Get-Date) - $oldest.CreationTime
        return [int]$age.TotalDays
    }
    catch {
        Write-Verbose "[Get-LabSnapshotAge] Failed to query snapshots for $VMName`: $($_.Exception.Message)"
        return $null
    }
}
```

Key implementation notes:
- Sort by CreationTime ascending to get oldest (earliest) snapshot
- Return $null when no snapshots exist (not 0) - allows UI to distinguish "no snapshots" from "0 days old"
- ErrorAction SilentlyContinue on Get-VMSnapshot to handle non-existent VMs
- TotalDays cast to [int] for whole-day precision

**Verify:**
- Function exists at Private/Get-LabSnapshotAge.ps1
- Returns $null when VM has no snapshots
- Returns positive integer when snapshots exist
- Handles non-existent VM names without throwing

**Done:**
Get-LabSnapshotAge exists in Private/, returns snapshot age in days or $null, handles errors gracefully with Verbose output.

### Task 2: Create Get-LabVMDiskUsage helper

**Type:** auto

**Files:**
- Private/Get-LabVMDiskUsage.ps1

**Action:**
Create Private/Get-LabVMDiskUsage.ps1 to calculate VHDx disk usage for a VM:

```powershell
function Get-LabVMDiskUsage {
    <#
    .SYNOPSIS
        Returns VHDx disk usage information for a VM.

    .DESCRIPTION
        Queries Get-VMHardDiskDrive to find VHD paths, then uses Get-VHD
        to retrieve FileSize (actual on disk) and Size (logical size).
        Returns usage percentage and actual size in GB.

    .PARAMETER VMName
        Name of the virtual machine to query.

    .OUTPUTS
        [PSCustomObject] with FileSizeGB, SizeGB, UsagePercent properties.
        Returns $null on error or for Linux VMs.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [Parameter(Mandatory)]
        [string]$VMName
    )

    try {
        # Get VHD paths for the VM
        $vhdDrives = Get-VMHardDiskDrive -VMName $VMName -ErrorAction SilentlyContinue
        if (-not $vhdDrives -or @($vhdDrives).Count -eq 0) {
            Write-Verbose "[Get-LabVMDiskUsage] No VHD drives found for $VMName"
            return $null
        }

        # Sum up all VHD sizes (VMs may have multiple disks)
        $totalFileSize = 0.0
        $totalSize = 0.0

        foreach ($drive in $vhdDrives) {
            $vhdPath = $drive.Path
            if (-not (Test-Path $vhdPath)) {
                Write-Verbose "[Get-LabVMDiskUsage] VHD path not found: $vhdPath"
                continue
            }

            $vhdInfo = Get-VHD -Path $vhdPath -ErrorAction SilentlyContinue
            if ($vhdInfo) {
                $totalFileSize += $vhdInfo.FileSize
                $totalSize += $vhdInfo.Size
            }
        }

        if ($totalSize -eq 0) {
            return $null
        }

        $fileSizeGB = [math]::Round($totalFileSize / 1GB, 2)
        $sizeGB = [math]::Round($totalSize / 1GB, 2)
        $usagePercent = [math]::Round(($totalFileSize / $totalSize) * 100, 0)

        return [pscustomobject]@{
            FileSizeGB    = $fileSizeGB
            SizeGB        = $sizeGB
            UsagePercent  = $usagePercent
        }
    }
    catch {
        Write-Verbose "[Get-LabVMDiskUsage] Failed to query disk usage for $VMName`: $($_.Exception.Message)"
        return $null
    }
}
```

Key implementation notes:
- Iterate all VHD drives (VMs may have multiple disks)
- Sum FileSize and Size across all disks before calculating percentage
- Return $null for Linux VMs (no VHDx drives)
- Use [math]::Round for 2 decimal places on GB values, 0 decimal on percent
- Test-Path check on VHD path before calling Get-VHD

**Verify:**
- Function exists at Private/Get-LabVMDiskUsage.ps1
- Returns PSCustomObject with FileSizeGB, SizeGB, UsagePercent properties
- Handles multi-disk VMs correctly (sums all disks)
- Returns $null for non-existent VMs or Linux VMs

**Done:**
Get-LabVMDiskUsage exists in Private/, returns disk usage object with all 3 properties, handles multi-disk VMs and errors gracefully.

### Task 3: Create Get-LabVMMetrics orchestrator function

**Type:** auto

**Files:**
- Private/Get-LabVMMetrics.ps1

**Action:**
Create Private/Get-LabVMMetrics.ps1 to orchestrate collection of all four metrics per VM:

```powershell
function Get-LabVMMetrics {
    <#
    .SYNOPSIS
        Collects all dashboard metrics for a single VM.

    .DESCRIPTION
        Orchestrates collection of snapshot age, disk usage, VM uptime, and
        STIG compliance status for a VM. Returns a single PSCustomObject with
        all metrics. Designed to be called from a background runspace.

    .PARAMETER VMName
        Name of the virtual machine to query.

    .OUTPUTS
        [PSCustomObject] with VMName, SnapshotAge, DiskUsage, UptimeHours,
        STIGStatus properties. Individual properties may be $null when data
        is unavailable.
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [Parameter(Mandatory, ValueFromPipeline)]
        [string[]]$VMName
    )

    process {
        foreach ($vm in $VMName) {
            try {
                # Collect snapshot age
                $snapshotAge = Get-LabSnapshotAge -VMName $vm

                # Collect disk usage
                $diskUsage = Get-LabVMDiskUsage -VMName $vm

                # Collect uptime (from Phase 26)
                $uptimeData = Get-LabUptime -ErrorAction SilentlyContinue
                $uptimeHours = if ($uptimeData -and $uptimeData.ElapsedHours) {
                    $uptimeData.ElapsedHours
                } else {
                    $null
                }

                # Collect STIG compliance (from Phase 27 cache)
                $stigData = Get-LabSTIGCompliance -ErrorAction SilentlyContinue
                $stigEntry = $stigData | Where-Object { $_.VMName -eq $vm }
                $stigStatus = if ($stigEntry) {
                    $stigEntry.Status
                } else {
                    'Unknown'
                }

                [pscustomobject]@{
                    VMName          = $vm
                    SnapshotAge     = $snapshotAge         # [int] days or $null
                    DiskUsageGB     = if ($diskUsage) { $diskUsage.FileSizeGB } else { $null }
                    DiskUsagePercent = if ($diskUsage) { $diskUsage.UsagePercent } else { $null }
                    UptimeHours     = $uptimeHours        # [double] or $null
                    STIGStatus      = $stigStatus         # 'Compliant', 'NonCompliant', 'Applying', 'Unknown'
                }
            }
            catch {
                Write-Verbose "[Get-LabVMMetrics] Failed to collect metrics for $vm`: $($_.Exception.Message)"
                # Return partial object with error indicator
                [pscustomobject]@{
                    VMName            = $vm
                    SnapshotAge       = $null
                    DiskUsageGB       = $null
                    DiskUsagePercent  = $null
                    UptimeHours       = $null
                    STIGStatus        = 'Unknown'
                }
            }
        }
    }
}
```

Key implementation notes:
- Accepts pipeline input for bulk VM collection
- Uptime is lab-wide (same value for all VMs from Get-LabUptime)
- STIG status per-VM from Get-LabSTIGCompliance filtering
- Returns partial object with $null values on error (never throws)
- ErrorAction SilentlyContinue on Get-LabUptime and Get-LabSTIGCompliance

**Verify:**
- Function exists at Private/Get-LabVMMetrics.ps1
- Accepts string array via pipeline or parameter
- Returns PSCustomObject with all 6 properties for each VM
- Returns 'Unknown' STIG status when VM not in compliance cache
- Handles collection errors without throwing (returns nulls)

**Done:**
Get-LabVMMetrics exists in Private/, accepts pipeline input, returns complete metrics object per VM, handles errors gracefully with partial objects.

### Task 4: Create unit tests for metric collection helpers

**Type:** auto

**Files:**
- Tests/LabVMMetrics.Tests.ps1

**Action:**
Create Tests/LabVMMetrics.Tests.ps1 with mocked Hyper-V cmdlets:

```powershell
BeforeAll {
    . $PSScriptRoot/../Private/Get-LabSnapshotAge.ps1
    . $PSScriptRoot/../Private/Get-LabVMDiskUsage.ps1
    . $PSScriptRoot/../Private/Get-LabVMMetrics.ps1

    # Mock helper functions from other phases
    Mock Get-LabUptime { return [pscustomobject]@{ ElapsedHours = 5.5 } }
    Mock Get-LabSTIGCompliance {
        return @(
            [pscustomobject]@{ VMName = 'dc1'; Status = 'Compliant' }
            [pscustomobject]@{ VMName = 'svr1'; Status = 'NonCompliant' }
        )
    }
}

Describe 'Get-LabSnapshotAge' {
    It 'Returns age in days when snapshots exist' {
        $snapshotDate = (Get-Date).AddDays(-15)
        Mock Get-VMSnapshot {
            return [pscustomobject]@{
                CreationTime = $snapshotDate
            }
        }

        $age = Get-LabSnapshotAge -VMName 'testvm'

        $age | Should -Be 15
    }

    It 'Returns $null when no snapshots exist' {
        Mock Get-VMSnapshot { return $null }

        $age = Get-LabSnapshotAge -VMName 'testvm'

        $age | Should -Be $null
    }

    It 'Returns oldest snapshot age when multiple snapshots exist' {
        $now = Get-Date
        Mock Get-VMSnapshot {
            return @(
                [pscustomobject]@{ CreationTime = $now.AddDays(-5) }
                [pscustomobject]@{ CreationTime = $now.AddDays(-30) }  # oldest
                [pscustomobject]@{ CreationTime = $now.AddDays(-10) }
            )
        }

        $age = Get-LabSnapshotAge -VMName 'testvm'

        $age | Should -Be 30
    }

    It 'Handles Get-VMSnapshot errors gracefully' {
        Mock Get-VMSnapshot { throw "Hyper-V module not available" }

        $age = Get-LabSnapshotAge -VMName 'testvm' -ErrorAction SilentlyContinue

        $age | Should -Be $null
    }
}

Describe 'Get-LabVMDiskUsage' {
    BeforeEach {
        Mock Test-Path { return $true }
    }

    It 'Returns disk usage for single VHD' {
        Mock Get-VMHardDiskDrive {
            return [pscustomobject]@{ Path = 'C:\VMs\testvm\disk.vhdx' }
        }
        Mock Get-VHD {
            return [pscustomobject]@{
                FileSize = 45GB
                Size = 50GB
            }
        }

        $usage = Get-LabVMDiskUsage -VMName 'testvm'

        $usage.FileSizeGB | Should -Be 45.0
        $usage.SizeGB | Should -Be 50.0
        $usage.UsagePercent | Should -Be 90
    }

    It 'Sums sizes for multiple VHDs' {
        Mock Get-VMHardDiskDrive {
            return @(
                [pscustomobject]@{ Path = 'C:\VMs\testvm\disk1.vhdx' }
                [pscustomobject]@{ Path = 'C:\VMs\testvm\disk2.vhdx' }
            )
        }
        Mock Get-VHD {
            return [pscustomobject]@{
                FileSize = 20GB
                Size = 25GB
            }
        }

        $usage = Get-LabVMDiskUsage -VMName 'testvm'

        $usage.FileSizeGB | Should -Be 40.0
        $usage.SizeGB | Should -Be 50.0
        $usage.UsagePercent | Should -Be 80
    }

    It 'Returns $null when no VHD drives found' {
        Mock Get-VMHardDiskDrive { return $null }

        $usage = Get-LabVMDiskUsage -VMName 'testvm'

        $usage | Should -Be $null
    }

    It 'Handles VHD path not found' {
        Mock Get-VMHardDiskDrive {
            return [pscustomobject]@{ Path = 'C:\VMs\testvm\disk.vhdx' }
        }
        Mock Test-Path { return $false }

        $usage = Get-LabVMDiskUsage -VMName 'testvm'

        $usage | Should -Be $null
    }
}

Describe 'Get-LabVMMetrics' {
    It 'Collects all metrics for a single VM' {
        Mock Get-LabSnapshotAge { return 10 }
        Mock Get-LabVMDiskUsage {
            return [pscustomobject]@{ FileSizeGB = 30; SizeGB = 40; UsagePercent = 75 }
        }

        $metrics = Get-LabVMMetrics -VMName 'dc1'

        $metrics.Count | Should -Be 1
        $metrics[0].VMName | Should -Be 'dc1'
        $metrics[0].SnapshotAge | Should -Be 10
        $metrics[0].DiskUsageGB | Should -Be 30
        $metrics[0].DiskUsagePercent | Should -Be 75
        $metrics[0].UptimeHours | Should -Be 5.5
        $metrics[0].STIGStatus | Should -Be 'Compliant'
    }

    It 'Returns Unknown STIG status for VM not in cache' {
        Mock Get-LabSnapshotAge { return $null }
        Mock Get-LabVMDiskUsage { return $null }

        $metrics = Get-LabVMMetrics -VMName 'ws1'

        $metrics[0].STIGStatus | Should -Be 'Unknown'
    }

    It 'Accepts pipeline input for multiple VMs' {
        Mock Get-LabSnapshotAge { return 5 }
        Mock Get-LabVMDiskUsage {
            return [pscustomobject]@{ FileSizeGB = 20; SizeGB = 25; UsagePercent = 80 }
        }

        $metrics = 'dc1', 'svr1', 'ws1' | Get-LabVMMetrics

        $metrics.Count | Should -Be 3
    }

    It 'Handles collection errors gracefully' {
        Mock Get-LabSnapshotAge { throw "VM not found" }
        Mock Get-LabVMDiskUsage { return $null }

        $metrics = Get-LabVMMetrics -VMName 'badvm' -ErrorAction SilentlyContinue

        $metrics[0].VMName | Should -Be 'badvm'
        $metrics[0].SnapshotAge | Should -Be $null
        $metrics[0].DiskUsageGB | Should -Be $null
        $metrics[0].STIGStatus | Should -Be 'Unknown'
    }
}
```

**Verify:**
- All 15 tests pass (4 for Get-LabSnapshotAge, 4 for Get-LabVMDiskUsage, 4 for Get-LabVMMetrics, plus error cases)
- Mocks correctly simulate Hyper-V cmdlets
- Error handling tests verify graceful failures

**Done:**
LabVMMetrics.Tests.ps1 created with comprehensive test coverage. All mocks and tests pass correctly.

### Task 5: Run metric collection tests

**Type:** manual

**Files:**
- None (verification task)

**Action:**
Run the metric collection tests to verify all helpers work correctly:

```powershell
Invoke-Pester Tests/LabVMMetrics.Tests.ps1
```

**Verify:**
- All 15+ tests pass
- No mocked cmdlets cause test failures
- Pipeline input tests verify bulk collection

**Done:**
All metric collection tests pass. Helpers ready for background runspace integration in plan 29-03.

---

## Verification Criteria

1. **Get-LabSnapshotAge**: Returns snapshot age in days or $null, handles missing snapshots gracefully
2. **Get-LabVMDiskUsage**: Returns FileSizeGB, SizeGB, UsagePercent, handles multi-disk VMs
3. **Get-LabVMMetrics**: Orchestrates all 4 metrics, accepts pipeline input, returns complete object per VM
4. **Unit Tests**: Comprehensive test coverage with mocked Hyper-V cmdlets, all tests pass
5. **Integration**: Get-LabUptime and Get-LabSTIGCompliance wired correctly for uptime/STIG data

## Success Metrics

- `Get-LabVMMetrics -VMName 'dc1', 'svr1'` returns array of 2 objects with all properties populated
- Snapshot age calculation accurate to within 1 day of Get-VMSnapshot CreationTime
- Disk usage percentage within 1% of actual (FileSize / Size) * 100
- STIG status matches Get-LabSTIGCompliance output for same VM names
- All unit tests pass with mocked Hyper-V cmdlets (no real VM access required)
