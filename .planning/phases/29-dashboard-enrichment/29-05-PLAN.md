---
phase: 29
plan: 05
title: GUI Integration and Final Testing
type: standard
wave: 4
depends_on: ["29-04"]
files_modified:
  - GUI/Start-OpenCodeLabGUI.ps1
  - Tests/LabDashboardMetrics.Tests.ps1
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
  - DASH-04
  - DASH-05
must_haves:
  - Initialize-DashboardView calls Update-VMCardWithMetrics on 5-second timer
  - Update-VMCardWithMetrics called during initial poll and on each timer tick
  - Integration tests verify end-to-end metrics flow (runspace -> hashtable -> UI)
  - No UI thread blocking (Hyper-V calls only in background runspace)
  - Manual GUI verification checklist completed
---

## Objective

Integrate the enriched metrics display into the dashboard view's polling timer and verify the complete end-to-end flow: background runspace collects metrics, populates synchronized hashtable, and UI thread updates VM cards without blocking.

## Context

@phase-context: .planning/phases/29-dashboard-enrichment/29-CONTEXT.md
@research: .planning/phases/29-dashboard-enrichment/29-RESEARCH.md
@existing-timer: GUI/Start-OpenCodeLabGUI.ps1 Initialize-DashboardView (5-second VMPollTimer)
@update-function: GUI/Start-OpenCodeLabGUI.ps1 Update-VMCardWithMetrics (created in plan 29-04)

Per CONTEXT.md decision: Existing 5-second DispatcherTimer unchanged. UI thread reads from synchronized hashtable (no Hyper-V calls on UI thread). Metrics refresh every 60 seconds in background, UI updates every 5 seconds.

## Tasks

### Task 1: Update Initialize-DashboardView to call Update-VMCardWithMetrics

**Type:** auto

**Files:**
- GUI/Start-OpenCodeLabGUI.ps1

**Action:**
Modify the Initialize-DashboardView function to call Update-VMCardWithMetrics in two places:

1. **In the initial poll** (around line 771, after Update-VMCard call):
```powershell
    # â”€â”€ Initial poll (immediate update) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try {
        $statuses = Get-LabStatus
        foreach ($vmData in $statuses) {
            $name = $vmData.VMName
            if ($script:VMCards.ContainsKey($name)) {
                Update-VMCard -Card $script:VMCards[$name] -VMData $vmData
                # Update enriched metrics (reads from background runspace hashtable)
                Update-VMCardWithMetrics -Card $script:VMCards[$name] -VMName $name
            }
        }
        Update-TopologyCanvas -Canvas $script:TopologyCanvas -VMStatuses $statuses
        & $updateBanner $statuses
        & $updateResources $statuses
    }
    catch {
        # Silently ignore initial poll errors
    }
```

2. **In the DispatcherTimer tick handler** (around line 796, after Update-VMCard call):
```powershell
        $script:VMPollTimer.Add_Tick({
            try {
                $statuses = Get-LabStatus
                foreach ($vmData in $statuses) {
                    $name = $vmData.VMName
                    if ($script:VMCards.ContainsKey($name)) {
                        Update-VMCard -Card $script:VMCards[$name] -VMData $vmData
                        # Update enriched metrics (reads from background runspace hashtable)
                        Update-VMCardWithMetrics -Card $script:VMCards[$name] -VMName $name
                    }
                }
                Update-TopologyCanvas -Canvas $script:TopologyCanvas -VMStatuses $statuses
                & $updateBanner $statuses
                & $updateResources $statuses
            }
            catch {
                # Silently ignore polling errors to keep the GUI responsive
            }
        }.GetNewClosure())
```

Key integration notes:
- Update-VMCardWithMetrics called AFTER Update-VMCard (preserves existing VM card layout)
- Function reads from $script:DashboardMetrics (populated by background runspace)
- No changes to timer interval (remains 5 seconds)
- No Hyper-V calls added to UI thread path

**Verify:**
- Update-VMCardWithMetrics called in initial poll
- Update-VMCardWithMetrics called in timer tick handler
- Calls placed after Update-VMCard to preserve card structure

**Done:**
Initialize-DashboardView integrates Update-VMCardWithMetrics into both initial poll and 5-second timer tick.

### Task 2: Create integration tests for end-to-end metrics flow

**Type:** auto

**Files:**
- Tests/LabDashboardMetrics.Tests.ps1

**Action:**
Create Tests/LabDashboardMetrics.Tests.ps1 with integration tests:

```powershell
BeforeAll {
    # Source required functions
    . $PSScriptRoot/../Private/Get-LabDashboardConfig.ps1
    . $PSScriptRoot/../Private/Get-LabVMMetrics.ps1

    # Mock WPF to avoid loading in tests
    Add-Type -AssemblyName PresentationFramework -ErrorAction SilentlyContinue

    # Mock the GUI functions that depend on WPF
    function New-VMCardElement {
        param([string]$VMName)
        $card = New-Object System.Windows.Controls.TextBlock
        $card.Name = $VMName
        return $card
    }

    function Update-VMCard {
        param($Card, $VMData)
        # Stub
    }

    # Mock Hyper-V and dependency queries
    Mock Get-LabStatus {
        return @(
            [pscustomobject]@{ VMName = 'dc1'; State = 'Running'; NetworkStatus = '10.0.10.10'; CPUUsage = '5%'; MemoryGB = '4GB' }
            [pscustomobject]@{ VMName = 'svr1'; State = 'Running'; NetworkStatus = '10.0.10.20'; CPUUsage = '3%'; MemoryGB = '2GB' }
        )
    }

    Mock Get-LabSnapshotAge {
        param($VMName)
        return @{ 'dc1' = 15; 'svr1' = 3 }[$VMName]
    }

    Mock Get-LabVMDiskUsage {
        param($VMName)
        return [pscustomobject]@{
            FileSizeGB = @{ 'dc1' = 45.0; 'svr1' = 20.5 }[$VMName]
            SizeGB = @{ 'dc1' = 50.0; 'svr1' = 25.0 }[$VMName]
            UsagePercent = @{ 'dc1' = 90; 'svr1' = 82 }[$VMName]
        }
    }

    Mock Get-LabUptime {
        return [pscustomobject]@{ ElapsedHours = 76.5 }
    }

    Mock Get-LabSTIGCompliance {
        return @(
            [pscustomobject]@{ VMName = 'dc1'; Status = 'NonCompliant' }
            [pscustomobject]@{ VMName = 'svr1'; Status = 'Compliant' }
        )
    }

    # Create synchronized hashtable
    $script:DashboardMetrics = [System.Collections.Hashtable]::Synchronized(@{})
    $script:DashboardMetrics['Continue'] = $true

    # Set up GlobalLabConfig
    $GlobalLabConfig = @{
        Lab = @{ CoreVMNames = @('dc1', 'svr1') }
        Dashboard = @{
            SnapshotStaleDays = 7
            SnapshotStaleCritical = 30
            DiskUsagePercent = 80
            DiskUsageCritical = 95
            UptimeStaleHours = 72
        }
    }
}

Describe 'LabDashboardMetrics Integration' {
    It 'Get-LabVMMetrics returns complete metrics object' {
        $metrics = Get-LabVMMetrics -VMName 'dc1'

        $metrics.VMName | Should -Be 'dc1'
        $metrics.SnapshotAge | Should -Be 15
        $metrics.DiskUsageGB | Should -Be 45.0
        $metrics.DiskUsagePercent | Should -Be 90
        $metrics.UptimeHours | Should -Be 76.5
        $metrics.STIGStatus | Should -Be 'NonCompliant'
    }

    It 'Metrics flow from Get-LabVMMetrics to synchronized hashtable' {
        # Simulate background runspace collection
        $metrics = Get-LabVMMetrics -VMName 'dc1', 'svr1'

        foreach ($m in $metrics) {
            $script:DashboardMetrics[$m.VMName] = @{
                SnapshotAge      = $m.SnapshotAge
                DiskUsageGB      = $m.DiskUsageGB
                DiskUsagePercent = $m.DiskUsagePercent
                UptimeHours      = $m.UptimeHours
                STIGStatus       = $m.STIGStatus
            }
        }

        $script:DashboardMetrics['dc1'].SnapshotAge | Should -Be 15
        $script:DashboardMetrics['dc1'].STIGStatus | Should -Be 'NonCompliant'
        $script:DashboardMetrics['svr1'].SnapshotAge | Should -Be 3
        $script:DashboardMetrics['svr1'].STIGStatus | Should -Be 'Compliant'
    }

    It 'Get-StatusBadgeForMetric returns correct emoji for thresholds' {
        . $PSScriptRoot/../GUI/Start-OpenCodeLabGUI.ps1

        # Snapshot thresholds
        Get-StatusBadgeForMetric -MetricType 'Snapshot' -Value 5 | Should -Be 'ðŸŸ¢'  # Below warning
        Get-StatusBadgeForMetric -MetricType 'Snapshot' -Value 15 | Should -Be 'ðŸŸ¡'  # Warning
        Get-StatusBadgeForMetric -MetricType 'Snapshot' -Value 35 | Should -Be 'ðŸ”´'  # Critical
        Get-StatusBadgeForMetric -MetricType 'Snapshot' -Value $null | Should -Be 'âšª'  # Unknown

        # Disk thresholds
        Get-StatusBadgeForMetric -MetricType 'Disk' -Value 75 | Should -Be 'ðŸŸ¢'
        Get-StatusBadgeForMetric -MetricType 'Disk' -Value 82 | Should -Be 'ðŸŸ¡'
        Get-StatusBadgeForMetric -MetricType 'Disk' -Value 96 | Should -Be 'ðŸ”´'
        Get-StatusBadgeForMetric -MetricType 'Disk' -Value $null | Should -Be 'âšª'

        # Uptime thresholds
        Get-StatusBadgeForMetric -MetricType 'Uptime' -Value 50 | Should -Be 'ðŸŸ¢'
        Get-StatusBadgeForMetric -MetricType 'Uptime' -Value 76 | Should -Be 'ðŸŸ¡'
        Get-StatusBadgeForMetric -MetricType 'Uptime' -Value $null | Should -Be 'âšª'

        # STIG status
        Get-StatusBadgeForMetric -MetricType 'STIG' -Value 'Compliant' | Should -Be 'ðŸŸ¢'
        Get-StatusBadgeForMetric -MetricType 'STIG' -Value 'NonCompliant' | Should -Be 'ðŸ”´'
        Get-StatusBadgeForMetric -MetricType 'STIG' -Value 'Applying' | Should -Be 'ðŸŸ¡'
        Get-StatusBadgeForMetric -MetricType 'STIG' -Value 'Unknown' | Should -Be 'âšª'
    }

    It 'Update-VMCardWithMetrics formats metrics correctly' {
        . $PSScriptRoot/../GUI/Start-OpenCodeLabGUI.ps1

        # Populate hashtable with test data
        $script:DashboardMetrics['dc1'] = @{
            SnapshotAge      = 15
            DiskUsageGB      = 45.0
            DiskUsagePercent = 90
            UptimeHours      = 76.5
            STIGStatus       = 'NonCompliant'
        }

        # Create mock card with TextBlocks
        $mockCard = [PSCustomObject]@{
            txtSnapshotAge = @{ Text = '' }
            txtDiskUsage   = @{ Text = '' }
            txtUptime      = @{ Text = '' }
            txtSTIGStatus  = @{ Text = '' }
        }

        # Mock FindName to return mock TextBlocks
        Mock FindName {
            param($Name)
            return $mockCard.$Name
        }

        Update-VMCardWithMetrics -Card $mockCard -VMName 'dc1'

        $mockCard.txtSnapshotAge.Text | Should -BeLike '*15 days*'
        $mockCard.txtDiskUsage.Text | Should -BeLike '*45 GB*'
        $mockCard.txtDiskUsage.Text | Should -BeLike '*90%*'
        $mockCard.txtUptime.Text | Should -BeLike '*3d*h*'  # 76.5 hours = 3d 4h
        $mockCard.txtSTIGStatus.Text | Should -BeLike '*NonCompliant*'
    }

    It 'UI thread does not block when reading from hashtable' {
        # Populate hashtable
        $script:DashboardMetrics['dc1'] = @{
            SnapshotAge      = 10
            DiskUsageGB      = 30.0
            DiskUsagePercent = 75
            UptimeHours      = 5.0
            STIGStatus       = 'Compliant'
        }

        # Measure time to read from hashtable (should be < 1ms)
        $sw = [Diagnostics.Stopwatch]::StartNew()
        $data = $script:DashboardMetrics['dc1']
        $sw.Stop()

        $sw.ElapsedMilliseconds | Should -BeLessThan 10  # Well under 16ms UI frame budget
        $data.SnapshotAge | Should -Be 10
    }
}
```

**Verify:**
- All 5 integration tests pass
- Metrics flow from Get-LabVMMetrics to hashtable
- Status badges match thresholds
- Update-VMCardWithMetrics formats correctly
- Hashtable reads are non-blocking

**Done:**
LabDashboardMetrics.Tests.ps1 created with 5 integration tests covering end-to-end metrics flow.

### Task 3: Run full test suite

**Type:** manual

**Files:**
- None (verification task)

**Action:**
Run the full Pester test suite to verify no regressions:

```powershell
# From repo root
Invoke-Pester -Tests .
```

**Verify:**
- All existing tests still pass
- All new Phase 29 tests pass:
  - LabDashboardConfig.Tests.ps1 (5 tests)
  - LabVMMetrics.Tests.ps1 (15+ tests)
  - LabDashboardMetricsRunspace.Tests.ps1 (3 tests)
  - LabDashboardMetrics.Tests.ps1 (5 tests)
- Total tests increased by ~28 from Phase 28 baseline

**Done:**
Full test suite passes with all Phase 29 tests integrated. No regressions detected.

### Task 4: Manual GUI verification

**Type:** manual

**Files:**
- None (verification task)

**Action:**
Launch the GUI and verify the dashboard displays enriched metrics correctly:

```powershell
# From repo root
.\GUI\Start-OpenCodeLabGUI.ps1
```

**Verification Checklist:**

1. **VM Cards Display New Metrics:**
   - [ ] Snapshot age row shows "ðŸ’¾ Snapshot: X days [badge]"
   - [ ] Disk usage row shows "ðŸ’¾ Disk: XX GB (XX%) [badge]"
   - [ ] Uptime row shows "â±ï¸ Uptime: Xh or Xd Yh [badge]"
   - [ ] STIG row shows "ðŸ”’ STIG: Status [badge]"

2. **Status Badges Match Thresholds:**
   - [ ] Snapshot < 7 days shows ðŸŸ¢, 7-29 days shows ðŸŸ¡, >= 30 days shows ðŸ”´
   - [ ] Disk < 80% shows ðŸŸ¢, 80-94% shows ðŸŸ¡, >= 95% shows ðŸ”´
   - [ ] Uptime < 72 hours shows ðŸŸ¢, >= 72 hours shows ðŸŸ¡
   - [ ] STIG Compliant shows ðŸŸ¢, NonCompliant shows ðŸ”´, Applying shows ðŸŸ¡, Unknown shows âšª

3. **UI Responsiveness:**
   - [ ] Dashboard remains responsive during metrics collection
   - [ ] No UI freezes when Hyper-V queries run in background
   - [ ] 5-second timer updates VM state (running/off) smoothly
   - [ ] Metrics update within 60 seconds of GUI launch

4. **Error Handling:**
   - [ ] VMs with no snapshots show "No snapshots [âšª]"
   - [ ] Missing STIG cache shows "Unknown [âšª]"
   - [ ] Non-existent VMs show "-- [âšª]" for all metrics
   - [ ] Dashboard doesn't crash when metrics collection fails

5. **Window Close:**
   - [ ] Window closes within 5 seconds (runspace disposes promptly)
   - [ ] No PowerShell.exe processes remain after GUI closes
   - [ ] No event log errors related to runspace disposal

**Done:**
All manual verification checklist items pass. Dashboard displays enriched metrics correctly with proper status badges and no UI blocking.

### Task 5: Create phase verification document

**Type:** auto

**Files:**
- .planning/phases/29-dashboard-enrichment/29-VERIFICATION.md

**Action:**
Create the verification document summarizing Phase 29 completion:

```markdown
# Phase 29: Dashboard Enrichment - Verification

**Completed:** 2026-02-21

## Requirements Verified

| ID | Description | Status |
|----|-------------|--------|
| DASH-01 | Per-VM snapshot age displayed with configurable staleness warnings | âœ… Verified |
| DASH-02 | VHDx disk usage shown per VM with disk pressure indicators | âœ… Verified |
| DASH-03 | VM uptime displayed with configurable stale threshold alerts | âœ… Verified |
| DASH-04 | STIG compliance status column reads from cached compliance JSON data | âœ… Verified |
| DASH-05 | Background runspace collects enriched VM data without freezing UI thread | âœ… Verified |

## Success Criteria

1. **Snapshot Age Display**: Each VM card shows snapshot age in days with status badge (ðŸŸ¢ < 7d, ðŸŸ¡ 7-29d, ðŸ”´ >= 30d, âšª no snapshots)
2. **Disk Usage Display**: Each VM card shows disk usage in GB and percentage with status badge (ðŸŸ¢ < 80%, ðŸŸ¡ 80-94%, ðŸ”´ >= 95%, âšª unknown)
3. **Uptime Display**: Each VM card shows uptime in hours or days+hours with status badge (ðŸŸ¢ < 72h, ðŸŸ¡ >= 72h, âšª unknown)
4. **STIG Status Display**: Each VM card shows STIG compliance status with status badge (ðŸŸ¢ Compliant, ðŸ”´ NonCompliant, ðŸŸ¡ Applying, âšª Unknown)
5. **Background Collection**: Metrics collected by 60-second runspace, UI updates every 5 seconds from synchronized hashtable

## Files Created

### Configuration
- Lab-Config.ps1 (Dashboard block added)
- Private/Get-LabDashboardConfig.ps1

### Metric Collection
- Private/Get-LabSnapshotAge.ps1
- Private/Get-LabVMDiskUsage.ps1
- Private/Get-LabVMMetrics.ps1

### GUI Components
- GUI/Components/VMCard.xaml (updated with 4 metric rows)
- GUI/Start-OpenCodeLabGUI.ps1 (runspace, badge helper, update function)

### Tests
- Tests/LabDashboardConfig.Tests.ps1 (5 tests)
- Tests/LabVMMetrics.Tests.ps1 (15 tests)
- Tests/LabDashboardMetricsRunspace.Tests.ps1 (3 tests)
- Tests/LabDashboardMetrics.Tests.ps1 (5 tests)

## Test Results

- Total new tests: 28
- All tests passing
- No regressions in existing tests
- Manual GUI verification passed

## Known Limitations

- Linux VMs show âšª Unknown for snapshot age and disk usage (no VHDx format)
- Metrics refresh every 60 seconds (not configurable)
- Thresholds only editable via Lab-Config.ps1 (no GUI settings)
- Historical metrics not tracked (current state only)

## Dependencies Handled

- Phase 26: Get-LabUptime wired for uptime data
- Phase 27: Get-LabSTIGCompliance wired for STIG status
- Phase 28: ADMX context available (not directly used in dashboard)

## Next Phase

Phase 30: (TBD based on roadmap priorities)
```

**Verify:**
- VERIFICATION.md created in phase directory
- All requirements marked as verified
- Test results documented
- Known limitations listed

**Done:**
29-VERIFICATION.md created summarizing Phase 29 completion.

---

## Verification Criteria

1. **Timer Integration**: Initialize-DashboardView calls Update-VMCardWithMetrics in initial poll and timer tick
2. **Integration Tests**: LabDashboardMetrics.Tests.ps1 with 5 tests covering end-to-end flow
3. **No UI Blocking**: Hashtable reads complete in < 10ms, no Hyper-V calls on UI thread
4. **Full Test Suite**: All Phase 29 tests pass, no regressions in existing tests
5. **Manual Verification**: GUI checklist confirms correct display, badges, responsiveness, error handling

## Success Metrics

- Total of ~28 new tests pass (config + metrics + runspace + integration)
- GUI launches without errors and displays all 4 metric rows per VM
- Status badges match configured thresholds for all 5 badge types
- Dashboard remains responsive (no freezes) during metrics collection
- Window closes cleanly within 5 seconds with no orphaned PowerShell processes
- Manual verification checklist shows all items passing
