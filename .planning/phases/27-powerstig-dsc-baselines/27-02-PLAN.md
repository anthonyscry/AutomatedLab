---
phase: 27-powerstig-dsc-baselines
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - Private/Get-LabSTIGProfile.ps1
  - Private/Test-PowerStigInstallation.ps1
  - Tests/LabSTIGProfile.Tests.ps1
  - Tests/PowerStigInstallation.Tests.ps1
autonomous: true
requirements: [STIG-01, STIG-02]
must_haves:
  truths:
    - "Get-LabSTIGProfile returns correct technology, version, and role strings for DC VMs"
    - "Get-LabSTIGProfile returns correct technology, version, and role strings for member server VMs"
    - "Get-LabSTIGProfile discovers OS version at runtime and maps to PowerSTIG naming convention"
    - "Get-LabSTIGProfile returns null/empty for unsupported OS versions with a warning"
    - "Test-PowerStigInstallation verifies PowerSTIG module and its dependencies are installed"
    - "Test-PowerStigInstallation returns structured result with Installed bool and missing modules list"
  artifacts:
    - path: "Private/Get-LabSTIGProfile.ps1"
      provides: "Role-to-STIG profile mapping with runtime OS discovery"
      exports: ["Get-LabSTIGProfile"]
    - path: "Private/Test-PowerStigInstallation.ps1"
      provides: "PowerSTIG installation pre-flight check"
      exports: ["Test-PowerStigInstallation"]
    - path: "Tests/LabSTIGProfile.Tests.ps1"
      provides: "Unit tests for STIG profile mapping"
      min_lines: 80
    - path: "Tests/PowerStigInstallation.Tests.ps1"
      provides: "Unit tests for PowerSTIG installation check"
      min_lines: 60
  key_links:
    - from: "Private/Get-LabSTIGProfile.ps1"
      to: "PowerSTIG StigData/Processed/"
      via: "Maps OS version to PowerSTIG naming convention"
      pattern: "WindowsServer"
    - from: "Private/Test-PowerStigInstallation.ps1"
      to: "PowerSTIG module"
      via: "Get-Module -ListAvailable check"
      pattern: "PowerSTIG"
---

<objective>
Create STIG profile mapping helper and PowerSTIG installation pre-flight check.

Purpose: Get-LabSTIGProfile translates a VM's OS role (DC/MS) and runtime OS version (2019/2022) into the correct PowerSTIG technology, version, and role strings needed for MOF compilation. Test-PowerStigInstallation verifies that PowerSTIG and its dependency chain are installed on the target VM before compilation begins. Both are Private/ helpers consumed by the main Invoke-LabSTIGBaseline function (Plan 27-03).
Output: Get-LabSTIGProfile.ps1, Test-PowerStigInstallation.ps1, and comprehensive tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-powerstig-dsc-baselines/27-CONTEXT.md
@Private/Invoke-LabQuickModeHeal.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabSTIGProfile with TDD</name>
  <files>Private/Get-LabSTIGProfile.ps1, Tests/LabSTIGProfile.Tests.ps1</files>
  <action>
**RED phase -- write tests first** in Tests/LabSTIGProfile.Tests.ps1:

Test file structure:
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabSTIGProfile.ps1')
}
```

Mock strategy: The function accepts OsRole and OsVersion as parameters (no live VM queries in the helper itself -- the caller discovers and passes these). This makes testing straightforward.

**Test cases:**
1. Returns Technology='WindowsServer', StigVersion matching 2019, OsRole='DC' for DC role on Server 2019 (build 10.0.17763)
2. Returns Technology='WindowsServer', StigVersion matching 2022, OsRole='DC' for DC role on Server 2022 (build 10.0.20348)
3. Returns Technology='WindowsServer', StigVersion matching 2019, OsRole='MS' for member server on Server 2019
4. Returns Technology='WindowsServer', StigVersion matching 2022, OsRole='MS' for member server on Server 2022
5. Returns OsRole='DC' when input role is 'DC' (case-insensitive)
6. Returns OsRole='MS' when input role is 'Server', 'MS', or default/empty
7. Returns $null with warning when OS version is unrecognized (e.g., build 10.0.99999)
8. Returns $null with warning when OS version string is empty or null
9. Returns PSCustomObject with Technology, StigVersion, OsRole, OsVersionString fields
10. Maps build 10.0.17763 to '2019' and 10.0.20348 to '2022' correctly

**GREEN phase -- create Private/Get-LabSTIGProfile.ps1:**
```powershell
function Get-LabSTIGProfile {
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [Parameter(Mandatory)]
        [string]$OsRole,

        [Parameter(Mandatory)]
        [string]$OsVersionBuild
    )

    # Map OS build number to PowerSTIG version string
    $versionMap = @{
        '10.0.17763' = '2019'   # Windows Server 2019
        '10.0.20348' = '2022'   # Windows Server 2022
    }

    # Normalize role: DC stays DC, everything else is MS (Member Server)
    $stigRole = if ($OsRole -eq 'DC') { 'DC' } else { 'MS' }

    # Find matching OS version
    $osVersionKey = $null
    foreach ($key in $versionMap.Keys) {
        if ($OsVersionBuild.StartsWith($key)) {
            $osVersionKey = $key
            break
        }
    }

    if (-not $osVersionKey) {
        Write-Warning "[STIGProfile] Unsupported OS version '$OsVersionBuild'. PowerSTIG baselines are available for Server 2019 (10.0.17763) and Server 2022 (10.0.20348)."
        return $null
    }

    $osYear = $versionMap[$osVersionKey]

    return [pscustomobject]@{
        Technology     = 'WindowsServer'
        StigVersion    = $osYear
        OsRole         = $stigRole
        OsVersionString = $OsVersionBuild
    }
}
```

The function is intentionally simple and testable -- no live VM queries. The caller (Invoke-LabSTIGBaseline) discovers the OS version via WinRM and passes it in. The version map can be extended for future OS releases without changing the interface.

**REFACTOR:** Ensure all tests pass, verify edge cases.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/LabSTIGProfile.Tests.ps1 -Output Detailed"` -- all tests pass.</verify>
  <done>Get-LabSTIGProfile correctly maps OsRole + OsVersionBuild to PowerSTIG Technology/StigVersion/OsRole tuple. Returns $null with warning for unsupported OS. 10+ tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: Create Test-PowerStigInstallation with TDD</name>
  <files>Private/Test-PowerStigInstallation.ps1, Tests/PowerStigInstallation.Tests.ps1</files>
  <action>
**RED phase -- write tests first** in Tests/PowerStigInstallation.Tests.ps1:

Test file structure:
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Test-PowerStigInstallation.ps1')
}
```

Mock strategy: Define stub functions for Get-Module and Invoke-Command in BeforeEach. Test-PowerStigInstallation accepts a -Session or -ComputerName parameter for remote checks, but in tests we mock the underlying calls.

**Test cases:**
1. Returns Installed=$true when PowerSTIG module is found with minimum version
2. Returns Installed=$false with MissingModules list when PowerSTIG is not found
3. Returns Installed=$false when PowerSTIG version is below minimum (4.28.0)
4. Returns Installed=$true when PowerSTIG version exceeds minimum
5. Checks for key dependency modules: PowerSTIG, StigData, AuditPolicyDsc, SecurityPolicyDsc
6. Returns PSCustomObject with Installed (bool), Version (string or $null), MissingModules (string array)
7. Returns Installed=$false gracefully when remote check throws (connection failure)
8. Does not throw under Set-StrictMode -Version Latest

**GREEN phase -- create Private/Test-PowerStigInstallation.ps1:**
```powershell
function Test-PowerStigInstallation {
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [Parameter(Mandatory)]
        [string]$ComputerName,

        [version]$MinimumVersion = '4.28.0'
    )

    $requiredModules = @('PowerSTIG')
    $keyDependencies = @('AuditPolicyDsc', 'SecurityPolicyDsc', 'WindowsDefenderDsc',
                         'xDnsServer', 'xWebAdministration', 'ProcessMitigations',
                         'PSDscResources', 'GPRegistryPolicyParser',
                         'FileContentDsc', 'CertificateDsc')

    try {
        $remoteResult = Invoke-Command -ComputerName $ComputerName -ScriptBlock {
            param($modules, $deps, $minVer)
            $result = @{ Modules = @{}; Missing = @() }
            foreach ($mod in $modules) {
                $found = Get-Module -Name $mod -ListAvailable -ErrorAction SilentlyContinue |
                         Sort-Object Version -Descending | Select-Object -First 1
                if ($found -and $found.Version -ge [version]$minVer) {
                    $result.Modules[$mod] = $found.Version.ToString()
                } else {
                    $result.Missing += $mod
                }
            }
            foreach ($dep in $deps) {
                $found = Get-Module -Name $dep -ListAvailable -ErrorAction SilentlyContinue
                if (-not $found) { $result.Missing += $dep }
            }
            $result
        } -ArgumentList @($requiredModules, $keyDependencies, $MinimumVersion.ToString())

        $installed = $remoteResult.Missing.Count -eq 0
        $version = if ($remoteResult.Modules.ContainsKey('PowerSTIG')) {
            $remoteResult.Modules['PowerSTIG']
        } else { $null }

        return [pscustomobject]@{
            Installed      = $installed
            Version        = $version
            MissingModules = $remoteResult.Missing
            ComputerName   = $ComputerName
        }
    }
    catch {
        Write-Warning "[PowerSTIG] Pre-flight check failed on ${ComputerName}: $($_.Exception.Message)"
        return [pscustomobject]@{
            Installed      = $false
            Version        = $null
            MissingModules = @('PowerSTIG (check failed)')
            ComputerName   = $ComputerName
        }
    }
}
```

Uses Invoke-Command for remote execution (WinRM). Returns structured PSCustomObject. Error handling with try-catch. No ternary operators.

**REFACTOR:** Ensure all tests pass, verify error scenarios.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/PowerStigInstallation.Tests.ps1 -Output Detailed"` -- all tests pass.</verify>
  <done>Test-PowerStigInstallation checks PowerSTIG and 10 dependency modules on remote VM via Invoke-Command. Returns structured result with Installed, Version, MissingModules. 8+ tests passing.</done>
</task>

</tasks>

<verification>
- [ ] Get-LabSTIGProfile maps DC role + Server 2019/2022 to correct PowerSTIG strings
- [ ] Get-LabSTIGProfile maps member server role correctly (MS)
- [ ] Get-LabSTIGProfile returns $null with warning for unsupported OS
- [ ] Test-PowerStigInstallation checks PowerSTIG and key dependencies on remote VM
- [ ] Test-PowerStigInstallation returns structured PSCustomObject with Installed, Version, MissingModules
- [ ] Both functions handle errors gracefully
- [ ] All Pester tests pass
</verification>

<success_criteria>
STIG profile mapping and pre-flight installation check are complete and tested. Get-LabSTIGProfile correctly translates VM role/OS to PowerSTIG parameters. Test-PowerStigInstallation verifies remote module availability. Both follow project patterns.
</success_criteria>

<output>
After completion, create `.planning/phases/27-powerstig-dsc-baselines/27-02-SUMMARY.md`
</output>
