---
phase: 27-powerstig-dsc-baselines
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - Lab-Config.ps1
  - Private/Get-LabSTIGConfig.ps1
  - Tests/LabSTIGConfig.Tests.ps1
autonomous: true
requirements: [STIG-04]
must_haves:
  truths:
    - "Operator sees STIG block in Lab-Config.ps1 with Enabled, AutoApplyOnDeploy, ComplianceCachePath, Exceptions keys"
    - "Loading config with missing STIG keys does not throw under Set-StrictMode -Version Latest"
    - "Get-LabSTIGConfig returns correct defaults when STIG block is absent"
    - "Get-LabSTIGConfig returns operator values when STIG block is present"
    - "Exceptions hashtable is parsed correctly with per-VM V-number arrays"
  artifacts:
    - path: "Lab-Config.ps1"
      provides: "STIG config block in GlobalLabConfig"
      contains: "STIG = @{"
    - path: "Private/Get-LabSTIGConfig.ps1"
      provides: "Safe STIG config reader with ContainsKey guards"
      exports: ["Get-LabSTIGConfig"]
    - path: "Tests/LabSTIGConfig.Tests.ps1"
      provides: "Unit tests for STIG config reading"
      min_lines: 80
  key_links:
    - from: "Private/Get-LabSTIGConfig.ps1"
      to: "Lab-Config.ps1"
      via: "Reads $GlobalLabConfig.STIG with ContainsKey guards"
      pattern: "ContainsKey.*STIG"
---

<objective>
Add STIG configuration block to Lab-Config.ps1 and create a safe config reader function.

Purpose: Enables operators to configure STIG baselines with safe defaults. The config reader uses ContainsKey guards to prevent StrictMode failures when keys are absent, following the same pattern established by the TTL config block (Phase 26). Per-VM exception overrides are declared here as a hashtable keyed by VM name.
Output: Lab-Config.ps1 updated, Get-LabSTIGConfig.ps1 created and tested.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-powerstig-dsc-baselines/27-CONTEXT.md
@Lab-Config.ps1
@Private/Get-LabTTLConfig.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add STIG config block to Lab-Config.ps1</name>
  <files>Lab-Config.ps1</files>
  <action>
Add a `STIG = @{...}` block to `$GlobalLabConfig` in Lab-Config.ps1, positioned immediately after the existing `TTL` block and before the `SSH` block.

Keys with inline comments (matching existing Lab-Config.ps1 style):
```powershell
STIG = @{
    # Changing Enabled toggles whether DISA STIG DSC baselines are applied during PostInstall.
    Enabled = $false
    # Changing AutoApplyOnDeploy toggles whether STIGs apply automatically during deployment.
    AutoApplyOnDeploy = $true
    # Changing ComplianceCachePath moves where STIG compliance results are cached.
    ComplianceCachePath = '.planning/stig-compliance.json'
    # Changing Exceptions adds per-VM STIG rule exclusions (V-numbers skipped at compile time).
    # Example: Exceptions = @{ 'dc1' = @('V-12345', 'V-67890'); 'svr1' = @('V-11111') }
    Exceptions = @{}
}
```

Feature is disabled by default. Every key has a comment explaining what it controls. The Exceptions key includes an example comment showing the expected format.
  </action>
  <verify>Open Lab-Config.ps1 and confirm STIG block exists after TTL block with all 4 keys and inline comments. Verify the file parses without syntax error: `powershell -NoProfile -Command "& { . ./Lab-Config.ps1 }"` (or equivalent syntax check).</verify>
  <done>Lab-Config.ps1 contains STIG = @{ Enabled = $false; AutoApplyOnDeploy = $true; ComplianceCachePath = '.planning/stig-compliance.json'; Exceptions = @{} } with inline comments matching project style.</done>
</task>

<task type="auto">
  <name>Task 2: Create Get-LabSTIGConfig with TDD</name>
  <files>Private/Get-LabSTIGConfig.ps1, Tests/LabSTIGConfig.Tests.ps1</files>
  <action>
**RED phase -- write tests first** in Tests/LabSTIGConfig.Tests.ps1:

Test file structure (follow LabTTLConfig.Tests.ps1 pattern):
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabSTIGConfig.ps1')
}
```

Test cases (use `$script:` scope for BeforeEach variables per project pattern):
1. Returns defaults when GlobalLabConfig variable does not exist (Enabled=$false, AutoApplyOnDeploy=$true, ComplianceCachePath='.planning/stig-compliance.json', Exceptions=@{})
2. Returns defaults when GlobalLabConfig exists but has no STIG key
3. Returns defaults when STIG block exists but is empty hashtable
4. Returns operator values when all STIG keys are present
5. Returns partial defaults when only some STIG keys are present (e.g., Enabled=$true but no ComplianceCachePath)
6. Casts types correctly: Enabled as [bool], AutoApplyOnDeploy as [bool], ComplianceCachePath as [string], Exceptions as [hashtable]
7. Does not throw under Set-StrictMode -Version Latest with missing keys
8. Parses Exceptions hashtable with per-VM V-number arrays correctly
9. Returns empty hashtable for Exceptions when key is absent
10. Handles Exceptions with multiple VMs and multiple V-numbers per VM

For tests that set $GlobalLabConfig, use `$script:GlobalLabConfig = @{...}` in test scope and clean up in AfterEach.

**GREEN phase -- create Private/Get-LabSTIGConfig.ps1:**
```powershell
function Get-LabSTIGConfig {
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $stigBlock = if (Test-Path variable:GlobalLabConfig) {
        if ($GlobalLabConfig.ContainsKey('STIG')) { $GlobalLabConfig.STIG } else { @{} }
    } else { @{} }

    [pscustomobject]@{
        Enabled             = if ($stigBlock.ContainsKey('Enabled'))             { [bool]$stigBlock.Enabled }             else { $false }
        AutoApplyOnDeploy   = if ($stigBlock.ContainsKey('AutoApplyOnDeploy'))   { [bool]$stigBlock.AutoApplyOnDeploy }   else { $true }
        ComplianceCachePath = if ($stigBlock.ContainsKey('ComplianceCachePath')) { [string]$stigBlock.ComplianceCachePath } else { '.planning/stig-compliance.json' }
        Exceptions          = if ($stigBlock.ContainsKey('Exceptions'))          { $stigBlock.Exceptions }                else { @{} }
    }
}
```

Uses [CmdletBinding()], returns [pscustomobject], ContainsKey guards on every read. No ternary operators (PS 5.1 compat). Function is auto-discovered by Lab-Common.ps1 -- no registration needed.

**REFACTOR:** Ensure all tests pass, clean up any duplication.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/LabSTIGConfig.Tests.ps1 -Output Detailed"` -- all tests pass. Confirm function file exists at Private/Get-LabSTIGConfig.ps1 and follows [CmdletBinding()] pattern.</verify>
  <done>Get-LabSTIGConfig returns correct PSCustomObject with all 4 fields, uses ContainsKey guards, handles missing config gracefully, 10+ tests passing.</done>
</task>

</tasks>

<verification>
- [ ] Lab-Config.ps1 parses without error after adding STIG block
- [ ] STIG block positioned after TTL, before SSH
- [ ] All 4 keys have inline comments matching project style
- [ ] Exceptions key has example comment showing per-VM V-number format
- [ ] Get-LabSTIGConfig returns [pscustomobject] with Enabled, AutoApplyOnDeploy, ComplianceCachePath, Exceptions
- [ ] No StrictMode failures when STIG keys are absent
- [ ] All Pester tests pass
</verification>

<success_criteria>
Operator can set STIG values in Lab-Config.ps1 including per-VM exception overrides. Get-LabSTIGConfig reads them safely with defaults. No breakage of existing config loading. All tests green.
</success_criteria>

<output>
After completion, create `.planning/phases/27-powerstig-dsc-baselines/27-01-SUMMARY.md`
</output>
