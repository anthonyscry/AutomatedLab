---
phase: 27-powerstig-dsc-baselines
plan: 04
type: tdd
wave: 3
depends_on: [01, 02, 03]
files_modified:
  - Public/Invoke-LabSTIGBaseline.ps1
  - Public/Get-LabSTIGCompliance.ps1
  - LabBuilder/Roles/DC.ps1
  - Tests/LabSTIGBaselinePublic.Tests.ps1
  - Tests/LabSTIGCompliancePublic.Tests.ps1
autonomous: true
requirements: [STIG-05, STIG-06]
must_haves:
  truths:
    - "Public Invoke-LabSTIGBaseline -VMName <name> re-applies STIG to a single VM on demand"
    - "Public Invoke-LabSTIGBaseline with no parameters applies to all lab VMs"
    - "Get-LabSTIGCompliance reads stig-compliance.json and returns PSCustomObject array"
    - "Get-LabSTIGCompliance returns empty array when cache file does not exist"
    - "Get-LabSTIGCompliance returns per-VM compliance breakdown"
    - "DC.ps1 PostInstall scriptblock calls Private Invoke-LabSTIGBaseline after role provisioning"
    - "PostInstall STIG step is gated on $GlobalLabConfig.STIG.Enabled"
    - "PostInstall STIG step runs after DC promotion is fully complete"
  artifacts:
    - path: "Public/Invoke-LabSTIGBaseline.ps1"
      provides: "Public on-demand STIG re-apply cmdlet"
      exports: ["Invoke-LabSTIGBaseline"]
    - path: "Public/Get-LabSTIGCompliance.ps1"
      provides: "Public compliance query cmdlet"
      exports: ["Get-LabSTIGCompliance"]
    - path: "LabBuilder/Roles/DC.ps1"
      provides: "PostInstall STIG integration hook for DC VMs"
      contains: "Invoke-LabSTIGBaseline"
    - path: "Tests/LabSTIGBaselinePublic.Tests.ps1"
      provides: "Unit tests for public STIG re-apply cmdlet"
      min_lines: 60
    - path: "Tests/LabSTIGCompliancePublic.Tests.ps1"
      provides: "Unit tests for public compliance query"
      min_lines: 60
  key_links:
    - from: "Public/Invoke-LabSTIGBaseline.ps1"
      to: "Private/Invoke-LabSTIGBaseline.ps1"
      via: "Thin wrapper calling private implementation"
      pattern: "Invoke-LabSTIGBaseline"
    - from: "Public/Get-LabSTIGCompliance.ps1"
      to: ".planning/stig-compliance.json"
      via: "Reads cached compliance data"
      pattern: "stig-compliance\\.json"
    - from: "LabBuilder/Roles/DC.ps1"
      to: "Private/Invoke-LabSTIGBaseline.ps1"
      via: "PostInstall hook calls STIG application"
      pattern: "Invoke-LabSTIGBaseline"
---

<objective>
Create public-facing STIG cmdlets and integrate STIG application into PostInstall lifecycle.

Purpose: Provides the operator-facing Invoke-LabSTIGBaseline (on-demand re-apply) and Get-LabSTIGCompliance (compliance query) cmdlets. Integrates automatic STIG application into the LabBuilder PostInstall flow for DC and member server VMs. This completes the Phase 27 feature end-to-end.
Output: Public/ cmdlets, DC.ps1 PostInstall integration, and comprehensive tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-powerstig-dsc-baselines/27-CONTEXT.md
@.planning/phases/27-powerstig-dsc-baselines/27-01-SUMMARY.md
@.planning/phases/27-powerstig-dsc-baselines/27-02-SUMMARY.md
@.planning/phases/27-powerstig-dsc-baselines/27-03-SUMMARY.md
@Private/Invoke-LabSTIGBaseline.ps1
@Private/Write-LabSTIGCompliance.ps1
@Private/Get-LabSTIGConfig.ps1
@Public/Get-LabUptime.ps1
@LabBuilder/Roles/DC.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Public Invoke-LabSTIGBaseline and Get-LabSTIGCompliance with TDD</name>
  <files>Public/Invoke-LabSTIGBaseline.ps1, Public/Get-LabSTIGCompliance.ps1, Tests/LabSTIGBaselinePublic.Tests.ps1, Tests/LabSTIGCompliancePublic.Tests.ps1</files>
  <action>
**RED phase -- write tests first** for both public cmdlets:

**Tests/LabSTIGBaselinePublic.Tests.ps1:**
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabSTIGConfig.ps1')
    . (Join-Path $repoRoot 'Private/Invoke-LabSTIGBaseline.ps1')
    . (Join-Path $repoRoot 'Public/Invoke-LabSTIGBaseline.ps1')
}
```

Note: The Public and Private functions share the same name. The Public version is a thin wrapper that dot-sources Lab-Common.ps1 (ensuring all Private helpers are loaded) then calls the Private implementation. In tests, we mock the Private function directly.

Alternative approach if naming collision is a concern: name the Private function `Invoke-LabSTIGBaselineCore` and have the Public function call it. Use Claude's discretion on naming.

**Test cases:**
1. Calls Private Invoke-LabSTIGBaseline (or Core) with correct parameters when -VMName specified
2. Calls Private function targeting all lab VMs when no -VMName specified
3. Returns audit PSCustomObject from the private function
4. Has comment-based help (.SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE)
5. Supports -Verbose passthrough
6. Returns @() when STIG feature is disabled

**Tests/LabSTIGCompliancePublic.Tests.ps1:**
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabSTIGConfig.ps1')
    . (Join-Path $repoRoot 'Public/Get-LabSTIGCompliance.ps1')
}
```

**Test cases:**
1. Returns empty array when stig-compliance.json does not exist
2. Returns PSCustomObject array with correct fields from valid JSON
3. Returns per-VM objects with VMName, Role, STIGVersion, Status, ExceptionsApplied, LastChecked, ErrorMessage
4. Returns empty array when JSON exists but VMs array is empty
5. Returns empty array gracefully when JSON is malformed (corrupted file)
6. Has comment-based help (.SYNOPSIS, .DESCRIPTION, .OUTPUTS, .EXAMPLE)
7. Supports -CachePath parameter override
8. Uses default path from Get-LabSTIGConfig when -CachePath not specified

**GREEN phase -- create Public cmdlets:**

**Public/Invoke-LabSTIGBaseline.ps1:**
```powershell
function Invoke-LabSTIGBaseline {
    <#
    .SYNOPSIS
        Applies DISA STIG DSC baselines to lab VMs.
    .DESCRIPTION
        Re-applies role-appropriate STIG baselines to one or more lab VMs.
        Installs PowerSTIG if needed, compiles MOF with exception overrides,
        applies via DSC push mode, and updates the compliance cache.
    .PARAMETER VMName
        Specific VM name(s) to target. If omitted, targets all lab VMs.
    .EXAMPLE
        Invoke-LabSTIGBaseline -VMName 'dc1'
    .EXAMPLE
        Invoke-LabSTIGBaseline
    .OUTPUTS
        [PSCustomObject] Audit result with VMsProcessed, VMsSucceeded, VMsFailed
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [string[]]$VMName
    )

    # Delegate to private implementation (auto-loaded by Lab-Common.ps1)
    $params = @{}
    if ($VMName) { $params['VMName'] = $VMName }
    Invoke-LabSTIGBaselineCore @params
}
```

Note: Rename the Private function to `Invoke-LabSTIGBaselineCore` to avoid collision. Update Private/Invoke-LabSTIGBaseline.ps1 accordingly (rename function inside the file, or rename the file to Invoke-LabSTIGBaselineCore.ps1). Use Claude's discretion on the cleanest approach.

**Public/Get-LabSTIGCompliance.ps1:**
```powershell
function Get-LabSTIGCompliance {
    <#
    .SYNOPSIS
        Returns STIG compliance status for lab VMs.
    .DESCRIPTION
        Reads the STIG compliance cache file and returns per-VM
        compliance breakdown as PSCustomObject array.
    .PARAMETER CachePath
        Override path to stig-compliance.json. Defaults to config value.
    .EXAMPLE
        Get-LabSTIGCompliance
    .EXAMPLE
        Get-LabSTIGCompliance | Where-Object Status -eq 'NonCompliant'
    .OUTPUTS
        [PSCustomObject[]] Per-VM compliance entries
    #>
    [CmdletBinding()]
    [OutputType([pscustomobject[]])]
    param(
        [string]$CachePath
    )

    if (-not $CachePath) {
        $config = Get-LabSTIGConfig
        $CachePath = $config.ComplianceCachePath
    }

    if (-not (Test-Path $CachePath)) {
        return @()
    }

    try {
        $cache = Get-Content -Path $CachePath -Raw | ConvertFrom-Json
    }
    catch {
        Write-Warning "[STIG] Failed to read compliance cache: $($_.Exception.Message)"
        return @()
    }

    if (-not $cache.VMs -or $cache.VMs.Count -eq 0) {
        return @()
    }

    return @($cache.VMs | ForEach-Object {
        [pscustomobject]@{
            VMName            = $_.VMName
            Role              = $_.Role
            STIGVersion       = $_.STIGVersion
            Status            = $_.Status
            ExceptionsApplied = $_.ExceptionsApplied
            LastChecked       = $_.LastChecked
            ErrorMessage      = $_.ErrorMessage
        }
    })
}
```

**REFACTOR:** Ensure all tests pass, verify comment-based help renders correctly.
  </action>
  <verify>Run both test files with Invoke-Pester -- all tests pass. Verify comment-based help with `Get-Help Invoke-LabSTIGBaseline` and `Get-Help Get-LabSTIGCompliance`.</verify>
  <done>Public Invoke-LabSTIGBaseline provides on-demand re-apply. Get-LabSTIGCompliance reads compliance cache. Both have comment-based help. 14+ tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate STIG application into PostInstall lifecycle</name>
  <files>LabBuilder/Roles/DC.ps1</files>
  <action>
Add STIG application as a PostInstall step in LabBuilder/Roles/DC.ps1, after the existing AD DS validation step (step 2). This runs after DC promotion is fully complete.

Insert the following block after the existing AD DS service validation (approximately after the line `Write-Host '  [OK] AD DS services verified running (NTDS + ADWS + DNS).' -ForegroundColor Green`):

```powershell
# 3. Apply STIG baseline (if enabled)
if (Test-Path variable:GlobalLabConfig) {
    if ($GlobalLabConfig.ContainsKey('STIG') -and $GlobalLabConfig.STIG.ContainsKey('Enabled') -and $GlobalLabConfig.STIG.Enabled) {
        if ($GlobalLabConfig.STIG.ContainsKey('AutoApplyOnDeploy') -and -not $GlobalLabConfig.STIG.AutoApplyOnDeploy) {
            Write-Host '  [SKIP] STIG baselines enabled but AutoApplyOnDeploy is false.' -ForegroundColor Yellow
        }
        else {
            Write-Host "  Applying STIG baseline to $dcName..." -ForegroundColor Cyan
            try {
                $stigResult = Invoke-LabSTIGBaselineCore -VMName $dcName
                if ($stigResult.VMsFailed -eq 0) {
                    Write-Host "  [OK] STIG baseline applied to $dcName ($($stigResult.VMsSucceeded) succeeded)." -ForegroundColor Green
                }
                else {
                    Write-Warning "DC role: STIG baseline application had failures on ${dcName}. Check .planning/stig-compliance.json for details."
                }
            }
            catch {
                Write-Warning "DC role: STIG baseline application failed on ${dcName}: $($_.Exception.Message). Lab deployment continues without STIG."
            }
        }
    }
}
```

Key design decisions:
- Gated on `$GlobalLabConfig.STIG.Enabled` using ContainsKey guards (StrictMode safe)
- Respects AutoApplyOnDeploy flag -- skips with message when false
- Failure does NOT abort lab deployment (try-catch with Write-Warning)
- Uses ContainsKey pattern consistently (Phase 26 established pattern)
- Calls Invoke-LabSTIGBaselineCore (Private function name)

Also add a similar block to member server roles. Check if there's a generic server PostInstall hook. If server roles use individual PostInstall blocks in their respective role files (IIS.ps1, SQL.ps1, etc.), add the STIG step to each OR create a shared PostInstall hook. Use Claude's discretion on the cleanest approach -- the CONTEXT.md says "runs as a PostInstall step after existing role provisioning completes." The cleanest approach is likely to add STIG application to the Build-LabFromSelection.ps1 orchestrator as a final PostInstall step that runs after all per-role PostInstall blocks complete.

Verify the integration by reading the PostInstall flow in Build-LabFromSelection.ps1 and placing the STIG step appropriately.
  </action>
  <verify>Read DC.ps1 and verify STIG PostInstall step is present after AD DS validation. Verify ContainsKey guards are correct. Verify failure does not abort deployment. Check that member server VMs also get STIG applied through the chosen integration approach.</verify>
  <done>PostInstall lifecycle integrates STIG application for DC and member server VMs. Gated on STIG.Enabled config. Failure does not abort deployment. ContainsKey guards prevent StrictMode failures.</done>
</task>

</tasks>

<verification>
- [ ] Public Invoke-LabSTIGBaseline -VMName <name> re-applies STIG to specific VM
- [ ] Public Invoke-LabSTIGBaseline targets all lab VMs when no -VMName specified
- [ ] Get-LabSTIGCompliance returns PSCustomObject array from stig-compliance.json
- [ ] Get-LabSTIGCompliance returns empty array when cache missing or empty
- [ ] DC PostInstall calls Invoke-LabSTIGBaselineCore after AD DS validation
- [ ] PostInstall STIG step gated on $GlobalLabConfig.STIG.Enabled
- [ ] PostInstall STIG step respects AutoApplyOnDeploy flag
- [ ] STIG failure does NOT abort lab deployment
- [ ] Both public cmdlets have comment-based help
- [ ] All Pester tests pass
</verification>

<success_criteria>
Complete Phase 27 feature end-to-end: config -> profile mapping -> pre-flight -> installation -> MOF compile with exceptions -> DSC push -> compliance cache -> public query/re-apply -> PostInstall integration. All 6 requirements (STIG-01 through STIG-06) are fulfilled. All tests green.
</success_criteria>

<output>
After completion, create `.planning/phases/27-powerstig-dsc-baselines/27-04-SUMMARY.md`
</output>
