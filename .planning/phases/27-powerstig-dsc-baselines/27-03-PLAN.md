---
phase: 27-powerstig-dsc-baselines
plan: 03
type: tdd
wave: 2
depends_on: [01, 02]
files_modified:
  - Private/Invoke-LabSTIGBaseline.ps1
  - Private/Write-LabSTIGCompliance.ps1
  - Tests/LabSTIGBaseline.Tests.ps1
  - Tests/LabSTIGCompliance.Tests.ps1
autonomous: true
requirements: [STIG-01, STIG-02, STIG-03, STIG-05]
must_haves:
  truths:
    - "Invoke-LabSTIGBaseline installs PowerSTIG on target VM if not present"
    - "Invoke-LabSTIGBaseline raises WinRM MaxEnvelopeSizekb to 8192 before DSC push"
    - "Invoke-LabSTIGBaseline compiles role-appropriate STIG MOF using Get-LabSTIGProfile"
    - "Invoke-LabSTIGBaseline applies MOF via Start-DscConfiguration push mode"
    - "Invoke-LabSTIGBaseline applies per-VM exception overrides from config at compile time"
    - "Invoke-LabSTIGBaseline writes compliance results via Write-LabSTIGCompliance"
    - "Write-LabSTIGCompliance writes JSON cache with per-VM compliance status"
    - "Write-LabSTIGCompliance follows the schema: LastUpdated, VMs array with VMName, Role, STIGVersion, Status, ExceptionsApplied, LastChecked, ErrorMessage"
    - "Invoke-LabSTIGBaseline returns audit PSCustomObject following Invoke-LabQuickModeHeal pattern"
    - "Invoke-LabSTIGBaseline handles compilation and application failures gracefully per-VM"
  artifacts:
    - path: "Private/Invoke-LabSTIGBaseline.ps1"
      provides: "Core STIG baseline application engine"
      exports: ["Invoke-LabSTIGBaseline"]
    - path: "Private/Write-LabSTIGCompliance.ps1"
      provides: "Compliance cache writer"
      exports: ["Write-LabSTIGCompliance"]
    - path: "Tests/LabSTIGBaseline.Tests.ps1"
      provides: "Unit tests for STIG baseline application"
      min_lines: 150
    - path: "Tests/LabSTIGCompliance.Tests.ps1"
      provides: "Unit tests for compliance cache writing"
      min_lines: 60
  key_links:
    - from: "Private/Invoke-LabSTIGBaseline.ps1"
      to: "Private/Get-LabSTIGConfig.ps1"
      via: "Reads STIG configuration and exceptions"
      pattern: "Get-LabSTIGConfig"
    - from: "Private/Invoke-LabSTIGBaseline.ps1"
      to: "Private/Get-LabSTIGProfile.ps1"
      via: "Gets role-appropriate STIG profile strings"
      pattern: "Get-LabSTIGProfile"
    - from: "Private/Invoke-LabSTIGBaseline.ps1"
      to: "Private/Test-PowerStigInstallation.ps1"
      via: "Pre-flight check before MOF compilation"
      pattern: "Test-PowerStigInstallation"
    - from: "Private/Invoke-LabSTIGBaseline.ps1"
      to: "Private/Write-LabSTIGCompliance.ps1"
      via: "Writes compliance results after application"
      pattern: "Write-LabSTIGCompliance"
    - from: "Private/Write-LabSTIGCompliance.ps1"
      to: ".planning/stig-compliance.json"
      via: "Writes compliance cache file"
      pattern: "stig-compliance\\.json"
---

<objective>
Implement the core STIG baseline application engine and compliance cache writer.

Purpose: Invoke-LabSTIGBaseline is the central orchestrator that installs PowerSTIG on target VMs, discovers OS version, compiles role-appropriate STIG MOFs with exception overrides, applies via DSC push mode, and writes compliance results. Write-LabSTIGCompliance persists per-VM compliance status to the JSON cache file that Phase 29 dashboard will consume.
Output: Invoke-LabSTIGBaseline.ps1 (Private), Write-LabSTIGCompliance.ps1, and comprehensive tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-powerstig-dsc-baselines/27-CONTEXT.md
@.planning/phases/27-powerstig-dsc-baselines/27-01-SUMMARY.md
@.planning/phases/27-powerstig-dsc-baselines/27-02-SUMMARY.md
@Private/Invoke-LabQuickModeHeal.ps1
@Private/Get-LabSTIGConfig.ps1
@Private/Get-LabSTIGProfile.ps1
@Private/Test-PowerStigInstallation.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Write-LabSTIGCompliance with TDD</name>
  <files>Private/Write-LabSTIGCompliance.ps1, Tests/LabSTIGCompliance.Tests.ps1</files>
  <action>
**RED phase -- write tests first** in Tests/LabSTIGCompliance.Tests.ps1:

Test file structure:
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Write-LabSTIGCompliance.ps1')
}
```

**Test cases:**
1. Creates new compliance JSON file when it does not exist
2. Writes correct schema: LastUpdated (ISO 8601), VMs array
3. Each VM entry contains VMName, Role, STIGVersion, Status, ExceptionsApplied, LastChecked, ErrorMessage
4. Status is 'Compliant' when DSC application succeeds with no errors
5. Status is 'NonCompliant' when DSC reports non-compliant resources
6. Status is 'Failed' when DSC application throws an error
7. Updates existing VM entry (by VMName match) without duplicating
8. Adds new VM entry when VMName not previously in cache
9. Preserves existing VM entries when updating a single VM
10. ErrorMessage is null on success, contains error text on failure
11. ExceptionsApplied is integer count of excluded V-numbers
12. Does not throw when output directory does not exist (creates it)

Mock strategy: Mock Set-Content and Get-Content for file I/O. Use $script: tracking variables.

**GREEN phase -- create Private/Write-LabSTIGCompliance.ps1:**
```powershell
function Write-LabSTIGCompliance {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [string]$CachePath,

        [Parameter(Mandatory)]
        [string]$VMName,

        [Parameter(Mandatory)]
        [string]$Role,

        [Parameter(Mandatory)]
        [string]$STIGVersion,

        [Parameter(Mandatory)]
        [ValidateSet('Compliant', 'NonCompliant', 'Failed', 'Pending')]
        [string]$Status,

        [int]$ExceptionsApplied = 0,

        [string]$ErrorMessage = $null
    )

    # Read existing cache or create new
    $cache = $null
    if (Test-Path $CachePath) {
        try {
            $cache = Get-Content -Path $CachePath -Raw | ConvertFrom-Json
        }
        catch { $cache = $null }
    }

    if (-not $cache) {
        $cache = [pscustomobject]@{
            LastUpdated = (Get-Date).ToString('o')
            VMs = @()
        }
    }

    # Build new VM entry
    $vmEntry = [pscustomobject]@{
        VMName            = $VMName
        Role              = $Role
        STIGVersion       = $STIGVersion
        Status            = $Status
        ExceptionsApplied = $ExceptionsApplied
        LastChecked       = (Get-Date).ToString('o')
        ErrorMessage      = $ErrorMessage
    }

    # Update or append
    $existingIndex = -1
    for ($i = 0; $i -lt $cache.VMs.Count; $i++) {
        if ($cache.VMs[$i].VMName -eq $VMName) {
            $existingIndex = $i
            break
        }
    }

    if ($existingIndex -ge 0) {
        $vmList = [System.Collections.ArrayList]@($cache.VMs)
        $vmList[$existingIndex] = $vmEntry
        $cache.VMs = $vmList.ToArray()
    }
    else {
        $cache.VMs = @($cache.VMs) + @($vmEntry)
    }

    $cache.LastUpdated = (Get-Date).ToString('o')

    # Ensure directory exists
    $dir = Split-Path -Parent $CachePath
    if ($dir -and -not (Test-Path $dir)) {
        New-Item -Path $dir -ItemType Directory -Force | Out-Null
    }

    $cache | ConvertTo-Json -Depth 5 | Set-Content -Path $CachePath -Encoding UTF8
}
```

**REFACTOR:** Ensure all tests pass, verify JSON roundtrip fidelity.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/LabSTIGCompliance.Tests.ps1 -Output Detailed"` -- all tests pass.</verify>
  <done>Write-LabSTIGCompliance writes/updates per-VM compliance entries to JSON cache with correct schema. 12+ tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: Create Invoke-LabSTIGBaseline (Private) with TDD</name>
  <files>Private/Invoke-LabSTIGBaseline.ps1, Tests/LabSTIGBaseline.Tests.ps1</files>
  <action>
**RED phase -- write tests first** in Tests/LabSTIGBaseline.Tests.ps1:

Test file structure:
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabSTIGConfig.ps1')
    . (Join-Path $repoRoot 'Private/Get-LabSTIGProfile.ps1')
    . (Join-Path $repoRoot 'Private/Test-PowerStigInstallation.ps1')
    . (Join-Path $repoRoot 'Private/Write-LabSTIGCompliance.ps1')
    . (Join-Path $repoRoot 'Private/Invoke-LabSTIGBaseline.ps1')
}
```

Mock strategy: Define stub functions for Invoke-Command, Get-VM, Install-Module (remote), Start-DscConfiguration, Get-DscConfigurationStatus, Set-Item (WinRM), Write-LabSTIGCompliance. Track calls via $script: variables.

**Core test cases:**
1. Returns no-op result when STIG is disabled (Enabled=$false)
2. Returns no-op when no target VMs specified and no lab VMs found
3. Installs PowerSTIG on target VM when Test-PowerStigInstallation returns Installed=$false
4. Skips installation when PowerSTIG already installed
5. Raises WinRM MaxEnvelopeSizekb to 8192 before DSC operations
6. Calls Get-LabSTIGProfile with correct OsRole and OsVersionBuild for DC VM
7. Calls Get-LabSTIGProfile with correct OsRole for member server VM
8. Compiles STIG MOF with exception overrides when VM has entries in config Exceptions
9. Compiles STIG MOF without exceptions when VM has no exception entries
10. Applies MOF via Start-DscConfiguration in push mode
11. Calls Write-LabSTIGCompliance with 'Compliant' on success
12. Calls Write-LabSTIGCompliance with 'Failed' and error message on MOF compilation failure
13. Handles per-VM failure gracefully -- continues processing remaining VMs
14. Returns audit PSCustomObject: VMsProcessed, VMsSucceeded, VMsFailed, Repairs, RemainingIssues, DurationSeconds
15. Applies 10-minute timeout per VM for MOF compilation + application
16. Skips VM when Get-LabSTIGProfile returns $null (unsupported OS)
17. Invalid V-numbers in exceptions produce a warning but don't fail compilation

**GREEN phase -- create Private/Invoke-LabSTIGBaseline.ps1:**

Follow Invoke-LabQuickModeHeal pattern exactly:
- [CmdletBinding()] with param block
- No-op early return when disabled
- Try-catch around each VM action
- List[string] for repairs and remaining issues
- Duration tracking with Get-Date arithmetic
- Return [pscustomobject] audit trail

Parameters:
- `[string[]]$VMName` -- specific VM(s) to target (for on-demand re-apply). If empty, targets all lab VMs.
- `[string]$ComplianceCachePath` -- override path (default from Get-LabSTIGConfig)

Logic flow per VM:
1. Call Get-LabSTIGConfig -- exit early if not Enabled
2. Discover target VMs (parameter or $GlobalLabConfig.Lab.CoreVMNames)
3. For each VM:
   a. Discover OS version via Invoke-Command: `(Get-WmiObject Win32_OperatingSystem).Version`
   b. Discover OS role: check if VM is a domain controller via `(Get-WmiObject Win32_ComputerSystem).DomainRole` (4 or 5 = DC)
   c. Call Test-PowerStigInstallation -- if not installed, install via `Install-Module PowerSTIG -Scope AllUsers -Force -AllowClobber`
   d. Raise WinRM MaxEnvelopeSizekb: `Set-Item WSMan:\localhost\MaxEnvelopeSizekb 8192`
   e. Call Get-LabSTIGProfile with discovered role and version
   f. Skip if profile is $null (unsupported OS)
   g. Compile MOF: invoke PowerSTIG DSC configuration on target with Technology, StigVersion, OsRole, and Exception V-numbers
   h. Apply MOF: `Start-DscConfiguration -Path <mof-output> -Wait -Force -Verbose`
   i. Check compliance: `Get-DscConfigurationStatus` or `Test-DscConfiguration`
   j. Write compliance: call Write-LabSTIGCompliance with result
   k. Add to repairs list on success, remaining issues on failure

All remote operations use Invoke-Command -ComputerName $vmName. Exception V-numbers passed via PowerSTIG's -Exception parameter during MOF compilation. Invalid V-numbers logged as warnings via Write-Warning with `[STIG]` prefix.

**REFACTOR:** Ensure all tests pass, verify audit trail shape matches Invoke-LabQuickModeHeal.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/LabSTIGBaseline.Tests.ps1 -Output Detailed"` -- all tests pass.</verify>
  <done>Invoke-LabSTIGBaseline orchestrates full STIG lifecycle per VM: install PowerSTIG, discover OS, compile MOF with exceptions, apply via DSC push, write compliance cache, return audit object. 17+ tests passing.</done>
</task>

</tasks>

<verification>
- [ ] Invoke-LabSTIGBaseline installs PowerSTIG when missing on target VM
- [ ] WinRM MaxEnvelopeSizekb raised to 8192 before DSC operations
- [ ] Role-appropriate MOF compiled (DC vs MS) using correct OS version
- [ ] Per-VM exception V-numbers applied at compile time via -Exception parameter
- [ ] MOF applied via Start-DscConfiguration in push mode with -Wait
- [ ] Compliance results written to .planning/stig-compliance.json after each VM
- [ ] Compliance JSON follows documented schema (LastUpdated, VMs array)
- [ ] Per-VM failures handled gracefully -- other VMs continue
- [ ] Returns audit PSCustomObject matching Invoke-LabQuickModeHeal pattern
- [ ] 10-minute timeout per VM for compilation + application
- [ ] All Pester tests pass
</verification>

<success_criteria>
Complete STIG application pipeline: config read -> pre-flight check -> PowerSTIG install -> OS discovery -> MOF compile with exceptions -> DSC push -> compliance cache write -> audit result. Per-VM error isolation. All tests green. Success criteria 1-5 from roadmap are achievable.
</success_criteria>

<output>
After completion, create `.planning/phases/27-powerstig-dsc-baselines/27-03-SUMMARY.md`
</output>
