---
phase: 27-powerstig-dsc-baselines
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Invoke-LabSTIGBaselineCore.ps1
  - Tests/LabSTIGBaseline.Tests.ps1
autonomous: true
gap_closure: true
requirements: [STIG-01, STIG-02, STIG-03, STIG-04, STIG-05, STIG-06]

must_haves:
  truths:
    - "Invoke-LabSTIGBaselineCore compiles a PowerSTIG DSC MOF using the Technology, StigVersion, OsRole, and Exception parameters resolved earlier in the pipeline"
    - "Start-DscConfiguration receives a -Path pointing to the compiled MOF output directory"
    - "Per-VM exception V-numbers from config are passed to the PowerSTIG DSC Configuration at MOF compile time"
  artifacts:
    - path: "Private/Invoke-LabSTIGBaselineCore.ps1"
      provides: "PowerSTIG DSC Configuration scriptblock compilation and DSC push with -Path"
      contains: "WindowsServer"
    - path: "Tests/LabSTIGBaseline.Tests.ps1"
      provides: "Tests verifying MOF compilation call with correct parameters"
  key_links:
    - from: "Private/Invoke-LabSTIGBaselineCore.ps1"
      to: "PowerSTIG WindowsServer DSC Configuration"
      via: "Invoke-Command with DSC Configuration scriptblock"
      pattern: "WindowsServer.*StigVersion.*OsRole"
    - from: "Private/Invoke-LabSTIGBaselineCore.ps1"
      to: "Start-DscConfiguration"
      via: "-Path parameter pointing to MOF output"
      pattern: "Start-DscConfiguration.*-Path"
    - from: "Private/Invoke-LabSTIGBaselineCore.ps1"
      to: "$exceptions"
      via: "Exception parameter in DSC Configuration call"
      pattern: "Exception.*\\$exceptions"
---

<objective>
Close 2 verification gaps from 27-VERIFICATION.md: implement real PowerSTIG DSC MOF compilation (replacing the stub comment at lines 150-154 of Invoke-LabSTIGBaselineCore.ps1) and wire per-VM exception V-numbers into the compile call.

Purpose: The central deliverable of Phase 27 -- compiling and applying STIG baselines via DSC push mode -- is currently stubbed. This plan replaces the stub with a working PowerSTIG DSC Configuration scriptblock that compiles a MOF and passes it to Start-DscConfiguration via -Path.

Output: Updated Invoke-LabSTIGBaselineCore.ps1 with real MOF compilation, updated tests, stale duplicate removed.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-powerstig-dsc-baselines/27-VERIFICATION.md
@.planning/phases/27-powerstig-dsc-baselines/27-03-SUMMARY.md
@.planning/phases/27-powerstig-dsc-baselines/27-04-SUMMARY.md
@Private/Invoke-LabSTIGBaselineCore.ps1
@Tests/LabSTIGBaseline.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PowerSTIG DSC MOF compilation and wire exceptions into Invoke-LabSTIGBaselineCore</name>
  <files>Private/Invoke-LabSTIGBaselineCore.ps1, Tests/LabSTIGBaseline.Tests.ps1</files>
  <action>
Replace the stub comment block at lines 150-154 of Private/Invoke-LabSTIGBaselineCore.ps1 with real PowerSTIG DSC MOF compilation logic. The implementation must:

1. **Create a temp MOF output directory** per VM: `$mofOutputDir = Join-Path (Join-Path $env:TEMP 'LabSTIG') $vm` — create it with `New-Item -ItemType Directory -Force`.

2. **Compile a PowerSTIG MOF via Invoke-Command on the target VM.** The remote scriptblock must:
   - Import the PowerSTIG module (`Import-Module PowerSTIG -Force`)
   - Define a DSC Configuration block named `LabSTIGBaseline` that calls the `WindowsServer` composite resource with parameters:
     - `-OsVersion` = `$profile.StigVersion` (e.g., '2019', '2022')
     - `-OsRole` = `$profile.OsRole` (e.g., 'DC', 'MS')
   - If `$exceptions.Count -gt 0`, build a hashtable of exception overrides. PowerSTIG's `-Exception` parameter takes a hashtable like `@{ 'V-12345' = @{ ValueData = '1' } }`. For lab STIG skip-rule semantics, each V-number maps to a skip marker: `@{ 'V-12345' = @{ ValueData = '' } }`. Build this hashtable from the `$exceptions` array and pass it to `WindowsServer -Exception $exceptionHash`.
   - Compile the Configuration: `LabSTIGBaseline -OutputPath $mofOutputDir`
   - Verify at least one `.mof` file exists in `$mofOutputDir` after compilation; throw if not.

3. **Update Start-DscConfiguration call** to include `-Path $mofOutputDir`:
   `Start-DscConfiguration -Path $mofOutputDir -ComputerName $vm -Wait -Force -Verbose:($VerbosePreference -ne 'SilentlyContinue') | Out-Null`

4. **Clean up temp MOF directory** after DSC apply completes (both success and failure paths): `Remove-Item $mofOutputDir -Recurse -Force -ErrorAction SilentlyContinue`

5. **Remove stale duplicate file** `Private/Invoke-LabSTIGBaseline.ps1` — all callers use `Invoke-LabSTIGBaselineCore`. The file defines a private function named `Invoke-LabSTIGBaseline` that creates a naming collision with the public wrapper. Per VERIFICATION.md, this file should not exist.

6. **Fix test label typo**: In `Tests/LabSTIGBaseline.Tests.ps1`, fix the Describe block label from `'Invoke-LabSTIGBaselineCoreCore'` (doubled Core) to `'Invoke-LabSTIGBaselineCore'`.

7. **Update tests** to verify MOF compilation:
   - Add a test that verifies `Invoke-Command` is called with a scriptblock containing the PowerSTIG Configuration (mock Invoke-Command, assert `-ScriptBlock` parameter includes 'WindowsServer' or 'LabSTIGBaseline')
   - Add a test that verifies when exceptions are configured, the exception hashtable is built and passed (assert scriptblock includes exception handling logic)
   - Add a test that verifies `Start-DscConfiguration` is called with `-Path` parameter (not without it)
   - Add a test that verifies temp MOF directory cleanup after successful apply
   - Existing tests that mock `Start-DscConfiguration` must be updated to also mock the MOF compilation `Invoke-Command` call (since there is now an additional Invoke-Command call for MOF compilation)

IMPORTANT PS 5.1 COMPATIBILITY:
- Use `if ($x) { $a } else { $b }` not ternary operator
- Use nested `Join-Path` for 3+ path segments
- Use `${vm}:` not `$vm:` in interpolated strings
- Pipe side-effect Invoke-Command calls to `| Out-Null` to prevent null pipeline leakage
- DSC cmdlets (Start-DscConfiguration, etc.) must remain as global: stub functions in test BeforeAll blocks

IMPORTANT: The MOF compilation runs on the target VM via Invoke-Command (the VM has PowerSTIG installed). The compiled MOF output must be accessible for Start-DscConfiguration. Since Start-DscConfiguration runs from the host targeting -ComputerName, the MOF must be on the host. Approach: run the DSC Configuration scriptblock on the remote VM to compile the MOF, then copy it back, OR run the DSC Configuration locally if the PowerSTIG module is available locally. Simplest correct approach for lab context: run the entire DSC compile + apply on the remote VM via a single Invoke-Command session. Update Start-DscConfiguration to run inside the same Invoke-Command block (on the remote VM) rather than from the host. This avoids MOF transfer complexity. Wrap the entire compile-and-apply in one Invoke-Command -ComputerName $vm -ScriptBlock { ... } call.
  </action>
  <verify>
Run: `pwsh -Command "Invoke-Pester Tests/LabSTIGBaseline.Tests.ps1 -Output Detailed"` — all existing + new tests pass.
Verify: `Select-String 'In a real environment' Private/Invoke-LabSTIGBaselineCore.ps1` returns no matches (stub comment removed).
Verify: `Select-String 'WindowsServer' Private/Invoke-LabSTIGBaselineCore.ps1` returns at least one match (real compile call present).
Verify: `Select-String 'Start-DscConfiguration.*-Path' Private/Invoke-LabSTIGBaselineCore.ps1` returns at least one match.
Verify: `Test-Path Private/Invoke-LabSTIGBaseline.ps1` returns False (stale duplicate removed).
  </verify>
  <done>
Invoke-LabSTIGBaselineCore.ps1 compiles a real PowerSTIG DSC MOF using WindowsServer technology with correct StigVersion, OsRole, and Exception parameters; Start-DscConfiguration receives -Path to compiled MOF; exception V-numbers are passed at compile time; stale duplicate Private/Invoke-LabSTIGBaseline.ps1 is deleted; all Pester tests pass including new MOF compilation verification tests.
  </done>
</task>

</tasks>

<verification>
1. `Select-String 'In a real environment' Private/Invoke-LabSTIGBaselineCore.ps1` returns no output (stub removed)
2. `Select-String 'WindowsServer' Private/Invoke-LabSTIGBaselineCore.ps1` returns matches (real DSC Configuration)
3. `Select-String '-Path' Private/Invoke-LabSTIGBaselineCore.ps1` shows Start-DscConfiguration with -Path
4. `Select-String 'Exception' Private/Invoke-LabSTIGBaselineCore.ps1` shows exceptions wired to compile call
5. `Test-Path Private/Invoke-LabSTIGBaseline.ps1` returns $false (stale file removed)
6. All Pester tests pass: `pwsh -Command "Invoke-Pester Tests/LabSTIGBaseline.Tests.ps1 -Output Detailed"`
7. No `LabSTIGBaselineCoreCore` typo in test file
</verification>

<success_criteria>
- VERIFICATION.md Gap 1 closed: MOF compilation implemented with WindowsServer technology, StigVersion, OsRole
- VERIFICATION.md Gap 2 closed: Exception V-numbers passed to PowerSTIG at compile time
- Stale duplicate Private/Invoke-LabSTIGBaseline.ps1 removed
- All existing + new tests pass
- No stub comments remain in the MOF compilation section
</success_criteria>

<output>
After completion, create `.planning/phases/27-powerstig-dsc-baselines/27-05-SUMMARY.md`
</output>
