---
phase: 16-snapshot-lifecycle
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - OpenCodeLab-App.ps1
  - Scripts/Lab-Status.ps1
  - Tests/SnapshotLifecycleIntegration.Tests.ps1
autonomous: true
requirements: [SNAP-01, SNAP-02, SNAP-03]

must_haves:
  truths:
    - "Operator can run a CLI action to list all snapshots with age, creation date, and parent checkpoint"
    - "Operator can run a CLI action to prune stale snapshots older than N days"
    - "Lab status output includes a snapshot inventory summary (count, oldest, newest) without extra commands"
  artifacts:
    - path: "OpenCodeLab-App.ps1"
      provides: "snapshot-list and snapshot-prune CLI actions"
      contains: "snapshot-list"
    - path: "Scripts/Lab-Status.ps1"
      provides: "Snapshot inventory summary section in status output"
      contains: "Get-LabSnapshotInventory"
    - path: "Tests/SnapshotLifecycleIntegration.Tests.ps1"
      provides: "Integration tests for CLI wiring and status integration"
      min_lines: 50
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Get-LabSnapshotInventory.ps1"
      via: "snapshot-list action calls Get-LabSnapshotInventory"
      pattern: "Get-LabSnapshotInventory"
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Remove-LabStaleSnapshots.ps1"
      via: "snapshot-prune action calls Remove-LabStaleSnapshots"
      pattern: "Remove-LabStaleSnapshots"
    - from: "Scripts/Lab-Status.ps1"
      to: "Private/Get-LabSnapshotInventory.ps1"
      via: "status script dot-sources and calls inventory for summary"
      pattern: "Get-LabSnapshotInventory"
---

<objective>
Wire snapshot lifecycle functions into the CLI orchestrator and integrate snapshot summary into lab status output.

Purpose: Operators need CLI commands to list and prune snapshots without leaving the normal workflow, and snapshot health should surface automatically in the status dashboard.

Output: Two new CLI actions (snapshot-list, snapshot-prune), enriched status output, and integration tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-snapshot-lifecycle/16-01-SUMMARY.md

# Files being modified
@OpenCodeLab-App.ps1
@Scripts/Lab-Status.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snapshot-list and snapshot-prune CLI actions and enrich Lab-Status.ps1</name>
  <files>OpenCodeLab-App.ps1, Scripts/Lab-Status.ps1</files>
  <action>
**OpenCodeLab-App.ps1 changes:**

1. Add `'snapshot-list'` and `'snapshot-prune'` to the `[ValidateSet()]` on the `$Action` parameter (after `'validate'`).

2. Add a new parameter `[int]$PruneDays` (no default — will default inside action block). Place it after the `$Scenario` parameter.

3. In the switch block (where actions are routed), add two new cases:

```powershell
'snapshot-list' {
    $inventory = Get-LabSnapshotInventory
    if ($inventory.Count -eq 0) {
        Write-LabStatus -Status INFO -Message 'No snapshots found across lab VMs'
    }
    else {
        Write-Host "`n  SNAPSHOT INVENTORY" -ForegroundColor Cyan
        Write-Host "  $('-' * 40)" -ForegroundColor DarkGray
        foreach ($snap in $inventory) {
            $ageStr = "$($snap.AgeDays)d"
            $dateStr = $snap.CreationTime.ToString('yyyy-MM-dd HH:mm')
            $parentStr = $snap.ParentCheckpointName
            Write-Host ("  {0,-8} {1,-25} {2,-18} {3,6}  parent: {4}" -f $snap.VMName, $snap.CheckpointName, $dateStr, $ageStr, $parentStr) -ForegroundColor Gray
        }
        Write-Host "`n  Total: $($inventory.Count) snapshot(s)" -ForegroundColor DarkGray
    }
}

'snapshot-prune' {
    $threshold = if ($PSBoundParameters.ContainsKey('PruneDays')) { $PruneDays } else { 7 }
    Write-LabStatus -Status INFO -Message "Pruning snapshots older than $threshold days..."
    $pruneResult = Remove-LabStaleSnapshots -OlderThanDays $threshold
    switch ($pruneResult.OverallStatus) {
        'NoStale' { Write-LabStatus -Status OK -Message "No stale snapshots found (threshold: ${threshold}d)" }
        'OK' {
            Write-LabStatus -Status OK -Message "Removed $($pruneResult.TotalRemoved) snapshot(s)"
            foreach ($r in $pruneResult.Removed) {
                Write-LabStatus -Status INFO -Message "  $($r.VMName) / $($r.CheckpointName) ($($r.AgeDays)d old)" -Indent 2
            }
        }
        'Partial' {
            Write-LabStatus -Status WARN -Message "Removed $($pruneResult.TotalRemoved) of $($pruneResult.TotalFound) stale snapshots"
            foreach ($f in $pruneResult.Failed) {
                Write-LabStatus -Status FAIL -Message "  $($f.VMName) / $($f.CheckpointName): $($f.ErrorMessage)" -Indent 2
            }
        }
    }
}
```

**Scripts/Lab-Status.ps1 changes:**

Replace the existing SNAPSHOTS section (lines ~49-59 that use `Get-VMSnapshot`) with an enriched version that uses Get-LabSnapshotInventory:

1. Dot-source the inventory function near the top of the file (after existing dot-sources):
   ```powershell
   $inventoryPath = Join-Path $RepoRoot 'Private/Get-LabSnapshotInventory.ps1'
   if (Test-Path $inventoryPath) { . $inventoryPath }
   ```

2. Replace the SNAPSHOTS section with:
   ```powershell
   Write-Host "`n  SNAPSHOTS:" -ForegroundColor Yellow
   try {
       $snapInventory = Get-LabSnapshotInventory
       if ($snapInventory.Count -gt 0) {
           $oldest = ($snapInventory | Sort-Object CreationTime | Select-Object -First 1)
           $newest = ($snapInventory | Sort-Object CreationTime -Descending | Select-Object -First 1)
           $staleCount = @($snapInventory | Where-Object { $_.AgeDays -gt 7 }).Count
           Write-Host "    Count: $($snapInventory.Count)  |  Oldest: $($oldest.AgeDays)d ($($oldest.VMName)/$($oldest.CheckpointName))  |  Newest: $($newest.AgeDays)d ($($newest.VMName)/$($newest.CheckpointName))" -ForegroundColor Gray
           if ($staleCount -gt 0) {
               Write-Host "    Stale (>7d): $staleCount — run 'snapshot-prune' to clean up" -ForegroundColor Yellow
           }
       }
       else {
           Write-Host "    (none)" -ForegroundColor DarkGray
       }
   }
   catch {
       # Fall back to basic snapshot listing if inventory function unavailable
       $snaps = Get-VM | Where-Object { $_.Name -in $allLabVMs } | Get-VMSnapshot -ErrorAction SilentlyContinue
       if ($snaps) {
           Write-Host "    ($($snaps.Count) total snapshots)" -ForegroundColor DarkGray
       }
       else {
           Write-Host "    (none)" -ForegroundColor DarkGray
       }
   }
   ```
  </action>
  <verify>
1. Verify OpenCodeLab-App.ps1 parses: `pwsh -NoProfile -Command "& { $ast = [System.Management.Automation.Language.Parser]::ParseFile('OpenCodeLab-App.ps1', [ref]$null, [ref]$null); Write-Host 'Parse OK' }"`
2. Verify snapshot-list and snapshot-prune are in the ValidateSet: `Select-String -Path OpenCodeLab-App.ps1 -Pattern 'snapshot-list|snapshot-prune'`
3. Verify Lab-Status.ps1 references Get-LabSnapshotInventory: `Select-String -Path Scripts/Lab-Status.ps1 -Pattern 'Get-LabSnapshotInventory'`
  </verify>
  <done>OpenCodeLab-App.ps1 has snapshot-list and snapshot-prune actions with formatted console output. Lab-Status.ps1 shows snapshot inventory summary (count, oldest, newest, stale count) using Get-LabSnapshotInventory with fallback to basic listing.</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for snapshot CLI actions and status integration</name>
  <files>Tests/SnapshotLifecycleIntegration.Tests.ps1</files>
  <action>
Create `Tests/SnapshotLifecycleIntegration.Tests.ps1` with Pester 5.x integration tests using static analysis patterns (consistent with Phases 14-02 and 15-02).

BeforeAll block:
- `$repoRoot = Split-Path -Parent $PSScriptRoot`
- Read file contents into variables for static analysis:
  - `$script:appContent = Get-Content (Join-Path $repoRoot 'OpenCodeLab-App.ps1') -Raw`
  - `$script:statusContent = Get-Content (Join-Path (Join-Path $repoRoot 'Scripts') 'Lab-Status.ps1') -Raw`

Describe 'Snapshot CLI Actions - OpenCodeLab-App.ps1':
- Test: ValidateSet includes 'snapshot-list' (use Select-String or regex on $appContent)
- Test: ValidateSet includes 'snapshot-prune' (use Select-String or regex on $appContent)
- Test: snapshot-list switch case exists and calls Get-LabSnapshotInventory
- Test: snapshot-prune switch case exists and calls Remove-LabStaleSnapshots
- Test: PruneDays parameter is declared (regex for `\$PruneDays` in param block)
- Test: snapshot-prune uses Write-LabStatus for output formatting

Describe 'Snapshot Status Integration - Lab-Status.ps1':
- Test: Lab-Status.ps1 dot-sources Get-LabSnapshotInventory.ps1 (pattern: `Get-LabSnapshotInventory\.ps1`)
- Test: SNAPSHOTS section calls Get-LabSnapshotInventory (pattern in content)
- Test: Status output includes oldest/newest summary (pattern: `Oldest.*Newest` or similar)
- Test: Status output includes stale count warning (pattern: `Stale.*snapshot-prune`)
- Test: Fallback exists for when inventory function is unavailable (pattern: `catch` and `Get-VMSnapshot`)

Describe 'Function Availability':
- Test: Get-LabSnapshotInventory.ps1 exists in Private/
- Test: Remove-LabStaleSnapshots.ps1 exists in Private/
- Test: Both functions can be dot-sourced without error:
  ```powershell
  { . (Join-Path $repoRoot 'Private/Get-LabSnapshotInventory.ps1') } | Should -Not -Throw
  { . (Join-Path $repoRoot 'Private/Remove-LabStaleSnapshots.ps1') } | Should -Not -Throw
  ```
  </action>
  <verify>
```powershell
pwsh -NoProfile -Command "Invoke-Pester ./Tests/SnapshotLifecycleIntegration.Tests.ps1 -Output Detailed -PassThru | Select-Object -Property Result,TotalCount,PassedCount,FailedCount"
```
All tests pass.
  </verify>
  <done>SnapshotLifecycleIntegration.Tests.ps1 exists with 12+ tests covering CLI action wiring, status integration, and function availability. All tests pass.</done>
</task>

</tasks>

<verification>
1. OpenCodeLab-App.ps1 parses without errors and includes snapshot-list, snapshot-prune in ValidateSet
2. Lab-Status.ps1 uses Get-LabSnapshotInventory for enriched snapshot summary
3. All integration tests pass
4. Operator can run `-Action snapshot-list` to see all snapshots with age and parent info
5. Operator can run `-Action snapshot-prune -PruneDays 7` to clean up stale snapshots
6. Lab status shows snapshot count, oldest, newest, and stale warning automatically
</verification>

<success_criteria>
- Two new CLI actions functional (snapshot-list, snapshot-prune)
- Lab status output enriched with snapshot inventory summary
- 12+ integration tests all passing
- All three SNAP requirements fully addressed end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/16-snapshot-lifecycle/16-02-SUMMARY.md`
</output>
