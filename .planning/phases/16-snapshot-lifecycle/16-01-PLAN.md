---
phase: 16-snapshot-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Get-LabSnapshotInventory.ps1
  - Private/Remove-LabStaleSnapshots.ps1
  - Tests/SnapshotLifecycle.Tests.ps1
autonomous: true
requirements: [SNAP-01, SNAP-02]

must_haves:
  truths:
    - "Operator can retrieve a structured list of all snapshots across lab VMs showing age, creation date, and parent checkpoint name"
    - "Operator can prune snapshots older than N days (default 7) and see what was removed"
    - "Pruning respects a configurable threshold and defaults to 7 days when unspecified"
  artifacts:
    - path: "Private/Get-LabSnapshotInventory.ps1"
      provides: "Snapshot inventory function returning structured PSCustomObjects per snapshot"
      contains: "function Get-LabSnapshotInventory"
    - path: "Private/Remove-LabStaleSnapshots.ps1"
      provides: "Age-based snapshot pruning with configurable threshold"
      contains: "function Remove-LabStaleSnapshots"
    - path: "Tests/SnapshotLifecycle.Tests.ps1"
      provides: "Pester 5.x tests for inventory and pruning functions"
      min_lines: 80
  key_links:
    - from: "Private/Get-LabSnapshotInventory.ps1"
      to: "Get-VMCheckpoint"
      via: "Hyper-V cmdlet call"
      pattern: "Get-VMCheckpoint"
    - from: "Private/Remove-LabStaleSnapshots.ps1"
      to: "Private/Get-LabSnapshotInventory.ps1"
      via: "calls inventory to discover stale snapshots"
      pattern: "Get-LabSnapshotInventory"
---

<objective>
Create the snapshot inventory and age-based pruning functions with comprehensive Pester tests.

Purpose: Operators need visibility into checkpoint accumulation and a safe way to clean up stale snapshots without manually digging through Hyper-V Manager for each VM.

Output: Two Private helper functions (Get-LabSnapshotInventory, Remove-LabStaleSnapshots) and a Pester test suite.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing checkpoint functions for pattern reference
@Public/Get-LabCheckpoint.ps1
@Private/Remove-LabCheckpoint.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabSnapshotInventory and Remove-LabStaleSnapshots functions</name>
  <files>Private/Get-LabSnapshotInventory.ps1, Private/Remove-LabStaleSnapshots.ps1</files>
  <action>
Create `Private/Get-LabSnapshotInventory.ps1` with function `Get-LabSnapshotInventory`:

- `[CmdletBinding()]` and `[OutputType([PSCustomObject[]])]`
- No mandatory parameters. Optional `-VMName [string[]]` to filter specific VMs (default: all lab VMs from GlobalLabConfig.Lab.CoreVMNames + auto-detect LIN1, same pattern as Get-LabCheckpoint.ps1)
- For each lab VM, call `Get-VMCheckpoint -VMName $name -ErrorAction SilentlyContinue`
- For each checkpoint returned, build a PSCustomObject with these properties:
  - `VMName` [string] - the VM name
  - `CheckpointName` [string] - the checkpoint name
  - `CreationTime` [datetime] - from checkpoint's CreationTime property
  - `AgeDays` [double] - `[math]::Round(((Get-Date) - $checkpoint.CreationTime).TotalDays, 1)`
  - `ParentCheckpointName` [string] - from `$checkpoint.ParentCheckpointName`; if null use `'(root)'`
- If VM does not exist, skip silently with Write-Verbose
- If VM has no checkpoints, skip silently with Write-Verbose
- Return all snapshot objects sorted by CreationTime ascending
- Wrap entire body in try/catch, Write-Error on failure, return @()
- Use `Set-StrictMode` safe patterns: `Test-Path variable:GlobalLabConfig` for config access

Create `Private/Remove-LabStaleSnapshots.ps1` with function `Remove-LabStaleSnapshots`:

- `[CmdletBinding(SupportsShouldProcess)]` and `[OutputType([PSCustomObject])]`
- Parameters:
  - `[int]$OlderThanDays = 7` - age threshold for stale snapshots
  - `[string[]]$VMName` - optional filter (same default as inventory function)
- Call `Get-LabSnapshotInventory` (with `-VMName` if provided) to get all snapshots
- Filter where `AgeDays -gt $OlderThanDays`
- For each stale snapshot, use `$PSCmdlet.ShouldProcess("$($snap.CheckpointName) on $($snap.VMName)", 'Remove-VMCheckpoint')` before calling `Remove-VMCheckpoint -VMName $snap.VMName -Name $snap.CheckpointName -ErrorAction Stop`
- Track removed and failed in arrays
- Return a PSCustomObject with:
  - `Removed` [PSCustomObject[]] - array of removed snapshot info objects (VMName, CheckpointName, AgeDays)
  - `Failed` [PSCustomObject[]] - array of failed removals with ErrorMessage
  - `TotalFound` [int] - count of stale snapshots found
  - `TotalRemoved` [int] - count successfully removed
  - `ThresholdDays` [int] - the threshold used
  - `OverallStatus` [string] - 'OK' if no failures, 'Partial' if some failed, 'NoStale' if none found
- Wrap Hyper-V calls in try/catch per snapshot (don't let one failure stop others)
  </action>
  <verify>
Both files exist in Private/ directory. Functions parse without syntax errors:
```powershell
pwsh -NoProfile -Command ". ./Private/Get-LabSnapshotInventory.ps1; . ./Private/Remove-LabStaleSnapshots.ps1; Write-Host 'OK'"
```
  </verify>
  <done>Get-LabSnapshotInventory returns PSCustomObject[] with VMName/CheckpointName/CreationTime/AgeDays/ParentCheckpointName. Remove-LabStaleSnapshots filters by age threshold, removes stale checkpoints with ShouldProcess support, returns structured result with Removed/Failed/OverallStatus.</done>
</task>

<task type="auto">
  <name>Task 2: Create Pester test suite for snapshot lifecycle functions</name>
  <files>Tests/SnapshotLifecycle.Tests.ps1</files>
  <action>
Create `Tests/SnapshotLifecycle.Tests.ps1` with Pester 5.x tests.

BeforeAll block:
- `$repoRoot = Split-Path -Parent $PSScriptRoot`
- Dot-source both `Private/Get-LabSnapshotInventory.ps1` and `Private/Remove-LabStaleSnapshots.ps1`
- Also dot-source `Public/Get-LabCheckpoint.ps1` if needed for any shared helpers

Describe 'Get-LabSnapshotInventory':
- BeforeEach: Mock `Get-VM` to return test VM objects. Mock `Get-VMCheckpoint` to return checkpoint objects with CreationTime, Name, ParentCheckpointName properties. Set `$Global:GlobalLabConfig = @{ Lab = @{ CoreVMNames = @('dc1','svr1','ws1') } }`
- Test: Returns snapshot objects with correct properties (VMName, CheckpointName, CreationTime, AgeDays, ParentCheckpointName)
- Test: Calculates AgeDays correctly (mock CreationTime to 3 days ago, verify AgeDays is approximately 3.0)
- Test: Sets ParentCheckpointName to '(root)' when parent is null
- Test: Returns ParentCheckpointName when parent exists
- Test: Returns empty array when no VMs have checkpoints (mock Get-VMCheckpoint returning nothing)
- Test: Skips non-existent VMs without error (mock Get-VM returning $null for one VM)
- Test: Includes LIN1 when Get-VM finds it (mock Get-VM for LIN1)
- Test: Results sorted by CreationTime ascending
- Test: Filters by -VMName parameter when provided

Describe 'Remove-LabStaleSnapshots':
- BeforeEach: Mock `Get-LabSnapshotInventory` returning a mix of old (10 days) and recent (2 days) snapshots. Mock `Remove-VMCheckpoint` as no-op.
- Test: Removes only snapshots older than threshold (default 7 days)
- Test: Returns 'NoStale' status when no snapshots exceed threshold
- Test: Custom threshold via -OlderThanDays parameter works (set to 1, verify more are pruned)
- Test: Returns correct TotalFound and TotalRemoved counts
- Test: Handles removal failure gracefully (mock Remove-VMCheckpoint to throw for one, verify Partial status and Failed array populated)
- Test: Result contains ThresholdDays matching input parameter
- Test: ShouldProcess is respected (-WhatIf does not call Remove-VMCheckpoint)
- Test: Passes -VMName through to Get-LabSnapshotInventory

AfterAll: Remove `$Global:GlobalLabConfig` if set.

Use `$script:` prefix for BeforeAll variables accessed in It blocks per Pester 5.x convention.
  </action>
  <verify>
```powershell
pwsh -NoProfile -Command "Invoke-Pester ./Tests/SnapshotLifecycle.Tests.ps1 -Output Detailed -PassThru | Select-Object -Property Result,TotalCount,PassedCount,FailedCount"
```
All tests pass.
  </verify>
  <done>SnapshotLifecycle.Tests.ps1 exists with 15+ Pester tests covering both functions. All tests pass. Tests cover: property shape, age calculation, parent name fallback, empty results, LIN1 detection, sorting, filtering, threshold logic, failure handling, WhatIf support.</done>
</task>

</tasks>

<verification>
1. Both Private functions parse without errors
2. All Pester tests pass
3. Get-LabSnapshotInventory returns PSCustomObject[] with VMName, CheckpointName, CreationTime, AgeDays, ParentCheckpointName
4. Remove-LabStaleSnapshots filters by age, supports -WhatIf, returns structured result
</verification>

<success_criteria>
- Two new Private helper functions created following existing codebase conventions
- 15+ Pester tests all passing
- Functions are self-contained and ready for CLI wiring in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/16-snapshot-lifecycle/16-01-SUMMARY.md`
</output>
