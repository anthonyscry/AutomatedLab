name: PR Lint

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write

jobs:
  lint:
    name: ScriptAnalyzer lint
    runs-on: windows-latest
    shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck

      - name: Run ScriptAnalyzer
        run: |
          $results = @()
          $results += Invoke-ScriptAnalyzer -Path ./Public -Recurse -Settings .PSScriptAnalyzerSettings.psd1
          $results += Invoke-ScriptAnalyzer -Path ./Private -Recurse -Settings .PSScriptAnalyzerSettings.psd1
          $results += Invoke-ScriptAnalyzer -Path ./Scripts -Recurse -Settings .PSScriptAnalyzerSettings.psd1
          $results += Invoke-ScriptAnalyzer -Path ./Deploy.ps1 -Settings .PSScriptAnalyzerSettings.psd1
          $results += Invoke-ScriptAnalyzer -Path ./Bootstrap.ps1 -Settings .PSScriptAnalyzerSettings.psd1
          $results += Invoke-ScriptAnalyzer -Path ./OpenCodeLab-App.ps1 -Settings .PSScriptAnalyzerSettings.psd1

          $errors = @($results | Where-Object { $_.Severity -eq 'Error' })
          $warnings = @($results | Where-Object { $_.Severity -eq 'Warning' })

          # Emit GitHub Actions annotations for all results
          foreach ($r in $results) {
              $file = $r.ScriptName
              $line = $r.Line
              $msg = "$($r.RuleName): $($r.Message)"
              if ($r.Severity -eq 'Error') {
                  Write-Output "::error file=$file,line=$line::$msg"
              } else {
                  Write-Output "::warning file=$file,line=$line::$msg"
              }
          }

          Write-Output ""
          Write-Output "ScriptAnalyzer: $($errors.Count) error(s), $($warnings.Count) warning(s)"

          if ($errors.Count -gt 0) {
              Write-Output "::error::ScriptAnalyzer found $($errors.Count) error(s)"
              exit 1
          }
