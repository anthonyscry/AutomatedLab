name: OpenCodeLab v2 CI

on:
  workflow_dispatch:
  push:
    paths:
      - "OpenCodeLab-v2/**"
      - ".github/workflows/opencodelab-v2-ci.yml"
      - "OpenCodeLab-v2/.github/workflows/ci.yml"
  pull_request:
    paths:
      - "OpenCodeLab-v2/**"
      - ".github/workflows/opencodelab-v2-ci.yml"
      - "OpenCodeLab-v2/.github/workflows/ci.yml"

permissions:
  contents: read

jobs:
  quality-gates:
    name: Unit, Integration, Smoke, Analyzer
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install test and lint modules
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.5.0 -Scope CurrentUser -Force
          Install-Module -Name PSScriptAnalyzer -MinimumVersion 1.22.0 -Scope CurrentUser -Force

      - name: Run unit tests
        run: Invoke-Pester -Path 'OpenCodeLab-v2/tests/unit' -CI

      - name: Run integration tests
        run: Invoke-Pester -Path 'OpenCodeLab-v2/tests/integration' -CI

      - name: Run smoke tests
        run: Invoke-Pester -Path 'OpenCodeLab-v2/tests/smoke' -CI -Output Detailed

      - name: Run ScriptAnalyzer quality gate
        run: |
          $warnings = @()
          $warnings += @(Invoke-ScriptAnalyzer -Path 'OpenCodeLab-v2/src' -Recurse -Severity Warning)
          $warnings += @(Invoke-ScriptAnalyzer -Path 'OpenCodeLab-v2/scripts' -Recurse -Severity Warning)
          if ($warnings.Count -gt 0) {
            Write-Warning "ScriptAnalyzer reported $($warnings.Count) warning issue(s)."
            $warnings | Format-Table -AutoSize
          }

          $errors = @()
          $errors += @(Invoke-ScriptAnalyzer -Path 'OpenCodeLab-v2/src' -Recurse -Severity Error)
          $errors += @(Invoke-ScriptAnalyzer -Path 'OpenCodeLab-v2/scripts' -Recurse -Severity Error)
          if ($errors.Count -gt 0) {
            $errors | Format-Table -AutoSize
            throw "ScriptAnalyzer reported $($errors.Count) error issue(s)."
          }

      - name: Build WPF application
        run: dotnet build OpenCodeLab-v2/OpenCodeLab-V2.csproj -c Release --nologo

      - name: Check .NET dependency vulnerabilities
        run: |
          $vulnOutput = dotnet list OpenCodeLab-v2/OpenCodeLab-V2.csproj package --vulnerable --include-transitive
          $vulnOutput
          if ($vulnOutput -notmatch 'has no vulnerable packages') {
            throw 'Potential vulnerable packages detected. Review the dependency report above.'
          }
