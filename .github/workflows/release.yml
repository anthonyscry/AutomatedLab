name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      publish_to_gallery:
        description: 'Publish to PowerShell Gallery after release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  checks: write

jobs:
  release:
    name: Build, test, and release
    runs-on: windows-latest
    shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          $tag = if ($env:GITHUB_REF_TYPE -eq 'tag') { $env:GITHUB_REF_NAME } else { 'v0.0.0-manual' }
          $version = $tag -replace '^v', ''
          Write-Output "TAG=$tag" >> $env:GITHUB_OUTPUT
          Write-Output "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Output "Detected tag: $tag, version: $version"

      - name: Validate version matches manifest
        run: |
          $manifest = Import-PowerShellDataFile -Path SimpleLab.psd1
          $manifestVersion = $manifest.ModuleVersion
          $tagVersion = '${{ steps.version.outputs.VERSION }}'
          if ($tagVersion -ne '0.0.0-manual' -and $manifestVersion -ne $tagVersion) {
              Write-Output "::error::Version mismatch: SimpleLab.psd1 has $manifestVersion but tag is v$tagVersion"
              exit 1
          }
          Write-Output "Version validated: $manifestVersion"

      - name: Install Pester
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser -SkipPublisherCheck

      - name: Run full test suite
        run: |
          .\Tests\Run.Tests.ps1 -OutputPath Tests/results/testResults.xml -Verbosity Detailed

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-test-results
          path: Tests/results/testResults.xml

      - name: Verify module loads
        run: |
          Import-Module ./SimpleLab.psd1 -Force -ErrorAction Stop
          $mod = Get-Module SimpleLab
          Write-Output "Module loaded: $($mod.Name) v$($mod.Version)"
          Write-Output "Exported functions: $($mod.ExportedFunctions.Count)"

      - name: Validate FunctionsToExport
        run: |
          $manifest = Import-PowerShellDataFile -Path SimpleLab.psd1
          $exportCount = $manifest.FunctionsToExport.Count
          $publicFiles = (Get-ChildItem -Path ./Public -Filter '*.ps1' -Recurse -File).Count
          if ($exportCount -ne $publicFiles) {
              Write-Output "::warning::FunctionsToExport ($exportCount) does not match Public/ file count ($publicFiles). Review before publishing."
          }
          Write-Output "Export check: $exportCount functions exported, $publicFiles Public/ files"

      - name: Generate changelog
        id: changelog
        if: github.ref_type == 'tag'
        run: |
          $previousTag = git describe --tags --abbrev=0 HEAD~1 2>$null
          if (-not $previousTag) {
              $previousTag = git rev-list --max-parents=0 HEAD
          }
          $log = git log "$previousTag..HEAD" --pretty=format:"- %s" --no-merges
          $log | Out-File -FilePath changelog.txt -Encoding utf8
          Write-Output "Changelog generated from $previousTag to HEAD"

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: SimpleLab ${{ steps.version.outputs.TAG }}
          body_path: changelog.txt
          draft: false
          prerelease: false

      - name: Publish to PowerShell Gallery (dry run)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_gallery == 'true'
        run: |
          Write-Output "--- DRY RUN ---"
          Publish-Module -Path . -NuGetApiKey '${{ secrets.PSGALLERY_API_KEY }}' -WhatIf -Verbose
          Write-Output "--- DRY RUN COMPLETE ---"

      - name: Publish to PowerShell Gallery
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_gallery == 'true'
        run: |
          Write-Output "--- PUBLISHING ---"
          Publish-Module -Path . -NuGetApiKey '${{ secrets.PSGALLERY_API_KEY }}' -Verbose
          Write-Output "Published SimpleLab to PowerShell Gallery"
